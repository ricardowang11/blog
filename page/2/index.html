<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-minimal.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Pisces',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'å¤åˆ¶',
      copy_success: 'å¤åˆ¶æˆåŠŸ',
      copy_failure: 'å¤åˆ¶å¤±è´¥'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Dunwu&#39;s Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu">
<meta property="og:url" content="https://dunwu.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="Dunwu">
<meta property="og:description" content="Dunwu&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zhang Peng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://dunwu.github.io/blog/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Dunwu</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/blog/atom.xml" title="Dunwu" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Dunwu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">å¤§é“è‡³ç®€ï¼ŒçŸ¥æ˜“è¡Œéš¾</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blog/about/" rel="section"><i class="fa fa-fw fa-user"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>æ ‡ç­¾<span class="badge">43</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-fw fa-th"></i>åˆ†ç±»<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>å½’æ¡£<span class="badge">47</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="æœç´¢..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/dunwu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/limiting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/limiting/" class="post-title-link" itemprop="url">é™æµç®—æ³•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-01-20 11:06:00" itemprop="dateCreated datePublished" datetime="2020-01-20T11:06:00+08:00">2020-01-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/limiting/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/limiting/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>6.4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>6 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="é™æµç®—æ³•"><a class="markdownIt-Anchor" href="#é™æµç®—æ³•"></a> é™æµç®—æ³•</h1>
<blockquote>
<p>åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºäº†åº”å¯¹ç¬æ—¶æµ·é‡è¯·æ±‚çš„å‹åŠ›ï¼Œä¿éšœç³»ç»Ÿçš„å¹³ç¨³è¿è¡Œï¼Œå¿…é¡»é¢„ä¼°ç³»ç»Ÿçš„æµé‡é˜ˆå€¼ï¼Œé€šè¿‡é™æµè§„åˆ™é˜»æ–­å¤„ç†ä¸è¿‡æ¥çš„è¯·æ±‚ã€‚</p>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#%E4%B8%80%E9%99%90%E6%B5%81%E7%AE%80%E4%BB%8B">ä¸€ã€é™æµç®€ä»‹</a></li>
<li><a href="#%E4%BA%8C%E8%AE%A1%E6%95%B0%E5%99%A8%E6%B3%95">äºŒã€è®¡æ•°å™¨æ³•</a></li>
<li><a href="#%E4%B8%89%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B3%95">ä¸‰ã€æ»‘åŠ¨çª—å£æ³•</a></li>
<li><a href="#%E5%9B%9B%E4%BB%A4%E7%89%8C%E6%A1%B6%E6%B3%95">å››ã€ä»¤ç‰Œæ¡¶æ³•</a></li>
<li><a href="#%E4%BA%94%E6%BC%8F%E6%A1%B6%E6%B3%95">äº”ã€æ¼æ¡¶æ³•</a></li>
<li><a href="#%E5%85%AD%E9%99%90%E6%B5%81%E5%B7%A5%E5%85%B7">å…­ã€é™æµå·¥å…·</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="ä¸€-é™æµç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-é™æµç®€ä»‹"></a> ä¸€ã€é™æµç®€ä»‹</h2>
<p>é™æµå¯ä»¥è®¤ä¸ºæ˜¯æœåŠ¡é™çº§çš„ä¸€ç§ã€‚é™æµå°±æ˜¯<strong>é™åˆ¶ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡ºæµé‡å·²è¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„</strong>ã€‚ä¸€èˆ¬æ¥è¯´ç³»ç»Ÿçš„ååé‡æ˜¯å¯ä»¥è¢«æµ‹ç®—çš„ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œä¸€æ—¦è¾¾åˆ°çš„éœ€è¦é™åˆ¶çš„é˜ˆå€¼ï¼Œå°±éœ€è¦é™åˆ¶æµé‡å¹¶é‡‡å–ä¸€äº›æªæ–½ä»¥å®Œæˆé™åˆ¶æµé‡çš„ç›®çš„ã€‚æ¯”å¦‚ï¼šå»¶è¿Ÿå¤„ç†ï¼Œæ‹’ç»å¤„ç†ï¼Œæˆ–è€…éƒ¨åˆ†æ‹’ç»å¤„ç†ç­‰ç­‰ã€‚</p>
<p>é™æµè§„åˆ™åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ—¶é—´ç²’åº¦ï¼Œæ¥å£ç²’åº¦ï¼Œæœ€å¤§é™æµå€¼ã€‚é™æµè§„åˆ™è®¾ç½®æ˜¯å¦åˆç†ç›´æ¥å½±å“åˆ°é™æµæ˜¯å¦åˆç†æœ‰æ•ˆã€‚</p>
<h2 id="äºŒ-è®¡æ•°å™¨æ³•"><a class="markdownIt-Anchor" href="#äºŒ-è®¡æ•°å™¨æ³•"></a> äºŒã€è®¡æ•°å™¨æ³•</h2>
<p>è®¡æ•°å™¨æ³•çš„<strong>åŸç†</strong>æ˜¯ï¼šè®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºç»Ÿè®¡æŒ‡å®šæ—¶é—´æ®µå†…çš„è¯·æ±‚æ•°é‡ï¼Œå¹¶åœ¨æŒ‡å®šæ—¶é—´æ®µä¹‹åé‡ç½®è®¡æ•°å™¨ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡é™å®šçš„é˜ˆå€¼ï¼Œåˆ™æ‹’ç»è¯·æ±‚ã€‚</p>
<p>è¿™ç§ç®—æ³•çš„ç¼ºé™·æ˜¯ï¼šè¿™ç§ç®—æ³•æ˜¯é’ˆå¯¹ä¸€ä¸ªæ—¶é—´æ®µè¿›è¡Œç»Ÿè®¡ï¼Œå¦‚æœè¯·æ±‚åˆ†å¸ƒä¸å‡åŒ€ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œ<strong>æ‰€æœ‰è¯·æ±‚éƒ½åœ¨æŸä¸€åˆ»æ”¶åˆ°ï¼Œè¿˜æ˜¯å¯èƒ½å‹å®ç³»ç»Ÿ</strong>ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬é™æµè§„åˆ™ä¸ºæ¯ç§’é’Ÿä¸è¶…è¿‡ 100 æ¬¡æ¥å£è¯·æ±‚ï¼Œç¬¬ä¸€ä¸ª 1s æ—¶é—´çª—å£å†…ï¼Œ100 æ¬¡æ¥å£è¯·æ±‚éƒ½é›†ä¸­åœ¨æœ€åçš„ 10ms å†…ï¼Œåœ¨ç¬¬äºŒä¸ª 1s çš„æ—¶é—´çª—å£å†…ï¼Œ100 æ¬¡æ¥å£è¯·æ±‚éƒ½é›†ä¸­åœ¨æœ€å¼€å§‹çš„ 10ms å†…ï¼Œè™½ç„¶ä¸¤ä¸ªæ—¶é—´çª—å£å†…æµé‡éƒ½ç¬¦åˆé™æµè¦æ±‚ï¼Œä½†æ˜¯åœ¨è¿™ä¸¤ä¸ªæ—¶é—´çª—å£ä¸´ç•Œçš„ 20ms å†…ä¼šé›†ä¸­æœ‰ 200 æ¬¡æ¥å£è¯·æ±‚ï¼Œå¦‚æœä¸åšé™æµï¼Œé›†ä¸­åœ¨è¿™ 20ms å†…çš„ 200 æ¬¡è¯·æ±‚å°±æœ‰å¯èƒ½å‹å®ç³»ç»Ÿã€‚</p>
<p>ã€ç¤ºä¾‹ã€‘ä½¿ç”¨ <code>AtomicInteger</code> å®ç°è®¡æ•°å™¨æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å¤§è®¿é—®æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> limit = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¿é—®æ—¶é—´å·®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeout = <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger reqCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (now &lt; time + timeout) &#123;</span><br><span class="line">            <span class="comment">// å•ä½æ—¶é—´å†…</span></span><br><span class="line">            reqCount.addAndGet(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> reqCount.get() &lt;= limit;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¶…å‡ºå•ä½æ—¶é—´</span></span><br><span class="line">            time = now;</span><br><span class="line">            reqCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ã€ç¤ºä¾‹ã€‘åŸºäº Redis Lua è®¡æ•°é™æµç®—æ³•çš„å®ç°</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å®ç°åŸç†</span></span><br><span class="line"><span class="comment">-- æ¯æ¬¡è¯·æ±‚éƒ½å°†å½“å‰æ—¶é—´ï¼Œç²¾ç¡®åˆ°ç§’ä½œä¸º key æ”¾å…¥ Redis ä¸­ï¼Œè¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 2sï¼Œ Redis å°†è¯¥ key çš„å€¼è¿›è¡Œè‡ªå¢</span></span><br><span class="line"><span class="comment">-- å½“è¾¾åˆ°é˜ˆå€¼æ—¶è¿”å›é”™è¯¯ï¼Œè¡¨ç¤ºè¯·æ±‚è¢«é™æµ</span></span><br><span class="line"><span class="comment">-- å†™å…¥ Redis çš„æ“ä½œç”¨ Lua è„šæœ¬æ¥å®Œæˆï¼Œåˆ©ç”¨ Redis çš„å•çº¿ç¨‹æœºåˆ¶å¯ä»¥ä¿è¯æ¯ä¸ª Redis è¯·æ±‚çš„åŸå­æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- èµ„æºå”¯ä¸€æ ‡å¿—ä½</span></span><br><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- é™æµå¤§å°</span></span><br><span class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–å½“å‰æµé‡å¤§å°</span></span><br><span class="line"><span class="keyword">local</span> currentLimit = <span class="built_in">tonumber</span>(redis.call(<span class="string">'get'</span>, key) <span class="keyword">or</span> <span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> currentLimit + <span class="number">1</span> &gt; limit <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è¾¾åˆ°é™æµå¤§å° è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- æ²¡æœ‰è¾¾åˆ°é˜ˆå€¼ value + 1</span></span><br><span class="line">    redis.call(<span class="string">"INCRBY"</span>, key, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">-- è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    redis.call(<span class="string">"EXPIRE"</span>, key, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> currentLimit + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="ä¸‰-æ»‘åŠ¨çª—å£æ³•"><a class="markdownIt-Anchor" href="#ä¸‰-æ»‘åŠ¨çª—å£æ³•"></a> ä¸‰ã€æ»‘åŠ¨çª—å£æ³•</h2>
<p>æ»‘åŠ¨çª—å£æ³•çš„<strong>åŸç†</strong>ï¼š</p>
<p>æ»‘åŠ¨çª—å£æ³•æ˜¯è®¡æ•°å™¨ç®—æ³•çš„ä¸€ç§æ”¹è¿›ï¼Œ<strong>å¢åŠ ä¸€ä¸ªæ—¶é—´ç²’åº¦çš„åº¦é‡å•ä½ï¼Œå°†åŸæ¥çš„ä¸€ä¸ªæ—¶é—´çª—å£åˆ’åˆ†æˆå¤šä¸ªæ—¶é—´çª—å£ï¼Œå¹¶ä¸”ä¸æ–­å‘å³æ»‘åŠ¨è¯¥çª—å£</strong>ã€‚æµé‡ç»è¿‡æ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•æ•´å½¢ä¹‹åï¼Œå¯ä»¥ä¿è¯ä»»æ„æ—¶é—´çª—å£å†…ï¼Œéƒ½ä¸ä¼šè¶…è¿‡æœ€å¤§å…è®¸çš„é™æµå€¼ï¼Œä»æµé‡æ›²çº¿ä¸Šæ¥çœ‹ä¼šæ›´åŠ å¹³æ»‘ï¼Œå¯ä»¥éƒ¨åˆ†è§£å†³ä¸Šé¢æåˆ°çš„ä¸´ç•Œçªå‘æµé‡é—®é¢˜ã€‚</p>
<p>å¯¹æ¯”å›ºå®šæ—¶é—´çª—å£é™æµç®—æ³•ï¼Œæ»‘åŠ¨æ—¶é—´çª—å£é™æµç®—æ³•çš„æ—¶é—´çª—å£æ˜¯æŒç»­æ»‘åŠ¨çš„ï¼Œå¹¶ä¸”é™¤äº†éœ€è¦ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•æ—¶é—´çª—å£å†…æ¥å£è¯·æ±‚æ¬¡æ•°ä¹‹å¤–ï¼Œè¿˜éœ€è¦è®°å½•åœ¨æ—¶é—´çª—å£å†…æ¯ä¸ªæ¥å£è¯·æ±‚åˆ°è¾¾çš„æ—¶é—´ç‚¹ï¼Œå¯¹å†…å­˜çš„å ç”¨ä¼šæ¯”è¾ƒå¤šã€‚ åœ¨ä¸´ç•Œä½ç½®çš„çªå‘è¯·æ±‚éƒ½ä¼šè¢«ç®—åˆ°æ—¶é—´çª—å£å†…ï¼Œå› æ­¤å¯ä»¥è§£å†³è®¡æ•°å™¨ç®—æ³•çš„ä¸´ç•Œé—®é¢˜ï¼Œ</p>
<p>æ¯”å¦‚åœ¨ä¸Šæ–‡çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡æ»‘åŠ¨çª—å£ç®—æ³•æ•´å‹åï¼Œç¬¬ä¸€ä¸ª 1s çš„æ—¶é—´çª—å£çš„ 100 æ¬¡è¯·æ±‚éƒ½ä¼šé€šè¿‡ï¼Œç¬¬äºŒä¸ªæ—¶é—´çª—å£æœ€å¼€å§‹çš„ 10ms å†…çš„ 100 ä¸ªè¯·æ±‚éƒ½ä¼šè¢«é™æµç†”æ–­ã€‚</p>
<p>æ»‘åŠ¨çª—å£æ³•çš„<strong>ç¼ºé™·</strong>ï¼šåŸºäºæ—¶é—´çª—å£çš„é™æµç®—æ³•ï¼Œ<strong>åªèƒ½åœ¨é€‰å®šçš„æ—¶é—´ç²’åº¦ä¸Šé™æµï¼Œå¯¹é€‰å®šæ—¶é—´ç²’åº¦å†…çš„æ›´åŠ ç»†ç²’åº¦çš„è®¿é—®é¢‘ç‡ä¸åšé™åˆ¶</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeWindow</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ConcurrentLinkedQueue&lt;Long&gt; queue = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Long&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é—´éš”ç§’æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> seconds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ€å¤§é™æµ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> max;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeWindow</span><span class="params">(<span class="keyword">int</span> max, <span class="keyword">int</span> seconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.seconds = seconds;</span><br><span class="line">        <span class="keyword">this</span>.max = max;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ°¸ç»­çº¿ç¨‹æ‰§è¡Œæ¸…ç†queue ä»»åŠ¡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ç­‰å¾… é—´éš”ç§’æ•°-1 æ‰§è¡Œæ¸…ç†æ“ä½œ</span></span><br><span class="line">                    Thread.sleep((seconds - <span class="number">1</span>) * <span class="number">1000L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                clean();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> TimeWindow timeWindow = <span class="keyword">new</span> TimeWindow(<span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æµ‹è¯•3ä¸ªçº¿ç¨‹</span></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">3</span>).forEach((i) -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">20</span>) * <span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    timeWindow.take();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;).start();</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ä»¤ç‰Œï¼Œå¹¶ä¸”æ·»åŠ æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">take</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> size = sizeOfValid();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; max) &#123;</span><br><span class="line">                System.err.println(<span class="string">"è¶…é™"</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sizeOfValid() &gt; max) &#123;</span><br><span class="line">                    System.err.println(<span class="string">"è¶…é™"</span>);</span><br><span class="line">                    System.err.println(<span class="string">"queueä¸­æœ‰ "</span> + queue.size() + <span class="string">" æœ€å¤§æ•°é‡ "</span> + max);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.queue.offer(System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"queueä¸­æœ‰ "</span> + queue.size() + <span class="string">" æœ€å¤§æ•°é‡ "</span> + max);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sizeOfValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;Long&gt; it = queue.iterator();</span><br><span class="line">        Long ms = System.currentTimeMillis() - seconds * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">long</span> t = it.next();</span><br><span class="line">            <span class="keyword">if</span> (t &gt; ms) &#123;</span><br><span class="line">                <span class="comment">// åœ¨å½“å‰çš„ç»Ÿè®¡æ—¶é—´èŒƒå›´å†…</span></span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸…ç†è¿‡æœŸçš„æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Long c = System.currentTimeMillis() - seconds * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        Long tl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((tl = queue.peek()) != <span class="keyword">null</span> &amp;&amp; tl &lt; c) &#123;</span><br><span class="line">            System.out.println(<span class="string">"æ¸…ç†æ•°æ®"</span>);</span><br><span class="line">            queue.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å››-ä»¤ç‰Œæ¡¶æ³•"><a class="markdownIt-Anchor" href="#å››-ä»¤ç‰Œæ¡¶æ³•"></a> å››ã€ä»¤ç‰Œæ¡¶æ³•</h2>
<p>ä»¤ç‰Œæ¡¶ç®—æ³•çš„<strong>åŸç†</strong>ï¼š</p>
<ol>
<li>æ¥å£é™åˆ¶ T ç§’å†…æœ€å¤§è®¿é—®æ¬¡æ•°ä¸º Nï¼Œåˆ™æ¯éš” T/N ç§’ä¼šæ”¾ä¸€ä¸ª token åˆ°æ¡¶ä¸­</li>
<li>æ¡¶å†…æœ€å¤šå­˜æ”¾ M ä¸ª tokenï¼Œå¦‚æœ token åˆ°è¾¾æ—¶ä»¤ç‰Œæ¡¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ª token å°±ä¼šè¢«ä¸¢å¼ƒ</li>
<li>æ¥å£è¯·æ±‚ä¼šå…ˆä»ä»¤ç‰Œæ¡¶ä¸­å– tokenï¼Œæ‹¿åˆ° token åˆ™å¤„ç†æ¥å£è¯·æ±‚ï¼Œæ‹¿ä¸åˆ° token åˆ™è¿›è¡Œé™æµå¤„ç†</li>
</ol>
<p>å› ä¸ºä»¤ç‰Œæ¡¶å­˜æ”¾äº†å¾ˆå¤šä»¤ç‰Œï¼Œé‚£ä¹ˆå¤§é‡çš„çªå‘è¯·æ±‚ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä¸ä¼šå‡ºç°ä¸´ç•Œé—®é¢˜ï¼Œåœ¨ä»¤ç‰Œç”¨å®Œä¹‹åï¼Œä»¤ç‰Œæ˜¯ä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿç‡æ·»åŠ åˆ°ä»¤ç‰Œæ¡¶ä¸­çš„ï¼Œå› æ­¤ä¸èƒ½å†æ¬¡å‘é€å¤§é‡çªå‘è¯·æ±‚ã€‚</p>
<p>è§„å®šå›ºå®šå®¹é‡çš„æ¡¶ï¼Œtoken ä»¥å›ºå®šé€Ÿåº¦å¾€æ¡¶å†…å¡«å……ï¼Œå½“æ¡¶æ»¡æ—¶ token ä¸ä¼šè¢«ç»§ç»­æ”¾å…¥ï¼Œæ¯è¿‡æ¥ä¸€ä¸ªè¯·æ±‚æŠŠ token ä»æ¡¶ä¸­ç§»é™¤,å¦‚æœæ¡¶ä¸­æ²¡æœ‰ token ä¸èƒ½è¯·æ±‚ã€‚</p>
<p>ã€ç¤ºä¾‹ã€‘Java å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenBucket</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double total;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token æ”¾å…¥é€Ÿåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double rate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double nowSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        nowSize = Math.min(total, nowSize + (now - time) * rate);</span><br><span class="line">        time = now;</span><br><span class="line">        <span class="keyword">if</span> (nowSize &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// æ¡¶é‡Œæ²¡æœ‰token</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å­˜åœ¨token</span></span><br><span class="line">            nowSize -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ã€ç¤ºä¾‹ã€‘åŸºäº Redis Lua ä»¤ç‰Œæ¡¶é™æµç®—æ³•å®ç°</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä»¤ç‰Œæ¡¶é™æµ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä»¤ç‰Œçš„å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> bucketKey = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> last_mill_request_key = KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- ä»¤ç‰Œæ¡¶çš„å®¹é‡</span></span><br><span class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="comment">-- è¯·æ±‚ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">local</span> permits = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="comment">-- ä»¤ç‰Œæµå…¥çš„é€Ÿç‡</span></span><br><span class="line"><span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"><span class="comment">-- å½“å‰æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> curr_mill_time = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ·»åŠ ä»¤ç‰Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–å½“å‰ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">local</span> current_limit = <span class="built_in">tonumber</span>(redis.call(<span class="string">'get'</span>, bucketKey) <span class="keyword">or</span> <span class="string">"0"</span>)</span><br><span class="line"><span class="comment">-- è·å–ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> last_mill_request_time = <span class="built_in">tonumber</span>(redis.call(<span class="string">'get'</span>, last_mill_request_key) <span class="keyword">or</span> <span class="string">"0"</span>)</span><br><span class="line"><span class="comment">-- è®¡ç®—å‘æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">if</span> last_mill_request_time == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">	<span class="comment">-- ä»¤ç‰Œæ¡¶åˆå§‹åŒ–</span></span><br><span class="line">	<span class="comment">-- æ›´æ–°ä¸Šæ¬¡è¯·æ±‚æ—¶é—´</span></span><br><span class="line">	redis.call(<span class="string">"HSET"</span>, last_mill_request_key, curr_mill_time)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">local</span> add_token_num = <span class="built_in">math</span>.<span class="built_in">floor</span>((curr_mill_time - last_mill_request_time) * rate)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ›´æ–°ä»¤ç‰Œçš„æ•°é‡</span></span><br><span class="line"><span class="keyword">if</span> current_limit + add_token_num &gt; limit <span class="keyword">then</span></span><br><span class="line">    current_limit = limit</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	current_limit = current_limit + add_token_num</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">	redis.<span class="built_in">pcall</span>(<span class="string">"HSET"</span>,bucketKey, current_limit)</span><br><span class="line"><span class="comment">-- è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">redis.call(<span class="string">"EXPIRE"</span>, bucketKey, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é™æµåˆ¤æ–­</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> current_limit - permits &lt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è¾¾åˆ°é™æµå¤§å°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- æ²¡æœ‰è¾¾åˆ°é™æµå¤§å°</span></span><br><span class="line">	current_limit = current_limit - permits</span><br><span class="line">	redis.<span class="built_in">pcall</span>(<span class="string">"HSET"</span>, bucketKey, current_limit)</span><br><span class="line">    <span class="comment">-- è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    redis.call(<span class="string">"EXPIRE"</span>, bucketKey, <span class="number">2</span>)</span><br><span class="line">	<span class="comment">-- æ›´æ–°ä¸Šæ¬¡è¯·æ±‚çš„æ—¶é—´</span></span><br><span class="line">	redis.call(<span class="string">"HSET"</span>, last_mill_request_key, curr_mill_time)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="äº”-æ¼æ¡¶æ³•"><a class="markdownIt-Anchor" href="#äº”-æ¼æ¡¶æ³•"></a> äº”ã€æ¼æ¡¶æ³•</h2>
<p>ç›¸æ¯”äºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¼æ¡¶æ³•å¯¹äºå–ä»¤ç‰Œçš„é¢‘ç‡ä¹Ÿæœ‰é™åˆ¶ï¼Œè¦æŒ‰ç…§ T/N çš„å›ºå®šé€Ÿç‡æ¥å–ä»¤ç‰Œ ã€‚</p>
<p>ä»¤ç‰Œæ¡¶ç®—æ³•å’Œæ¼æ¡¶ç®—æ³•å¯¹æµé‡çš„æ•´å½¢æ•ˆæœæ¯”è¾ƒå¥½ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ•´å‹æ•ˆæœå¥½å°±è¶Šåˆé€‚ï¼Œå¯¹äºæ²¡æœ‰æå‰é¢„çƒ­çš„ä»¤ç‰Œæ¡¶ï¼Œå¦‚æœåšå¦å†³å¼é™æµï¼Œä¼šå¯¼è‡´è¯¯æ€å¾ˆå¤šè¯·æ±‚ã€‚ä¸Šè¿°ç®—æ³•ä¸­å½“ n æ¯”è¾ƒå°æ—¶ï¼Œæ¯”å¦‚ 50ï¼Œé—´éš” 20ms æ‰ä¼šå‘æ¡¶ä¸­æ”¾å…¥ä¸€ä¸ªä»¤ç‰Œï¼Œè€Œæ¥å£çš„è®¿é—®åœ¨ 1s å†…å¯èƒ½éšæœºæ€§å¾ˆå¼ºï¼Œè¿™å°±ä¼šå‡ºç°ï¼šå°½ç®¡ä»æ›²çº¿ä¸Šçœ‹å¯¹æœ€å¤§è®¿é—®é¢‘ç‡çš„é™åˆ¶å¾ˆæœ‰æ•ˆï¼Œæµé‡åœ¨ç»†æ—¶é—´ç²’åº¦ä¸Šé¢éƒ½å¾ˆå¹³æ»‘ï¼Œä½†æ˜¯è¯¯æ€äº†å¾ˆå¤šæœ¬ä¸åº”è¯¥æ‹’ç»çš„æ¥å£è¯·æ±‚ã€‚</p>
<p>ã€ç¤ºä¾‹ã€‘æ¼æ¡¶æ³•å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeakBucket</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double total;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ°´æµå‡ºå»çš„é€Ÿåº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double rate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double nowSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        nowSize = Math.max(<span class="number">0</span>, (nowSize - (now - time) * rate));</span><br><span class="line">        time = now;</span><br><span class="line">        <span class="keyword">if</span> ((nowSize + <span class="number">1</span>) &lt; total) &#123;</span><br><span class="line">            nowSize++;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å…­-é™æµå·¥å…·"><a class="markdownIt-Anchor" href="#å…­-é™æµå·¥å…·"></a> å…­ã€é™æµå·¥å…·</h2>
<p>å‰é¢ä»‹ç»äº†é™æµç®—æ³•çš„åŸºæœ¬åŸç†å’Œä¸€äº›ç®€å•çš„å®ç°ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘ä»¬ä¸€èˆ¬åº”è¯¥ä½¿ç”¨æ›´æˆç†Ÿçš„é™æµå·¥å…·ã€‚</p>
<ul>
<li>Guava çš„ <code>RateLimiter</code>ï¼šRateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/forezp/article/details/100060686" target="_blank" rel="noopener">RateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•</a></li>
<li><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener">Hystrix</a>ï¼šç»å…¸çš„é™æµã€ç†”æ–­å·¥å…·ï¼Œå¾ˆå€¼å¾—å€Ÿé‰´å­¦ä¹ ã€‚æ³¨ï¼šå®˜æ–¹å·²åœæ­¢å‘å¸ƒç‰ˆæœ¬ã€‚</li>
<li><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener">Sentinel</a>ï¼šé˜¿é‡Œçš„é™æµã€ç†”æ–­å·¥å…·ã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://item.jd.com/11322972.html" target="_blank" rel="noopener">ã€Šå¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„ï¼šæ ¸å¿ƒåŸç†ä¸æ¡ˆä¾‹åˆ†æã€‹</a></li>
<li><a href="https://www.jianshu.com/p/76cc8ba5ca91" target="_blank" rel="noopener">è°ˆè°ˆé™æµç®—æ³•çš„å‡ ç§å®ç°</a></li>
<li><a href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/huifer-how-to-limit-current.md" target="_blank" rel="noopener">å¦‚ä½•é™æµï¼Ÿåœ¨å·¥ä½œä¸­æ˜¯æ€ä¹ˆåšçš„ï¼Ÿè¯´ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼Ÿ</a></li>
<li><a href="https://gongfukangee.github.io/2019/04/04/Limit/" target="_blank" rel="noopener">æµ…æé™æµç®—æ³•</a></li>
<li><a href="https://blog.csdn.net/forezp/article/details/100060686" target="_blank" rel="noopener">RateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/distributed-storage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/distributed-storage/" class="post-title-link" itemprop="url">åˆ†å¸ƒå¼å­˜å‚¨åŸºæœ¬åŸç†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-10-16 20:54:00" itemprop="dateCreated datePublished" datetime="2019-10-16T20:54:00+08:00">2019-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/distributed-storage/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/distributed-storage/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>6.6k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>6 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åˆ†å¸ƒå¼å­˜å‚¨åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼å­˜å‚¨åŸºæœ¬åŸç†"></a> åˆ†å¸ƒå¼å­˜å‚¨åŸºæœ¬åŸç†</h1>
<blockquote>
<p>åˆ†ç‰‡ï¼ˆShardingï¼‰çš„åŸºæœ¬æ€æƒ³å°±è¦æŠŠä¸€ä¸ªæ•°æ®åº“åˆ‡åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œå­˜å‚¨åœ¨ä¸åŒçš„æ•°æ®åº“(server)ä¸Šï¼Œä»è€Œç¼“è§£å•ä¸€æ•°æ®åº“çš„æ€§èƒ½é—®é¢˜ã€‚</p>
<p>åˆ†åº“åˆ†è¡¨ä¸€å®šæ˜¯ä¸ºäº†æ”¯æ’‘ <strong>é«˜å¹¶å‘ã€æ•°æ®é‡å¤§</strong> ä¸¤ä¸ªé—®é¢˜çš„ã€‚</p>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#%E4%B8%80%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">ä¸€ã€è¯»å†™åˆ†ç¦»</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BD%95%E8%A6%81%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">ä¸ºä½•è¦è¯»å†™åˆ†ç¦»</a></li>
<li><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E7%9A%84%E5%8E%9F%E7%90%86">è¯»å†™åˆ†ç¦»çš„åŸç†</a></li>
<li><a href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E7%9A%84%E9%97%AE%E9%A2%98">è¯»å†™åˆ†ç¦»çš„é—®é¢˜</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">äºŒã€åˆ†åº“åˆ†è¡¨</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BD%95%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">ä¸ºä½•è¦åˆ†åº“åˆ†è¡¨</a></li>
<li><a href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%8E%9F%E7%90%86">åˆ†åº“åˆ†è¡¨åŸç†</a></li>
<li><a href="#%E8%BF%81%E7%A7%BB%E5%92%8C%E6%89%A9%E5%AE%B9">è¿ç§»å’Œæ‰©å®¹</a></li>
<li><a href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E9%97%AE%E9%A2%98">åˆ†åº“åˆ†è¡¨çš„é—®é¢˜</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E4%B8%AD%E9%97%B4%E4%BB%B6">ä¸‰ã€ä¸­é—´ä»¶</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="ä¸€-è¯»å†™åˆ†ç¦»"><a class="markdownIt-Anchor" href="#ä¸€-è¯»å†™åˆ†ç¦»"></a> ä¸€ã€è¯»å†™åˆ†ç¦»</h2>
<p><strong>è¯»å†™åˆ†ç¦»çš„åŸºæœ¬åŸç†æ˜¯ï¼šä¸»æœåŠ¡å™¨ç”¨æ¥å¤„ç†å†™æ“ä½œä»¥åŠå®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„è¯»æ“ä½œï¼Œè€Œä»æœåŠ¡å™¨ç”¨æ¥å¤„ç†è¯»æ“ä½œ</strong>ã€‚</p>
<h3 id="ä¸ºä½•è¦è¯»å†™åˆ†ç¦»"><a class="markdownIt-Anchor" href="#ä¸ºä½•è¦è¯»å†™åˆ†ç¦»"></a> ä¸ºä½•è¦è¯»å†™åˆ†ç¦»</h3>
<ul>
<li><strong>æœ‰æ•ˆå‡å°‘é”ç«äº‰</strong> - ä¸»æœåŠ¡å™¨åªè´Ÿè´£å†™ï¼Œä»æœåŠ¡å™¨åªè´Ÿè´£è¯»ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„é¿å…ç”±æ•°æ®æ›´æ–°å¯¼è‡´çš„è¡Œé”ç«äº‰ï¼Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿçš„æŸ¥è¯¢æ€§èƒ½å¾—åˆ°æå¤§çš„æ”¹å–„ã€‚</li>
<li><strong>æé«˜æŸ¥è¯¢ååé‡</strong> - é€šè¿‡ä¸€ä¸»å¤šä»çš„é…ç½®æ–¹å¼ï¼Œå¯ä»¥å°†æŸ¥è¯¢è¯·æ±‚å‡åŒ€çš„åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®å‰¯æœ¬ï¼Œèƒ½å¤Ÿè¿›ä¸€æ­¥çš„æå‡ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ã€‚</li>
<li><strong>æå‡æ•°æ®åº“å¯ç”¨æ€§</strong> - ä½¿ç”¨å¤šä¸»å¤šä»çš„æ–¹å¼ï¼Œä¸ä½†èƒ½å¤Ÿæå‡ç³»ç»Ÿçš„ååé‡ï¼Œè¿˜èƒ½å¤Ÿæå‡æ•°æ®åº“çš„å¯ç”¨æ€§ï¼Œå¯ä»¥è¾¾åˆ°åœ¨ä»»ä½•ä¸€ä¸ªæ•°æ®åº“å®•æœºï¼Œç”šè‡³ç£ç›˜ç‰©ç†æŸåçš„æƒ…å†µä¸‹ä»ç„¶ä¸å½±å“ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œã€‚</li>
</ul>
<h3 id="è¯»å†™åˆ†ç¦»çš„åŸç†"><a class="markdownIt-Anchor" href="#è¯»å†™åˆ†ç¦»çš„åŸç†"></a> è¯»å†™åˆ†ç¦»çš„åŸç†</h3>
<p>è¯»å†™åˆ†ç¦»çš„å®ç°æ˜¯æ ¹æ® SQL è¯­ä¹‰åˆ†æï¼Œå°†è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«è·¯ç”±è‡³ä¸»åº“ä¸ä»åº“ã€‚</p>
<p><img src="https://shardingsphere.apache.org/document/current/img/read-write-split/read-write-split.png" alt="è¯»å†™åˆ†ç¦»" /></p>
<p>è¯»å†™åˆ†ç¦»çš„åŸºæœ¬å®ç°æ˜¯ï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/cs/database/mysql/master-slave-proxy.png" alt="img" /></p>
<ul>
<li>æ•°æ®åº“æœåŠ¡å™¨æ­å»ºä¸»ä»é›†ç¾¤ï¼Œä¸€ä¸»ä¸€ä»ã€ä¸€ä¸»å¤šä»éƒ½å¯ä»¥ã€‚</li>
<li>æ•°æ®åº“ä¸»æœºè´Ÿè´£è¯»å†™æ“ä½œï¼Œä»æœºåªè´Ÿè´£è¯»æ“ä½œã€‚</li>
<li>æ•°æ®åº“ä¸»æœºé€šè¿‡å¤åˆ¶å°†æ•°æ®åŒæ­¥åˆ°ä»æœºï¼Œæ¯å°æ•°æ®åº“æœåŠ¡å™¨éƒ½å­˜å‚¨äº†å…¨é‡æ•°æ®ã€‚</li>
<li>ä¸šåŠ¡æœåŠ¡å™¨å°†å†™æ“ä½œå‘ç»™æ•°æ®åº“ä¸»æœºï¼Œå°†è¯»æ“ä½œå‘ç»™æ•°æ®åº“ä»æœºã€‚</li>
<li>ä¸»æœºä¼šè®°å½•è¯·æ±‚çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œç„¶åæ¨é€ç»™ä»åº“ï¼Œä»åº“è§£æå¹¶æ‰§è¡Œæ—¥å¿—ä¸­çš„è¯·æ±‚ï¼Œå®Œæˆä¸»ä»å¤åˆ¶ã€‚è¿™æ„å‘³ç€ï¼šå¤åˆ¶è¿‡ç¨‹å­˜åœ¨æ—¶å»¶ï¼Œè¿™æ®µæ—¶é—´å†…ï¼Œä¸»ä»æ•°æ®å¯èƒ½ä¸ä¸€è‡´ã€‚</li>
</ul>
<h3 id="è¯»å†™åˆ†ç¦»çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#è¯»å†™åˆ†ç¦»çš„é—®é¢˜"></a> è¯»å†™åˆ†ç¦»çš„é—®é¢˜</h3>
<p>è¯»å†™åˆ†ç¦»å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š<strong>æ•°æ®ä¸€è‡´æ€§</strong>å’Œ<strong>åˆ†å‘æœºåˆ¶</strong>ã€‚</p>
<h4 id="æ•°æ®ä¸€è‡´æ€§"><a class="markdownIt-Anchor" href="#æ•°æ®ä¸€è‡´æ€§"></a> æ•°æ®ä¸€è‡´æ€§</h4>
<p>è¯»å†™åˆ†ç¦»äº§ç”Ÿäº†ä¸»åº“ä¸ä»åº“ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚</p>
<p><img src="https://shardingsphere.apache.org/document/current/img/read-write-split/sharding-read-write-split.png" alt="æ•°æ®åˆ†ç‰‡ + è¯»å†™åˆ†ç¦»" /></p>
<h4 id="åˆ†å‘æœºåˆ¶"><a class="markdownIt-Anchor" href="#åˆ†å‘æœºåˆ¶"></a> åˆ†å‘æœºåˆ¶</h4>
<p>æ•°æ®åº“è¯»å†™åˆ†ç¦»åï¼Œä¸€ä¸ª SQL è¯·æ±‚å…·ä½“åˆ†å‘åˆ°å“ªä¸ªæ•°æ®åº“èŠ‚ç‚¹ï¼Ÿä¸€èˆ¬æœ‰ä¸¤ç§åˆ†å‘æ–¹å¼ï¼šå®¢æˆ·ç«¯åˆ†å‘å’Œä¸­é—´ä»¶ä»£ç†åˆ†å‘ã€‚</p>
<p>å®¢æˆ·ç«¯åˆ†å‘ï¼Œæ˜¯åŸºäºç¨‹åºä»£ç ï¼Œè‡ªè¡Œæ§åˆ¶æ•°æ®åˆ†å‘åˆ°å“ªä¸ªæ•°æ®åº“èŠ‚ç‚¹ã€‚æ›´ç»†ä¸€ç‚¹æ¥è¯´ï¼Œä¸€èˆ¬ç¨‹åºä¸­å»ºç«‹å¤šä¸ªæ•°æ®åº“çš„è¿æ¥ï¼Œæ ¹æ®ä¸€å®šçš„ç®—æ³•ï¼Œé€‰æ‹©åˆé€‚çš„è¿æ¥å»å‘èµ· SQL è¯·æ±‚ã€‚è¿™ç§æ–¹å¼ä¹Ÿè¢«ç§°ä¸ºå®¢æˆ·ç«¯ä¸­é—´ä»¶ï¼Œä»£è¡¨æœ‰ï¼šjdbc-shardingã€‚</p>
<p>ä¸­é—´ä»¶ä»£ç†åˆ†å‘ï¼ŒæŒ‡çš„æ˜¯ç‹¬ç«‹ä¸€å¥—ç³»ç»Ÿå‡ºæ¥ï¼Œå®ç°è¯»å†™æ“ä½œåˆ†ç¦»å’Œæ•°æ®åº“æœåŠ¡å™¨è¿æ¥çš„ç®¡ç†ã€‚ä¸­é—´ä»¶å¯¹ä¸šåŠ¡æœåŠ¡å™¨æä¾› SQL å…¼å®¹çš„åè®®ï¼Œä¸šåŠ¡æœåŠ¡å™¨æ— é¡»è‡ªå·±è¿›è¡Œè¯»å†™åˆ†ç¦»ã€‚å¯¹äºä¸šåŠ¡æœåŠ¡å™¨æ¥è¯´ï¼Œè®¿é—®ä¸­é—´ä»¶å’Œè®¿é—®æ•°æ®åº“æ²¡æœ‰åŒºåˆ«ï¼Œäº‹å®ä¸Šåœ¨ä¸šåŠ¡æœåŠ¡å™¨çœ‹æ¥ï¼Œä¸­é—´ä»¶å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“æœåŠ¡å™¨ã€‚ä»£è¡¨æœ‰ï¼šMycatã€‚</p>
<h2 id="äºŒ-åˆ†åº“åˆ†è¡¨"><a class="markdownIt-Anchor" href="#äºŒ-åˆ†åº“åˆ†è¡¨"></a> äºŒã€åˆ†åº“åˆ†è¡¨</h2>
<h3 id="ä¸ºä½•è¦åˆ†åº“åˆ†è¡¨"><a class="markdownIt-Anchor" href="#ä¸ºä½•è¦åˆ†åº“åˆ†è¡¨"></a> ä¸ºä½•è¦åˆ†åº“åˆ†è¡¨</h3>
<p>åˆ†åº“åˆ†è¡¨ä¸»è¦åŸºäºä»¥ä¸‹ç†ç”±ï¼š</p>
<ul>
<li><strong>å¹¶å‘è¿æ¥</strong> - å•åº“è¶…è¿‡æ¯ç§’ 2000 ä¸ªå¹¶å‘æ—¶ï¼Œè€Œä¸€ä¸ªå¥åº·çš„å•åº“æœ€å¥½ä¿æŒåœ¨æ¯ç§’ 1000 ä¸ªå¹¶å‘å·¦å³ï¼Œä¸è¦å¤ªå¤§ã€‚</li>
<li><strong>ç£ç›˜å®¹é‡</strong> - ç£ç›˜å®¹é‡å æ»¡ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨ä¸å¯ç”¨ã€‚</li>
<li><strong>SQL æ€§èƒ½</strong> - å•è¡¨æ•°æ®é‡è¿‡å¤§ï¼Œä¼šå¯¼è‡´ SQL æ‰§è¡Œæ•ˆç‡ä½ä¸‹ã€‚ä¸€èˆ¬ï¼Œå•è¡¨æœ‰ 200 ä¸‡æ¡æ•°æ®ï¼Œå°±å¯ä»¥è€ƒè™‘åˆ†è¡¨äº†ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>#</th>
<th>åˆ†åº“åˆ†è¡¨å‰</th>
<th>åˆ†åº“åˆ†è¡¨å</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¹¶å‘æ”¯æ’‘æƒ…å†µ</td>
<td>MySQL å•æœºéƒ¨ç½²ï¼Œæ‰›ä¸ä½é«˜å¹¶å‘</td>
<td>MySQL ä»å•æœºåˆ°å¤šæœºï¼Œèƒ½æ‰¿å—çš„å¹¶å‘å¢åŠ äº†å¤šå€</td>
</tr>
<tr>
<td>ç£ç›˜ä½¿ç”¨æƒ…å†µ</td>
<td>MySQL å•æœºç£ç›˜å®¹é‡å‡ ä¹æ’‘æ»¡</td>
<td>æ‹†åˆ†ä¸ºå¤šä¸ªåº“ï¼Œæ•°æ®åº“æœåŠ¡å™¨ç£ç›˜ä½¿ç”¨ç‡å¤§å¤§é™ä½</td>
</tr>
<tr>
<td>SQL æ‰§è¡Œæ€§èƒ½</td>
<td>å•è¡¨æ•°æ®é‡å¤ªå¤§ï¼ŒSQL è¶Šè·‘è¶Šæ…¢</td>
<td>å•è¡¨æ•°æ®é‡å‡å°‘ï¼ŒSQL æ‰§è¡Œæ•ˆç‡æ˜æ˜¾æå‡</td>
</tr>
</tbody>
</table>
<h3 id="åˆ†åº“åˆ†è¡¨åŸç†"><a class="markdownIt-Anchor" href="#åˆ†åº“åˆ†è¡¨åŸç†"></a> åˆ†åº“åˆ†è¡¨åŸç†</h3>
<p><strong>æ•°æ®åˆ†ç‰‡æŒ‡æŒ‰ç…§æŸä¸ªç»´åº¦å°†å­˜æ”¾åœ¨å•ä¸€æ•°æ®åº“ä¸­çš„æ•°æ®åˆ†æ•£åœ°å­˜æ”¾è‡³å¤šä¸ªæ•°æ®åº“æˆ–è¡¨ä¸­ä»¥è¾¾åˆ°æå‡æ€§èƒ½ç“¶é¢ˆä»¥åŠå¯ç”¨æ€§çš„æ•ˆæœ</strong>ã€‚ æ•°æ®åˆ†ç‰‡çš„æœ‰æ•ˆæ‰‹æ®µæ˜¯å¯¹å…³ç³»å‹æ•°æ®åº“è¿›è¡Œåˆ†åº“å’Œåˆ†è¡¨ã€‚åˆ†åº“å’Œåˆ†è¡¨å‡å¯ä»¥æœ‰æ•ˆçš„é¿å…ç”±æ•°æ®é‡è¶…è¿‡å¯æ‰¿å—é˜ˆå€¼è€Œäº§ç”Ÿçš„æŸ¥è¯¢ç“¶é¢ˆã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œåˆ†åº“è¿˜èƒ½å¤Ÿç”¨äºæœ‰æ•ˆçš„åˆ†æ•£å¯¹æ•°æ®åº“å•ç‚¹çš„è®¿é—®é‡ï¼›åˆ†è¡¨è™½ç„¶æ— æ³•ç¼“è§£æ•°æ®åº“å‹åŠ›ï¼Œä½†å´èƒ½å¤Ÿæä¾›å°½é‡å°†åˆ†å¸ƒå¼äº‹åŠ¡è½¬åŒ–ä¸ºæœ¬åœ°äº‹åŠ¡çš„å¯èƒ½ï¼Œä¸€æ—¦æ¶‰åŠåˆ°è·¨åº“çš„æ›´æ–°æ“ä½œï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å¾€å¾€ä¼šä½¿é—®é¢˜å˜å¾—å¤æ‚ã€‚ ä½¿ç”¨å¤šä¸»å¤šä»çš„åˆ†ç‰‡æ–¹å¼ï¼Œå¯ä»¥æœ‰æ•ˆçš„é¿å…æ•°æ®å•ç‚¹ï¼Œä»è€Œæå‡æ•°æ®æ¶æ„çš„å¯ç”¨æ€§ã€‚</p>
<p>é€šè¿‡åˆ†åº“å’Œåˆ†è¡¨è¿›è¡Œæ•°æ®çš„æ‹†åˆ†æ¥ä½¿å¾—å„ä¸ªè¡¨çš„æ•°æ®é‡ä¿æŒåœ¨é˜ˆå€¼ä»¥ä¸‹ï¼Œä»¥åŠå¯¹æµé‡è¿›è¡Œç–å¯¼åº”å¯¹é«˜è®¿é—®é‡ï¼Œæ˜¯åº”å¯¹é«˜å¹¶å‘å’Œæµ·é‡æ•°æ®ç³»ç»Ÿçš„æœ‰æ•ˆæ‰‹æ®µã€‚ æ•°æ®åˆ†ç‰‡çš„æ‹†åˆ†æ–¹å¼åˆåˆ†ä¸ºå‚ç›´åˆ†ç‰‡å’Œæ°´å¹³åˆ†ç‰‡ã€‚</p>
<h4 id="å‚ç›´åˆ†ç‰‡"><a class="markdownIt-Anchor" href="#å‚ç›´åˆ†ç‰‡"></a> å‚ç›´åˆ†ç‰‡</h4>
<p>å‚ç›´åˆ†ç‰‡æœ‰ä¸¤ç§æ‹†åˆ†è€ƒé‡ï¼šä¸šåŠ¡æ‹†åˆ†å’Œè®¿é—®é¢‘ç‡æ‹†åˆ†</p>
<p>ï¼ˆ1ï¼‰ä¸šåŠ¡æ‹†åˆ†</p>
<blockquote>
<p>ä¸šåŠ¡æ‹†åˆ†çš„æ ¸å¿ƒç†å¿µæ˜¯<strong>ä¸“åº“ä¸“ç”¨</strong>ã€‚</p>
</blockquote>
<p>åœ¨æ‹†åˆ†ä¹‹å‰ï¼Œä¸€ä¸ªæ•°æ®åº“ç”±å¤šä¸ªæ•°æ®è¡¨æ„æˆï¼Œæ¯ä¸ªè¡¨å¯¹åº”ç€ä¸åŒçš„ä¸šåŠ¡ã€‚è€Œæ‹†åˆ†ä¹‹åï¼Œåˆ™æ˜¯<strong>æŒ‰ç…§ä¸šåŠ¡å°†è¡¨è¿›è¡Œå½’ç±»ï¼Œåˆ†å¸ƒåˆ°ä¸åŒçš„æ•°æ®åº“ä¸­</strong>ï¼Œä»è€Œå°†å‹åŠ›åˆ†æ•£è‡³ä¸åŒçš„æ•°æ®åº“ã€‚ä¸‹å›¾å±•ç¤ºäº†æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œå°†ç”¨æˆ·è¡¨å’Œè®¢å•è¡¨å‚ç›´åˆ†ç‰‡åˆ°ä¸åŒçš„æ•°æ®åº“çš„æ–¹æ¡ˆã€‚</p>
<p>å‚ç›´åˆ†ç‰‡å¾€å¾€éœ€è¦å¯¹æ¶æ„å’Œè®¾è®¡è¿›è¡Œè°ƒæ•´ã€‚é€šå¸¸æ¥è®²ï¼Œæ˜¯æ¥ä¸åŠåº”å¯¹äº’è”ç½‘ä¸šåŠ¡éœ€æ±‚å¿«é€Ÿå˜åŒ–çš„ï¼›è€Œä¸”ï¼Œå®ƒä¹Ÿå¹¶æ— æ³•çœŸæ­£çš„è§£å†³å•ç‚¹ç“¶é¢ˆã€‚<strong>å‚ç›´æ‹†åˆ†å¯ä»¥ç¼“è§£æ•°æ®é‡å’Œè®¿é—®é‡å¸¦æ¥çš„é—®é¢˜ï¼Œä½†æ— æ³•æ ¹æ²»ã€‚å¦‚æœå‚ç›´æ‹†åˆ†ä¹‹åï¼Œè¡¨ä¸­çš„æ•°æ®é‡ä¾ç„¶è¶…è¿‡å•èŠ‚ç‚¹æ‰€èƒ½æ‰¿è½½çš„é˜ˆå€¼ï¼Œåˆ™éœ€è¦æ°´å¹³åˆ†ç‰‡æ¥è¿›ä¸€æ­¥å¤„ç†</strong>ã€‚</p>
<p>ï¼ˆ2ï¼‰è®¿é—®é¢‘ç‡æ‹†åˆ†</p>
<blockquote>
<p>è®¿é—®é¢‘ç‡æ‹†åˆ†ï¼Œæ˜¯ <strong>æŠŠä¸€ä¸ªæœ‰å¾ˆå¤šå­—æ®µçš„è¡¨ç»™æ‹†åˆ†æˆå¤šä¸ªè¡¨ï¼Œæˆ–è€…æ˜¯å¤šä¸ªåº“ä¸Šå»</strong>ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¼š <strong>å°†è¾ƒå°‘çš„ã€è®¿é—®é¢‘ç‡è¾ƒé«˜çš„å­—æ®µæ”¾åˆ°ä¸€ä¸ªè¡¨ä¸­</strong>ï¼Œç„¶å <strong>å°†è¾ƒå¤šçš„ã€è®¿é—®é¢‘ç‡è¾ƒä½çš„å­—æ®µæ”¾åˆ°å¦å¤–ä¸€ä¸ªè¡¨ä¸­</strong>ã€‚å› ä¸ºæ•°æ®åº“æ˜¯æœ‰ç¼“å­˜çš„ï¼Œè®¿é—®é¢‘ç‡é«˜çš„è¡Œå­—æ®µè¶Šå°‘ï¼Œå°±å¯ä»¥åœ¨ç¼“å­˜é‡Œç¼“å­˜æ›´å¤šçš„è¡Œï¼Œæ€§èƒ½å°±è¶Šå¥½ã€‚è¿™ä¸ªä¸€èˆ¬åœ¨è¡¨å±‚é¢åšçš„è¾ƒå¤šä¸€äº›ã€‚</p>
</blockquote>
<p><img src="http://dunwu.test.upcdn.net/snap/image-20200114211639899.png" alt="image-20200114211639899" /></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæ»¡è¶³ä¸‹é¢çš„æ¡ä»¶å°±å¯ä»¥è€ƒè™‘æ‰©å®¹äº†ï¼š</p>
<ul>
<li>Mysql å•åº“è¶…è¿‡ 5000 ä¸‡æ¡è®°å½•ï¼ŒOracle å•åº“è¶…è¿‡ 1 äº¿æ¡è®°å½•ï¼ŒDB å‹åŠ›å°±å¾ˆå¤§ã€‚</li>
<li>å•åº“è¶…è¿‡æ¯ç§’ 2000 ä¸ªå¹¶å‘æ—¶ï¼Œè€Œä¸€ä¸ªå¥åº·çš„å•åº“æœ€å¥½ä¿æŒåœ¨æ¯ç§’ 1000 ä¸ªå¹¶å‘å·¦å³ï¼Œä¸è¦å¤ªå¤§ã€‚</li>
</ul>
<p>åœ¨æ•°æ®åº“çš„å±‚é¢ä½¿ç”¨å‚ç›´åˆ‡åˆ†å°†æŒ‰æ•°æ®åº“ä¸­è¡¨çš„å¯†é›†ç¨‹åº¦éƒ¨ç½²åˆ°ä¸åŒçš„åº“ä¸­ï¼Œä¾‹å¦‚å°†åŸæ¥çš„ç”µå•†æ•°æ®åº“å‚ç›´åˆ‡åˆ†æˆå•†å“æ•°æ®åº“ã€ç”¨æˆ·æ•°æ®åº“ç­‰ã€‚</p>
<h4 id="æ°´å¹³åˆ†ç‰‡"><a class="markdownIt-Anchor" href="#æ°´å¹³åˆ†ç‰‡"></a> æ°´å¹³åˆ†ç‰‡</h4>
<blockquote>
<p><strong>æ°´å¹³æ‹†åˆ†</strong> åˆç§°ä¸º <strong>Sharding</strong>ï¼Œå®ƒæ˜¯å°†åŒä¸€ä¸ªè¡¨ä¸­çš„è®°å½•æ‹†åˆ†åˆ°å¤šä¸ªç»“æ„ç›¸åŒçš„è¡¨ä¸­ã€‚å½“ <strong>å•è¡¨æ•°æ®é‡å¤ªå¤§</strong> æ—¶ï¼Œä¼šæå¤§å½±å“ <strong>SQL æ‰§è¡Œçš„æ€§èƒ½</strong> ã€‚åˆ†è¡¨æ˜¯å°†åŸæ¥ä¸€å¼ è¡¨çš„æ•°æ®åˆ†å¸ƒåˆ°æ•°æ®åº“é›†ç¾¤çš„ä¸åŒèŠ‚ç‚¹ä¸Šï¼Œä»è€Œç¼“è§£å•ç‚¹çš„å‹åŠ›ã€‚</p>
</blockquote>
<p>ç›¸å¯¹äºå‚ç›´åˆ†ç‰‡ï¼Œæ°´å¹³åˆ†ç‰‡ä¸å†å°†æ•°æ®æ ¹æ®ä¸šåŠ¡é€»è¾‘åˆ†ç±»ï¼Œè€Œæ˜¯é€šè¿‡æŸä¸ªå­—æ®µï¼ˆæˆ–æŸå‡ ä¸ªå­—æ®µï¼‰ï¼Œæ ¹æ®æŸç§è§„åˆ™å°†æ•°æ®åˆ†æ•£è‡³å¤šä¸ªåº“æˆ–è¡¨ä¸­ï¼Œæ¯ä¸ªåˆ†ç‰‡ä»…åŒ…å«æ•°æ®çš„ä¸€éƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼šæ ¹æ®ä¸»é”®åˆ†ç‰‡ï¼Œå¶æ•°ä¸»é”®çš„è®°å½•æ”¾å…¥ 0 åº“ï¼ˆæˆ–è¡¨ï¼‰ï¼Œå¥‡æ•°ä¸»é”®çš„è®°å½•æ”¾å…¥ 1 åº“ï¼ˆæˆ–è¡¨ï¼‰ã€‚</p>
<p>æ°´å¹³åˆ†ç‰‡ä»ç†è®ºä¸Šçªç ´äº†å•æœºæ•°æ®é‡å¤„ç†çš„ç“¶é¢ˆï¼Œå¹¶ä¸”æ‰©å±•ç›¸å¯¹è‡ªç”±ï¼Œæ˜¯åˆ†åº“åˆ†è¡¨çš„æ ‡å‡†è§£å†³æ–¹æ¡ˆã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/image-20200114211203589.png" alt="image-20200114211203589" /></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œ<strong>å•è¡¨æœ‰ 200 ä¸‡æ¡æ•°æ®</strong> çš„æ—¶å€™ï¼Œæ€§èƒ½å°±ä¼šç›¸å¯¹å·®ä¸€äº›äº†ï¼Œéœ€è¦è€ƒè™‘åˆ†è¡¨äº†ã€‚ä½†æ˜¯ï¼Œè¿™ä¹Ÿè¦è§†å…·ä½“æƒ…å†µè€Œå®šï¼Œå¯èƒ½æ˜¯ 100 ä¸‡æ¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ 500 ä¸‡æ¡ï¼ŒSQL è¶Šå¤æ‚ï¼Œå°±æœ€å¥½è®©å•è¡¨è¡Œæ•°è¶Šå°‘ã€‚</p>
<p>è¯»å†™åˆ†ç¦»çš„æ•°æ®èŠ‚ç‚¹ä¸­çš„æ•°æ®å†…å®¹æ˜¯ä¸€è‡´çš„ï¼Œè€Œæ°´å¹³åˆ†ç‰‡çš„æ¯ä¸ªæ•°æ®èŠ‚ç‚¹çš„æ•°æ®å†…å®¹å´å¹¶ä¸ç›¸åŒã€‚å°†æ°´å¹³åˆ†ç‰‡å’Œè¯»å†™åˆ†ç¦»è”åˆä½¿ç”¨ï¼Œèƒ½å¤Ÿæ›´åŠ æœ‰æ•ˆçš„æå‡ç³»ç»Ÿæ€§èƒ½ã€‚</p>
<h4 id="åˆ†åº“åˆ†è¡¨ç­–ç•¥"><a class="markdownIt-Anchor" href="#åˆ†åº“åˆ†è¡¨ç­–ç•¥"></a> åˆ†åº“åˆ†è¡¨ç­–ç•¥</h4>
<p><img src="http://dunwu.test.upcdn.net/snap/20200608091832.png" alt="img" /></p>
<p>åˆ†åº“åˆ†è¡¨ç­–ç•¥ä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>æ ¹æ®æ•°å€¼èŒƒå›´åˆ’åˆ†</li>
<li>æ ¹æ® Hash åˆ’åˆ†</li>
</ul>
<h5 id="æ•°å€¼èŒƒå›´è·¯ç”±"><a class="markdownIt-Anchor" href="#æ•°å€¼èŒƒå›´è·¯ç”±"></a> æ•°å€¼èŒƒå›´è·¯ç”±</h5>
<p>æ•°å€¼èŒƒå›´è·¯ç”±ï¼Œå°±æ˜¯æ ¹æ® IDã€æ—¶é—´èŒƒå›´ è¿™ç±»å…·æœ‰æ’åºæ€§çš„å­—æ®µæ¥è¿›è¡Œåˆ’åˆ†ã€‚ä¾‹å¦‚ï¼šç”¨æˆ· Id ä¸º 1-9999 çš„è®°å½•åˆ†åˆ°ç¬¬ä¸€ä¸ªåº“ï¼Œ10000-20000 çš„åˆ†åˆ°ç¬¬äºŒä¸ªåº“ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>æŒ‰è¿™ç§ç­–ç•¥åˆ’åˆ†å‡ºæ¥çš„æ•°æ®ï¼Œå…·æœ‰æ•°æ®è¿ç»­æ€§ã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ•°æ®è¿ç§»å¾ˆç®€å•ã€‚</p>
<p>ç¼ºç‚¹ï¼šå®¹æ˜“äº§ç”Ÿçƒ­ç‚¹é—®é¢˜ï¼Œå¤§é‡çš„æµé‡éƒ½æ‰“åœ¨æœ€æ–°çš„æ•°æ®ä¸Šäº†ã€‚</p>
<h5 id="hash-è·¯ç”±"><a class="markdownIt-Anchor" href="#hash-è·¯ç”±"></a> Hash è·¯ç”±</h5>
<p><img src="C:%5CUsers%5Czp%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200608092034118.png" alt="image-20200608092034118" /></p>
<p>å…¸å‹çš„ Hash è·¯ç”±ï¼Œå¦‚æ ¹æ®æ•°å€¼å–æ¨¡ï¼Œå½“éœ€è¦æ‰©å®¹æ—¶ï¼Œä¸€èˆ¬ä»¥ 2 çš„å¹‚æ¬¡æ–¹è¿›è¡Œæ‰©å®¹ï¼ˆè¿™æ ·ï¼Œæ‰©å®¹æ—¶è¿ç§»çš„æ•°æ®é‡ä¼šå°ä¸€äº›ï¼‰ã€‚ä¾‹å¦‚ï¼šç”¨æˆ· Id mod nï¼Œä½™æ•°ä¸º 0 çš„è®°å½•æ”¾åˆ°ç¬¬ä¸€ä¸ªåº“ï¼Œä½™æ•°ä¸º 1 çš„æ”¾åˆ°ç¬¬äºŒä¸ªåº“ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>ä¸€èˆ¬é‡‡ç”¨ <strong>é¢„åˆ†åŒº</strong> çš„æ–¹å¼ï¼Œæå‰æ ¹æ® <strong>æ•°æ®é‡</strong> è§„åˆ’å¥½ <strong>åˆ†åŒºæ•°</strong>ï¼Œæ¯”å¦‚åˆ’åˆ†ä¸º <code>512</code> æˆ– <code>1024</code> å¼ è¡¨ï¼Œä¿è¯å¯æ”¯æ’‘æœªæ¥ä¸€æ®µæ—¶é—´çš„ <strong>æ•°æ®å®¹é‡</strong>ï¼Œå†æ ¹æ® <strong>è´Ÿè½½æƒ…å†µ</strong> å°† <strong>è¡¨</strong> è¿ç§»åˆ°å…¶ä»– <strong>æ•°æ®åº“</strong> ä¸­ã€‚æ‰©å®¹æ—¶é€šå¸¸é‡‡ç”¨ <strong>ç¿»å€æ‰©å®¹</strong>ï¼Œé¿å… <strong>æ•°æ®æ˜ å°„</strong> å…¨éƒ¨è¢« <strong>æ‰“ä¹±</strong>ï¼Œå¯¼è‡´ <strong>å…¨é‡è¿ç§»</strong> çš„æƒ…å†µã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ•°æ®ç¦»æ•£åˆ†å¸ƒï¼Œä¸å­˜åœ¨çƒ­ç‚¹é—®é¢˜ã€‚</p>
<p>ç¼ºç‚¹ï¼šæ•°æ®è¿ç§»ã€æ‰©å®¹éº»çƒ¦ï¼ˆä¹‹å‰çš„æ•°æ®éœ€è¦é‡æ–°è®¡ç®— hash å€¼é‡æ–°åˆ†é…åˆ°ä¸åŒçš„åº“æˆ–è¡¨ï¼‰ã€‚å½“ <strong>èŠ‚ç‚¹æ•°é‡</strong> å˜åŒ–æ—¶ï¼Œå¦‚ <strong>æ‰©å®¹</strong> æˆ– <strong>æ”¶ç¼©</strong> èŠ‚ç‚¹ï¼Œæ•°æ®èŠ‚ç‚¹ <strong>æ˜ å°„å…³ç³»</strong> éœ€è¦é‡æ–°è®¡ç®—ï¼Œä¼šå¯¼è‡´æ•°æ®çš„ <strong>é‡æ–°è¿ç§»</strong>ã€‚</p>
<h5 id="è·¯ç”±è¡¨"><a class="markdownIt-Anchor" href="#è·¯ç”±è¡¨"></a> è·¯ç”±è¡¨</h5>
<p>è¿™ç§ç­–ç•¥ï¼Œå°±æ˜¯ç”¨ä¸€å¼ ç‹¬ç«‹çš„è¡¨è®°å½•è·¯ç”±ä¿¡æ¯ã€‚</p>
<p>ä¼˜ç‚¹ï¼šç®€å•ã€çµæ´»ï¼Œå°¤å…¶æ˜¯åœ¨æ‰©å®¹ã€è¿ç§»æ—¶ï¼Œåªéœ€è¦è¿ç§»æŒ‡å®šçš„æ•°æ®ï¼Œç„¶åä¿®æ”¹è·¯ç”±è¡¨å³å¯ã€‚</p>
<p>ç¼ºç‚¹ï¼šæ¯æ¬¡æŸ¥è¯¢ï¼Œå¿…é¡»å…ˆæŸ¥è·¯ç”±è¡¨ï¼Œå¢åŠ äº† IO å¼€é”€ã€‚å¹¶ä¸”ï¼Œå¦‚æœè·¯ç”±è¡¨æœ¬èº«å¤ªå¤§ï¼Œä¹Ÿä¼šé¢ä¸´æ€§èƒ½ç“¶é¢ˆï¼Œå¦‚æœæƒ³å¯¹è·¯ç”±è¡¨å†åšåˆ†åº“åˆ†è¡¨ï¼Œå°†å‡ºç°æ­»å¾ªç¯å¼çš„è·¯ç”±ç®—æ³•é€‰æ‹©é—®é¢˜ã€‚</p>
<h3 id="è¿ç§»å’Œæ‰©å®¹"><a class="markdownIt-Anchor" href="#è¿ç§»å’Œæ‰©å®¹"></a> è¿ç§»å’Œæ‰©å®¹</h3>
<h4 id="åœæœºè¿ç§»æ‰©å®¹ä¸æ¨è"><a class="markdownIt-Anchor" href="#åœæœºè¿ç§»æ‰©å®¹ä¸æ¨è"></a> åœæœºè¿ç§»/æ‰©å®¹ï¼ˆä¸æ¨èï¼‰</h4>
<p>åœæœºè¿ç§»/æ‰©å®¹æ˜¯æœ€æš´åŠ›ã€æœ€ç®€å•çš„è¿ç§»ã€æ‰©å®¹æ–¹æ¡ˆã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200601114836.png" alt="img" /></p>
<h5 id="åœæœºè¿ç§»æ‰©å®¹æµç¨‹"><a class="markdownIt-Anchor" href="#åœæœºè¿ç§»æ‰©å®¹æµç¨‹"></a> åœæœºè¿ç§»/æ‰©å®¹æµç¨‹</h5>
<p>ï¼ˆ0ï¼‰é¢„ä¼°åœæœæ—¶é—´ï¼Œå‘å¸ƒåœæœå…¬å‘Šã€‚</p>
<p>ï¼ˆ1ï¼‰åœæœï¼Œä¸å…è®¸æ•°æ®è®¿é—®ã€‚</p>
<p>ï¼ˆ2ï¼‰ç¼–å†™ä¸´æ—¶çš„æ•°æ®å¯¼å…¥ç¨‹åºï¼Œä»è€æ•°æ®åº“ä¸­è¯»å–æ•°æ®ã€‚</p>
<p>ï¼ˆ3ï¼‰å°†æ•°æ®å†™å…¥ä¸­é—´ä»¶ã€‚</p>
<p>ï¼ˆ4ï¼‰ä¸­é—´ä»¶æ ¹æ®åˆ†ç‰‡è§„åˆ™ï¼Œå°†æ•°æ®åˆ†å‘åˆ°åˆ†åº“ï¼ˆåˆ†è¡¨ï¼‰ä¸­ã€‚</p>
<p>ï¼ˆ5ï¼‰åº”ç”¨ç¨‹åºä¿®æ”¹é…ç½®ï¼Œé‡å¯ã€‚</p>
<h5 id="åœæœºè¿ç§»æ‰©å®¹æ–¹æ¡ˆåˆ†æ"><a class="markdownIt-Anchor" href="#åœæœºè¿ç§»æ‰©å®¹æ–¹æ¡ˆåˆ†æ"></a> åœæœºè¿ç§»/æ‰©å®¹æ–¹æ¡ˆåˆ†æ</h5>
<p>ä¼˜ç‚¹ï¼šç®€å•ã€æ²¡æœ‰æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
<p>ç¼ºç‚¹ï¼šå¦‚æœè€çš„æ•°æ®åº“æ•°æ®é‡å¾ˆå¤§ï¼Œåˆ™åœæœºå¤„ç†æ—¶é—´å¯èƒ½å¾ˆä¹…ã€‚æ¯”å¦‚è€çš„æ•°æ®åº“æ˜¯å·²ç»åˆ†åº“åˆ†è¡¨çš„æ•°æ®åº“ç¾¤ï¼Œæ•°æ®é‡å¯èƒ½è¾¾åˆ°äº¿çº§ï¼Œå¯¼å…¥æ•°æ®å¯èƒ½å°±è¦èŠ±è´¹å‡ å°æ—¶ã€‚å¦‚æœä¸­é—´è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œå°±å®¹æ˜“å¼•å‘é‡å¤§äº‹æ•…ã€‚</p>
<p>ç‚¹è¯„ï¼šç»¼ä¸Šï¼Œè¿™ç§æ–¹æ¡ˆä»£ä»·å¤ªé«˜ï¼Œä¸å¯å–ã€‚</p>
<h4 id="åŒå†™è¿ç§»"><a class="markdownIt-Anchor" href="#åŒå†™è¿ç§»"></a> åŒå†™è¿ç§»</h4>
<p><img src="http://dunwu.test.upcdn.net/snap/20200601135751.png" alt="img" /></p>
<h5 id="åŒå†™è¿ç§»æµç¨‹"><a class="markdownIt-Anchor" href="#åŒå†™è¿ç§»æµç¨‹"></a> åŒå†™è¿ç§»æµç¨‹</h5>
<p>ï¼ˆ1ï¼‰ä¿®æ”¹åº”ç”¨ç¨‹åºé…ç½®ï¼Œå°†æ•°æ®åŒæ—¶å†™å…¥è€æ•°æ®åº“å’Œä¸­é—´ä»¶ã€‚è¿™å°±æ˜¯æ‰€è°“çš„<strong>åŒå†™</strong>ï¼ŒåŒæ—¶å†™ä¿©åº“ï¼Œè€åº“å’Œæ–°åº“ã€‚</p>
<p>ï¼ˆ2ï¼‰ç¼–å†™ä¸´æ—¶ç¨‹åºï¼Œè¯»å–è€æ•°æ®åº“ã€‚</p>
<p>ï¼ˆ3ï¼‰å°†æ•°æ®å†™å…¥ä¸­é—´ä»¶ã€‚å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œç›´æ¥å†™å…¥ï¼›å¦‚æœæ•°æ®å­˜åœ¨ï¼Œæ¯”è¾ƒæ—¶é—´æˆ³ï¼Œåªå…è®¸æ–°æ•°æ®è¦†ç›–è€æ•°æ®ã€‚</p>
<p>ï¼ˆ4ï¼‰å¯¼å…¥æ•°æ®åï¼Œæœ‰å¯èƒ½æ•°æ®è¿˜æ˜¯å­˜åœ¨ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å¯¹æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œæ¯”å¯¹æ–°è€åº“çš„æ¯æ¡æ•°æ®ã€‚å¦‚æœå­˜åœ¨å·®å¼‚ï¼Œé’ˆå¯¹å·®å¼‚æ•°æ®ï¼Œæ‰§è¡Œï¼ˆ3ï¼‰ã€‚å¾ªç¯ï¼ˆ3ï¼‰ã€ï¼ˆ4ï¼‰æ­¥éª¤ï¼Œç›´è‡³æ•°æ®å®Œå…¨ä¸€è‡´ã€‚</p>
<p>ï¼ˆ5ï¼‰ä¿®æ”¹åº”ç”¨ç¨‹åºé…ç½®ï¼Œå°†æ•°æ®åªå†™å…¥ä¸­é—´ä»¶ã€‚</p>
<p>ï¼ˆ6ï¼‰ä¸­é—´ä»¶æ ¹æ®åˆ†ç‰‡è§„åˆ™ï¼Œå°†æ•°æ®åˆ†å‘åˆ°åˆ†åº“ï¼ˆåˆ†è¡¨ï¼‰ä¸­ã€‚</p>
<h4 id="ä¸»ä»å‡çº§"><a class="markdownIt-Anchor" href="#ä¸»ä»å‡çº§"></a> ä¸»ä»å‡çº§</h4>
<p>ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“ï¼Œä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨ä¸»å¤‡æ¶æ„ã€‚ä¸»åº“æ”¯æŒè¯»å†™æ“ä½œï¼Œä»åº“æ”¯æŒè¯»æ“ä½œã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200601121215.png" alt="img" /></p>
<p>ç”±äºä¸»å¤‡èŠ‚ç‚¹æ•°æ®ä¸€è‡´ï¼Œæ‰€ä»¥å°†ä»åº“å‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¿®æ”¹åˆ†ç‰‡é…ç½®ï¼Œå°†ä»èŠ‚ç‚¹ä½œä¸ºåˆ†åº“ä¹‹ä¸€ï¼Œå°±å®ç°äº†æ‰©å®¹ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200601121400.png" alt="img" /></p>
<h5 id="å‡çº§ä»åº“çš„æµç¨‹"><a class="markdownIt-Anchor" href="#å‡çº§ä»åº“çš„æµç¨‹"></a> å‡çº§ä»åº“çš„æµç¨‹</h5>
<p>ï¼ˆ1ï¼‰è§£é™¤ä¸»ä»å…³ç³»ï¼Œä»åº“å‡çº§ä¸ºä¸»åº“ã€‚</p>
<p>ï¼ˆ2ï¼‰åº”ç”¨ç¨‹åºï¼Œä¿®æ”¹é…ç½®ï¼Œè¯»å†™é€šè¿‡ä¸­é—´ä»¶ã€‚</p>
<p>ï¼ˆ3ï¼‰åˆ†åº“åˆ†è¡¨ä¸­é—´ï¼Œä¿®æ”¹åˆ†ç‰‡é…ç½®ã€‚å°†æ•°æ®æŒ‰ç…§æ–°çš„è§„åˆ™åˆ†å‘ã€‚</p>
<p>ï¼ˆ4ï¼‰ç¼–å†™ä¸´æ—¶ç¨‹åºï¼Œæ¸…ç†å†—ä½™æ•°æ®ã€‚æ¯”å¦‚ï¼šåŸæ¥æ˜¯ä¸€ä¸ªå•åº“ï¼Œæ•°æ®é‡ä¸º 400 ä¸‡ã€‚ä»èŠ‚ç‚¹å‡çº§ä¸ºåˆ†åº“ä¹‹ä¸€åï¼Œæ¯ä¸ªåˆ†åº“éƒ½æœ‰ 400 ä¸‡æ•°æ®ï¼Œå…¶ä¸­ 200 ä¸‡æ˜¯å†—ä½™æ•°æ®ã€‚æ¸…ç†å®Œåï¼Œè¿›è¡Œæ•°æ®æ ¡éªŒã€‚</p>
<p>ï¼ˆ5ï¼‰ä¸ºæ¯ä¸ªåˆ†åº“æ·»åŠ æ–°çš„ä»åº“ï¼Œä¿è¯é«˜å¯ç”¨ã€‚</p>
<h5 id="å‡çº§ä»åº“æ–¹æ¡ˆåˆ†æ"><a class="markdownIt-Anchor" href="#å‡çº§ä»åº“æ–¹æ¡ˆåˆ†æ"></a> å‡çº§ä»åº“æ–¹æ¡ˆåˆ†æ</h5>
<p>ä¼˜ç‚¹ï¼šä¸éœ€è¦åœæœºï¼Œæ— éœ€æ•°æ®è¿ç§»ã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<h3 id="åˆ†åº“åˆ†è¡¨çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#åˆ†åº“åˆ†è¡¨çš„é—®é¢˜"></a> åˆ†åº“åˆ†è¡¨çš„é—®é¢˜</h3>
<h4 id="åˆ†å¸ƒå¼-id-é—®é¢˜"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼-id-é—®é¢˜"></a> åˆ†å¸ƒå¼ ID é—®é¢˜</h4>
<p>ä¸€æ—¦æ•°æ®åº“è¢«åˆ‡åˆ†åˆ°å¤šä¸ªç‰©ç†ç»“ç‚¹ä¸Šï¼Œæˆ‘ä»¬å°†ä¸èƒ½å†ä¾èµ–æ•°æ®åº“è‡ªèº«çš„ä¸»é”®ç”Ÿæˆæœºåˆ¶ã€‚ä¸€æ–¹é¢ï¼ŒæŸä¸ªåˆ†åŒºæ•°æ®åº“è‡ªç”Ÿæˆçš„ ID æ— æ³•ä¿è¯åœ¨å…¨å±€ä¸Šæ˜¯å”¯ä¸€çš„ï¼›å¦ä¸€æ–¹é¢ï¼Œåº”ç”¨ç¨‹åºåœ¨æ’å…¥æ•°æ®ä¹‹å‰éœ€è¦å…ˆè·å¾— IDï¼Œä»¥ä¾¿è¿›è¡Œ SQL è·¯ç”±ã€‚</p>
<blockquote>
<p>åˆ†å¸ƒå¼ ID çš„è§£å†³æ–¹æ¡ˆè¯¦è§ï¼š<a href="https://github.com/dunwu/blog/blob/master/source/_posts/theory/distributed-id.md" target="_blank" rel="noopener">åˆ†å¸ƒå¼ ID</a></p>
</blockquote>
<h4 id="åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜"></a> åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜</h4>
<p>è·¨åº“äº‹åŠ¡ä¹Ÿæ˜¯åˆ†å¸ƒå¼çš„æ•°æ®åº“é›†ç¾¤è¦é¢å¯¹çš„æ£˜æ‰‹äº‹æƒ…ã€‚ åˆç†é‡‡ç”¨åˆ†è¡¨ï¼Œå¯ä»¥åœ¨é™ä½å•è¡¨æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä½¿ç”¨æœ¬åœ°äº‹åŠ¡ï¼Œå–„äºä½¿ç”¨åŒåº“ä¸åŒè¡¨å¯æœ‰æ•ˆé¿å…åˆ†å¸ƒå¼äº‹åŠ¡å¸¦æ¥çš„éº»çƒ¦ã€‚åœ¨ä¸èƒ½é¿å…è·¨åº“äº‹åŠ¡çš„åœºæ™¯ï¼Œæœ‰äº›ä¸šåŠ¡ä»ç„¶éœ€è¦ä¿æŒäº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚ è€ŒåŸºäº XA çš„åˆ†å¸ƒå¼äº‹åŠ¡ç”±äºåœ¨å¹¶å‘åº¦é«˜çš„åœºæ™¯ä¸­æ€§èƒ½æ— æ³•æ»¡è¶³éœ€è¦ï¼Œå¹¶æœªè¢«äº’è”ç½‘å·¨å¤´å¤§è§„æ¨¡ä½¿ç”¨ï¼Œä»–ä»¬å¤§å¤šé‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§çš„æŸ”æ€§äº‹åŠ¡ä»£æ›¿å¼ºä¸€è‡´äº‹åŠ¡ã€‚</p>
<blockquote>
<p>åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆè¯¦è§ï¼š<a href="https://github.com/dunwu/blog/blob/master/source/_posts/theory/distributed-transaction.md" target="_blank" rel="noopener">åˆ†å¸ƒå¼äº‹åŠ¡</a></p>
</blockquote>
<h4 id="è·¨èŠ‚ç‚¹-join-å’Œèšåˆ"><a class="markdownIt-Anchor" href="#è·¨èŠ‚ç‚¹-join-å’Œèšåˆ"></a> è·¨èŠ‚ç‚¹ Join å’Œèšåˆ</h4>
<p>åˆ†åº“åˆ†è¡¨åï¼Œæ— æ³•ç›´æ¥è·¨èŠ‚ç‚¹ <code>join</code> ã€<code>count</code>ã€<code>order by</code>ã€<code>group by</code> ä»¥åŠèšåˆã€‚</p>
<p>é’ˆå¯¹è¿™ç±»é—®é¢˜ï¼Œæ™®éåšæ³•æ˜¯<strong>äºŒæ¬¡æŸ¥è¯¢</strong>ã€‚</p>
<p>åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ï¼Œè·å–å„ä¸ªèŠ‚ç‚¹ä¸Šçš„ç»“æœã€‚</p>
<p>åœ¨ç¨‹åºä¸­å°†è¿™äº›ç»“æœè¿›è¡Œåˆå¹¶ã€ç­›é€‰ã€‚</p>
<h4 id="è·¨åˆ†ç‰‡çš„æ’åºåˆ†é¡µ"><a class="markdownIt-Anchor" href="#è·¨åˆ†ç‰‡çš„æ’åºåˆ†é¡µ"></a> è·¨åˆ†ç‰‡çš„æ’åºåˆ†é¡µ</h4>
<p>ä¸€èˆ¬æ¥è®²ï¼Œåˆ†é¡µæ—¶éœ€è¦æŒ‰ç…§æŒ‡å®šå­—æ®µè¿›è¡Œæ’åºã€‚å½“æ’åºå­—æ®µå°±æ˜¯åˆ†ç‰‡å­—æ®µçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡åˆ†ç‰‡è§„åˆ™å¯ä»¥æ¯”è¾ƒå®¹æ˜“å®šä½åˆ°æŒ‡å®šçš„åˆ†ç‰‡ï¼Œè€Œå½“æ’åºå­—æ®µéåˆ†ç‰‡å­—æ®µçš„æ—¶å€™ï¼Œæƒ…å†µå°±ä¼šå˜å¾—æ¯”è¾ƒå¤æ‚äº†ã€‚ä¸ºäº†æœ€ç»ˆç»“æœçš„å‡†ç¡®æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸åŒçš„åˆ†ç‰‡èŠ‚ç‚¹ä¸­å°†æ•°æ®è¿›è¡Œæ’åºå¹¶è¿”å›ï¼Œå¹¶å°†ä¸åŒåˆ†ç‰‡è¿”å›çš„ç»“æœé›†è¿›è¡Œæ±‡æ€»å’Œå†æ¬¡æ’åºï¼Œæœ€åå†è¿”å›ç»™ç”¨æˆ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3710706-925381b9a478c8df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640/format/webp" alt="img" /></p>
<p>ä¸Šé¢å›¾ä¸­æ‰€æè¿°çš„åªæ˜¯æœ€ç®€å•çš„ä¸€ç§æƒ…å†µï¼ˆå–ç¬¬ä¸€é¡µæ•°æ®ï¼‰ï¼Œçœ‹èµ·æ¥å¯¹æ€§èƒ½çš„å½±å“å¹¶ä¸å¤§ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³å–å‡ºç¬¬ 10 é¡µæ•°æ®ï¼Œæƒ…å†µåˆå°†å˜å¾—å¤æ‚å¾ˆå¤šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3710706-9a7cfbdb95bb9b70.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640/format/webp" alt="img" /></p>
<p>æœ‰äº›è¯»è€…å¯èƒ½å¹¶ä¸å¤ªç†è§£ï¼Œä¸ºä»€ä¹ˆä¸èƒ½åƒè·å–ç¬¬ä¸€é¡µæ•°æ®é‚£æ ·ç®€å•å¤„ç†ï¼ˆæ’åºå–å‡ºå‰ 10 æ¡å†åˆå¹¶ã€æ’åºï¼‰ã€‚å…¶å®å¹¶ä¸éš¾ç†è§£ï¼Œå› ä¸ºå„åˆ†ç‰‡èŠ‚ç‚¹ä¸­çš„æ•°æ®å¯èƒ½æ˜¯éšæœºçš„ï¼Œä¸ºäº†æ’åºçš„å‡†ç¡®æ€§ï¼Œå¿…é¡»æŠŠæ‰€æœ‰åˆ†ç‰‡èŠ‚ç‚¹çš„å‰ N é¡µæ•°æ®éƒ½æ’åºå¥½ååšåˆå¹¶ï¼Œæœ€åå†è¿›è¡Œæ•´ä½“çš„æ’åºã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™æ ·çš„æ“ä½œæ˜¯æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„ï¼Œç”¨æˆ·è¶Šå¾€åç¿»é¡µï¼Œç³»ç»Ÿæ€§èƒ½å°†ä¼šè¶Šå·®ã€‚</p>
<p>é‚£å¦‚ä½•è§£å†³åˆ†åº“æƒ…å†µä¸‹çš„åˆ†é¡µé—®é¢˜å‘¢ï¼Ÿæœ‰ä»¥ä¸‹å‡ ç§åŠæ³•ï¼š</p>
<p>å¦‚æœæ˜¯åœ¨å‰å°åº”ç”¨æä¾›åˆ†é¡µï¼Œåˆ™é™å®šç”¨æˆ·åªèƒ½çœ‹å‰é¢ n é¡µï¼Œè¿™ä¸ªé™åˆ¶åœ¨ä¸šåŠ¡ä¸Šä¹Ÿæ˜¯åˆç†çš„ï¼Œä¸€èˆ¬çœ‹åé¢çš„åˆ†é¡µæ„ä¹‰ä¸å¤§ï¼ˆå¦‚æœä¸€å®šè¦çœ‹ï¼Œå¯ä»¥è¦æ±‚ç”¨æˆ·ç¼©å°èŒƒå›´é‡æ–°æŸ¥è¯¢ï¼‰ã€‚</p>
<p>å¦‚æœæ˜¯åå°æ‰¹å¤„ç†ä»»åŠ¡è¦æ±‚åˆ†æ‰¹è·å–æ•°æ®ï¼Œåˆ™å¯ä»¥åŠ å¤§ page sizeï¼Œæ¯”å¦‚æ¯æ¬¡è·å– 5000 æ¡è®°å½•ï¼Œæœ‰æ•ˆå‡å°‘åˆ†é¡µæ•°ï¼ˆå½“ç„¶ç¦»çº¿è®¿é—®ä¸€èˆ¬èµ°å¤‡åº“ï¼Œé¿å…å†²å‡»ä¸»åº“ï¼‰ã€‚</p>
<p>åˆ†åº“è®¾è®¡æ—¶ï¼Œä¸€èˆ¬è¿˜æœ‰é…å¥—å¤§æ•°æ®å¹³å°æ±‡æ€»æ‰€æœ‰åˆ†åº“çš„è®°å½•ï¼Œæœ‰äº›åˆ†é¡µæŸ¥è¯¢å¯ä»¥è€ƒè™‘èµ°å¤§æ•°æ®å¹³å°ã€‚</p>
<h2 id="ä¸‰-ä¸­é—´ä»¶"><a class="markdownIt-Anchor" href="#ä¸‰-ä¸­é—´ä»¶"></a> ä¸‰ã€ä¸­é—´ä»¶</h2>
<p>å›½å†…å¸¸è§åˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶ï¼š</p>
<ul>
<li><a href="https://github.com/alibaba/cobar" target="_blank" rel="noopener">Cobar</a> - é˜¿é‡Œ b2b å›¢é˜Ÿå¼€å‘å’Œå¼€æºçš„ï¼Œå±äº proxy å±‚æ–¹æ¡ˆï¼Œå°±æ˜¯ä»‹äºåº”ç”¨æœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨ä¹‹é—´ã€‚åº”ç”¨ç¨‹åºé€šè¿‡ JDBC é©±åŠ¨è®¿é—® cobar é›†ç¾¤ï¼Œcobar æ ¹æ® SQL å’Œåˆ†åº“è§„åˆ™å¯¹ SQL åšåˆ†è§£ï¼Œç„¶ååˆ†å‘åˆ° MySQL é›†ç¾¤ä¸åŒçš„æ•°æ®åº“å®ä¾‹ä¸Šæ‰§è¡Œã€‚æ—©äº›å¹´è¿˜å¯ä»¥ç”¨ï¼Œä½†æ˜¯æœ€è¿‘å‡ å¹´éƒ½æ²¡æ›´æ–°äº†ï¼ŒåŸºæœ¬æ²¡å•¥äººç”¨ï¼Œå·®ä¸å¤šç®—æ˜¯è¢«æŠ›å¼ƒçš„çŠ¶æ€å§ã€‚è€Œä¸”ä¸æ”¯æŒè¯»å†™åˆ†ç¦»ã€å­˜å‚¨è¿‡ç¨‹ã€è·¨åº“ join å’Œåˆ†é¡µç­‰æ“ä½œã€‚</li>
<li><a href="https://github.com/alibaba/tb_tddl" target="_blank" rel="noopener">TDDL</a> - æ·˜å®å›¢é˜Ÿå¼€å‘çš„ï¼Œå±äº client å±‚æ–¹æ¡ˆã€‚æ”¯æŒåŸºæœ¬çš„ crud è¯­æ³•å’Œè¯»å†™åˆ†ç¦»ï¼Œä½†ä¸æ”¯æŒ joinã€å¤šè¡¨æŸ¥è¯¢ç­‰è¯­æ³•ã€‚ç›®å‰ä½¿ç”¨çš„ä¹Ÿä¸å¤šï¼Œå› ä¸ºè¿˜ä¾èµ–æ·˜å®çš„ diamond é…ç½®ç®¡ç†ç³»ç»Ÿã€‚</li>
<li><a href="https://github.com/Qihoo360/Atlas" target="_blank" rel="noopener">Atlas</a> - 360 å¼€æºçš„ï¼Œå±äº proxy å±‚æ–¹æ¡ˆï¼Œä»¥å‰æ˜¯æœ‰ä¸€äº›å…¬å¸åœ¨ç”¨çš„ï¼Œä½†æ˜¯ç¡®å®æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯ç¤¾åŒºæœ€æ–°çš„ç»´æŠ¤éƒ½åœ¨ 5 å¹´å‰äº†ã€‚æ‰€ä»¥ï¼Œç°åœ¨ç”¨çš„å…¬å¸åŸºæœ¬ä¹Ÿå¾ˆå°‘äº†ã€‚</li>
<li><a href="https://github.com/dangdangdotcom/sharding-jdbc" target="_blank" rel="noopener">sharding-jdbc</a> - å½“å½“å¼€æºçš„ï¼Œå±äº client å±‚æ–¹æ¡ˆã€‚ç¡®å®ä¹‹å‰ç”¨çš„è¿˜æ¯”è¾ƒå¤šä¸€äº›ï¼Œå› ä¸º SQL è¯­æ³•æ”¯æŒä¹Ÿæ¯”è¾ƒå¤šï¼Œæ²¡æœ‰å¤ªå¤šé™åˆ¶ï¼Œè€Œä¸”ç›®å‰æ¨å‡ºåˆ°äº† 2.0 ç‰ˆæœ¬ï¼Œæ”¯æŒåˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ã€åˆ†å¸ƒå¼ id ç”Ÿæˆã€æŸ”æ€§äº‹åŠ¡ï¼ˆæœ€å¤§åŠªåŠ›é€è¾¾å‹äº‹åŠ¡ã€TCC äº‹åŠ¡ï¼‰ã€‚è€Œä¸”ç¡®å®ä¹‹å‰ä½¿ç”¨çš„å…¬å¸ä¼šæ¯”è¾ƒå¤šä¸€äº›ï¼ˆè¿™ä¸ªåœ¨å®˜ç½‘æœ‰ç™»è®°ä½¿ç”¨çš„å…¬å¸ï¼Œå¯ä»¥çœ‹åˆ°ä» 2017 å¹´ä¸€ç›´åˆ°ç°åœ¨ï¼Œæ˜¯æœ‰ä¸å°‘å…¬å¸åœ¨ç”¨çš„ï¼‰ï¼Œç›®å‰ç¤¾åŒºä¹Ÿè¿˜ä¸€ç›´åœ¨å¼€å‘å’Œç»´æŠ¤ï¼Œè¿˜ç®—æ˜¯æ¯”è¾ƒæ´»è·ƒï¼Œä¸ªäººè®¤ä¸ºç®—æ˜¯ä¸€ä¸ªç°åœ¨ä¹Ÿ<strong>å¯ä»¥é€‰æ‹©çš„æ–¹æ¡ˆ</strong>ã€‚</li>
<li><a href="http://www.mycat.org.cn/" target="_blank" rel="noopener">Mycat</a> - åŸºäº cobar æ”¹é€ çš„ï¼Œå±äº proxy å±‚æ–¹æ¡ˆï¼Œæ”¯æŒçš„åŠŸèƒ½éå¸¸å®Œå–„ï¼Œè€Œä¸”ç›®å‰åº”è¯¥æ˜¯éå¸¸ç«çš„è€Œä¸”ä¸æ–­æµè¡Œçš„æ•°æ®åº“ä¸­é—´ä»¶ï¼Œç¤¾åŒºå¾ˆæ´»è·ƒï¼Œä¹Ÿæœ‰ä¸€äº›å…¬å¸å¼€å§‹åœ¨ç”¨äº†ã€‚ä½†æ˜¯ç¡®å®ç›¸æ¯”äº sharding jdbc æ¥è¯´ï¼Œå¹´è½»ä¸€äº›ï¼Œç»å†çš„é”¤ç‚¼å°‘ä¸€äº›ã€‚</li>
</ul>
<p>æŠ€æœ¯é€‰å‹å»ºè®®ï¼š</p>
<p>å»ºè®®ä½¿ç”¨çš„æ˜¯ sharding-jdbc å’Œ mycatã€‚</p>
<ul>
<li><a href="https://github.com/dangdangdotcom/sharding-jdbc" target="_blank" rel="noopener">sharding-jdbc</a> è¿™ç§ client å±‚æ–¹æ¡ˆçš„<strong>ä¼˜ç‚¹åœ¨äºä¸ç”¨éƒ¨ç½²ï¼Œè¿ç»´æˆæœ¬ä½ï¼Œä¸éœ€è¦ä»£ç†å±‚çš„äºŒæ¬¡è½¬å‘è¯·æ±‚ï¼Œæ€§èƒ½å¾ˆé«˜</strong>ï¼Œä½†æ˜¯å¦‚æœé‡åˆ°å‡çº§å•¥çš„éœ€è¦å„ä¸ªç³»ç»Ÿéƒ½é‡æ–°å‡çº§ç‰ˆæœ¬å†å‘å¸ƒï¼Œå„ä¸ªç³»ç»Ÿéƒ½éœ€è¦<strong>è€¦åˆ</strong> sharding-jdbc çš„ä¾èµ–ã€‚å…¶æœ¬è´¨ä¸Šé€šè¿‡é…ç½®å¤šæ•°æ®æºï¼Œç„¶åæ ¹æ®è®¾å®šçš„åˆ†åº“åˆ†è¡¨ç­–ç•¥ï¼Œè®¡ç®—è·¯ç”±ï¼Œå°†è¯·æ±‚å‘é€åˆ°è®¡ç®—å¾—åˆ°çš„èŠ‚ç‚¹ä¸Šã€‚</li>
<li><a href="http://www.mycat.org.cn/" target="_blank" rel="noopener">Mycat</a> è¿™ç§ proxy å±‚æ–¹æ¡ˆçš„<strong>ç¼ºç‚¹åœ¨äºéœ€è¦éƒ¨ç½²</strong>ï¼Œè‡ªå·±è¿ç»´ä¸€å¥—ä¸­é—´ä»¶ï¼Œè¿ç»´æˆæœ¬é«˜ï¼Œä½†æ˜¯<strong>å¥½å¤„åœ¨äºå¯¹äºå„ä¸ªé¡¹ç›®æ˜¯é€æ˜çš„</strong>ï¼Œå¦‚æœé‡åˆ°å‡çº§ä¹‹ç±»çš„éƒ½æ˜¯è‡ªå·±ä¸­é—´ä»¶é‚£é‡Œæå°±è¡Œäº†ã€‚</li>
</ul>
<p>é€šå¸¸æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªæ–¹æ¡ˆå…¶å®éƒ½å¯ä»¥é€‰ç”¨ï¼Œä½†æ˜¯æˆ‘ä¸ªäººå»ºè®®ä¸­å°å‹å…¬å¸é€‰ç”¨ sharding-jdbcï¼Œclient å±‚æ–¹æ¡ˆè½»ä¾¿ï¼Œè€Œä¸”ç»´æŠ¤æˆæœ¬ä½ï¼Œä¸éœ€è¦é¢å¤–å¢æ´¾äººæ‰‹ï¼Œè€Œä¸”ä¸­å°å‹å…¬å¸ç³»ç»Ÿå¤æ‚åº¦ä¼šä½ä¸€äº›ï¼Œé¡¹ç›®ä¹Ÿæ²¡é‚£ä¹ˆå¤šï¼›ä½†æ˜¯ä¸­å¤§å‹å…¬å¸æœ€å¥½è¿˜æ˜¯é€‰ç”¨ mycat è¿™ç±» proxy å±‚æ–¹æ¡ˆï¼Œå› ä¸ºå¯èƒ½å¤§å…¬å¸ç³»ç»Ÿå’Œé¡¹ç›®éå¸¸å¤šï¼Œå›¢é˜Ÿå¾ˆå¤§ï¼Œäººå‘˜å……è¶³ï¼Œé‚£ä¹ˆæœ€å¥½æ˜¯ä¸“é—¨å¼„ä¸ªäººæ¥ç ”ç©¶å’Œç»´æŠ¤ mycatï¼Œç„¶åå¤§é‡é¡¹ç›®ç›´æ¥é€æ˜ä½¿ç”¨å³å¯ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://shardingsphere.apache.org/document/current/cn/overview/" target="_blank" rel="noopener">ShardingSphere å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://juejin.im/post/5bf778ef5188251b8a26ed8b" target="_blank" rel="noopener">â€œåˆ†åº“åˆ†è¡¨&quot; ï¼Ÿé€‰å‹å’Œæµç¨‹è¦æ…é‡ï¼Œå¦åˆ™ä¼šå¤±æ§</a></li>
<li><a href="https://www.jianshu.com/p/32b3e91aa22c" target="_blank" rel="noopener">åˆ†åº“åˆ†è¡¨éœ€è¦è€ƒè™‘çš„é—®é¢˜åŠæ–¹æ¡ˆ</a></li>
<li><a href="https://juejin.im/post/5d4b6dc1f265da03c1288332" target="_blank" rel="noopener">ä¸€æ¬¡éš¾å¾—çš„åˆ†åº“åˆ†è¡¨å®è·µ</a></li>
<li><a href="https://www.cnblogs.com/barrywxx/p/11532122.html" target="_blank" rel="noopener">åˆ†åº“åˆ†è¡¨å¹³æ»‘æ‰©å®¹</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/distributed-id/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/distributed-id/" class="post-title-link" itemprop="url">åˆ†å¸ƒå¼ ID åŸºæœ¬åŸç†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-07-24 11:55:00" itemprop="dateCreated datePublished" datetime="2019-07-24T11:55:00+08:00">2019-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/distributed-id/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/distributed-id/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>5 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åˆ†å¸ƒå¼-id-åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼-id-åŸºæœ¬åŸç†"></a> åˆ†å¸ƒå¼ ID åŸºæœ¬åŸç†</h1>
<blockquote>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
<p>ä¼ ç»Ÿæ•°æ®åº“è½¯ä»¶å¼€å‘ä¸­ï¼Œä¸»é”®è‡ªåŠ¨ç”ŸæˆæŠ€æœ¯æ˜¯åŸºæœ¬éœ€æ±‚ã€‚è€Œå„ä¸ªæ•°æ®åº“å¯¹äºè¯¥éœ€æ±‚ä¹Ÿæä¾›äº†ç›¸åº”çš„æ”¯æŒï¼Œæ¯”å¦‚ MySQL çš„è‡ªå¢é”®ï¼ŒOracle çš„è‡ªå¢åºåˆ—ç­‰ã€‚</p>
<p>æ•°æ®åˆ†ç‰‡åï¼Œä¸åŒæ•°æ®èŠ‚ç‚¹ç”Ÿæˆå…¨å±€å”¯ä¸€ä¸»é”®æ˜¯éå¸¸æ£˜æ‰‹çš„é—®é¢˜ã€‚åŒä¸€ä¸ªé€»è¾‘è¡¨å†…çš„ä¸åŒå®é™…è¡¨ä¹‹é—´çš„è‡ªå¢é”®ç”±äºæ— æ³•äº’ç›¸æ„ŸçŸ¥è€Œäº§ç”Ÿé‡å¤ä¸»é”®ã€‚ è™½ç„¶å¯é€šè¿‡çº¦æŸè‡ªå¢ä¸»é”®åˆå§‹å€¼å’Œæ­¥é•¿çš„æ–¹å¼é¿å…ç¢°æ’ï¼Œä½†éœ€å¼•å…¥é¢å¤–çš„è¿ç»´è§„åˆ™ï¼Œä½¿è§£å†³æ–¹æ¡ˆç¼ºä¹å®Œæ•´æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<p>ä¸ºæ­¤ï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ ID æ¥è§£å†³æ­¤é—®é¢˜ã€‚æœ¬æ–‡æ€»ç»“ä¸šç•Œå¸¸ç”¨çš„åˆ†å¸ƒå¼ ID è§£å†³æ–¹æ¡ˆã€‚</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#%E4%B8%80%E5%88%86%E5%B8%83%E5%BC%8F-id-%E7%AE%80%E4%BB%8B">ä¸€ã€åˆ†å¸ƒå¼ ID ç®€ä»‹</a></li>
<li><a href="#%E4%BA%8Cuuid">äºŒã€UUID</a>
<ul>
<li><a href="#uuid-%E7%9A%84%E4%BC%98%E7%82%B9">UUID çš„ä¼˜ç‚¹</a></li>
<li><a href="#uuid-%E7%9A%84%E7%BC%BA%E7%82%B9">UUID çš„ç¼ºç‚¹</a></li>
<li><a href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF">é€‚ç”¨åœºæ™¯</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E5%88%A9%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%AD%98%E5%82%A8%E7%94%9F%E6%88%90%E9%94%AE">ä¸‰ã€åˆ©ç”¨ç¬¬ä¸‰æ–¹å­˜å‚¨ç”Ÿæˆé”®</a>
<ul>
<li><a href="#%E4%BC%98%E7%82%B9">ä¼˜ç‚¹</a></li>
<li><a href="#%E7%BC%BA%E7%82%B9">ç¼ºç‚¹</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95snowflake">å››ã€é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">åŸºæœ¬åŸç†</a></li>
<li><a href="#%E4%BC%98%E7%82%B9-1">ä¼˜ç‚¹</a></li>
<li><a href="#%E7%BC%BA%E7%82%B9-1">ç¼ºç‚¹</a></li>
<li><a href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-1">é€‚ç”¨åœºæ™¯</a></li>
<li><a href="#%E9%98%B2%E6%AD%A2%E6%97%B6%E9%92%9F%E5%9B%9E%E6%8B%A8">é˜²æ­¢æ—¶é’Ÿå›æ‹¨</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94leaf">äº”ã€Leaf</a>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86-1">åŸºæœ¬åŸç†</a></li>
<li><a href="#%E4%BC%98%E7%82%B9-2">ä¼˜ç‚¹</a></li>
<li><a href="#%E7%BC%BA%E7%82%B9-2">ç¼ºç‚¹</a></li>
<li><a href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-2">é€‚ç”¨åœºæ™¯</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="ä¸€-åˆ†å¸ƒå¼-id-ç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-åˆ†å¸ƒå¼-id-ç®€ä»‹"></a> ä¸€ã€åˆ†å¸ƒå¼ ID ç®€ä»‹</h2>
<p>é¦–å…ˆï¼Œåˆ†å¸ƒå¼ ID åº”è¯¥å…·å¤‡å“ªäº›ç‰¹æ€§å‘¢ï¼Ÿ</p>
<ol>
<li><strong>å…¨å±€å”¯ä¸€æ€§</strong> - ä¸èƒ½å‡ºç°é‡å¤çš„ ID å·ï¼Œæ—¢ç„¶æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚</li>
<li><strong>è¶‹åŠ¿é€’å¢</strong> - åœ¨ MySQL InnoDB å¼•æ“ä¸­ä½¿ç”¨çš„æ˜¯èšé›†ç´¢å¼•ï¼Œç”±äºå¤šæ•° RDBMS ä½¿ç”¨ B-tree çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œåœ¨ä¸»é”®çš„é€‰æ‹©ä¸Šé¢æˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æœ‰åºçš„ä¸»é”®ä¿è¯å†™å…¥æ€§èƒ½ã€‚</li>
<li><strong>å•è°ƒé€’å¢</strong> - ä¿è¯ä¸‹ä¸€ä¸ª ID ä¸€å®šå¤§äºä¸Šä¸€ä¸ª IDï¼Œä¾‹å¦‚äº‹åŠ¡ç‰ˆæœ¬å·ã€IM å¢é‡æ¶ˆæ¯ã€æ’åºç­‰ç‰¹æ®Šéœ€æ±‚ã€‚</li>
<li><strong>ä¿¡æ¯å®‰å…¨</strong> - å¦‚æœ ID æ˜¯è¿ç»­çš„ï¼Œæ¶æ„ç”¨æˆ·çš„æ‰’å–å·¥ä½œå°±éå¸¸å®¹æ˜“åšäº†ï¼Œç›´æ¥æŒ‰ç…§é¡ºåºä¸‹è½½æŒ‡å®š URL å³å¯ï¼›å¦‚æœæ˜¯è®¢å•å·å°±æ›´å±é™©äº†ï¼Œç«å¯¹å¯ä»¥ç›´æ¥çŸ¥é“æˆ‘ä»¬ä¸€å¤©çš„å•é‡ã€‚æ‰€ä»¥åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸‹ï¼Œä¼šéœ€è¦ ID æ— è§„åˆ™ã€ä¸è§„åˆ™ã€‚</li>
</ol>
<h2 id="äºŒ-uuid"><a class="markdownIt-Anchor" href="#äºŒ-uuid"></a> äºŒã€UUID</h2>
<p>UUID æ˜¯æœ€ç®€å•çš„åˆ†å¸ƒå¼ ID æ–¹æ¡ˆã€‚</p>
<p>UUID æ˜¯é€šç”¨å”¯ä¸€è¯†åˆ«ç ï¼ˆUniversally Unique Identifier)çš„ç¼©å†™ï¼Œå¼€æ”¾è½¯ä»¶åŸºé‡‘ä¼š(OSF)è§„èŒƒå®šä¹‰äº†åŒ…æ‹¬ç½‘å¡ MAC åœ°å€ã€æ—¶é—´æˆ³ã€åå­—ç©ºé—´ï¼ˆNamespaceï¼‰ã€éšæœºæˆ–ä¼ªéšæœºæ•°ã€æ—¶åºç­‰å…ƒç´ ã€‚åˆ©ç”¨è¿™äº›å…ƒç´ æ¥ç”Ÿæˆ UUIDã€‚</p>
<p>UUID æ˜¯ç”± 128 ä½äºŒè¿›åˆ¶ç»„æˆï¼Œä¸€èˆ¬è½¬æ¢æˆåå…­è¿›åˆ¶ï¼Œç„¶åç”¨ String è¡¨ç¤ºã€‚åœ¨ java ä¸­æœ‰ä¸ª UUID ç±»,åœ¨ä»–çš„æ³¨é‡Šä¸­æˆ‘ä»¬çœ‹è§è¿™é‡Œæœ‰ 4 ç§ä¸åŒçš„ UUID çš„ç”Ÿæˆç­–ç•¥:</p>
<ul>
<li>random - åŸºäºéšæœºæ•°ç”Ÿæˆ UUIDï¼Œç”±äº Java ä¸­çš„éšæœºæ•°æ˜¯ä¼ªéšæœºæ•°ï¼Œå…¶é‡å¤çš„æ¦‚ç‡æ˜¯å¯ä»¥è¢«è®¡ç®—å‡ºæ¥çš„ã€‚è¿™ä¸ªä¸€èˆ¬æˆ‘ä»¬ç”¨ä¸‹é¢çš„ä»£ç è·å–åŸºäºéšæœºæ•°çš„ UUID:</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String id = UUID.randomUUID().toString();</span><br></pre></td></tr></table></figure>
<ul>
<li>time-based - åŸºäºæ—¶é—´çš„ UUID,è¿™ä¸ªä¸€èˆ¬æ˜¯é€šè¿‡å½“å‰æ—¶é—´ï¼Œéšæœºæ•°ï¼Œå’Œæœ¬åœ° Mac åœ°å€æ¥è®¡ç®—å‡ºæ¥ï¼Œè‡ªå¸¦çš„ JDK åŒ…å¹¶æ²¡æœ‰è¿™ä¸ªç®—æ³•çš„æˆ‘ä»¬åœ¨ä¸€äº› UUIDUtil ä¸­ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ log4j.core.utilï¼Œä¼šé‡æ–°å®šä¹‰ UUID çš„é«˜ä½å’Œä½ä½ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UUID <span class="title">getTimeBasedUuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> time = System.currentTimeMillis() * <span class="number">10000L</span> + <span class="number">122192928000000000L</span> + (<span class="keyword">long</span>)(COUNT.incrementAndGet() % <span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">long</span> timeLow = (time &amp; <span class="number">4294967295L</span>) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">long</span> timeMid = (time &amp; <span class="number">281470681743360L</span>) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">long</span> timeHi = (time &amp; <span class="number">1152640029630136320L</span>) &gt;&gt; <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">long</span> most = timeLow | timeMid | <span class="number">4096L</span> | timeHi;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UUID(most, LEAST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>DCE security - DCE å®‰å…¨çš„ UUIDã€‚</p>
</li>
<li>
<p>name-based - åŸºäºåå­—çš„ UUIDï¼Œé€šè¿‡è®¡ç®—åå­—å’Œåå­—ç©ºé—´çš„ MD5 æ¥è®¡ç®— UUIDã€‚</p>
</li>
</ul>
<h3 id="uuid-çš„ä¼˜ç‚¹"><a class="markdownIt-Anchor" href="#uuid-çš„ä¼˜ç‚¹"></a> UUID çš„ä¼˜ç‚¹</h3>
<ul>
<li>é€šè¿‡æœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰ç»è¿‡ç½‘ç»œ I/Oï¼Œæ€§èƒ½è¾ƒå¿«ã€‚</li>
</ul>
<h3 id="uuid-çš„ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#uuid-çš„ç¼ºç‚¹"></a> UUID çš„ç¼ºç‚¹</h3>
<ul>
<li><strong>é•¿åº¦è¿‡é•¿</strong> - UUID å¤ªé•¿ï¼Œ16 å­—èŠ‚ 128 ä½ï¼Œé€šå¸¸ä»¥ 36 é•¿åº¦çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå¾ˆå¤šåœºæ™¯ä¸é€‚ç”¨ã€‚ä¾‹å¦‚ï¼šMysql å®˜æ–¹æ˜ç¡®å»ºè®®ä¸»é”®è¶ŠçŸ­è¶Šå¥½ï¼Œ36 ä¸ªå­—ç¬¦é•¿åº¦çš„ UUID ä¸ç¬¦åˆè¦æ±‚ã€‚</li>
<li><strong>ä¿¡æ¯ä¸å®‰å…¨</strong> - åŸºäº MAC åœ°å€ç”Ÿæˆ UUID çš„ç®—æ³•å¯èƒ½ä¼šé€ æˆ MAC åœ°å€æ³„éœ²ï¼Œè¿™ä¸ªæ¼æ´æ›¾è¢«ç”¨äºå¯»æ‰¾æ¢…ä¸½èç—…æ¯’çš„åˆ¶ä½œè€…ä½ç½®ã€‚</li>
<li><strong>æ— åºæ€§</strong> - ä¸èƒ½ç”Ÿæˆé€’å¢æœ‰åºçš„æ•°å­—ã€‚è¿™å¯¹äºä¸€äº›ç‰¹å®šåœºæ™¯ä¸åˆ©ã€‚ä¾‹å¦‚ï¼šå¦‚æœä½œä¸ºæ•°æ®åº“ä¸»é”®ï¼Œåœ¨ InnoDB å¼•æ“ä¸‹ï¼ŒUUID çš„æ— åºæ€§å¯èƒ½ä¼šå¼•èµ·æ•°æ®ä½ç½®é¢‘ç¹å˜åŠ¨ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚</li>
</ul>
<h3 id="é€‚ç”¨åœºæ™¯"><a class="markdownIt-Anchor" href="#é€‚ç”¨åœºæ™¯"></a> é€‚ç”¨åœºæ™¯</h3>
<p>UUID çš„é€‚ç”¨åœºæ™¯å¯ä»¥ä¸ºä¸éœ€è¦æ‹…å¿ƒè¿‡å¤šçš„ç©ºé—´å ç”¨ï¼Œä»¥åŠä¸éœ€è¦ç”Ÿæˆæœ‰é€’å¢è¶‹åŠ¿çš„æ•°å­—ã€‚åœ¨ Log4j é‡Œ <code>UuidPatternConverter</code> ä¸­åŠ å…¥äº† UUID æ¥æ ‡è¯†æ¯ä¸€æ¡æ—¥å¿—ã€‚</p>
<h2 id="ä¸‰-åˆ©ç”¨ç¬¬ä¸‰æ–¹å­˜å‚¨ç”Ÿæˆé”®"><a class="markdownIt-Anchor" href="#ä¸‰-åˆ©ç”¨ç¬¬ä¸‰æ–¹å­˜å‚¨ç”Ÿæˆé”®"></a> ä¸‰ã€åˆ©ç”¨ç¬¬ä¸‰æ–¹å­˜å‚¨ç”Ÿæˆé”®</h2>
<p>æåˆ°è‡ªå¢é”®ï¼Œæœ€å…ˆæƒ³åˆ°çš„è‚¯å®šæ˜¯ç›´æ¥ä½¿ç”¨æ•°æ®åº“è‡ªå¢é”®ã€‚<em>å„æ•°æ®åº“å¯¹äºè¯¥éœ€æ±‚ä¹Ÿæä¾›äº†ç›¸åº”çš„æ”¯æŒï¼Œæ¯”å¦‚ MySQL çš„è‡ªå¢é”®ï¼ŒOracle çš„è‡ªå¢åºåˆ—ç­‰</em>ã€‚</p>
<p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘æ˜¯ç”¨ Redis è¿™æ ·çš„ Nosqlï¼Œç”šè‡³ ZooKeeper å»ç”Ÿæˆé”®</p>
<h3 id="ä¼˜ç‚¹"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹"></a> ä¼˜ç‚¹</h3>
<ul>
<li>éå¸¸ç®€å•ï¼Œåˆ©ç”¨ç°æœ‰çš„åŠŸèƒ½å®ç°ï¼Œæˆæœ¬å°</li>
<li>æœ‰åºé€’å¢</li>
<li>æ–¹ä¾¿æ’åºå’Œåˆ†é¡µ</li>
</ul>
<h3 id="ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹"></a> ç¼ºç‚¹</h3>
<ul>
<li>å¼ºä¾èµ–ç¬¬ä¸‰æ–¹å­˜å‚¨ï¼Œå¦‚æœç¬¬ä¸‰æ–¹å­˜å‚¨éé«˜å¯ç”¨ç³»ç»Ÿï¼Œè‹¥å‡ºç°ä¸¢å¤±æ•°æ®çš„æƒ…å†µï¼Œå°±å¯èƒ½å‡ºç°é‡å¤ç”Ÿæˆ ID çš„é—®é¢˜ã€‚</li>
<li>ç”Ÿæˆ ID æ€§èƒ½ç“¶é¢ˆä¾èµ–äºç¬¬ä¸‰æ–¹å­˜å‚¨çš„æ€§èƒ½ã€‚</li>
<li>å¢åŠ äº†å¯¹ç¬¬ä¸‰æ–¹å­˜å‚¨è¿ç»´çš„æˆæœ¬ã€‚</li>
</ul>
<h2 id="å››-é›ªèŠ±ç®—æ³•snowflake"><a class="markdownIt-Anchor" href="#å››-é›ªèŠ±ç®—æ³•snowflake"></a> å››ã€é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰</h2>
<p>é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰æ˜¯ç”± Twitter å…¬å¸ƒçš„åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆç®—æ³•ï¼Œ<strong>å®ƒä¼šç”Ÿæˆä¸€ä¸ª <code>64 bit</code> çš„æ•´æ•°</strong>ï¼Œå¯ä»¥ä¿è¯ä¸åŒè¿›ç¨‹ä¸»é”®çš„ä¸é‡å¤æ€§ï¼Œä»¥åŠç›¸åŒè¿›ç¨‹ä¸»é”®çš„æœ‰åºæ€§ã€‚</p>
<p>åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå®ƒé¦–å…ˆæ˜¯é€šè¿‡æ—¶é—´ä½ä¿è¯ä¸é‡å¤ï¼Œå¦‚æœæ—¶é—´ç›¸åŒåˆ™æ˜¯é€šè¿‡åºåˆ—ä½ä¿è¯ã€‚ åŒæ—¶ç”±äºæ—¶é—´ä½æ˜¯å•è°ƒé€’å¢çš„ï¼Œä¸”å„ä¸ªæœåŠ¡å™¨å¦‚æœå¤§ä½“åšäº†æ—¶é—´åŒæ­¥ï¼Œé‚£ä¹ˆç”Ÿæˆçš„ä¸»é”®åœ¨åˆ†å¸ƒå¼ç¯å¢ƒå¯ä»¥è®¤ä¸ºæ˜¯æ€»ä½“æœ‰åºçš„ï¼Œè¿™å°±ä¿è¯äº†å¯¹ç´¢å¼•å­—æ®µçš„æ’å…¥çš„é«˜æ•ˆæ€§ã€‚</p>
<h3 id="åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#åŸºæœ¬åŸç†"></a> åŸºæœ¬åŸç†</h3>
<h4 id="é”®çš„ç»„æˆ"><a class="markdownIt-Anchor" href="#é”®çš„ç»„æˆ"></a> é”®çš„ç»„æˆ</h4>
<p>ä½¿ç”¨<strong>é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ä¸»é”®ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼åŒ…å« 4 éƒ¨åˆ†</strong>ï¼Œä»é«˜ä½åˆ°ä½ä½åˆ†è¡¨ä¸ºï¼š1bit ç¬¦å·ä½ã€41bit æ—¶é—´æˆ³ä½ã€10bit å·¥ä½œè¿›ç¨‹ä½ä»¥åŠ 12bit åºåˆ—å·ä½ã€‚</p>
<ul>
<li><strong>ç¬¦å·ä½(1bit)</strong></li>
</ul>
<p>é¢„ç•™çš„ç¬¦å·ä½ï¼Œæ’ä¸ºé›¶ã€‚</p>
<ul>
<li><strong>æ—¶é—´æˆ³ä½(41bit)</strong></li>
</ul>
<p>41 ä½çš„æ—¶é—´æˆ³å¯ä»¥å®¹çº³çš„æ¯«ç§’æ•°æ˜¯ 2 çš„ 41 æ¬¡å¹‚ï¼Œä¸€å¹´æ‰€ä½¿ç”¨çš„æ¯«ç§’æ•°æ˜¯ï¼š<code>365 * 24 * 60 * 60 * 1000</code>ã€‚é€šè¿‡è®¡ç®—å¯çŸ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Math.pow(<span class="number">2</span>, <span class="number">41</span>) / (<span class="number">365</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<p>ç»“æœçº¦ç­‰äº 69.73 å¹´ã€‚ShardingSphere çš„é›ªèŠ±ç®—æ³•çš„æ—¶é—´çºªå…ƒä» 2016 å¹´ 11 æœˆ 1 æ—¥é›¶ç‚¹å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨åˆ° 2086 å¹´ï¼Œç›¸ä¿¡èƒ½æ»¡è¶³ç»å¤§éƒ¨åˆ†ç³»ç»Ÿçš„è¦æ±‚ã€‚</p>
<ul>
<li><strong>å·¥ä½œè¿›ç¨‹ä½(10bit)</strong></li>
</ul>
<p>è¯¥æ ‡å¿—åœ¨ Java è¿›ç¨‹å†…æ˜¯å”¯ä¸€çš„ï¼Œå¦‚æœæ˜¯åˆ†å¸ƒå¼åº”ç”¨éƒ¨ç½²åº”ä¿è¯æ¯ä¸ªå·¥ä½œè¿›ç¨‹çš„ id æ˜¯ä¸åŒçš„ã€‚è¯¥å€¼é»˜è®¤ä¸º 0ï¼Œå¯é€šè¿‡å±æ€§è®¾ç½®ã€‚</p>
<ul>
<li><strong>åºåˆ—å·ä½(12bit)</strong></li>
</ul>
<p>è¯¥åºåˆ—æ˜¯ç”¨æ¥åœ¨åŒä¸€ä¸ªæ¯«ç§’å†…ç”Ÿæˆä¸åŒçš„ IDã€‚å¦‚æœåœ¨è¿™ä¸ªæ¯«ç§’å†…ç”Ÿæˆçš„æ•°é‡è¶…è¿‡ 4096(2 çš„ 12 æ¬¡å¹‚)ï¼Œé‚£ä¹ˆç”Ÿæˆå™¨ä¼šç­‰å¾…åˆ°ä¸‹ä¸ªæ¯«ç§’ç»§ç»­ç”Ÿæˆã€‚</p>
<p>é›ªèŠ±ç®—æ³•ä¸»é”®çš„è¯¦ç»†ç»“æ„è§ä¸‹å›¾ï¼š</p>
<p><img src="https://shardingsphere.apache.org/document/current/img/sharding/snowflake_cn_v2.png" alt="é›ªèŠ±ç®—æ³•" /></p>
<h4 id="æ—¶é’Ÿå›æ‹¨"><a class="markdownIt-Anchor" href="#æ—¶é’Ÿå›æ‹¨"></a> æ—¶é’Ÿå›æ‹¨</h4>
<p>æœåŠ¡å™¨æ—¶é’Ÿå›æ‹¨ä¼šå¯¼è‡´äº§ç”Ÿé‡å¤åºåˆ—ï¼Œå› æ­¤é»˜è®¤åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆå™¨æä¾›äº†ä¸€ä¸ªæœ€å¤§å®¹å¿çš„æ—¶é’Ÿå›æ‹¨æ¯«ç§’æ•°ã€‚ å¦‚æœæ—¶é’Ÿå›æ‹¨çš„æ—¶é—´è¶…è¿‡æœ€å¤§å®¹å¿çš„æ¯«ç§’æ•°é˜ˆå€¼ï¼Œåˆ™ç¨‹åºæŠ¥é”™ï¼›å¦‚æœåœ¨å¯å®¹å¿çš„èŒƒå›´å†…ï¼Œé»˜è®¤åˆ†å¸ƒå¼ä¸»é”®ç”Ÿæˆå™¨ä¼šç­‰å¾…æ—¶é’ŸåŒæ­¥åˆ°æœ€åä¸€æ¬¡ä¸»é”®ç”Ÿæˆçš„æ—¶é—´åå†ç»§ç»­å·¥ä½œã€‚ æœ€å¤§å®¹å¿çš„æ—¶é’Ÿå›æ‹¨æ¯«ç§’æ•°çš„é»˜è®¤å€¼ä¸º 0ï¼Œå¯é€šè¿‡å±æ€§è®¾ç½®ã€‚</p>
<h4 id="çµæ´»å®šåˆ¶"><a class="markdownIt-Anchor" href="#çµæ´»å®šåˆ¶"></a> çµæ´»å®šåˆ¶</h4>
<p>ä¸Šé¢åªæ˜¯ä¸€ä¸ªå°† <code>64bit</code> åˆ’åˆ†çš„æ ‡å‡†ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šè¿™ä¹ˆåšï¼Œå¯ä»¥æ ¹æ®ä¸åŒä¸šåŠ¡çš„å…·ä½“åœºæ™¯æ¥åˆ’åˆ†ï¼Œæ¯”å¦‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼š</p>
<ul>
<li>æœåŠ¡ç›®å‰ QPS10 ä¸‡ï¼Œé¢„è®¡å‡ å¹´ä¹‹å†…ä¼šå‘å±•åˆ°ç™¾ä¸‡ã€‚</li>
<li>å½“å‰æœºå™¨ä¸‰åœ°éƒ¨ç½²ï¼Œä¸Šæµ·ï¼ŒåŒ—äº¬ï¼Œæ·±åœ³éƒ½æœ‰ã€‚</li>
<li>å½“å‰æœºå™¨ 10 å°å·¦å³ï¼Œé¢„è®¡æœªæ¥ä¼šå¢åŠ è‡³ç™¾å°ã€‚</li>
</ul>
<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ ¹æ®ä¸Šé¢çš„åœºæ™¯å¯ä»¥å†æ¬¡åˆç†çš„åˆ’åˆ† 62bitï¼ŒQPS å‡ å¹´ä¹‹å†…ä¼šå‘å±•åˆ°ç™¾ä¸‡ï¼Œé‚£ä¹ˆæ¯æ¯«ç§’å°±æ˜¯åƒçº§çš„è¯·æ±‚ï¼Œç›®å‰ 10 å°æœºå™¨é‚£ä¹ˆæ¯å°æœºå™¨æ‰¿æ‹…ç™¾çº§çš„è¯·æ±‚ï¼Œä¸ºäº†ä¿è¯æ‰©å±•ï¼Œåé¢çš„å¾ªç¯ä½å¯ä»¥é™åˆ¶åˆ° 1024ï¼Œä¹Ÿå°±æ˜¯ 2^10ï¼Œé‚£ä¹ˆå¾ªç¯ä½ 10 ä½å°±è¶³å¤Ÿäº†ã€‚</p>
<p>æœºå™¨ä¸‰åœ°éƒ¨ç½²æˆ‘ä»¬å¯ä»¥ç”¨ 3bit æ€»å…± 8 æ¥è¡¨ç¤ºæœºæˆ¿ä½ç½®ï¼Œå½“å‰çš„æœºå™¨ 10 å°ï¼Œä¸ºäº†ä¿è¯æ‰©å±•åˆ°ç™¾å°é‚£ä¹ˆå¯ä»¥ç”¨ 7bit 128 æ¥è¡¨ç¤ºï¼Œæ—¶é—´ä½ä¾ç„¶æ˜¯ 41bitï¼Œé‚£ä¹ˆè¿˜å‰©ä¸‹ 64-10-3-7-41-1 = 2bitï¼Œè¿˜å‰©ä¸‹ 2bit å¯ä»¥ç”¨æ¥è¿›è¡Œæ‰©å±•ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/9/29/16624909d2007c22?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>
<h3 id="ä¼˜ç‚¹-2"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-2"></a> ä¼˜ç‚¹</h3>
<ul>
<li>ç”Ÿæˆçš„ ID éƒ½æ˜¯è¶‹åŠ¿é€’å¢çš„ã€‚</li>
<li>ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä»¥æœåŠ¡çš„æ–¹å¼éƒ¨ç½²ï¼Œç¨³å®šæ€§æ›´é«˜ï¼Œç”Ÿæˆ ID çš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚</li>
<li>å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§åˆ†é… bit ä½ï¼Œéå¸¸çµæ´»ã€‚</li>
</ul>
<h3 id="ç¼ºç‚¹-2"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹-2"></a> ç¼ºç‚¹</h3>
<ul>
<li>å¼ºä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œå¦‚æœæœºå™¨ä¸Šæ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´å‘å·é‡å¤æˆ–è€…æœåŠ¡ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚</li>
</ul>
<h3 id="é€‚ç”¨åœºæ™¯-2"><a class="markdownIt-Anchor" href="#é€‚ç”¨åœºæ™¯-2"></a> é€‚ç”¨åœºæ™¯</h3>
<p>å½“æˆ‘ä»¬éœ€è¦æ— åºä¸èƒ½è¢«çŒœæµ‹çš„ IDï¼Œå¹¶ä¸”éœ€è¦ä¸€å®šé«˜æ€§èƒ½ï¼Œä¸”éœ€è¦ long å‹ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬é›ªèŠ±ç®—æ³•ã€‚æ¯”å¦‚å¸¸è§çš„è®¢å• IDï¼Œç”¨é›ªèŠ±ç®—æ³•åˆ«äººå°±æ— æ³•çŒœæµ‹ä½ æ¯å¤©çš„è®¢å•é‡æ˜¯å¤šå°‘ã€‚</p>
<h3 id="é˜²æ­¢æ—¶é’Ÿå›æ‹¨"><a class="markdownIt-Anchor" href="#é˜²æ­¢æ—¶é’Ÿå›æ‹¨"></a> é˜²æ­¢æ—¶é’Ÿå›æ‹¨</h3>
<p>é›ªèŠ±ç®—æ³•æ˜¯å¼ºä¾èµ–äºæ—¶é—´çš„ï¼Œè€Œå¦‚æœæœºå™¨æ—¶é—´å‘ç”Ÿå›æ‹¨ï¼Œæœ‰å¯èƒ½ä¼šç”Ÿæˆé‡å¤çš„ IDã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é’ˆå¯¹ç®—æ³•åšä¸€äº›ä¼˜åŒ–ï¼Œæ¥é˜²æ­¢æ—¶é’Ÿå›æ‹¨ç”Ÿæˆé‡å¤ IDã€‚</p>
<p>ç”¨å½“å‰æ—¶é—´å’Œä¸Šä¸€æ¬¡çš„æ—¶é—´è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ—¶é—´å°äºä¸Šä¸€æ¬¡çš„æ—¶é—´é‚£ä¹ˆè‚¯å®šæ˜¯å‘ç”Ÿäº†å›æ‹¨ã€‚æ™®é€šçš„ç®—æ³•ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸¤ä¸ªæƒ…å†µ:</p>
<ul>
<li>å¦‚æœæ—¶é—´å›æ‹¨æ—¶é—´è¾ƒçŸ­ï¼Œæ¯”å¦‚é…ç½® <code>5ms</code> ä»¥å†…ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œè®©æœºå™¨çš„æ—¶é—´è¿½ä¸Šæ¥ã€‚</li>
<li>å¦‚æœæ—¶é—´çš„å›æ‹¨æ—¶é—´è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¸èƒ½æ¥å—è¿™ä¹ˆé•¿çš„é˜»å¡ç­‰å¾…ï¼Œé‚£ä¹ˆåˆæœ‰ä¸¤ä¸ªç­–ç•¥:
<ul>
<li>ç›´æ¥æ‹’ç»ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚æ‰“æ—¥å¿—ï¼Œé€šçŸ¥ RD æ—¶é’Ÿå›æ»šã€‚</li>
<li>åˆ©ç”¨æ‰©å±•ä½ã€‚ä¸Šé¢æˆ‘ä»¬è®¨è®ºè¿‡ï¼Œä¸åŒä¸šåŠ¡åœºæ™¯ä½æ•°å¯èƒ½ç”¨ä¸åˆ°é‚£ä¹ˆå¤šæ¯”ç‰¹ä½ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠæ‰©å±•ä½æ•°åˆ©ç”¨èµ·æ¥ã€‚æ¯”å¦‚ï¼šå½“è¿™ä¸ªæ—¶é—´å›æ‹¨æ¯”è¾ƒé•¿çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦ç­‰å¾…ï¼Œç›´æ¥åœ¨æ‰©å±•ä½åŠ  1ã€‚ä¸¤ä½çš„æ‰©å±•ä½å…è®¸æˆ‘ä»¬æœ‰ä¸‰æ¬¡å¤§çš„æ—¶é’Ÿå›æ‹¨ï¼Œä¸€èˆ¬æ¥è¯´å°±å¤Ÿäº†ï¼Œå¦‚æœå…¶è¶…è¿‡ä¸‰æ¬¡æˆ‘ä»¬è¿˜æ˜¯é€‰æ‹©æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰“æ—¥å¿—ã€‚</li>
</ul>
</li>
</ul>
<h2 id="äº”-leaf"><a class="markdownIt-Anchor" href="#äº”-leaf"></a> äº”ã€Leaf</h2>
<blockquote>
<p>ç¾å›¢æä¾›äº†ä¸€ç§åˆ†å¸ƒå¼ ID è§£å†³æ–¹æ¡ˆ Leafï¼Œå…¶æœ¬è´¨å¯ä»¥è§†ä¸ºæ•°æ®åº“åˆ†æ®µ+æœåŠ¡ç¼“å­˜ IDã€‚</p>
<p>è¯¦æƒ…å¯ä»¥å‚è€ƒ <a href="https://tech.meituan.com/2017/04/21/mt-leaf.html" target="_blank" rel="noopener">Leafâ€”â€”ç¾å›¢ç‚¹è¯„åˆ†å¸ƒå¼ ID ç”Ÿæˆç³»ç»Ÿ</a></p>
</blockquote>
<h3 id="åŸºæœ¬åŸç†-2"><a class="markdownIt-Anchor" href="#åŸºæœ¬åŸç†-2"></a> åŸºæœ¬åŸç†</h3>
<p>ä½¿ç”¨æ•°æ®åº“ç”Ÿæˆ IDï¼Œä½†æ˜¯åšäº†å¦‚ä¸‹æ”¹è¿›ï¼š</p>
<p>åŸæ–¹æ¡ˆæ¯æ¬¡è·å– ID éƒ½å¾—è¯»å†™ä¸€æ¬¡æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“å‹åŠ›å¤§ã€‚æ”¹ä¸ºåˆ©ç”¨ proxy server æ‰¹é‡è·å–ï¼Œæ¯æ¬¡è·å–ä¸€ä¸ª segment(step å†³å®šå¤§å°)å·æ®µçš„å€¼ã€‚ç”¨å®Œä¹‹åå†å»æ•°æ®åº“è·å–æ–°çš„å·æ®µï¼Œå¯ä»¥å¤§å¤§çš„å‡è½»æ•°æ®åº“çš„å‹åŠ›ã€‚ - å„ä¸ªä¸šåŠ¡ä¸åŒçš„å‘å·éœ€æ±‚ç”¨ biz_tag å­—æ®µæ¥åŒºåˆ†ï¼Œæ¯ä¸ª biz-tag çš„ ID è·å–ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å½±å“ã€‚å¦‚æœä»¥åæœ‰æ€§èƒ½éœ€æ±‚éœ€è¦å¯¹æ•°æ®åº“æ‰©å®¹ï¼Œä¸éœ€è¦ä¸Šè¿°æè¿°çš„å¤æ‚çš„æ‰©å®¹æ“ä½œï¼Œåªéœ€è¦å¯¹ biz_tag åˆ†åº“åˆ†è¡¨å°±è¡Œã€‚</p>
<p>æ•°æ®åº“è¡¨è®¾è®¡å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">+<span class="comment">-------------+--------------+------+-----+-------------------+-----------------------------+</span></span><br><span class="line">| Field       | Type         | Null | Key | Default           | Extra                       |</span><br><span class="line">+<span class="comment">-------------+--------------+------+-----+-------------------+-----------------------------+</span></span><br><span class="line">| biz_tag     | varchar(128) | NO   | PRI |                   |                             |</span><br><span class="line">| max_id      | bigint(20)   | NO   |     | 1                 |                             |</span><br><span class="line">| step        | int(11)      | NO   |     | NULL              |                             |</span><br><span class="line">| desc        | varchar(256) | YES  |     | NULL              |                             |</span><br><span class="line">| update_time | timestamp    | NO   |     | CURRENT_TIMESTAMP | on <span class="keyword">update</span> <span class="keyword">CURRENT_TIMESTAMP</span> |</span><br><span class="line">+<span class="comment">-------------+--------------+------+-----+-------------------+-----------------------------+</span></span><br></pre></td></tr></table></figure>
<p>é‡è¦å­—æ®µè¯´æ˜ï¼š</p>
<ul>
<li><code>biz_tag</code> ç”¨æ¥åŒºåˆ†ä¸šåŠ¡</li>
<li><code>max_id</code> è¡¨ç¤ºè¯¥ <code>biz_tag</code> ç›®å‰æ‰€è¢«åˆ†é…çš„ ID å·æ®µçš„æœ€å¤§å€¼</li>
<li><code>step</code> è¡¨ç¤ºæ¯æ¬¡åˆ†é…çš„å·æ®µé•¿åº¦ã€‚åŸæ¥è·å– ID æ¯æ¬¡éƒ½éœ€è¦å†™æ•°æ®åº“ï¼Œç°åœ¨åªéœ€è¦æŠŠ <code>step</code> è®¾ç½®å¾—è¶³å¤Ÿå¤§ï¼Œæ¯”å¦‚ 1000ã€‚é‚£ä¹ˆåªæœ‰å½“ 1000 ä¸ªå·è¢«æ¶ˆè€—å®Œäº†ä¹‹åæ‰ä¼šå»é‡æ–°è¯»å†™ä¸€æ¬¡æ•°æ®åº“ã€‚è¯»å†™æ•°æ®åº“çš„é¢‘ç‡ä» 1 å‡å°åˆ°äº† 1/stepã€‚</li>
</ul>
<p>å¤§è‡´æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/5e4ff128.png" alt="image" /></p>
<p>test_tag åœ¨ç¬¬ä¸€å° Leaf æœºå™¨ä¸Šæ˜¯ <code>1~1000</code> çš„å·æ®µï¼Œå½“è¿™ä¸ªå·æ®µç”¨å®Œæ—¶ï¼Œä¼šå»åŠ è½½å¦ä¸€ä¸ªé•¿åº¦ä¸º step=1000 çš„å·æ®µï¼Œå‡è®¾å¦å¤–ä¸¤å°å·æ®µéƒ½æ²¡æœ‰æ›´æ–°ï¼Œè¿™ä¸ªæ—¶å€™ç¬¬ä¸€å°æœºå™¨æ–°åŠ è½½çš„å·æ®µå°±åº”è¯¥æ˜¯ <code>3001~4000</code>ã€‚åŒæ—¶æ•°æ®åº“å¯¹åº”çš„ biz_tag è¿™æ¡æ•°æ®çš„ max_id ä¼šä» 3000 è¢«æ›´æ–°æˆ 4000ï¼Œæ›´æ–°å·æ®µçš„ SQL è¯­å¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Begin</span></span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">table</span> <span class="keyword">SET</span> max_id=max_id+step <span class="keyword">WHERE</span> biz_tag=xxx</span><br><span class="line"><span class="keyword">SELECT</span> tag, max_id, step <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> biz_tag=xxx</span><br><span class="line"><span class="keyword">Commit</span></span><br></pre></td></tr></table></figure>
<h3 id="ä¼˜ç‚¹-3"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-3"></a> ä¼˜ç‚¹</h3>
<ul>
<li>æ¯”æ•°æ®åº“è‡ªå¢é”®æ€§èƒ½é«˜</li>
<li>èƒ½ä¿è¯é”®è¶‹åŠ¿é€’å¢ã€‚</li>
<li>å¦‚æœæ•°æ®åº“å®•æœºï¼Œç”±äº proxServer æœ‰ç¼“å­˜ï¼Œä¾ç„¶å¯ä»¥åšæŒä¸€æ®µæ—¶é—´ã€‚</li>
</ul>
<h3 id="ç¼ºç‚¹-3"><a class="markdownIt-Anchor" href="#ç¼ºç‚¹-3"></a> ç¼ºç‚¹</h3>
<ul>
<li>å’Œä¸»é”®é€’å¢ä¸€æ ·ï¼Œå®¹æ˜“è¢«äººçŒœæµ‹ã€‚</li>
<li>æ•°æ®åº“å®•æœºåï¼Œè™½ç„¶èƒ½æ”¯æ’‘ä¸€æ®µæ—¶é—´ï¼Œä½†æ˜¯ä»ç„¶ä¼šé€ æˆç³»ç»Ÿä¸å¯ç”¨ã€‚</li>
</ul>
<h3 id="é€‚ç”¨åœºæ™¯-3"><a class="markdownIt-Anchor" href="#é€‚ç”¨åœºæ™¯-3"></a> é€‚ç”¨åœºæ™¯</h3>
<p>éœ€è¦è¶‹åŠ¿é€’å¢ï¼Œå¹¶ä¸” ID å¤§å°å¯æ§åˆ¶çš„ï¼Œå¯ä»¥ä½¿ç”¨è¿™å¥—æ–¹æ¡ˆã€‚</p>
<p>å½“ç„¶è¿™ä¸ªæ–¹æ¡ˆä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›æ‰‹æ®µé¿å…è¢«äººçŒœæµ‹ï¼ŒæŠŠ ID å˜æˆæ˜¯æ— åºçš„ï¼Œæ¯”å¦‚æŠŠæˆ‘ä»¬ç”Ÿæˆçš„æ•°æ®æ˜¯ä¸€ä¸ªé€’å¢çš„ long å‹ï¼ŒæŠŠè¿™ä¸ª Long åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯”å¦‚å¯ä»¥åˆ†æˆå‡ ç»„ä¸‰ä½æ•°ï¼Œå‡ ç»„å››ä½æ•°ï¼Œç„¶ååœ¨å»ºç«‹ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œå°†æˆ‘ä»¬çš„æ•°æ®å˜æˆæ— åºã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md" target="_blank" rel="noopener">ç™¾åº¦åˆ†å¸ƒå¼ ID</a></li>
<li><a href="https://juejin.im/post/5bb0217ef265da0ac2567b42" target="_blank" rel="noopener">å¦‚æœå†æœ‰äººé—®ä½ åˆ†å¸ƒå¼ IDï¼Œè¿™ç¯‡æ–‡ç« ä¸¢ç»™ä»–</a></li>
<li><a href="https://segmentfault.com/a/1190000011282426" target="_blank" rel="noopener">ç†è§£åˆ†å¸ƒå¼ id ç”Ÿæˆç®—æ³• SnowFlake</a></li>
<li><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html" target="_blank" rel="noopener">Leafâ€”â€”ç¾å›¢ç‚¹è¯„åˆ†å¸ƒå¼ ID ç”Ÿæˆç³»ç»Ÿ</a></li>
<li><a href="https://www.ietf.org/rfc/rfc4122.txt" target="_blank" rel="noopener">UUID è§„èŒƒ</a></li>
<li><a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/key-generator/" target="_blank" rel="noopener">ShardingSphere åˆ†å¸ƒå¼ä¸»é”®</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/mq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/mq/" class="post-title-link" itemprop="url">æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬åŸç†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-07-05 15:11:00" itemprop="dateCreated datePublished" datetime="2019-07-05T15:11:00+08:00">2019-07-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/mq/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/mq/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>13 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬åŸç†"></a> æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬åŸç†</h1>
<blockquote>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼Œç®€ç§° MQï¼‰æŠ€æœ¯æ˜¯<strong>åº”ç”¨é—´äº¤æ¢ä¿¡æ¯</strong>çš„ä¸€ç§æŠ€æœ¯ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦è§£å†³å¼‚æ­¥å¤„ç†ã€åº”ç”¨é—´è€¦åˆï¼Œæµé‡å‰Šé”‹ç­‰é—®é¢˜ï¼Œå®ç°é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨ï¼Œå¯ä¼¸ç¼©å’Œæœ€ç»ˆä¸€è‡´æ€§æ¶æ„ã€‚æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯ç¼ºå°‘çš„ä¸­é—´ä»¶ã€‚</p>
<p>ç›®å‰ä¸»æµçš„ MQ æœ‰ï¼šKafkaã€RabbitMQã€RocketMQã€ActiveMQï¼Œè€Œéƒ¨åˆ†æ•°æ®åº“å¦‚ Redisã€MySQL ä»¥åŠ phxsql ä¹Ÿå¯å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ã€‚</p>
<p>æ³¨æ„ï¼š<em>ä¸ºäº†ç®€ä¾¿ï¼Œä¸‹æ–‡ä¸­é™¤äº†æ–‡ç« æ ‡é¢˜ï¼Œä¸€å¾‹ä½¿ç”¨ MQ ç®€ç§°</em>ã€‚</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#1-mq-%E7%9A%84%E7%AE%80%E4%BB%8B">1. MQ çš„ç®€ä»‹</a>
<ul>
<li><a href="#11-%E4%BB%80%E4%B9%88%E6%98%AF-mq">1.1. ä»€ä¹ˆæ˜¯ MQ</a></li>
<li><a href="#12-mq-%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B">1.2. MQ é€šä¿¡æ¨¡å‹</a></li>
</ul>
</li>
<li><a href="#2-mq-%E7%9A%84%E5%BA%94%E7%94%A8">2. MQ çš„åº”ç”¨</a>
<ul>
<li><a href="#21-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86">2.1. å¼‚æ­¥å¤„ç†</a></li>
<li><a href="#22-%E7%B3%BB%E7%BB%9F%E8%A7%A3%E8%80%A6">2.2. ç³»ç»Ÿè§£è€¦</a></li>
<li><a href="#23-%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0">2.3. æµé‡å‰Šå³°</a></li>
<li><a href="#24-%E4%BC%A0%E8%BE%93%E7%BC%93%E5%86%B2">2.4. ä¼ è¾“ç¼“å†²</a></li>
<li><a href="#25-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7">2.5. æœ€ç»ˆä¸€è‡´æ€§</a></li>
<li><a href="#26-%E7%B3%BB%E7%BB%9F%E9%97%B4%E9%80%9A%E4%BF%A1">2.6. ç³»ç»Ÿé—´é€šä¿¡</a></li>
</ul>
</li>
<li><a href="#3-mq-%E7%9A%84%E9%97%AE%E9%A2%98">3. MQ çš„é—®é¢˜</a>
<ul>
<li><a href="#31-%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9">3.1. é‡å¤æ¶ˆè´¹</a></li>
<li><a href="#32-%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1">3.2. æ¶ˆæ¯ä¸¢å¤±</a></li>
<li><a href="#33-%E6%B6%88%E6%81%AF%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%80%A7">3.3. æ¶ˆæ¯çš„é¡ºåºæ€§</a></li>
<li><a href="#34-%E6%B6%88%E6%81%AF%E7%A7%AF%E5%8E%8B">3.4. æ¶ˆæ¯ç§¯å‹</a></li>
</ul>
</li>
<li><a href="#4-mq-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8">4. MQ çš„é«˜å¯ç”¨</a>
<ul>
<li><a href="#41-kafka-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8">4.1. Kafka çš„é«˜å¯ç”¨</a></li>
</ul>
</li>
<li><a href="#5-%E4%B8%BB%E6%B5%81-mq">5. ä¸»æµ MQ</a>
<ul>
<li><a href="#51-activemq">5.1. ActiveMQ</a></li>
<li><a href="#52-rabbitmq">5.2. RabbitMQ</a></li>
<li><a href="#53-rocketmq">5.3. RocketMQ</a></li>
<li><a href="#54-kafka">5.4. Kafka</a></li>
<li><a href="#55-mq-%E7%9A%84%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B">5.5. MQ çš„æŠ€æœ¯é€‰å‹</a></li>
</ul>
</li>
<li><a href="#6-jms">6. JMS</a>
<ul>
<li><a href="#61-%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B">6.1. æ¶ˆæ¯æ¨¡å‹</a></li>
<li><a href="#62-%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9">6.2. æ¶ˆæ¯æ¶ˆè´¹</a></li>
<li><a href="#63-jms-%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%9E%8B">6.3. JMS ç¼–ç¨‹æ¨¡å‹</a></li>
</ul>
</li>
<li><a href="#7-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">7. å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="1-mq-çš„ç®€ä»‹"><a class="markdownIt-Anchor" href="#1-mq-çš„ç®€ä»‹"></a> 1. MQ çš„ç®€ä»‹</h2>
<h3 id="11-ä»€ä¹ˆæ˜¯-mq"><a class="markdownIt-Anchor" href="#11-ä»€ä¹ˆæ˜¯-mq"></a> 1.1. ä»€ä¹ˆæ˜¯ MQ</h3>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼Œç®€ç§° MQï¼‰æŠ€æœ¯æ˜¯åº”ç”¨é—´äº¤æ¢ä¿¡æ¯çš„ä¸€ç§æŠ€æœ¯ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦è§£å†³åº”ç”¨è€¦åˆï¼Œå¼‚æ­¥æ¶ˆæ¯ï¼Œæµé‡å‰Šé”‹ç­‰é—®é¢˜ï¼Œå®ç°é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨ï¼Œå¯ä¼¸ç¼©å’Œæœ€ç»ˆä¸€è‡´æ€§æ¶æ„ã€‚æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯ç¼ºå°‘çš„ä¸­é—´ä»¶ã€‚</p>
<p>MQ æ˜¯æ¶ˆè´¹-ç”Ÿäº§è€…æ¨¡å‹çš„ä¸€ä¸ªå…¸å‹çš„ä»£è¡¨ï¼Œä¸€ç«¯å¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸æ–­å†™å…¥æ¶ˆæ¯ï¼Œè€Œå¦ä¸€ç«¯åˆ™å¯ä»¥è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å‘å¸ƒè€…åªç®¡æŠŠæ¶ˆæ¯å‘å¸ƒåˆ° MQ ä¸­è€Œä¸ç”¨ç®¡è°æ¥å–ï¼Œæ¶ˆæ¯ä½¿ç”¨è€…åªç®¡ä» MQ ä¸­å–æ¶ˆæ¯è€Œä¸ç®¡æ˜¯è°å‘å¸ƒçš„ã€‚è¿™æ ·å‘å¸ƒè€…å’Œä½¿ç”¨è€…éƒ½ä¸ç”¨çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚</p>
<p>MQ çš„æ•°æ®å¯é©»ç•™åœ¨å†…å­˜æˆ–ç£ç›˜ä¸Šï¼Œç›´åˆ°å®ƒä»¬è¢«åº”ç”¨ç¨‹åºè¯»å–ã€‚é€šè¿‡ MQï¼Œåº”ç”¨ç¨‹åºå¯ç‹¬ç«‹åœ°æ‰§è¡Œï¼Œå®ƒä»¬ä¸éœ€è¦çŸ¥é“å½¼æ­¤çš„ä½ç½®ï¼Œä¸éœ€è¦ç­‰å¾…æ¥æ”¶ç¨‹åºæ¥æ”¶æ­¤æ¶ˆæ¯ã€‚åœ¨åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒä¸­ï¼Œä¸ºäº†é›†æˆåˆ†å¸ƒå¼åº”ç”¨ï¼Œå¼€å‘è€…éœ€è¦å¯¹å¼‚æ„ç½‘ç»œç¯å¢ƒä¸‹çš„åˆ†å¸ƒå¼åº”ç”¨æä¾›æœ‰æ•ˆçš„é€šä¿¡æ‰‹æ®µã€‚ä¸ºäº†ç®¡ç†éœ€è¦å…±äº«çš„ä¿¡æ¯ï¼Œå¯¹åº”ç”¨æä¾›å…¬å…±çš„ä¿¡æ¯äº¤æ¢æœºåˆ¶æ˜¯é‡è¦çš„ã€‚</p>
<p>ç›®å‰ä¸»æµçš„ MQ æœ‰ï¼šKafkaã€RabbitMQã€RocketMQã€ActiveMQã€‚</p>
<h3 id="12-mq-é€šä¿¡æ¨¡å‹"><a class="markdownIt-Anchor" href="#12-mq-é€šä¿¡æ¨¡å‹"></a> 1.2. MQ é€šä¿¡æ¨¡å‹</h3>
<p>MQ é€šä¿¡æ¨¡å‹å¤§è‡´æœ‰ä»¥ä¸‹ç±»å‹ï¼š</p>
<ul>
<li><strong>ç‚¹å¯¹ç‚¹</strong> - ç‚¹å¯¹ç‚¹æ–¹å¼æ˜¯æœ€ä¸ºä¼ ç»Ÿå’Œå¸¸è§çš„é€šè®¯æ–¹å¼ï¼Œå®ƒæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šã€å¤šå¯¹ä¸€ç­‰å¤šç§é…ç½®æ–¹å¼ï¼Œæ”¯æŒæ ‘çŠ¶ã€ç½‘çŠ¶ç­‰å¤šç§æ‹“æ‰‘ç»“æ„ã€‚</li>
<li><strong>å¤šç‚¹å¹¿æ’­</strong> - MQ é€‚ç”¨äºä¸åŒç±»å‹çš„åº”ç”¨ã€‚å…¶ä¸­é‡è¦çš„ï¼Œä¹Ÿæ˜¯æ­£åœ¨å‘å±•ä¸­çš„æ˜¯&quot;å¤šç‚¹å¹¿æ’­&quot;åº”ç”¨ï¼Œå³èƒ½å¤Ÿå°†æ¶ˆæ¯å‘é€åˆ°å¤šä¸ªç›®æ ‡ç«™ç‚¹ (Destination List)ã€‚å¯ä»¥ä½¿ç”¨ä¸€æ¡ MQ æŒ‡ä»¤å°†å•ä¸€æ¶ˆæ¯å‘é€åˆ°å¤šä¸ªç›®æ ‡ç«™ç‚¹ï¼Œå¹¶ç¡®ä¿ä¸ºæ¯ä¸€ç«™ç‚¹å¯é åœ°æä¾›ä¿¡æ¯ã€‚MQ ä¸ä»…æä¾›äº†å¤šç‚¹å¹¿æ’­çš„åŠŸèƒ½ï¼Œè€Œä¸”è¿˜æ‹¥æœ‰æ™ºèƒ½æ¶ˆæ¯åˆ†å‘åŠŸèƒ½ï¼Œåœ¨å°†ä¸€æ¡æ¶ˆæ¯å‘é€åˆ°åŒä¸€ç³»ç»Ÿä¸Šçš„å¤šä¸ªç”¨æˆ·æ—¶ï¼ŒMQ å°†æ¶ˆæ¯çš„ä¸€ä¸ªå¤åˆ¶ç‰ˆæœ¬å’Œè¯¥ç³»ç»Ÿä¸Šæ¥æ”¶è€…çš„åå•å‘é€åˆ°ç›®æ ‡ MQ ç³»ç»Ÿã€‚ç›®æ ‡ MQ ç³»ç»Ÿåœ¨æœ¬åœ°å¤åˆ¶è¿™äº›æ¶ˆæ¯ï¼Œå¹¶å°†å®ƒä»¬å‘é€åˆ°åå•ä¸Šçš„é˜Ÿåˆ—ï¼Œä»è€Œå°½å¯èƒ½å‡å°‘ç½‘ç»œçš„ä¼ è¾“é‡ã€‚</li>
<li><strong>å‘å¸ƒ/è®¢é˜… (Publish/Subscribe)</strong> - å‘å¸ƒ/è®¢é˜…æ¨¡å¼ä½¿æ¶ˆæ¯çš„åˆ†å‘å¯ä»¥çªç ´ç›®çš„é˜Ÿåˆ—åœ°ç†ä½ç½®çš„é™åˆ¶ï¼Œä½¿æ¶ˆæ¯æŒ‰ç…§ç‰¹å®šçš„ä¸»é¢˜ç”šè‡³å†…å®¹è¿›è¡Œåˆ†å‘ï¼Œç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®ä¸»é¢˜æˆ–å†…å®¹æ¥æ”¶åˆ°æ‰€éœ€è¦çš„æ¶ˆæ¯ã€‚å‘å¸ƒ/è®¢é˜…æ¨¡å¼ä½¿å¾—å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»å˜å¾—æ›´ä¸ºæ¾æ•£ï¼Œå‘é€è€…ä¸å¿…å…³å¿ƒæ¥æ”¶è€…çš„ç›®çš„åœ°å€ï¼Œè€Œæ¥æ”¶è€…ä¹Ÿä¸å¿…å…³å¿ƒæ¶ˆæ¯çš„å‘é€åœ°å€ï¼Œè€Œåªæ˜¯æ ¹æ®æ¶ˆæ¯çš„ä¸»é¢˜è¿›è¡Œæ¶ˆæ¯çš„æ”¶å‘ã€‚</li>
<li><strong>é›†ç¾¤ (Cluster)</strong> - ä¸ºäº†ç®€åŒ–ç‚¹å¯¹ç‚¹é€šè®¯æ¨¡å¼ä¸­çš„ç³»ç»Ÿé…ç½®ï¼ŒMQ æä¾› Cluster(é›†ç¾¤) çš„è§£å†³æ–¹æ¡ˆã€‚é›†ç¾¤ç±»ä¼¼äºä¸€ä¸ªåŸŸ (Domain)ï¼Œé›†ç¾¤å†…éƒ¨çš„é˜Ÿåˆ—ç®¡ç†å™¨ä¹‹é—´é€šè®¯æ—¶ï¼Œä¸éœ€è¦ä¸¤ä¸¤ä¹‹é—´å»ºç«‹æ¶ˆæ¯é€šé“ï¼Œè€Œæ˜¯é‡‡ç”¨é›†ç¾¤ (Cluster) é€šé“ä¸å…¶å®ƒæˆå‘˜é€šè®¯ï¼Œä»è€Œå¤§å¤§ç®€åŒ–äº†ç³»ç»Ÿé…ç½®ã€‚æ­¤å¤–ï¼Œé›†ç¾¤ä¸­çš„é˜Ÿåˆ—ç®¡ç†å™¨ä¹‹é—´èƒ½å¤Ÿè‡ªåŠ¨è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå½“æŸä¸€é˜Ÿåˆ—ç®¡ç†å™¨å‡ºç°æ•…éšœæ—¶ï¼Œå…¶å®ƒé˜Ÿåˆ—ç®¡ç†å™¨å¯ä»¥æ¥ç®¡å®ƒçš„å·¥ä½œï¼Œä»è€Œå¤§å¤§æé«˜ç³»ç»Ÿçš„é«˜å¯é æ€§ã€‚</li>
</ul>
<h2 id="2-mq-çš„åº”ç”¨"><a class="markdownIt-Anchor" href="#2-mq-çš„åº”ç”¨"></a> 2. MQ çš„åº”ç”¨</h2>
<h3 id="21-å¼‚æ­¥å¤„ç†"><a class="markdownIt-Anchor" href="#21-å¼‚æ­¥å¤„ç†"></a> 2.1. å¼‚æ­¥å¤„ç†</h3>
<blockquote>
<p>MQ å¯ä»¥å°†ç³»ç»Ÿé—´çš„å¤„ç†æµç¨‹å¼‚æ­¥åŒ–ï¼Œå‡å°‘ç­‰å¾…å“åº”çš„æ—¶é—´ï¼Œä»è€Œæé«˜æ•´ä½“å¹¶å‘ååé‡ã€‚</p>
<p>ä¸€èˆ¬ï¼ŒMQ å¼‚æ­¥å¤„ç†åº”ç”¨äºéæ ¸å¿ƒæµç¨‹ï¼Œä¾‹å¦‚ï¼šçŸ­ä¿¡/é‚®ä»¶é€šçŸ¥ã€æ•°æ®æ¨é€ã€ä¸ŠæŠ¥æ•°æ®åˆ°ç›‘æ§ä¸­å¿ƒ/æ—¥å¿—ä¸­å¿ƒç­‰ã€‚</p>
</blockquote>
<p>å‡è®¾è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œç”¨æˆ·å‘ç³»ç»Ÿ A å‘èµ·è¯·æ±‚ï¼Œç³»ç»Ÿ A å¤„ç†è®¡ç®—åªéœ€è¦ 10 msï¼Œç„¶åé€šçŸ¥ç³»ç»Ÿ BCD å†™åº“ï¼Œç³»ç»Ÿ BCD å†™åº“è€—æ—¶åˆ†åˆ«ä¸ºï¼š100msã€200msã€300msã€‚æœ€ç»ˆæ€»è€—æ—¶ä¸ºï¼š 10+100ms+200ms+300ms=610msã€‚æ­¤å¤–ï¼ŒåŠ ä¸Šè¯·æ±‚å’Œå“åº”çš„ç½‘ç»œä¼ è¾“æ—¶é—´ï¼Œä»ç”¨æˆ·è§’åº¦çœ‹ï¼Œå¯èƒ½è¦ç­‰å¾…å°†è¿‘ 1s æ‰èƒ½å¾—åˆ°ç»“æœã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/design/theory/mq/mq_3.png" alt="img" /></p>
<p>å¦‚æœä½¿ç”¨ MQï¼Œç³»ç»Ÿ A æ¥åˆ°è¯·æ±‚åï¼Œè€—æ—¶ 10ms å¤„ç†è®¡ç®—ï¼Œç„¶åå‘ç³»ç»Ÿ BCD è¿ç»­å‘é€æ¶ˆæ¯ï¼Œå‡è®¾è€—æ—¶ 5msã€‚é‚£ä¹ˆ è¿™ä¸€è¿‡ç¨‹çš„æ€»è€—æ—¶ä¸º 3ms + 5ms = 8msï¼Œè¿™ç›¸æ¯”äº 610 msï¼Œå¤§å¤§ç¼©çŸ­äº†å“åº”æ—¶é—´ã€‚è‡³äºç³»ç»Ÿ BCD çš„å†™åº“æ“ä½œï¼Œåªè¦è‡ªè¡Œæ¶ˆè´¹ MQ åå¤„ç†å³å¯ï¼Œç”¨æˆ·æ— éœ€å…³æ³¨ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/design/theory/mq/mq_4.png" alt="img" /></p>
<h3 id="22-ç³»ç»Ÿè§£è€¦"><a class="markdownIt-Anchor" href="#22-ç³»ç»Ÿè§£è€¦"></a> 2.2. ç³»ç»Ÿè§£è€¦</h3>
<blockquote>
<p>é€šè¿‡ MQï¼Œå¯ä»¥æ¶ˆé™¤ç³»ç»Ÿé—´çš„å¼ºè€¦åˆã€‚å®ƒçš„å¥½å¤„åœ¨äºï¼š</p>
<ul>
<li>æ¶ˆæ¯çš„æ¶ˆè´¹è€…ç³»ç»Ÿå¯ä»¥éšæ„å¢åŠ ï¼Œæ— éœ€ä¿®æ”¹ç”Ÿäº§è€…ç³»ç»Ÿçš„ä»£ç ã€‚</li>
<li>ç”Ÿäº§è€…ç³»ç»Ÿã€æ¶ˆè´¹è€…ç³»ç»Ÿå½¼æ­¤ä¸ä¼šå½±å“å¯¹æ–¹çš„æµç¨‹ã€‚
<ul>
<li>å¦‚æœç”Ÿäº§è€…ç³»ç»Ÿå®•æœºï¼Œæ¶ˆè´¹è€…ç³»ç»Ÿæ”¶ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ä¸ä¼šæœ‰ä¸‹ä¸€æ­¥çš„åŠ¨ä½œã€‚</li>
<li>å¦‚æœæ¶ˆè´¹è€…ç³»ç»Ÿå®•æœºï¼Œç”Ÿäº§è€…ç³»ç»Ÿè®©ç„¶å¯ä»¥æ­£å¸¸å‘é€æ¶ˆæ¯ï¼Œä¸å½±å“æµç¨‹ã€‚</li>
</ul>
</li>
</ul>
</blockquote>
<p>ä¸åŒç³»ç»Ÿå¦‚æœè¦å»ºç«‹é€šä¿¡ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯ï¼šè°ƒç”¨æ¥å£ã€‚</p>
<p>å¦‚æœéœ€è¦å’Œæ–°çš„ç³»ç»Ÿå»ºç«‹é€šä¿¡æˆ–åˆ é™¤å·²å»ºç«‹çš„é€šä¿¡ï¼Œéƒ½éœ€è¦ä¿®æ”¹ä»£ç ï¼Œè¿™ç§æ–¹æ¡ˆæ˜¾ç„¶è€¦åˆåº¦å¾ˆé«˜ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/design/theory/mq/mq_1.png" alt="img" /></p>
<p>å¦‚æœä½¿ç”¨ MQï¼Œç³»ç»Ÿé—´çš„é€šä¿¡åªéœ€è¦é€šè¿‡å‘å¸ƒ/è®¢é˜…ï¼ˆPub/Subï¼‰æ¨¡å‹å³å¯ï¼Œå½¼æ­¤æ²¡æœ‰ç›´æ¥è”ç³»ï¼Œä¹Ÿå°±ä¸éœ€è¦ç›¸äº’æ„ŸçŸ¥ï¼Œä»è€Œè¾¾åˆ° <strong>è§£è€¦</strong>ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/design/theory/mq/mq_2.png" alt="img" /></p>
<h3 id="23-æµé‡å‰Šå³°"><a class="markdownIt-Anchor" href="#23-æµé‡å‰Šå³°"></a> 2.3. æµé‡å‰Šå³°</h3>
<blockquote>
<p>å½“ <strong>ä¸Šä¸‹æ¸¸ç³»ç»Ÿ</strong> å¤„ç†èƒ½åŠ›å­˜åœ¨å·®è·çš„æ—¶å€™ï¼Œåˆ©ç”¨ MQ åšä¸€ä¸ª â€œ<strong>æ¼æ–—</strong>â€ æ¨¡å‹ï¼Œè¿›è¡Œ <strong>æµæ§</strong>ã€‚æŠŠ MQ å½“æˆå¯é çš„ <strong>æ¶ˆæ¯æš‚å­˜åœ°</strong>ï¼Œè¿›è¡Œä¸€å®šç¨‹åº¦çš„ <strong>æ¶ˆæ¯å †ç§¯</strong>ï¼›åœ¨ä¸‹æ¸¸æœ‰èƒ½åŠ›å¤„ç†çš„æ—¶å€™ï¼Œå†å‘é€æ¶ˆæ¯ã€‚</p>
<p>MQ çš„æµé‡å‰Šå³°å¸¸ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼ˆä¾‹å¦‚ï¼šç§’æ€ã€å›¢æŠ¢ç­‰ä¸šåŠ¡åœºæ™¯ï¼‰ï¼Œå®ƒæ˜¯ç¼“è§£ç¬æ—¶æš´å¢æµé‡çš„æ ¸å¿ƒæ‰‹æ®µä¹‹ä¸€ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ MQï¼Œä¸¤ä¸ªç³»ç»Ÿä¹‹é—´é€šè¿‡ <strong>åå•†</strong>ã€<strong>æ»‘åŠ¨çª—å£</strong>ã€<strong>é™æµ</strong>/<strong>é™çº§</strong>/<strong>ç†”æ–­</strong> ç­‰å¤æ‚çš„æ–¹æ¡ˆä¹Ÿèƒ½å®ç° <strong>æµæ§</strong>ã€‚ä½† <strong>ç³»ç»Ÿå¤æ‚æ€§</strong> æŒ‡æ•°çº§å¢é•¿ï¼ŒåŠ¿å¿…åœ¨ä¸Šæ¸¸æˆ–è€…ä¸‹æ¸¸åšå­˜å‚¨ï¼Œå¹¶ä¸”è¦å¤„ç† <strong>å®šæ—¶</strong>ã€<strong>æ‹¥å¡</strong> ç­‰ä¸€ç³»åˆ—é—®é¢˜ã€‚è€Œä¸”æ¯å½“æœ‰ <strong>å¤„ç†èƒ½åŠ›æœ‰å·®è·</strong> çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ <strong>å•ç‹¬</strong> å¼€å‘ä¸€å¥—é€»è¾‘æ¥ç»´æŠ¤è¿™å¥—é€»è¾‘ã€‚</p>
</blockquote>
<p>å‡è®¾æŸä¸ªç³»ç»Ÿè¯»å†™æ•°æ®åº“çš„ç¨³å®šæ€§èƒ½ä¸ºæ¯ç§’å¤„ç† 1000 æ¡æ•°æ®ã€‚å¹³å¸¸æƒ…å†µä¸‹ï¼Œè¿œè¿œè¾¾ä¸åˆ°è¿™ä¹ˆå¤§çš„å¤„ç†é‡ã€‚å‡è®¾ï¼Œå› ä¸ºå› ä¸ºåšæ´»åŠ¨ï¼Œç³»ç»Ÿçš„ç¬æ—¶è¯·æ±‚é‡å‰§å¢ï¼Œè¾¾åˆ°æ¯ç§’ 10000 ä¸ªå¹¶å‘è¯·æ±‚ï¼Œæ•°æ®åº“æ ¹æœ¬æ‰¿å—ä¸äº†ï¼Œå¯èƒ½ç›´æ¥å°±æŠŠæ•°æ®åº“ç»™æ•´å´©æºƒäº†ï¼Œè¿™æ ·ç³»ç»ŸæœåŠ¡å°±ä¸å¯ç”¨äº†ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/design/theory/mq/mq_5.png" alt="img" /></p>
<p>å¦‚æœä½¿ç”¨ MQï¼Œæ¯ç§’å†™å…¥ 10000 æ¡è¯·æ±‚ï¼Œä½†æ˜¯ç³»ç»Ÿ A æ¯ç§’åªä» MQ ä¸­æ¶ˆè´¹ 1000 æ¡è¯·æ±‚ï¼Œç„¶åå†™å…¥æ•°æ®åº“ã€‚è¿™æ ·ï¼Œå°±ä¸ä¼šè¶…è¿‡æ•°æ®åº“çš„æ‰¿å—èƒ½åŠ›ï¼Œè€Œæ˜¯æŠŠè¯·æ±‚ç§¯å‹åœ¨ MQ ä¸­ã€‚åªè¦é«˜å³°æœŸä¸€è¿‡ï¼Œç³»ç»Ÿ A å°±ä¼šå¾ˆå¿«æŠŠç§¯å‹çš„æ¶ˆæ¯ç»™å¤„ç†æ‰ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/design/theory/mq/mq_6.png" alt="img" /></p>
<h3 id="24-ä¼ è¾“ç¼“å†²"><a class="markdownIt-Anchor" href="#24-ä¼ è¾“ç¼“å†²"></a> 2.4. ä¼ è¾“ç¼“å†²</h3>
<p>ï¼ˆ1ï¼‰MQ å¸¸è¢«ç”¨äºåšæµ·é‡æ•°æ®çš„ä¼ è¾“ç¼“å†²ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒKafka å¸¸è¢«ç”¨äºåšä¸ºå„ç§æ—¥å¿—æ•°æ®ã€é‡‡é›†æ•°æ®çš„æ•°æ®ä¸­è½¬ã€‚ç„¶åï¼ŒKafka å°†æ•°æ®è½¬å‘ç»™ Logstashã€Elasticsearch ä¸­ï¼Œç„¶ååŸºäº Elasticsearch æ¥åšæ—¥å¿—ä¸­å¿ƒï¼Œæä¾›æ£€ç´¢ã€èšåˆã€åˆ†ææ—¥å¿—çš„èƒ½åŠ›ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ Kibana é›†æˆ Elasticsearch æ•°æ®è¿›è¡Œå¯è§†åŒ–å±•ç¤ºï¼Œæˆ–è‡ªè¡Œè¿›è¡Œå®šåˆ¶åŒ–å¼€å‘ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200930164342.png" alt="img" /></p>
<p>ï¼ˆ2ï¼‰MQ ä¹Ÿå¯ä»¥è¢«ç”¨äºæµå¼å¤„ç†ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒKafka å‡ ä¹å·²ç»æ˜¯æµè®¡ç®—çš„æ•°æ®é‡‡é›†ç«¯çš„æ ‡å‡†ç»„ä»¶ã€‚è€Œæµè®¡ç®—é€šè¿‡å®æ—¶æ•°æ®å¤„ç†èƒ½åŠ›ï¼Œæä¾›äº†æ›´ä¸ºå¿«æ·çš„èšåˆè®¡ç®—èƒ½åŠ›ï¼Œè¢«å¤§é‡åº”ç”¨äºé“¾è·¯ç›‘æ§ã€å®æ—¶ç›‘æ§ã€å®æ—¶æ•°ä»“ã€å®æ—¶å¤§å±ã€é£æ§ã€æ¨èç­‰åº”ç”¨é¢†åŸŸã€‚</p>
<h3 id="25-æœ€ç»ˆä¸€è‡´æ€§"><a class="markdownIt-Anchor" href="#25-æœ€ç»ˆä¸€è‡´æ€§"></a> 2.5. æœ€ç»ˆä¸€è‡´æ€§</h3>
<p><strong>æœ€ç»ˆä¸€è‡´æ€§</strong> ä¸æ˜¯ <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong> çš„å¿…å¤‡ç‰¹æ€§ï¼Œä½†ç¡®å®å¯ä»¥ä¾é  <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong> æ¥åš <strong>æœ€ç»ˆä¸€è‡´æ€§</strong> çš„äº‹æƒ…ã€‚</p>
<ul>
<li><strong>å…ˆå†™æ¶ˆæ¯å†æ“ä½œ</strong>ï¼Œç¡®ä¿æ“ä½œå®Œæˆåå†ä¿®æ”¹æ¶ˆæ¯çŠ¶æ€ã€‚<strong>å®šæ—¶ä»»åŠ¡è¡¥å¿æœºåˆ¶</strong> å®ç°æ¶ˆæ¯ <strong>å¯é å‘é€æ¥æ”¶</strong>ã€ä¸šåŠ¡æ“ä½œçš„å¯é æ‰§è¡Œï¼Œè¦æ³¨æ„ <strong>æ¶ˆæ¯é‡å¤</strong> ä¸ <strong>å¹‚ç­‰è®¾è®¡</strong>ã€‚</li>
<li>æ‰€æœ‰ä¸ä¿è¯ <code>100%</code> <strong>ä¸ä¸¢æ¶ˆæ¯</strong> çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç†è®ºä¸Šæ— æ³•å®ç° <strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</li>
</ul>
<blockquote>
<p>åƒ <code>Kafka</code> ä¸€ç±»çš„è®¾è®¡ï¼Œåœ¨è®¾è®¡å±‚é¢ä¸Šå°±æœ‰ <strong>ä¸¢æ¶ˆæ¯</strong> çš„å¯èƒ½ï¼ˆæ¯”å¦‚ <strong>å®šæ—¶åˆ·ç›˜</strong>ï¼Œå¦‚æœæ‰ç”µå°±ä¼šä¸¢æ¶ˆæ¯ï¼‰ã€‚å“ªæ€•åªä¸¢åƒåˆ†ä¹‹ä¸€çš„æ¶ˆæ¯ï¼Œä¸šåŠ¡ä¹Ÿå¿…é¡»ç”¨å…¶ä»–çš„æ‰‹æ®µæ¥ä¿è¯ç»“æœæ­£ç¡®ã€‚</p>
</blockquote>
<h3 id="26-ç³»ç»Ÿé—´é€šä¿¡"><a class="markdownIt-Anchor" href="#26-ç³»ç»Ÿé—´é€šä¿¡"></a> 2.6. ç³»ç»Ÿé—´é€šä¿¡</h3>
<p>æ¶ˆæ¯é˜Ÿåˆ—ä¸€èˆ¬éƒ½å†…ç½®äº† <strong>é«˜æ•ˆçš„é€šä¿¡æœºåˆ¶</strong>ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨äºå•çº¯çš„ <strong>æ¶ˆæ¯é€šè®¯</strong>ï¼Œæ¯”å¦‚å®ç° <strong>ç‚¹å¯¹ç‚¹æ¶ˆæ¯é˜Ÿåˆ—</strong> æˆ–è€… <strong>èŠå¤©å®¤</strong> ç­‰ã€‚</p>
<p><strong>ç”Ÿäº§è€…/æ¶ˆè´¹è€…</strong> æ¨¡å¼ï¼Œåªéœ€è¦å…³å¿ƒæ¶ˆæ¯æ˜¯å¦ <strong>é€è¾¾é˜Ÿåˆ—</strong>ï¼Œè‡³äºè°å¸Œæœ›è®¢é˜…å’Œéœ€è¦æ¶ˆè´¹ï¼Œæ˜¯ <strong>ä¸‹æ¸¸</strong> çš„äº‹æƒ…ï¼Œæ— ç–‘æå¤§åœ°å‡å°‘äº†å¼€å‘å’Œè”è°ƒçš„å·¥ä½œé‡ã€‚</p>
<h2 id="3-mq-çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#3-mq-çš„é—®é¢˜"></a> 3. MQ çš„é—®é¢˜</h2>
<p>ä»»ä½•æŠ€æœ¯éƒ½ä¼šæœ‰åˆ©æœ‰å¼Šï¼ŒMQ ç»™æ•´ä½“ç³»ç»Ÿæ¶æ„å¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼Œä½†ä¹Ÿä¼šä»˜å‡ºä¸€å®šçš„ä»£ä»·ã€‚</p>
<p>MQ ä¸»è¦å¼•å…¥äº†ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li><strong>ç³»ç»Ÿå¯ç”¨æ€§é™ä½</strong>ï¼šå¼•å…¥äº† MQ åï¼Œé€šä¿¡éœ€è¦åŸºäº MQ å®Œæˆï¼Œå¦‚æœ MQ å®•æœºï¼Œåˆ™æœåŠ¡ä¸å¯ç”¨ã€‚å› æ­¤ï¼ŒMQ è¦ä¿è¯æ˜¯é«˜å¯ç”¨çš„ï¼Œè¯¦æƒ…å‚è€ƒï¼š<a href="#MQ-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8">MQ çš„é«˜å¯ç”¨</a></li>
<li><strong>ç³»ç»Ÿå¤æ‚åº¦æé«˜</strong>ï¼šä½¿ç”¨ MQï¼Œéœ€è¦å…³æ³¨ä¸€äº›æ–°çš„é—®é¢˜ï¼š
<ul>
<li>å¦‚ä½•ä¿è¯æ¶ˆæ¯æ²¡æœ‰ <strong>é‡å¤æ¶ˆè´¹</strong>ï¼Ÿ</li>
<li>å¦‚ä½•å¤„ç† <strong>æ¶ˆæ¯ä¸¢å¤±</strong> çš„é—®é¢˜ï¼Ÿ</li>
<li>å¦‚ä½•ä¿è¯ä¼ é€’ <strong>æ¶ˆæ¯çš„é¡ºåºæ€§</strong>ï¼Ÿ</li>
<li>å¦‚ä½•å¤„ç†å¤§é‡ <strong>æ¶ˆæ¯ç§¯å‹</strong> çš„é—®é¢˜ï¼Ÿ</li>
</ul>
</li>
<li><strong>ä¸€è‡´æ€§é—®é¢˜</strong>ï¼šå‡è®¾ç³»ç»Ÿ A å¤„ç†å®Œç›´æ¥è¿”å›æˆåŠŸçš„ç»“æœç»™ç”¨æˆ·ï¼Œç”¨æˆ·è®¤ä¸ºè¯·æ±‚æˆåŠŸã€‚ä½†å¦‚æœæ­¤æ—¶ï¼Œç³»ç»Ÿ BCD ä¸­åªè¦æœ‰ä»»æ„ä¸€ä¸ªå†™åº“å¤±è´¥ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚è¿™ç§æƒ…å†µå¦‚ä½•å¤„ç†ï¼Ÿ</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é’ˆå¯¹ä»¥ä¸Šé—®é¢˜æ¥ä¸€ä¸€åˆ†æã€‚</p>
<h3 id="31-é‡å¤æ¶ˆè´¹"><a class="markdownIt-Anchor" href="#31-é‡å¤æ¶ˆè´¹"></a> 3.1. é‡å¤æ¶ˆè´¹</h3>
<p><strong>å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹</strong> å’Œ <strong>å¦‚ä½•ä¿è¯æ¶ˆæ¯æ¶ˆè´¹çš„å¹‚ç­‰æ€§</strong> æ˜¯åŒä¸€ä¸ªé—®é¢˜ã€‚</p>
<p>å¿…é¡»å…ˆæ˜ç¡®äº§ç”Ÿé‡å¤æ¶ˆè´¹çš„åŸå› ï¼Œæ‰èƒ½å¯¹ç—‡ä¸‹è¯ã€‚</p>
<h4 id="é‡å¤æ¶ˆè´¹é—®é¢˜åŸå› "><a class="markdownIt-Anchor" href="#é‡å¤æ¶ˆè´¹é—®é¢˜åŸå› "></a> é‡å¤æ¶ˆè´¹é—®é¢˜åŸå› </h4>
<p>é‡å¤æ¶ˆè´¹é—®é¢˜é€šå¸¸ä¸æ˜¯ MQ æ¥å¤„ç†ï¼Œè€Œæ˜¯ç”±å¼€å‘æ¥å¤„ç†çš„ã€‚</p>
<p>ä»¥ Kafka ä¸¾ä¾‹ï¼ŒKafka æ¯ä¸ª Partition éƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„ã€ä¸å¯å˜çš„è®°å½•åºåˆ—ï¼Œä¸æ–­è¿½åŠ åˆ°ç»“æ„åŒ–çš„æäº¤æ—¥å¿—ä¸­ã€‚Partition ä¸­ä¸ºæ¯æ¡è®°å½•åˆ†é…ä¸€ä¸ªè¿ç»­çš„ id å·ï¼Œç§°ä¸ºåç§»é‡ï¼ˆOffsetï¼‰ï¼Œç”¨äºå”¯ä¸€æ ‡è¯† Partition å†…çš„è®°å½•ã€‚</p>
<p>Kafka çš„å®¢æˆ·ç«¯å’Œ Broker éƒ½ä¼šä¿å­˜ Offsetã€‚å®¢æˆ·ç«¯æ¶ˆè´¹æ¶ˆæ¯åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œå°±æŠŠå·²æ¶ˆè´¹çš„ Offset æäº¤ç»™ Kafka Brokerï¼Œè¡¨ç¤ºå·²æ¶ˆè´¹ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200930154152.png" alt="img" /></p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯åº”ç”¨æ¶ˆè´¹æ¶ˆæ¯åï¼Œå› ä¸ºå®•æœºã€é‡å¯ç­‰æƒ…å†µè€Œæ²¡æœ‰æäº¤å·²æ¶ˆè´¹çš„ Offset ã€‚å½“ç³»ç»Ÿæ¢å¤åï¼Œä¼šç»§ç»­æ¶ˆè´¹æ¶ˆæ¯ï¼Œç”±äº Offset æœªæäº¤ï¼Œå°±ä¼šå‡ºç°é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚</p>
<h4 id="é‡å¤æ¶ˆè´¹è§£å†³æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#é‡å¤æ¶ˆè´¹è§£å†³æ–¹æ¡ˆ"></a> é‡å¤æ¶ˆè´¹è§£å†³æ–¹æ¡ˆ</h4>
<p>åº”å¯¹é‡å¤æ¶ˆè´¹é—®é¢˜ï¼Œéœ€è¦åœ¨ä¸šåŠ¡å±‚é¢ï¼Œé€šè¿‡ <strong>å¹‚ç­‰æ€§è®¾è®¡</strong> æ¥è§£å†³ã€‚</p>
<p>MQ é‡å¤æ¶ˆè´¹ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯æ²¡æœ‰åº”å¯¹æœºåˆ¶ï¼Œå¯ä»¥å€Ÿé‰´çš„æ€è·¯æœ‰ï¼š</p>
<ul>
<li>å¦‚æœæ˜¯å†™å…³ç³»å‹æ•°æ®åº“ï¼Œå¯ä»¥å…ˆæ ¹æ®ä¸»é”®æŸ¥è¯¢ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦å·²å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥ï¼›</li>
<li>å¦‚æœæ˜¯å†™ Redisï¼Œç”±äº set æ“ä½œå¤©ç„¶å…·æœ‰å¹‚ç­‰æ€§ï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½ä¸ç”¨åšï¼›</li>
<li>å¦‚æœæ˜¯æ ¹æ®æ¶ˆæ¯åšè¾ƒå¤æ‚çš„é€»è¾‘å¤„ç†ï¼Œå¯ä»¥åœ¨æ¶ˆæ¯ä¸­åŠ å…¥å…¨å±€å”¯ä¸€ IDï¼Œä¾‹å¦‚ï¼šè®¢å• ID ç­‰ã€‚åœ¨å®¢æˆ·ç«¯å­˜å‚¨ä¸­ï¼ˆMysqlã€Redis ç­‰ï¼‰ä¿å­˜å·²æ¶ˆè´¹æ¶ˆæ¯çš„ IDã€‚ä¸€æ—¦æ¥å—åˆ°æ–°æ¶ˆæ¯ï¼Œå…ˆåˆ¤æ–­æ¶ˆæ¯ä¸­çš„ ID æ˜¯å¦åœ¨å·²æ¶ˆè´¹æ¶ˆæ¯ ID è¡¨ä¸­å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ä¸å†å¤„ç†ï¼Œä¸å­˜åœ¨åˆ™å¤„ç†ã€‚</li>
</ul>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯ä»¥å‚è€ƒä¸Šé¢çš„ä¾‹å­ï¼Œç»“åˆç°å®åœºæ™¯ï¼Œè®¾è®¡åˆç†çš„å¹‚ç­‰æ€§æ–¹æ¡ˆã€‚</p>
<h3 id="32-æ¶ˆæ¯ä¸¢å¤±"><a class="markdownIt-Anchor" href="#32-æ¶ˆæ¯ä¸¢å¤±"></a> 3.2. æ¶ˆæ¯ä¸¢å¤±</h3>
<p><strong>å¦‚ä½•å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜</strong> å’Œ <strong>å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹</strong> æ˜¯åŒä¸€ä¸ªé—®é¢˜ã€‚å…³æ³¨ç‚¹æœ‰ï¼š</p>
<ul>
<li>MQ Server ä¸¢å¤±æ•°æ®</li>
<li>æ¶ˆè´¹æ–¹ä¸¢å¤±æ•°æ®</li>
<li>ç”Ÿäº§æ–¹ä¸¢å¤±æ•°æ®</li>
</ul>
<h4 id="æ¶ˆè´¹æ–¹ä¸¢å¤±æ•°æ®"><a class="markdownIt-Anchor" href="#æ¶ˆè´¹æ–¹ä¸¢å¤±æ•°æ®"></a> æ¶ˆè´¹æ–¹ä¸¢å¤±æ•°æ®</h4>
<p>å”¯ä¸€å¯èƒ½å¯¼è‡´æ¶ˆè´¹æ–¹ä¸¢å¤±æ•°æ®çš„æƒ…å†µæ˜¯ï¼šæ¶ˆè´¹æ–¹è®¾ç½®äº†<strong>è‡ªåŠ¨æäº¤ Offset</strong>ã€‚ä¸€æ—¦è®¾ç½®äº†è‡ªåŠ¨æäº¤ Offsetï¼Œæ¥å—åˆ°æ¶ˆæ¯åå°±ä¼šè‡ªåŠ¨æäº¤ Offset ç»™ Kafka ï¼ŒKafka å°±è®¤ä¸ºæ¶ˆæ¯å·²è¢«æ¶ˆè´¹ã€‚å¦‚æœæ­¤æ—¶ï¼Œæ¶ˆè´¹æ–¹å°šæœªæ¥å¾—åŠå¤„ç†æ¶ˆæ¯å°±æŒ‚äº†ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¸¢äº†ã€‚</p>
<p>è§£å†³æ–¹æ³•å°±æ˜¯ï¼šæ¶ˆè´¹æ–¹å…³é—­è‡ªåŠ¨æäº¤ Offsetï¼Œå¤„ç†å®Œæ¶ˆæ¯å<strong>æ‰‹åŠ¨æäº¤ Offset</strong>ã€‚ä½†è¿™ç§æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°é‡å¤æ¶ˆè´¹çš„æƒ…å½¢ï¼Œéœ€è¦è‡ªè¡Œä¿è¯å¹‚ç­‰æ€§ã€‚</p>
<h4 id="kafka-server-ä¸¢å¤±æ•°æ®"><a class="markdownIt-Anchor" href="#kafka-server-ä¸¢å¤±æ•°æ®"></a> Kafka Server ä¸¢å¤±æ•°æ®</h4>
<p>å½“ Kafka æŸä¸ª Broker å®•æœºï¼Œéœ€è¦é‡æ–°é€‰ä¸¾ Partition çš„ Leaderã€‚è‹¥æ­¤æ—¶å…¶ä»–çš„ Follower å°šæœªåŒæ­¥ Leader çš„æ•°æ®ï¼Œé‚£ä¹ˆæ–°é€‰æŸä¸ª Follower ä¸º Leader åï¼Œå°±ä¸¢å¤±äº†éƒ¨åˆ†æ•°æ®ã€‚</p>
<p>ä¸ºæ­¤ï¼Œä¸€èˆ¬è¦æ±‚è‡³å°‘è®¾ç½® 4 ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>ç»™ Topic è®¾ç½® <code>replication.factor</code> å‚æ•° - è¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¦æ±‚æ¯ä¸ª Partition å¿…é¡»æœ‰è‡³å°‘ 2 ä¸ªå‰¯æœ¬ã€‚</li>
<li>åœ¨ Kafka æœåŠ¡ç«¯è®¾ç½® <code>min.insync.replicas</code> å‚æ•° - è¿™ä¸ªå€¼å¿…é¡»å¤§äº 1ï¼Œè¿™æ˜¯è¦æ±‚ä¸€ä¸ª Leader éœ€è¦å’Œè‡³å°‘ä¸€ä¸ª Follower ä¿æŒé€šä¿¡ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ Leader æŒ‚äº†è¿˜æœ‰æ›¿è¡¥ã€‚</li>
<li>åœ¨ Producer ç«¯è®¾ç½® <code>acks=all</code> - è¿™æ„å‘³ç€ï¼šè¦æ±‚æ¯æ¡æ•°æ®ï¼Œå¿…é¡»æ˜¯<strong>å†™å…¥æ‰€æœ‰ replica ä¹‹åï¼Œæ‰èƒ½è®¤ä¸ºå†™å…¥æˆåŠŸäº†</strong>ã€‚</li>
<li>åœ¨ Producer ç«¯è®¾ç½® <code>retries=MAX</code>ï¼ˆå¾ˆå¤§å¾ˆå¤§å¾ˆå¤§çš„ä¸€ä¸ªå€¼ï¼Œæ— é™æ¬¡é‡è¯•çš„æ„æ€ï¼‰ - è¿™æ„å‘³ç€<strong>è¦æ±‚ä¸€æ—¦å†™å…¥å¤±è´¥ï¼Œå°±æ— é™é‡è¯•</strong>ï¼Œå¡åœ¨è¿™é‡Œäº†ã€‚</li>
</ul>
<h4 id="ç”Ÿäº§æ–¹ä¸¢å¤±æ•°æ®"><a class="markdownIt-Anchor" href="#ç”Ÿäº§æ–¹ä¸¢å¤±æ•°æ®"></a> ç”Ÿäº§æ–¹ä¸¢å¤±æ•°æ®</h4>
<p>å¦‚æœæŒ‰ç…§ä¸Šè¿°çš„æ€è·¯è®¾ç½®äº† <code>acks=all</code>ï¼Œç”Ÿäº§æ–¹ä¸€å®šä¸ä¼šä¸¢æ•°æ®ã€‚</p>
<p>è¦æ±‚æ˜¯ï¼Œä½ çš„ Leader æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€æœ‰çš„ Follower éƒ½åŒæ­¥åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œæ‰è®¤ä¸ºæœ¬ç”Ÿäº§æ¶ˆæ¯æˆåŠŸäº†ã€‚å¦‚æœæœªæ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨ä¸æ–­çš„é‡è¯•ï¼Œé‡è¯•æ— é™æ¬¡ã€‚</p>
<h3 id="33-æ¶ˆæ¯çš„é¡ºåºæ€§"><a class="markdownIt-Anchor" href="#33-æ¶ˆæ¯çš„é¡ºåºæ€§"></a> 3.3. æ¶ˆæ¯çš„é¡ºåºæ€§</h3>
<p>è¦ä¿è¯ MQ çš„é¡ºåºæ€§ï¼ŒåŠ¿å¿…è¦ä»˜å‡ºä¸€å®šçš„ä»£ä»·ï¼Œæ‰€ä»¥å®æ–½æ–¹æ¡ˆå‰ï¼Œè¦å…ˆæ˜ç¡®ä¸šåŠ¡åœºæ™¯æ˜¯ä¸æ˜¯æœ‰å¿…è¦ä¿è¯æ¶ˆæ¯çš„é¡ºåºæ€§ã€‚åªæœ‰é‚£äº›æ˜ç¡®å¯¹æ¶ˆæ¯å¤„ç†é¡ºåºæœ‰è¦æ±‚çš„ä¸šåŠ¡åœºæ™¯æ‰å€¼å¾—å»ä¿è¯æ¶ˆæ¯é¡ºåºæ€§ã€‚</p>
<p>æ–¹æ¡ˆä¸€</p>
<p>ä¸€ä¸ª Topicï¼Œä¸€ä¸ª Partitionï¼Œä¸€ä¸ª Consumerï¼Œå†…éƒ¨å•çº¿ç¨‹æ¶ˆè´¹ï¼Œå•çº¿ç¨‹ååé‡å¤ªä½ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªã€‚</p>
<p>æ–¹æ¡ˆäºŒ</p>
<ul>
<li>å†™å…¥æ•°æ®åˆ° Partition æ—¶æŒ‡å®šä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼Œä¾‹å¦‚è®¢å• IDã€‚å‘é€æ–¹ä¿è¯ç›¸åŒ ID çš„æ¶ˆæ¯æœ‰åºçš„å‘é€åˆ°åŒä¸€ä¸ª Partitionã€‚</li>
<li>åŸºäºä¸Šä¸€ç‚¹ï¼Œæ¶ˆè´¹æ–¹ä» Kafka Partition ä¸­æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œæ­¤åˆ»ä¸€å®šæ˜¯é¡ºåºçš„ã€‚ä½†å¦‚æœæ¶ˆè´¹æ–¹å¼ä»¥å¹¶å‘æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯ï¼Œé¡ºåºå°±å¯èƒ½ä¼šè¢«æ‰“ä¹±ã€‚ä¸ºæ­¤ï¼Œè¿˜æœ‰åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š
<ul>
<li>æ¶ˆè´¹æ–¹ç»´æŠ¤ N ä¸ªç¼“å­˜é˜Ÿåˆ—ï¼Œå…·æœ‰ç›¸åŒ ID çš„æ•°æ®éƒ½å†™å…¥åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼›</li>
<li>åˆ›å»º N ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åªè´Ÿè´£ä»æŒ‡å®šçš„ä¸€ä¸ªé˜Ÿåˆ—ä¸­å–æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<p><img src="http://dunwu.test.upcdn.net/cs/design/theory/mq/mq_7.png" alt="img" /></p>
<h3 id="34-æ¶ˆæ¯ç§¯å‹"><a class="markdownIt-Anchor" href="#34-æ¶ˆæ¯ç§¯å‹"></a> 3.4. æ¶ˆæ¯ç§¯å‹</h3>
<p>å‡è®¾ä¸€ä¸ª MQ æ¶ˆè´¹è€…å¯ä»¥ä¸€ç§’å¤„ç† 1000 æ¡æ¶ˆæ¯ï¼Œä¸‰ä¸ª MQ æ¶ˆè´¹è€…å¯ä»¥ä¸€ç§’å¤„ç† 3000 æ¡æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¸€åˆ†é’Ÿçš„å¤„ç†é‡æ˜¯ 18 ä¸‡æ¡ã€‚å¦‚æœ MQ ä¸­ç§¯å‹äº†å‡ ç™¾ä¸‡åˆ°ä¸Šåƒä¸‡çš„æ•°æ®ï¼Œå³ä½¿æ¶ˆè´¹è€…æ¢å¤äº†ï¼Œä¹Ÿéœ€è¦å¤§æ¦‚å¾ˆé•¿çš„æ—¶é—´æ‰èƒ½æ¢å¤è¿‡æ¥ã€‚</p>
<p>å¯¹äºäº§çº¿ç¯å¢ƒæ¥è¯´ï¼Œæ¼«é•¿çš„ç­‰å¾…æ˜¯ä¸å¯æ¥å—çš„ï¼Œæ‰€ä»¥é¢ä¸´è¿™ç§çª˜å¢ƒæ—¶ï¼Œåªèƒ½ä¸´æ—¶ç´§æ€¥æ‰©å®¹ä»¥åº”å¯¹äº†ï¼Œå…·ä½“æ“ä½œæ­¥éª¤å’Œæ€è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…ˆä¿®å¤ Consumer çš„é—®é¢˜ï¼Œç¡®ä¿å…¶æ¢å¤æ¶ˆè´¹é€Ÿåº¦ï¼Œç„¶åå°†ç°æœ‰ Consumer éƒ½åœæ‰ã€‚</li>
<li>æ–°å»ºä¸€ä¸ª Topicï¼ŒPartition æ˜¯åŸæ¥çš„ 10 å€ï¼Œä¸´æ—¶å»ºç«‹å¥½åŸå…ˆ 10 å€çš„ Queue æ•°é‡ã€‚</li>
<li>ç„¶åå†™ä¸€ä¸ªä¸´æ—¶çš„åˆ†å‘æ•°æ®çš„ Consumer ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºéƒ¨ç½²ä¸Šå»æ¶ˆè´¹ç§¯å‹çš„æ•°æ®ï¼Œ<strong>æ¶ˆè´¹ä¹‹åä¸åšè€—æ—¶çš„å¤„ç†</strong>ï¼Œç›´æ¥å‡åŒ€è½®è¯¢å†™å…¥ä¸´æ—¶å»ºç«‹å¥½çš„ 10 å€æ•°é‡çš„ Queueã€‚</li>
<li>æ¥ç€ä¸´æ—¶å¾ç”¨ 10 å€çš„æœºå™¨æ¥éƒ¨ç½² Consumer ï¼Œæ¯ä¸€æ‰¹ Consumer æ¶ˆè´¹ä¸€ä¸ªä¸´æ—¶ Queue çš„æ•°æ®ã€‚è¿™ç§åšæ³•ç›¸å½“äºæ˜¯ä¸´æ—¶å°† Queue èµ„æºå’Œ Consumer èµ„æºæ‰©å¤§ 10 å€ï¼Œä»¥æ­£å¸¸çš„ 10 å€é€Ÿåº¦æ¥æ¶ˆè´¹æ•°æ®ã€‚</li>
<li>ç­‰å¿«é€Ÿæ¶ˆè´¹å®Œç§¯å‹æ•°æ®ä¹‹åï¼Œ<strong>å¾—æ¢å¤åŸå…ˆéƒ¨ç½²çš„æ¶æ„</strong>ï¼Œ<strong>é‡æ–°</strong>ç”¨åŸå…ˆçš„ consumer æœºå™¨æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚</li>
</ul>
<h2 id="4-mq-çš„é«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#4-mq-çš„é«˜å¯ç”¨"></a> 4. MQ çš„é«˜å¯ç”¨</h2>
<p>ä¸åŒ MQ å®ç°é«˜å¯ç”¨çš„åŸç†å„ä¸ç›¸åŒã€‚å› ä¸º Kafka æ¯”è¾ƒå…·æœ‰ä»£è¡¨æ€§ï¼Œæ‰€ä»¥è¿™é‡Œä»¥ Kafka ä¸ºä¾‹ã€‚</p>
<h3 id="41-kafka-çš„é«˜å¯ç”¨"><a class="markdownIt-Anchor" href="#41-kafka-çš„é«˜å¯ç”¨"></a> 4.1. Kafka çš„é«˜å¯ç”¨</h3>
<h4 id="kafka-çš„æ ¸å¿ƒæ¦‚å¿µ"><a class="markdownIt-Anchor" href="#kafka-çš„æ ¸å¿ƒæ¦‚å¿µ"></a> Kafka çš„æ ¸å¿ƒæ¦‚å¿µ</h4>
<p>äº†è§£ Kafkaï¼Œå¿…é¡»å…ˆäº†è§£ Kafka çš„æ ¸å¿ƒæ¦‚å¿µï¼š</p>
<ul>
<li>
<p><strong>Broker</strong> - Kafka é›†ç¾¤åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ï¼Œè¿™ç§èŠ‚ç‚¹è¢«ç§°ä¸º Brokerã€‚</p>
</li>
<li>
<p><strong>Topic</strong> - æ¯æ¡å‘å¸ƒåˆ° Kafka é›†ç¾¤çš„æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªç±»åˆ«ï¼Œè¿™ä¸ªç±»åˆ«è¢«ç§°ä¸º Topicã€‚ï¼ˆä¸åŒ Topic çš„æ¶ˆæ¯æ˜¯ç‰©ç†éš”ç¦»çš„ï¼›åŒä¸€ä¸ª Topic çš„æ¶ˆæ¯ä¿å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ª Broker ä¸Šï¼Œä½†ç”¨æˆ·åªéœ€æŒ‡å®šæ¶ˆæ¯çš„ Topic å³å¯ç”Ÿäº§æˆ–æ¶ˆè´¹æ•°æ®è€Œä¸å¿…å…³å¿ƒæ•°æ®å­˜äºä½•å¤„ï¼‰ã€‚å¯¹äºæ¯ä¸€ä¸ª Topicï¼Œ Kafka é›†ç¾¤éƒ½ä¼šç»´æŒä¸€ä¸ªåˆ†åŒºæ—¥å¿—ã€‚</p>
</li>
<li>
<p><strong>Partition</strong> - äº†æé«˜ Kafka çš„ååç‡ï¼Œæ¯ä¸ª Topic åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Partitionï¼Œæ¯ä¸ª Partition åœ¨ç‰©ç†ä¸Šå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹å­˜å‚¨è¿™ä¸ª Partition çš„æ‰€æœ‰æ¶ˆæ¯å’Œç´¢å¼•æ–‡ä»¶ã€‚</p>
<ul>
<li>Kafka æ—¥å¿—çš„åˆ†åŒºï¼ˆPartitionï¼‰åˆ†å¸ƒåœ¨ Kafka é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šã€‚æ¯ä¸ªèŠ‚ç‚¹åœ¨å¤„ç†æ•°æ®å’Œè¯·æ±‚æ—¶ï¼Œå…±äº«è¿™äº›åˆ†åŒºã€‚æ¯ä¸€ä¸ªåˆ†åŒºéƒ½ä¼šåœ¨å·²é…ç½®çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œå¤‡ä»½ï¼Œç¡®ä¿å®¹é”™æ€§ã€‚</li>
</ul>
</li>
</ul>
<p><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/distributed/mq/kafka/kafka-cluster-roles.png" alt="img" /></p>
<h4 id="kafka-çš„å‰¯æœ¬æœºåˆ¶"><a class="markdownIt-Anchor" href="#kafka-çš„å‰¯æœ¬æœºåˆ¶"></a> Kafka çš„å‰¯æœ¬æœºåˆ¶</h4>
<p>Kafka æ˜¯å¦‚ä½•å®ç°é«˜å¯ç”¨çš„å‘¢ï¼Ÿ</p>
<p>Kafka åœ¨ 0.8 ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä¸€ä¸ª Broker å®•æœºäº†ï¼Œå…¶ä¸Šé¢çš„ Partition éƒ½ä¸èƒ½ç”¨äº†ï¼Œè¿™è‡ªç„¶ä¸æ˜¯é«˜å¯ç”¨çš„ã€‚</p>
<p>ä¸ºäº†å®ç°é«˜å¯ç”¨ï¼ŒKafka å¼•å…¥äº†å¤åˆ¶åŠŸèƒ½ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å‰¯æœ¬æœºåˆ¶ï¼ˆ Replicate ï¼‰ã€‚</p>
<p><strong>æ¯ä¸ª Partition éƒ½æœ‰ä¸€ä¸ª Leaderï¼Œé›¶ä¸ªæˆ–å¤šä¸ª Follower</strong>ã€‚Leader å’Œ Follower éƒ½æ˜¯ Brokerï¼Œæ¯ä¸ª Broker éƒ½ä¼šæˆä¸ºæŸäº›åˆ†åŒºçš„ Leader å’ŒæŸäº›åˆ†åŒºçš„ Followerï¼Œå› æ­¤é›†ç¾¤çš„è´Ÿè½½æ˜¯å¹³è¡¡çš„ã€‚</p>
<ul>
<li><strong>Leader å¤„ç†ä¸€åˆ‡å¯¹ Partition ï¼ˆåˆ†åŒºï¼‰çš„è¯»å†™è¯·æ±‚</strong>ï¼›</li>
<li><strong>è€Œ Follower åªéœ€è¢«åŠ¨çš„åŒæ­¥ Leader ä¸Šçš„æ•°æ®</strong>ã€‚</li>
</ul>
<p><strong>åŒä¸€ä¸ª Topic çš„ä¸åŒ Partition ä¼šåˆ†å¸ƒåœ¨å¤šä¸ª Broker ä¸Šï¼Œè€Œä¸”ä¸€ä¸ª Partition è¿˜ä¼šåœ¨å…¶ä»–çš„ Broker ä¸Šé¢è¿›è¡Œå¤‡ä»½</strong>ï¼ŒProducer åœ¨å‘å¸ƒæ¶ˆæ¯åˆ°æŸä¸ª Partition æ—¶ï¼Œå…ˆæ‰¾åˆ°è¯¥ Partition çš„ Leaderï¼Œç„¶åå‘è¿™ä¸ª Leader æ¨é€æ¶ˆæ¯ï¼›æ¯ä¸ª Follower éƒ½ä» Leader æ‹‰å–æ¶ˆæ¯ï¼Œæ‹‰å–æ¶ˆæ¯æˆåŠŸä¹‹åï¼Œå‘ Leader å‘é€ä¸€ä¸ª ACK ç¡®è®¤ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/distributed/mq/kafka/kafka-replication.png" alt="img" /></p>
<blockquote>
<p>FAQ</p>
<p>é—®ï¼šä¸ºä»€ä¹ˆè®© Leader å¤„ç†ä¸€åˆ‡å¯¹å¯¹ Partition ï¼ˆåˆ†åŒºï¼‰çš„è¯»å†™è¯·æ±‚ï¼Ÿ</p>
<p>ç­”ï¼šå› ä¸ºå¦‚æœå…è®¸æ‰€æœ‰ Broker éƒ½å¯ä»¥å¤„ç†è¯»å†™è¯·æ±‚ï¼Œå°±å¯èƒ½äº§ç”Ÿæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
</blockquote>
<h4 id="kafka-é€‰ä¸¾-leader"><a class="markdownIt-Anchor" href="#kafka-é€‰ä¸¾-leader"></a> Kafka é€‰ä¸¾ Leader</h4>
<p>ç”±ä¸Šæ–‡å¯çŸ¥ï¼ŒPartition åœ¨å¤šä¸ª Broker ä¸Šå­˜åœ¨å‰¯æœ¬ã€‚</p>
<p>å¦‚æœæŸä¸ª Follower å®•æœºï¼Œå•¥äº‹å„¿æ²¡æœ‰ï¼Œæ­£å¸¸å·¥ä½œã€‚</p>
<p>å¦‚æœ Leader å®•æœºäº†ï¼Œä¼šä» Follower ä¸­<strong>é‡æ–°é€‰ä¸¾</strong>ä¸€ä¸ªæ–°çš„ Leaderã€‚</p>
<h2 id="5-ä¸»æµ-mq"><a class="markdownIt-Anchor" href="#5-ä¸»æµ-mq"></a> 5. ä¸»æµ MQ</h2>
<h3 id="51-activemq"><a class="markdownIt-Anchor" href="#51-activemq"></a> 5.1. ActiveMQ</h3>
<p><code>ActiveMQ</code> æ˜¯ç”± <code>Apache</code> å‡ºå“ï¼Œ<code>ActiveMQ</code> æ˜¯ä¸€ä¸ªå®Œå…¨æ”¯æŒ<code>JMS1.1</code> å’Œ <code>J2EE 1.4</code> è§„èŒƒçš„ <code>JMS Provider</code> å®ç°ã€‚å®ƒéå¸¸å¿«é€Ÿï¼Œæ”¯æŒ <strong>å¤šç§è¯­è¨€çš„å®¢æˆ·ç«¯</strong> å’Œ <strong>åè®®</strong>ï¼Œè€Œä¸”å¯ä»¥éå¸¸å®¹æ˜“çš„åµŒå…¥åˆ°ä¼ä¸šçš„åº”ç”¨ç¯å¢ƒä¸­ï¼Œå¹¶æœ‰è®¸å¤šé«˜çº§åŠŸèƒ½ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/8/16479c8ea7cdc2c0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>
<h4 id="a-ä¸»è¦ç‰¹æ€§"><a class="markdownIt-Anchor" href="#a-ä¸»è¦ç‰¹æ€§"></a> (a) ä¸»è¦ç‰¹æ€§</h4>
<ol>
<li><strong>æœä» JMS è§„èŒƒ</strong>ï¼š<code>JMS</code> è§„èŒƒæä¾›äº†è‰¯å¥½çš„æ ‡å‡†å’Œä¿è¯ï¼ŒåŒ…æ‹¬ï¼š<strong>åŒæ­¥</strong> æˆ– <strong>å¼‚æ­¥</strong> çš„æ¶ˆæ¯åˆ†å‘ï¼Œä¸€æ¬¡å’Œä»…ä¸€æ¬¡çš„æ¶ˆæ¯åˆ†å‘ï¼Œ<strong>æ¶ˆæ¯æ¥æ”¶</strong> å’Œ <strong>è®¢é˜…</strong> ç­‰ç­‰ã€‚éµä» <code>JMS</code> è§„èŒƒçš„å¥½å¤„åœ¨äºï¼Œä¸è®ºä½¿ç”¨ä»€ä¹ˆ <code>JMS</code> å®ç°æä¾›è€…ï¼Œè¿™äº›åŸºç¡€ç‰¹æ€§éƒ½æ˜¯å¯ç”¨çš„ï¼›</li>
<li><strong>è¿æ¥çµæ´»æ€§</strong>ï¼š<code>ActiveMQ</code> æä¾›äº†å¹¿æ³›çš„ <strong>è¿æ¥åè®®</strong>ï¼Œæ”¯æŒçš„åè®®æœ‰ï¼š<code>HTTP/S</code>ï¼Œ<code>IP</code> <strong>å¤šæ’­</strong>ï¼Œ<code>SSL</code>ï¼Œ<code>TCP</code>ï¼Œ<code>UDP</code> ç­‰ç­‰ã€‚å¯¹ä¼—å¤šåè®®çš„æ”¯æŒè®© <code>ActiveMQ</code> æ‹¥æœ‰äº†å¾ˆå¥½çš„çµæ´»æ€§ï¼›</li>
<li><strong>æ”¯æŒçš„åè®®ç§ç±»å¤š</strong>ï¼š<code>OpenWire</code>ã€<code>STOMP</code>ã€<code>REST</code>ã€<code>XMPP</code>ã€<code>AMQP</code>ï¼›</li>
<li><strong>æŒä¹…åŒ–æ’ä»¶å’Œå®‰å…¨æ’ä»¶</strong>ï¼š<code>ActiveMQ</code> æä¾›äº† <strong>å¤šç§æŒä¹…åŒ–</strong> é€‰æ‹©ã€‚è€Œä¸”ï¼Œ<code>ActiveMQ</code> çš„å®‰å…¨æ€§ä¹Ÿå¯ä»¥å®Œå…¨ä¾æ®ç”¨æˆ·éœ€æ±‚è¿›è¡Œ <strong>è‡ªå®šä¹‰é‰´æƒ</strong> å’Œ <strong>æˆæƒ</strong>ï¼›</li>
<li><strong>æ”¯æŒçš„å®¢æˆ·ç«¯è¯­è¨€ç§ç±»å¤š</strong>ï¼šé™¤äº† <code>Java</code> ä¹‹å¤–ï¼Œè¿˜æœ‰ï¼š<code>C/C++</code>ï¼Œ<code>.NET</code>ï¼Œ<code>Perl</code>ï¼Œ<code>PHP</code>ï¼Œ<code>Python</code>ï¼Œ<code>Ruby</code>ï¼›</li>
<li><strong>ä»£ç†é›†ç¾¤</strong>ï¼šå¤šä¸ª <code>ActiveMQ</code> <strong>ä»£ç†</strong> å¯ä»¥ç»„æˆä¸€ä¸ª <strong>é›†ç¾¤</strong> æ¥æä¾›æœåŠ¡ï¼›</li>
<li><strong>å¼‚å¸¸ç®€å•çš„ç®¡ç†</strong>ï¼š<code>ActiveMQ</code> æ˜¯ä»¥å¼€å‘è€…æ€ç»´è¢«è®¾è®¡çš„ã€‚æ‰€ä»¥ï¼Œå®ƒå¹¶ä¸éœ€è¦ä¸“é—¨çš„ç®¡ç†å‘˜ï¼Œå› ä¸ºå®ƒæä¾›äº†ç®€å•åˆä½¿ç”¨çš„ç®¡ç†ç‰¹æ€§ã€‚æœ‰å¾ˆå¤šä¸­æ–¹æ³•å¯ä»¥ <strong>ç›‘æ§</strong> <code>ActiveMQ</code> ä¸åŒå±‚é¢çš„æ•°æ®ï¼ŒåŒ…æ‹¬ä½¿ç”¨åœ¨ <code>JConsole</code> æˆ–è€…åœ¨ <code>ActiveMQ</code> çš„ <code>Web Console</code> ä¸­ä½¿ç”¨ <code>JMX</code>ã€‚é€šè¿‡å¤„ç† <code>JMX</code> çš„å‘Šè­¦æ¶ˆæ¯ï¼Œé€šè¿‡ä½¿ç”¨ <strong>å‘½ä»¤è¡Œè„šæœ¬</strong>ï¼Œç”šè‡³å¯ä»¥é€šè¿‡ç›‘æ§å„ç§ç±»å‹çš„ <strong>æ—¥å¿—</strong>ã€‚</li>
</ol>
<h4 id="b-éƒ¨ç½²ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#b-éƒ¨ç½²ç¯å¢ƒ"></a> (b) éƒ¨ç½²ç¯å¢ƒ</h4>
<p><code>ActiveMQ</code> å¯ä»¥è¿è¡Œåœ¨ <code>Java</code> è¯­è¨€æ‰€æ”¯æŒçš„å¹³å°ä¹‹ä¸Šã€‚ä½¿ç”¨ <code>ActiveMQ</code> éœ€è¦ï¼š</p>
<ul>
<li><code>Java JDK</code></li>
<li><code>ActiveMQ</code> å®‰è£…åŒ…</li>
</ul>
<h4 id="ä¼˜ç‚¹"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹"></a> Â© ä¼˜ç‚¹</h4>
<ol>
<li><strong>è·¨å¹³å°</strong> (<code>JAVA</code> ç¼–å†™ä¸å¹³å°æ— å…³ï¼Œ<code>ActiveMQ</code> å‡ ä¹å¯ä»¥è¿è¡Œåœ¨ä»»ä½•çš„ <code>JVM</code> ä¸Š)ï¼›</li>
<li>å¯ä»¥ç”¨ <code>JDBC</code>ï¼šå¯ä»¥å°† <strong>æ•°æ®æŒä¹…åŒ–</strong> åˆ°æ•°æ®åº“ã€‚è™½ç„¶ä½¿ç”¨ <code>JDBC</code> ä¼šé™ä½ <code>ActiveMQ</code> çš„æ€§èƒ½ï¼Œä½†æ˜¯æ•°æ®åº“ä¸€ç›´éƒ½æ˜¯å¼€å‘äººå‘˜æœ€ç†Ÿæ‚‰çš„å­˜å‚¨ä»‹è´¨ï¼›</li>
<li>æ”¯æŒ <code>JMS</code> è§„èŒƒï¼šæ”¯æŒ <code>JMS</code> è§„èŒƒæä¾›çš„ <strong>ç»Ÿä¸€æ¥å£</strong>;</li>
<li>æ”¯æŒ <strong>è‡ªåŠ¨é‡è¿</strong> å’Œ <strong>é”™è¯¯é‡è¯•æœºåˆ¶</strong>ï¼›</li>
<li>æœ‰å®‰å…¨æœºåˆ¶ï¼šæ”¯æŒåŸºäº <code>shiro</code>ï¼Œ<code>jaas</code> ç­‰å¤šç§ <strong>å®‰å…¨é…ç½®æœºåˆ¶</strong>ï¼Œå¯ä»¥å¯¹ <code>Queue/Topic</code> è¿›è¡Œ <strong>è®¤è¯å’Œæˆæƒ</strong>ï¼›</li>
<li>ç›‘æ§å®Œå–„ï¼šæ‹¥æœ‰å®Œå–„çš„ <strong>ç›‘æ§</strong>ï¼ŒåŒ…æ‹¬ <code>Web Console</code>ï¼Œ<code>JMX</code>ï¼Œ<code>Shell</code> å‘½ä»¤è¡Œï¼Œ<code>Jolokia</code> çš„ <code>RESTful API</code>ï¼›</li>
<li>ç•Œé¢å‹å–„ï¼šæä¾›çš„ <code>Web Console</code> å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†æƒ…å†µï¼Œè¿˜æœ‰å¾ˆå¤š <strong>ç¬¬ä¸‰æ–¹çš„ç»„ä»¶</strong> å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚ <code>hawtio</code>ï¼›</li>
</ol>
<h4 id="d-ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#d-ç¼ºç‚¹"></a> (d) ç¼ºç‚¹</h4>
<ol>
<li>ç¤¾åŒºæ´»è·ƒåº¦ä¸åŠ <code>RabbitMQ</code> é«˜ï¼›</li>
<li>æ ¹æ®å…¶ä»–ç”¨æˆ·åé¦ˆï¼Œä¼šå‡ºè«åå…¶å¦™çš„é—®é¢˜ï¼Œä¼š <strong>ä¸¢å¤±æ¶ˆæ¯</strong>ï¼›</li>
<li>ç›®å‰é‡å¿ƒæ”¾åˆ° <code>activemq 6.0</code> äº§å“ <code>Apollo</code>ï¼Œå¯¹ <code>5.x</code> çš„ç»´æŠ¤è¾ƒå°‘ï¼›</li>
<li>ä¸é€‚åˆç”¨äº <strong>ä¸Šåƒä¸ªé˜Ÿåˆ—</strong> çš„åº”ç”¨åœºæ™¯ï¼›</li>
</ol>
<h3 id="52-rabbitmq"><a class="markdownIt-Anchor" href="#52-rabbitmq"></a> 5.2. RabbitMQ</h3>
<p><code>RabbitMQ</code> äº <code>2007</code> å¹´å‘å¸ƒï¼Œæ˜¯ä¸€ä¸ªåœ¨ <code>AMQP</code> (<strong>é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®</strong>)åŸºç¡€ä¸Šå®Œæˆçš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿï¼Œæ˜¯å½“å‰æœ€ä¸»æµçš„æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹ä¸€ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/7/8/16479c8ece3b5d7a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>
<h4 id="a-ä¸»è¦ç‰¹æ€§-2"><a class="markdownIt-Anchor" href="#a-ä¸»è¦ç‰¹æ€§-2"></a> (a) ä¸»è¦ç‰¹æ€§</h4>
<ol>
<li><strong>å¯é æ€§</strong>ï¼šæä¾›äº†å¤šç§æŠ€æœ¯å¯ä»¥è®©ä½ åœ¨ <strong>æ€§èƒ½</strong> å’Œ <strong>å¯é æ€§</strong> ä¹‹é—´è¿›è¡Œ <strong>æƒè¡¡</strong>ã€‚è¿™äº›æŠ€æœ¯åŒ…æ‹¬ <strong>æŒä¹…æ€§æœºåˆ¶</strong>ã€<strong>æŠ•é€’ç¡®è®¤</strong>ã€<strong>å‘å¸ƒè€…è¯å®</strong> å’Œ <strong>é«˜å¯ç”¨æ€§æœºåˆ¶</strong>ï¼›</li>
<li><strong>çµæ´»çš„è·¯ç”±</strong>ï¼šæ¶ˆæ¯åœ¨åˆ°è¾¾é˜Ÿåˆ—å‰æ˜¯é€šè¿‡ <strong>äº¤æ¢æœº</strong> è¿›è¡Œ <strong>è·¯ç”±</strong> çš„ã€‚<code>RabbitMQ</code> ä¸ºå…¸å‹çš„è·¯ç”±é€»è¾‘æä¾›äº† <strong>å¤šç§å†…ç½®äº¤æ¢æœº</strong> ç±»å‹ã€‚å¦‚æœä½ æœ‰æ›´å¤æ‚çš„è·¯ç”±éœ€æ±‚ï¼Œå¯ä»¥å°†è¿™äº›äº¤æ¢æœºç»„åˆèµ·æ¥ä½¿ç”¨ï¼Œä½ ç”šè‡³å¯ä»¥å®ç°è‡ªå·±çš„äº¤æ¢æœºç±»å‹ï¼Œå¹¶ä¸”å½“åš <code>RabbitMQ</code> çš„ <strong>æ’ä»¶</strong> æ¥ä½¿ç”¨ï¼›</li>
<li><strong>æ¶ˆæ¯é›†ç¾¤</strong>ï¼šåœ¨ç›¸åŒå±€åŸŸç½‘ä¸­çš„å¤šä¸ª <code>RabbitMQ</code> æœåŠ¡å™¨å¯ä»¥ <strong>èšåˆ</strong> åœ¨ä¸€èµ·ï¼Œä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘ä»£ç†æ¥ä½¿ç”¨ï¼›</li>
<li><strong>é˜Ÿåˆ—é«˜å¯ç”¨</strong>ï¼šé˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„æœºå™¨ä¸Š <strong>è¿›è¡Œé•œåƒ</strong>ï¼Œä»¥ç¡®ä¿åœ¨ç¡¬ä»¶é—®é¢˜ä¸‹è¿˜ä¿è¯ <strong>æ¶ˆæ¯å®‰å…¨</strong>ï¼›</li>
<li><strong>æ”¯æŒå¤šç§åè®®</strong>ï¼šæ”¯æŒ <strong>å¤šç§æ¶ˆæ¯é˜Ÿåˆ—åè®®</strong>ï¼›</li>
<li><strong>æ”¯æŒå¤šç§è¯­è¨€</strong>ï¼šç”¨ <code>Erlang</code> è¯­è¨€ç¼–å†™ï¼Œæ”¯æŒåªè¦æ˜¯ä½ èƒ½æƒ³åˆ°çš„ <strong>æ‰€æœ‰ç¼–ç¨‹è¯­è¨€</strong>ï¼›</li>
<li><strong>ç®¡ç†ç•Œé¢</strong>ï¼š <code>RabbitMQ</code> æœ‰ä¸€ä¸ªæ˜“ç”¨çš„ <strong>ç”¨æˆ·ç•Œé¢</strong>ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ <strong>ç›‘æ§</strong> å’Œ <strong>ç®¡ç†</strong> æ¶ˆæ¯ <code>Broker</code> çš„è®¸å¤šæ–¹é¢ï¼›</li>
<li><strong>è·Ÿè¸ªæœºåˆ¶</strong>ï¼šå¦‚æœ <strong>æ¶ˆæ¯å¼‚å¸¸</strong>ï¼Œ<code>RabbitMQ</code> æä¾›æ¶ˆæ¯è·Ÿè¸ªæœºåˆ¶ï¼Œä½¿ç”¨è€…å¯ä»¥æ‰¾å‡ºå‘ç”Ÿäº†ä»€ä¹ˆï¼›</li>
<li><strong>æ’ä»¶æœºåˆ¶</strong>ï¼šæä¾›äº†è®¸å¤š <strong>æ’ä»¶</strong>ï¼Œæ¥ä»å¤šæ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„æ’ä»¶ã€‚</li>
</ol>
<h4 id="b-éƒ¨ç½²ç¯å¢ƒ-2"><a class="markdownIt-Anchor" href="#b-éƒ¨ç½²ç¯å¢ƒ-2"></a> (b) éƒ¨ç½²ç¯å¢ƒ</h4>
<p><code>RabbitMQ</code> å¯ä»¥è¿è¡Œåœ¨ <code>Erlang</code> è¯­è¨€æ‰€æ”¯æŒçš„å¹³å°ä¹‹ä¸Šï¼ŒåŒ…æ‹¬ <code>Solaris</code>ï¼Œ<code>BSD</code>ï¼Œ<code>Linux</code>ï¼Œ<code>MacOSX</code>ï¼Œ<code>TRU64</code>ï¼Œ<code>Windows</code> ç­‰ã€‚ä½¿ç”¨ <code>RabbitMQ</code> éœ€è¦ï¼š</p>
<ul>
<li><code>ErLang</code> è¯­è¨€åŒ…</li>
<li><code>RabbitMQ</code> å®‰è£…åŒ…</li>
</ul>
<h4 id="ä¼˜ç‚¹-2"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-2"></a> Â© ä¼˜ç‚¹</h4>
<ol>
<li>ç”±äº <code>Erlang</code> è¯­è¨€çš„ç‰¹æ€§ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ€§èƒ½è¾ƒå¥½ï¼Œæ”¯æŒ <strong>é«˜å¹¶å‘</strong>ï¼›</li>
<li>å¥å£®ã€ç¨³å®šã€æ˜“ç”¨ã€<strong>è·¨å¹³å°</strong>ã€æ”¯æŒ <strong>å¤šç§è¯­è¨€</strong>ã€æ–‡æ¡£é½å…¨ï¼›</li>
<li>æœ‰æ¶ˆæ¯ <strong>ç¡®è®¤æœºåˆ¶</strong> å’Œ <strong>æŒä¹…åŒ–æœºåˆ¶</strong>ï¼Œå¯é æ€§é«˜ï¼›</li>
<li>é«˜åº¦å¯å®šåˆ¶çš„ <strong>è·¯ç”±</strong>ï¼›</li>
<li><strong>ç®¡ç†ç•Œé¢</strong> è¾ƒä¸°å¯Œï¼Œåœ¨äº’è”ç½‘å…¬å¸ä¹Ÿæœ‰è¾ƒå¤§è§„æ¨¡çš„åº”ç”¨ï¼Œç¤¾åŒºæ´»è·ƒåº¦é«˜ã€‚</li>
</ol>
<h4 id="d-ç¼ºç‚¹-2"><a class="markdownIt-Anchor" href="#d-ç¼ºç‚¹-2"></a> (d) ç¼ºç‚¹</h4>
<ol>
<li>å°½ç®¡ç»“åˆ <code>Erlang</code> è¯­è¨€æœ¬èº«çš„å¹¶å‘ä¼˜åŠ¿ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†æ˜¯ä¸åˆ©äºåš <strong>äºŒæ¬¡å¼€å‘å’Œç»´æŠ¤</strong>ï¼›</li>
<li>å®ç°äº† <strong>ä»£ç†æ¶æ„</strong>ï¼Œæ„å‘³ç€æ¶ˆæ¯åœ¨å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰å¯ä»¥åœ¨ <strong>ä¸­å¤®èŠ‚ç‚¹</strong> ä¸Šæ’é˜Ÿã€‚æ­¤ç‰¹æ€§ä½¿å¾— <code>RabbitMQ</code> æ˜“äºä½¿ç”¨å’Œéƒ¨ç½²ï¼Œä½†æ˜¯ä½¿å¾—å…¶ <strong>è¿è¡Œé€Ÿåº¦è¾ƒæ…¢</strong>ï¼Œå› ä¸ºä¸­å¤®èŠ‚ç‚¹ <strong>å¢åŠ äº†å»¶è¿Ÿ</strong>ï¼Œ<strong>æ¶ˆæ¯å°è£…å</strong> ä¹Ÿæ¯”è¾ƒå¤§ï¼›</li>
<li>éœ€è¦å­¦ä¹  <strong>æ¯”è¾ƒå¤æ‚</strong> çš„ <strong>æ¥å£å’Œåè®®</strong>ï¼Œå­¦ä¹ å’Œç»´æŠ¤æˆæœ¬è¾ƒé«˜ã€‚</li>
</ol>
<h3 id="53-rocketmq"><a class="markdownIt-Anchor" href="#53-rocketmq"></a> 5.3. RocketMQ</h3>
<p><code>RocketMQ</code> å‡ºè‡ª <strong>é˜¿é‡Œ</strong> çš„å¼€æºäº§å“ï¼Œç”¨ <code>Java</code> è¯­è¨€å®ç°ï¼Œåœ¨è®¾è®¡æ—¶å‚è€ƒäº† <code>Kafka</code>ï¼Œå¹¶åšå‡ºäº†è‡ªå·±çš„ä¸€äº›æ”¹è¿›ï¼Œ<strong>æ¶ˆæ¯å¯é æ€§ä¸Š</strong> æ¯” <code>Kafka</code> æ›´å¥½ã€‚<code>RocketMQ</code> åœ¨é˜¿é‡Œå†…éƒ¨  è¢«å¹¿æ³›åº”ç”¨åœ¨ <strong>è®¢å•</strong>ï¼Œ<strong>äº¤æ˜“</strong>ï¼Œ<strong>å……å€¼</strong>ï¼Œ<strong>æµè®¡ç®—</strong>ï¼Œ<strong>æ¶ˆæ¯æ¨é€</strong>ï¼Œ<strong>æ—¥å¿—æµå¼å¤„ç†</strong>ï¼Œ<code>binglog</code> <strong>åˆ†å‘</strong> ç­‰åœºæ™¯ã€‚</p>
<h4 id="a-ä¸»è¦ç‰¹æ€§-3"><a class="markdownIt-Anchor" href="#a-ä¸»è¦ç‰¹æ€§-3"></a> (a) ä¸»è¦ç‰¹æ€§</h4>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="800" height="600"></svg>)</p>
<ol>
<li>åŸºäº <strong>é˜Ÿåˆ—æ¨¡å‹</strong>ï¼šå…·æœ‰ <strong>é«˜æ€§èƒ½</strong>ã€<strong>é«˜å¯é </strong>ã€<strong>é«˜å®æ—¶</strong>ã€<strong>åˆ†å¸ƒå¼</strong> ç­‰ç‰¹ç‚¹ï¼›</li>
<li><code>Producer</code>ã€<code>Consumer</code>ã€<strong>é˜Ÿåˆ—</strong> éƒ½æ”¯æŒ <strong>åˆ†å¸ƒå¼</strong>ï¼›</li>
<li><code>Producer</code> å‘ä¸€äº›é˜Ÿåˆ—è½®æµå‘é€æ¶ˆæ¯ï¼Œ<strong>é˜Ÿåˆ—é›†åˆ</strong> ç§°ä¸º <code>Topic</code>ã€‚<code>Consumer</code> å¦‚æœåš <strong>å¹¿æ’­æ¶ˆè´¹</strong>ï¼Œåˆ™ä¸€ä¸ª <code>Consumer</code> å®ä¾‹æ¶ˆè´¹è¿™ä¸ª <code>Topic</code> å¯¹åº”çš„ <strong>æ‰€æœ‰é˜Ÿåˆ—</strong>ï¼›å¦‚æœåš <strong>é›†ç¾¤æ¶ˆè´¹</strong>ï¼Œåˆ™ <strong>å¤šä¸ª</strong> <code>Consumer</code> å®ä¾‹ <strong>å¹³å‡æ¶ˆè´¹</strong> è¿™ä¸ª <code>Topic</code> å¯¹åº”çš„é˜Ÿåˆ—é›†åˆï¼›</li>
<li>èƒ½å¤Ÿä¿è¯ <strong>ä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåº</strong>ï¼›</li>
<li>æä¾›ä¸°å¯Œçš„ <strong>æ¶ˆæ¯æ‹‰å–æ¨¡å¼</strong>ï¼›</li>
<li>é«˜æ•ˆçš„è®¢é˜…è€… <strong>æ°´å¹³æ‰©å±•</strong>èƒ½åŠ›ï¼›</li>
<li><strong>å®æ—¶</strong> çš„ <strong>æ¶ˆæ¯è®¢é˜…æœºåˆ¶</strong>ï¼›</li>
<li>äº¿çº§ <strong>æ¶ˆæ¯å †ç§¯</strong> èƒ½åŠ›ï¼›</li>
<li>è¾ƒå°‘çš„å¤–éƒ¨ä¾èµ–ã€‚</li>
</ol>
<h4 id="b-éƒ¨ç½²ç¯å¢ƒ-3"><a class="markdownIt-Anchor" href="#b-éƒ¨ç½²ç¯å¢ƒ-3"></a> (b) éƒ¨ç½²ç¯å¢ƒ</h4>
<p><code>RocketMQ</code> å¯ä»¥è¿è¡Œåœ¨ <code>Java</code> è¯­è¨€æ‰€æ”¯æŒçš„å¹³å°ä¹‹ä¸Šã€‚ä½¿ç”¨ <code>RocketMQ</code> éœ€è¦ï¼š</p>
<ul>
<li><code>Java JDK</code></li>
<li>å®‰è£… <code>git</code>ã€<code>Maven</code></li>
<li><code>RocketMQ</code> å®‰è£…åŒ…</li>
</ul>
<h4 id="ä¼˜ç‚¹-3"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-3"></a> Â© ä¼˜ç‚¹</h4>
<ol>
<li><strong>å•æœº</strong> æ”¯æŒ <code>1</code> ä¸‡ä»¥ä¸Š <strong>æŒä¹…åŒ–é˜Ÿåˆ—</strong>ï¼›</li>
<li><code>RocketMQ</code> çš„æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯ <strong>æŒä¹…åŒ–çš„</strong>ï¼Œå…ˆå†™å…¥ç³»ç»Ÿ <code>PAGECACHE</code>ï¼Œç„¶å <strong>åˆ·ç›˜</strong>ï¼Œå¯ä»¥ä¿è¯ <strong>å†…å­˜</strong> ä¸ <strong>ç£ç›˜</strong> éƒ½æœ‰ä¸€ä»½æ•°æ®ï¼Œè€Œ <strong>è®¿é—®</strong> æ—¶ï¼Œç›´æ¥ <strong>ä»å†…å­˜è¯»å–</strong>ã€‚</li>
<li>æ¨¡å‹ç®€å•ï¼Œæ¥å£æ˜“ç”¨ï¼ˆ<code>JMS</code> çš„æ¥å£å¾ˆå¤šåœºåˆå¹¶ä¸å¤ªå®ç”¨ï¼‰ï¼›</li>
<li><strong>æ€§èƒ½éå¸¸å¥½</strong>ï¼Œå¯ä»¥å…è®¸ <strong>å¤§é‡å †ç§¯æ¶ˆæ¯</strong> åœ¨ <code>Broker</code> ä¸­ï¼›</li>
<li>æ”¯æŒ <strong>å¤šç§æ¶ˆè´¹æ¨¡å¼</strong>ï¼ŒåŒ…æ‹¬ <strong>é›†ç¾¤æ¶ˆè´¹</strong>ã€<strong>å¹¿æ’­æ¶ˆè´¹</strong>ç­‰ï¼›</li>
<li>å„ä¸ªç¯èŠ‚ <strong>åˆ†å¸ƒå¼æ‰©å±•è®¾è®¡</strong>ï¼Œæ”¯æŒ <strong>ä¸»ä»</strong> å’Œ <strong>é«˜å¯ç”¨</strong>ï¼›</li>
<li>å¼€å‘åº¦è¾ƒæ´»è·ƒï¼Œç‰ˆæœ¬æ›´æ–°å¾ˆå¿«ã€‚</li>
</ol>
<h4 id="d-ç¼ºç‚¹-3"><a class="markdownIt-Anchor" href="#d-ç¼ºç‚¹-3"></a> (d) ç¼ºç‚¹</h4>
<ol>
<li>æ”¯æŒçš„ <strong>å®¢æˆ·ç«¯è¯­è¨€</strong> ä¸å¤šï¼Œç›®å‰æ˜¯ <code>Java</code> åŠ <code>C++</code>ï¼Œå…¶ä¸­ <code>C++</code> è¿˜ä¸æˆç†Ÿï¼›</li>
<li><code>RocketMQ</code> ç¤¾åŒºå…³æ³¨åº¦åŠæˆç†Ÿåº¦ä¹Ÿä¸åŠå‰ä¸¤è€…ï¼›</li>
<li>æ²¡æœ‰ <code>Web</code> ç®¡ç†ç•Œé¢ï¼Œæä¾›äº†ä¸€ä¸ª <code>CLI</code> (å‘½ä»¤è¡Œç•Œé¢) ç®¡ç†å·¥å…·å¸¦æ¥ <strong>æŸ¥è¯¢</strong>ã€<strong>ç®¡ç†</strong> å’Œ <strong>è¯Šæ–­å„ç§é—®é¢˜</strong>ï¼›</li>
<li>æ²¡æœ‰åœ¨ <code>MQ</code> æ ¸å¿ƒé‡Œå®ç° <code>JMS</code> ç­‰æ¥å£ï¼›</li>
</ol>
<h3 id="54-kafka"><a class="markdownIt-Anchor" href="#54-kafka"></a> 5.4. Kafka</h3>
<p><code>Apache Kafka</code> æ˜¯ä¸€ä¸ª <strong>åˆ†å¸ƒå¼æ¶ˆæ¯å‘å¸ƒè®¢é˜…</strong> ç³»ç»Ÿã€‚å®ƒæœ€åˆç”± <code>LinkedIn</code> å…¬å¸åŸºäºç‹¬ç‰¹çš„è®¾è®¡å®ç°ä¸ºä¸€ä¸ª <strong>åˆ†å¸ƒå¼çš„æ—¥å¿—æäº¤ç³»ç»Ÿ</strong> (<code>a distributed commit log</code>)ï¼Œä¹‹åæˆä¸º <code>Apache</code> é¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚<code>Kafka</code> <strong>æ€§èƒ½é«˜æ•ˆ</strong>ã€<strong>å¯æ‰©å±•è‰¯å¥½</strong> å¹¶ä¸” <strong>å¯æŒä¹…åŒ–</strong>ã€‚å®ƒçš„ <strong>åˆ†åŒºç‰¹æ€§</strong>ï¼Œ<strong>å¯å¤åˆ¶</strong> å’Œ <strong>å¯å®¹é”™</strong> éƒ½æ˜¯å…¶ä¸é”™çš„ç‰¹æ€§ã€‚</p>
<p>![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="708" height="364"></svg>)</p>
<h4 id="a-ä¸»è¦ç‰¹æ€§-4"><a class="markdownIt-Anchor" href="#a-ä¸»è¦ç‰¹æ€§-4"></a> (a) ä¸»è¦ç‰¹æ€§</h4>
<ol>
<li><strong>å¿«é€ŸæŒä¹…åŒ–</strong>ï¼šå¯ä»¥åœ¨ <code>O(1)</code> çš„ç³»ç»Ÿå¼€é”€ä¸‹è¿›è¡Œ <strong>æ¶ˆæ¯æŒä¹…åŒ–</strong>ï¼›</li>
<li><strong>é«˜åå</strong>ï¼šåœ¨ä¸€å°æ™®é€šçš„æœåŠ¡å™¨ä¸Šæ—¢å¯ä»¥è¾¾åˆ° <code>10W/s</code> çš„ <strong>ååé€Ÿç‡</strong>ï¼›</li>
<li><strong>å®Œå…¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿ</strong>ï¼š<code>Broker</code>ã€<code>Producer</code> å’Œ <code>Consumer</code> éƒ½åŸç”Ÿè‡ªåŠ¨æ”¯æŒ <strong>åˆ†å¸ƒå¼</strong>ï¼Œè‡ªåŠ¨å®ç° <strong>è´Ÿè½½å‡è¡¡</strong>ï¼›</li>
<li>æ”¯æŒ <strong>åŒæ­¥</strong> å’Œ <strong>å¼‚æ­¥</strong> å¤åˆ¶ä¸¤ç§ <strong>é«˜å¯ç”¨æœºåˆ¶</strong>ï¼›</li>
<li>æ”¯æŒ <strong>æ•°æ®æ‰¹é‡å‘é€</strong> å’Œ <strong>æ‹‰å–</strong>ï¼›</li>
<li><strong>é›¶æ‹·è´æŠ€æœ¯(zero-copy)</strong>ï¼šå‡å°‘ <code>IO</code> æ“ä½œæ­¥éª¤ï¼Œæé«˜ <strong>ç³»ç»Ÿååé‡</strong>ï¼›</li>
<li><strong>æ•°æ®è¿ç§»</strong>ã€<strong>æ‰©å®¹</strong> å¯¹ç”¨æˆ·é€æ˜ï¼›</li>
<li><strong>æ— éœ€åœæœº</strong> å³å¯æ‰©å±•æœºå™¨ï¼›</li>
<li><strong>å…¶ä»–ç‰¹æ€§</strong>ï¼šä¸°å¯Œçš„ <strong>æ¶ˆæ¯æ‹‰å–æ¨¡å‹</strong>ã€é«˜æ•ˆ <strong>è®¢é˜…è€…æ°´å¹³æ‰©å±•</strong>ã€å®æ—¶çš„ <strong>æ¶ˆæ¯è®¢é˜…</strong>ã€äº¿çº§çš„ <strong>æ¶ˆæ¯å †ç§¯èƒ½åŠ›</strong>ã€å®šæœŸåˆ é™¤æœºåˆ¶ï¼›</li>
</ol>
<h4 id="b-éƒ¨ç½²ç¯å¢ƒ-4"><a class="markdownIt-Anchor" href="#b-éƒ¨ç½²ç¯å¢ƒ-4"></a> (b) éƒ¨ç½²ç¯å¢ƒ</h4>
<p>ä½¿ç”¨ <code>Kafka</code> éœ€è¦ï¼š</p>
<ul>
<li><code>Java JDK</code></li>
<li><code>Kafka</code> å®‰è£…åŒ…</li>
</ul>
<h4 id="ä¼˜ç‚¹-4"><a class="markdownIt-Anchor" href="#ä¼˜ç‚¹-4"></a> Â© ä¼˜ç‚¹</h4>
<ol>
<li><strong>å®¢æˆ·ç«¯è¯­è¨€ä¸°å¯Œ</strong>ï¼šæ”¯æŒ <code>Java</code>ã€<code>.Net</code>ã€<code>PHP</code>ã€<code>Ruby</code>ã€<code>Python</code>ã€<code>Go</code> ç­‰å¤šç§è¯­è¨€ï¼›</li>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šå•æœºå†™å…¥ <code>TPS</code> çº¦åœ¨ <code>100</code> ä¸‡æ¡/ç§’ï¼Œæ¶ˆæ¯å¤§å° <code>10</code> ä¸ªå­—èŠ‚ï¼›</li>
<li>æä¾› <strong>å®Œå…¨åˆ†å¸ƒå¼æ¶æ„</strong>ï¼Œå¹¶æœ‰ <code>replica</code> æœºåˆ¶ï¼Œæ‹¥æœ‰è¾ƒé«˜çš„ <strong>å¯ç”¨æ€§</strong> å’Œ <strong>å¯é æ€§</strong>ï¼Œç†è®ºä¸Šæ”¯æŒ <strong>æ¶ˆæ¯æ— é™å †ç§¯</strong>ï¼›</li>
<li>æ”¯æŒæ‰¹é‡æ“ä½œï¼›</li>
<li><strong>æ¶ˆè´¹è€…</strong> é‡‡ç”¨ <code>Pull</code> æ–¹å¼è·å–æ¶ˆæ¯ã€‚<strong>æ¶ˆæ¯æœ‰åº</strong>ï¼Œ<strong>é€šè¿‡æ§åˆ¶</strong> èƒ½å¤Ÿä¿è¯æ‰€æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹ä¸”ä»…è¢«æ¶ˆè´¹ <strong>ä¸€æ¬¡</strong>ï¼›</li>
<li>æœ‰ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹ <code>Kafka Web</code> ç®¡ç†ç•Œé¢ <code>Kafka-Manager</code>ï¼›</li>
<li>åœ¨ <strong>æ—¥å¿—é¢†åŸŸ</strong> æ¯”è¾ƒæˆç†Ÿï¼Œè¢«å¤šå®¶å…¬å¸å’Œå¤šä¸ªå¼€æºé¡¹ç›®ä½¿ç”¨ã€‚</li>
</ol>
<h4 id="d-ç¼ºç‚¹-4"><a class="markdownIt-Anchor" href="#d-ç¼ºç‚¹-4"></a> (d) ç¼ºç‚¹</h4>
<ol>
<li><code>Kafka</code> å•æœºè¶…è¿‡ <code>64</code> ä¸ª <strong>é˜Ÿåˆ—/åˆ†åŒº</strong> æ—¶ï¼Œ<code>Load</code> æ—¶ä¼šå‘ç”Ÿæ˜æ˜¾çš„é£™é«˜ç°è±¡ã€‚<strong>é˜Ÿåˆ—</strong> è¶Šå¤šï¼Œ<strong>è´Ÿè½½</strong> è¶Šé«˜ï¼Œå‘é€æ¶ˆæ¯ <strong>å“åº”æ—¶é—´å˜é•¿</strong>ï¼›</li>
<li>ä½¿ç”¨ <strong>çŸ­è½®è¯¢æ–¹å¼</strong>ï¼Œ<strong>å®æ—¶æ€§</strong> å–å†³äº <strong>è½®è¯¢é—´éš”æ—¶é—´</strong>ï¼›</li>
<li>æ¶ˆè´¹å¤±è´¥ <strong>ä¸æ”¯æŒé‡è¯•</strong>ï¼›</li>
<li>æ”¯æŒ <strong>æ¶ˆæ¯é¡ºåº</strong>ï¼Œä½†æ˜¯ <strong>ä¸€å°ä»£ç†å®•æœº</strong> åï¼Œå°±ä¼šäº§ç”Ÿ <strong>æ¶ˆæ¯ä¹±åº</strong>ï¼›</li>
<li>ç¤¾åŒºæ›´æ–°è¾ƒæ…¢ã€‚</li>
</ol>
<h3 id="55-mq-çš„æŠ€æœ¯é€‰å‹"><a class="markdownIt-Anchor" href="#55-mq-çš„æŠ€æœ¯é€‰å‹"></a> 5.5. MQ çš„æŠ€æœ¯é€‰å‹</h3>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•æœºååé‡</td>
<td>ä¸‡çº§ï¼Œæ¯” RocketMQã€Kafka ä½ä¸€ä¸ªæ•°é‡çº§</td>
<td>åŒ ActiveMQ</td>
<td>10 ä¸‡çº§ï¼Œæ”¯æ’‘é«˜åå</td>
<td>10 ä¸‡çº§ï¼Œé«˜ååï¼Œä¸€èˆ¬é…åˆå¤§æ•°æ®ç±»çš„ç³»ç»Ÿæ¥è¿›è¡Œæµå¼è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯</td>
</tr>
<tr>
<td>topic æ•°é‡å¯¹ååé‡çš„å½±å“</td>
<td></td>
<td></td>
<td>topic å¯ä»¥è¾¾åˆ°å‡ ç™¾/å‡ åƒçš„çº§åˆ«ï¼Œååé‡ä¼šæœ‰è¾ƒå°å¹…åº¦çš„ä¸‹é™ï¼Œè¿™æ˜¯ RocketMQ çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼Œå¯ä»¥æ”¯æ’‘å¤§é‡çš„ topic</td>
<td>topic ä»å‡ ååˆ°å‡ ç™¾ä¸ªæ—¶å€™ï¼Œååé‡ä¼šå¤§å¹…åº¦ä¸‹é™ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼ŒKafka å°½é‡ä¿è¯ topic æ•°é‡ä¸è¦è¿‡å¤šï¼Œå¦‚æœè¦æ”¯æ’‘å¤§è§„æ¨¡çš„ topicï¼Œéœ€è¦å¢åŠ æ›´å¤šçš„æœºå™¨èµ„æº</td>
</tr>
<tr>
<td>æ—¶æ•ˆæ€§</td>
<td>ms çº§</td>
<td>å¾®ç§’çº§ï¼Œè¿™æ˜¯ RabbitMQ çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå»¶è¿Ÿæœ€ä½</td>
<td>ms çº§</td>
<td>å»¶è¿Ÿåœ¨ ms çº§ä»¥å†…</td>
</tr>
<tr>
<td>å¯ç”¨æ€§</td>
<td>é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°é«˜å¯ç”¨</td>
<td>åŒ ActiveMQ</td>
<td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼æ¶æ„</td>
<td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼Œå°‘æ•°æœºå™¨å®•æœºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´ä¸å¯ç”¨</td>
</tr>
<tr>
<td>æ¶ˆæ¯å¯é æ€§</td>
<td>æœ‰è¾ƒä½çš„æ¦‚ç‡ä¸¢å¤±æ•°æ®</td>
<td>åŸºæœ¬ä¸ä¸¢</td>
<td>ç»è¿‡å‚æ•°ä¼˜åŒ–é…ç½®ï¼Œå¯ä»¥åšåˆ° 0 ä¸¢å¤±</td>
<td>åŒ RocketMQ</td>
</tr>
<tr>
<td>åŠŸèƒ½æ”¯æŒ</td>
<td>MQ é¢†åŸŸçš„åŠŸèƒ½æå…¶å®Œå¤‡</td>
<td>åŸºäº erlang å¼€å‘ï¼Œå¹¶å‘èƒ½åŠ›å¾ˆå¼ºï¼Œæ€§èƒ½æå¥½ï¼Œå»¶æ—¶å¾ˆä½</td>
<td>MQ åŠŸèƒ½è¾ƒä¸ºå®Œå–„ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰©å±•æ€§å¥½</td>
<td>åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ”¯æŒç®€å•çš„ MQ åŠŸèƒ½ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ä»¥åŠæ—¥å¿—é‡‡é›†è¢«å¤§è§„æ¨¡ä½¿ç”¨</td>
</tr>
</tbody>
</table>
<p>ç»¼ä¸Šï¼Œå„ç§å¯¹æ¯”ä¹‹åï¼Œæœ‰å¦‚ä¸‹å»ºè®®ï¼š</p>
<ul>
<li>ä¸€èˆ¬çš„ä¸šåŠ¡ç³»ç»Ÿè¦å¼•å…¥ MQï¼Œæœ€æ—©å¤§å®¶éƒ½ç”¨ ActiveMQï¼Œä½†æ˜¯ç°åœ¨ç¡®å®å¤§å®¶ç”¨çš„ä¸å¤šäº†ï¼Œæ²¡ç»è¿‡å¤§è§„æ¨¡ååé‡åœºæ™¯çš„éªŒè¯ï¼Œç¤¾åŒºä¹Ÿä¸æ˜¯å¾ˆæ´»è·ƒï¼Œæ‰€ä»¥å¤§å®¶è¿˜æ˜¯ç®—äº†å§ï¼Œæˆ‘ä¸ªäººä¸æ¨èç”¨è¿™ä¸ªäº†ï¼›</li>
<li>åæ¥å¤§å®¶å¼€å§‹ç”¨ RabbitMQï¼Œä½†æ˜¯ç¡®å® erlang è¯­è¨€é˜»æ­¢äº†å¤§é‡çš„ Java å·¥ç¨‹å¸ˆå»æ·±å…¥ç ”ç©¶å’ŒæŒæ§å®ƒï¼Œå¯¹å…¬å¸è€Œè¨€ï¼Œå‡ ä¹å¤„äºä¸å¯æ§çš„çŠ¶æ€ï¼Œä½†æ˜¯ç¡®å®äººå®¶æ˜¯å¼€æºçš„ï¼Œæ¯”è¾ƒç¨³å®šçš„æ”¯æŒï¼Œæ´»è·ƒåº¦ä¹Ÿé«˜ï¼›</li>
<li>ä¸è¿‡ç°åœ¨ç¡®å®è¶Šæ¥è¶Šå¤šçš„å…¬å¸ä¼šå»ç”¨ RocketMQï¼Œç¡®å®å¾ˆä¸é”™ï¼Œæ¯•ç«Ÿæ˜¯é˜¿é‡Œå‡ºå“ï¼Œä½†ç¤¾åŒºå¯èƒ½æœ‰çªç„¶é»„æ‰çš„é£é™©ï¼ˆç›®å‰ RocketMQ å·²æç»™ <a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">Apache</a>ï¼Œä½† GitHub ä¸Šçš„æ´»è·ƒåº¦å…¶å®ä¸ç®—é«˜ï¼‰å¯¹è‡ªå·±å…¬å¸æŠ€æœ¯å®åŠ›æœ‰ç»å¯¹è‡ªä¿¡çš„ï¼Œæ¨èç”¨ RocketMQï¼Œå¦åˆ™å›å»è€è€å®å®ç”¨ RabbitMQ å§ï¼Œäººå®¶æœ‰æ´»è·ƒçš„å¼€æºç¤¾åŒºï¼Œç»å¯¹ä¸ä¼šé»„ã€‚</li>
<li>æ‰€ä»¥<strong>ä¸­å°å‹å…¬å¸</strong>ï¼ŒæŠ€æœ¯å®åŠ›è¾ƒä¸ºä¸€èˆ¬ï¼ŒæŠ€æœ¯æŒ‘æˆ˜ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œç”¨ RabbitMQ æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›<strong>å¤§å‹å…¬å¸</strong>ï¼ŒåŸºç¡€æ¶æ„ç ”å‘å®åŠ›è¾ƒå¼ºï¼Œç”¨ RocketMQ æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚</li>
<li>å¦‚æœæ˜¯<strong>å¤§æ•°æ®é¢†åŸŸ</strong>çš„å®æ—¶è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯ï¼Œç”¨ Kafka æ˜¯ä¸šå†…æ ‡å‡†çš„ï¼Œç»å¯¹æ²¡é—®é¢˜ï¼Œç¤¾åŒºæ´»è·ƒåº¦å¾ˆé«˜ï¼Œç»å¯¹ä¸ä¼šé»„ï¼Œä½•å†µå‡ ä¹æ˜¯å…¨ä¸–ç•Œè¿™ä¸ªé¢†åŸŸçš„äº‹å®æ€§è§„èŒƒã€‚</li>
</ul>
<h2 id="6-jms"><a class="markdownIt-Anchor" href="#6-jms"></a> 6. JMS</h2>
<p>æåˆ° MQï¼Œå°±é¡ºä¾¿æä¸€ä¸‹ JMS ã€‚</p>
<p><strong>JMSï¼ˆJAVA Message Serviceï¼Œjava æ¶ˆæ¯æœåŠ¡ï¼‰API æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœåŠ¡çš„æ ‡å‡†/è§„èŒƒï¼Œå…è®¸åº”ç”¨ç¨‹åºç»„ä»¶åŸºäº JavaEE å¹³å°åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯</strong>ã€‚å®ƒä½¿åˆ†å¸ƒå¼é€šä¿¡è€¦åˆåº¦æ›´ä½ï¼Œæ¶ˆæ¯æœåŠ¡æ›´åŠ å¯é ä»¥åŠå¼‚æ­¥æ€§ã€‚</p>
<p>åœ¨ EJB æ¶æ„ä¸­ï¼Œæœ‰æ¶ˆæ¯ bean å¯ä»¥æ— ç¼çš„ä¸ JMS æ¶ˆæ¯æœåŠ¡é›†æˆã€‚åœ¨ J2EE æ¶æ„æ¨¡å¼ä¸­ï¼Œæœ‰æ¶ˆæ¯æœåŠ¡è€…æ¨¡å¼ï¼Œç”¨äºå®ç°æ¶ˆæ¯ä¸åº”ç”¨ç›´æ¥çš„è§£è€¦ã€‚</p>
<h3 id="61-æ¶ˆæ¯æ¨¡å‹"><a class="markdownIt-Anchor" href="#61-æ¶ˆæ¯æ¨¡å‹"></a> 6.1. æ¶ˆæ¯æ¨¡å‹</h3>
<p>åœ¨ JMS æ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ï¼š</p>
<ul>
<li>P2P(Point to Point)</li>
<li>Pub/Sub(Publish/Subscribe)</li>
</ul>
<h4 id="p2p-æ¨¡å¼"><a class="markdownIt-Anchor" href="#p2p-æ¨¡å¼"></a> P2P æ¨¡å¼</h4>
<div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-2adc66e2367cd2c2.png"/></div>
P2P æ¨¡å¼åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼šMQï¼ˆQueueï¼‰ï¼Œå‘é€è€…(Sender)ï¼Œæ¥æ”¶è€…(Receiver)ã€‚æ¯ä¸ªæ¶ˆæ¯éƒ½è¢«å‘é€åˆ°ä¸€ä¸ªç‰¹å®šçš„é˜Ÿåˆ—ï¼Œæ¥æ”¶è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚é˜Ÿåˆ—ä¿ç•™ç€æ¶ˆæ¯ï¼Œç›´åˆ°ä»–ä»¬è¢«æ¶ˆè´¹æˆ–è¶…æ—¶ã€‚
<p>P2P çš„ç‰¹ç‚¹</p>
<ul>
<li>æ¯ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰(å³ä¸€æ—¦è¢«æ¶ˆè´¹ï¼Œæ¶ˆæ¯å°±ä¸å†åœ¨ MQ ä¸­)</li>
<li>å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´åœ¨æ—¶é—´ä¸Šæ²¡æœ‰ä¾èµ–æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‘é€è€…å‘é€äº†æ¶ˆæ¯ä¹‹åï¼Œä¸ç®¡æ¥æ”¶è€…æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œï¼Œå®ƒä¸ä¼šå½±å“åˆ°æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—</li>
<li>æ¥æ”¶è€…åœ¨æˆåŠŸæ¥æ”¶æ¶ˆæ¯ä¹‹åéœ€å‘é˜Ÿåˆ—åº”ç­”æˆåŠŸ</li>
</ul>
<p>å¦‚æœå¸Œæœ›å‘é€çš„æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æˆåŠŸå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦ P2P æ¨¡å¼ã€‚</p>
<h4 id="pubsub-æ¨¡å¼"><a class="markdownIt-Anchor" href="#pubsub-æ¨¡å¼"></a> Pub/sub æ¨¡å¼</h4>
<div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-12afe9581da889ea.png"/></div>
åŒ…å«ä¸‰ä¸ªè§’è‰²ä¸»é¢˜ï¼ˆTopicï¼‰ï¼Œå‘å¸ƒè€…ï¼ˆPublisherï¼‰ï¼Œè®¢é˜…è€…ï¼ˆSubscriberï¼‰ ã€‚å¤šä¸ªå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ° Topic,ç³»ç»Ÿå°†è¿™äº›æ¶ˆæ¯ä¼ é€’ç»™å¤šä¸ªè®¢é˜…è€…ã€‚
<p>Pub/Sub çš„ç‰¹ç‚¹</p>
<ul>
<li>æ¯ä¸ªæ¶ˆæ¯å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…</li>
<li>å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´æœ‰æ—¶é—´ä¸Šçš„ä¾èµ–æ€§ã€‚é’ˆå¯¹æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰çš„è®¢é˜…è€…ï¼Œå®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ä¹‹åï¼Œæ‰èƒ½æ¶ˆè´¹å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</li>
<li>ä¸ºäº†æ¶ˆè´¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…å¿…é¡»ä¿æŒè¿è¡Œçš„çŠ¶æ€ã€‚</li>
</ul>
<p>ä¸ºäº†ç¼“å’Œè¿™æ ·ä¸¥æ ¼çš„æ—¶é—´ç›¸å…³æ€§ï¼ŒJMS å…è®¸è®¢é˜…è€…åˆ›å»ºä¸€ä¸ªå¯æŒä¹…åŒ–çš„è®¢é˜…ã€‚è¿™æ ·ï¼Œå³ä½¿è®¢é˜…è€…æ²¡æœ‰è¢«æ¿€æ´»ï¼ˆè¿è¡Œï¼‰ï¼Œå®ƒä¹Ÿèƒ½æ¥æ”¶åˆ°å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœå¸Œæœ›å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¸è¢«åšä»»ä½•å¤„ç†ã€æˆ–è€…åªè¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†ã€æˆ–è€…å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨ Pub/Sub æ¨¡å‹ã€‚</p>
<h3 id="62-æ¶ˆæ¯æ¶ˆè´¹"><a class="markdownIt-Anchor" href="#62-æ¶ˆæ¯æ¶ˆè´¹"></a> 6.2. æ¶ˆæ¯æ¶ˆè´¹</h3>
<p>åœ¨ JMS ä¸­ï¼Œæ¶ˆæ¯çš„äº§ç”Ÿå’Œæ¶ˆè´¹éƒ½æ˜¯å¼‚æ­¥çš„ã€‚å¯¹äºæ¶ˆè´¹æ¥è¯´ï¼ŒJMS çš„æ¶ˆæ¯è€…å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚</p>
<ul>
<li><strong>åŒæ­¥</strong> - è®¢é˜…è€…æˆ–æ¥æ”¶è€…é€šè¿‡ <code>receive</code> æ–¹æ³•æ¥æ¥æ”¶æ¶ˆæ¯ï¼Œ<code>receive</code> æ–¹æ³•åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰ï¼ˆæˆ–è¶…æ—¶ä¹‹å‰ï¼‰å°†ä¸€ç›´é˜»å¡ï¼›</li>
<li><strong>å¼‚æ­¥</strong> - è®¢é˜…è€…æˆ–æ¥æ”¶è€…å¯ä»¥æ³¨å†Œä¸ºä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ã€‚å½“æ¶ˆæ¯åˆ°è¾¾ä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨çš„ <code>onMessage</code> æ–¹æ³•ã€‚</li>
</ul>
<p><code>JNDI</code> - Java å‘½åå’Œç›®å½•æ¥å£,æ˜¯ä¸€ç§æ ‡å‡†çš„ Java å‘½åç³»ç»Ÿæ¥å£ã€‚å¯ä»¥åœ¨ç½‘ç»œä¸ŠæŸ¥æ‰¾å’Œè®¿é—®æœåŠ¡ã€‚é€šè¿‡æŒ‡å®šä¸€ä¸ªèµ„æºåç§°ï¼Œè¯¥åç§°å¯¹åº”äºæ•°æ®åº“æˆ–å‘½åæœåŠ¡ä¸­çš„ä¸€ä¸ªè®°å½•ï¼ŒåŒæ—¶è¿”å›èµ„æºè¿æ¥å»ºç«‹æ‰€å¿…é¡»çš„ä¿¡æ¯ã€‚</p>
<p>JNDI åœ¨ JMS ä¸­èµ·åˆ°æŸ¥æ‰¾å’Œè®¿é—®å‘é€ç›®æ ‡æˆ–æ¶ˆæ¯æ¥æºçš„ä½œç”¨ã€‚</p>
<h3 id="63-jms-ç¼–ç¨‹æ¨¡å‹"><a class="markdownIt-Anchor" href="#63-jms-ç¼–ç¨‹æ¨¡å‹"></a> 6.3. JMS ç¼–ç¨‹æ¨¡å‹</h3>
<h4 id="connectionfactory"><a class="markdownIt-Anchor" href="#connectionfactory"></a> ConnectionFactory</h4>
<p>åˆ›å»º Connection å¯¹è±¡çš„å·¥å‚ï¼Œé’ˆå¯¹ä¸¤ç§ä¸åŒçš„ jms æ¶ˆæ¯æ¨¡å‹ï¼Œåˆ†åˆ«æœ‰ QueueConnectionFactory å’Œ TopicConnectionFactory ä¸¤ç§ã€‚å¯ä»¥é€šè¿‡ JNDI æ¥æŸ¥æ‰¾ ConnectionFactory å¯¹è±¡ã€‚</p>
<h4 id="destination"><a class="markdownIt-Anchor" href="#destination"></a> Destination</h4>
<p>Destination çš„æ„æ€æ˜¯æ¶ˆæ¯ç”Ÿäº§è€…çš„æ¶ˆæ¯å‘é€ç›®æ ‡æˆ–è€…è¯´æ¶ˆæ¯æ¶ˆè´¹è€…çš„æ¶ˆæ¯æ¥æºã€‚å¯¹äºæ¶ˆæ¯ç”Ÿäº§è€…æ¥è¯´ï¼Œå®ƒçš„ Destination æ˜¯æŸä¸ªé˜Ÿåˆ—ï¼ˆQueueï¼‰æˆ–æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰;å¯¹äºæ¶ˆæ¯æ¶ˆè´¹è€…æ¥è¯´ï¼Œå®ƒçš„ Destination ä¹Ÿæ˜¯æŸä¸ªé˜Ÿåˆ—æˆ–ä¸»é¢˜ï¼ˆå³æ¶ˆæ¯æ¥æºï¼‰ã€‚</p>
<p>æ‰€ä»¥ï¼ŒDestination å®é™…ä¸Šå°±æ˜¯ä¸¤ç§ç±»å‹çš„å¯¹è±¡ï¼šQueueã€Topicã€‚å¯ä»¥é€šè¿‡ JNDI æ¥æŸ¥æ‰¾ Destinationã€‚</p>
<h4 id="connection"><a class="markdownIt-Anchor" href="#connection"></a> Connection</h4>
<p>Connection è¡¨ç¤ºåœ¨å®¢æˆ·ç«¯å’Œ JMS ç³»ç»Ÿä¹‹é—´å»ºç«‹çš„é“¾æ¥ï¼ˆå¯¹ TCP/IP socket çš„åŒ…è£…ï¼‰ã€‚Connection å¯ä»¥äº§ç”Ÿä¸€ä¸ªæˆ–å¤šä¸ª Sessionã€‚è·Ÿ ConnectionFactory ä¸€æ ·ï¼ŒConnection ä¹Ÿæœ‰ä¸¤ç§ç±»å‹ï¼šQueueConnection å’Œ TopicConnectionã€‚</p>
<h4 id="session"><a class="markdownIt-Anchor" href="#session"></a> Session</h4>
<p>Session æ˜¯æ“ä½œæ¶ˆæ¯çš„æ¥å£ã€‚å¯ä»¥é€šè¿‡ session åˆ›å»ºç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ã€æ¶ˆæ¯ç­‰ã€‚Session æä¾›äº†äº‹åŠ¡çš„åŠŸèƒ½ã€‚å½“éœ€è¦ä½¿ç”¨ session å‘é€/æ¥æ”¶å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œå¯ä»¥å°†è¿™äº›å‘é€/æ¥æ”¶åŠ¨ä½œæ”¾åˆ°ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚åŒæ ·ï¼Œä¹Ÿåˆ† QueueSession å’Œ TopicSessionã€‚</p>
<h4 id="æ¶ˆæ¯çš„ç”Ÿäº§è€…"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯çš„ç”Ÿäº§è€…"></a> æ¶ˆæ¯çš„ç”Ÿäº§è€…</h4>
<p>æ¶ˆæ¯ç”Ÿäº§è€…ç”± Session åˆ›å»ºï¼Œå¹¶ç”¨äºå°†æ¶ˆæ¯å‘é€åˆ° Destinationã€‚åŒæ ·ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…åˆ†ä¸¤ç§ç±»å‹ï¼šQueueSender å’Œ TopicPublisherã€‚å¯ä»¥è°ƒç”¨æ¶ˆæ¯ç”Ÿäº§è€…çš„æ–¹æ³•ï¼ˆsend æˆ– publish æ–¹æ³•ï¼‰å‘é€æ¶ˆæ¯ã€‚</p>
<h4 id="æ¶ˆæ¯æ¶ˆè´¹è€…"><a class="markdownIt-Anchor" href="#æ¶ˆæ¯æ¶ˆè´¹è€…"></a> æ¶ˆæ¯æ¶ˆè´¹è€…</h4>
<p>æ¶ˆæ¯æ¶ˆè´¹è€…ç”± Session åˆ›å»ºï¼Œç”¨äºæ¥æ”¶è¢«å‘é€åˆ° Destination çš„æ¶ˆæ¯ã€‚ä¸¤ç§ç±»å‹ï¼šQueueReceiver å’Œ TopicSubscriberã€‚å¯åˆ†åˆ«é€šè¿‡ session çš„ createReceiver(Queue)æˆ– createSubscriber(Topic)æ¥åˆ›å»ºã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ session çš„ creatDurableSubscriber æ–¹æ³•æ¥åˆ›å»ºæŒä¹…åŒ–çš„è®¢é˜…è€…ã€‚</p>
<h4 id="messagelistener"><a class="markdownIt-Anchor" href="#messagelistener"></a> MessageListener</h4>
<p>æ¶ˆæ¯ç›‘å¬å™¨ã€‚å¦‚æœæ³¨å†Œäº†æ¶ˆæ¯ç›‘å¬å™¨ï¼Œä¸€æ—¦æ¶ˆæ¯åˆ°è¾¾ï¼Œå°†è‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨çš„ onMessage æ–¹æ³•ã€‚EJB ä¸­çš„ MDBï¼ˆMessage-Driven Beanï¼‰å°±æ˜¯ä¸€ç§ MessageListenerã€‚</p>
<h2 id="7-å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#7-å‚è€ƒèµ„æ–™"></a> 7. å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://www.cnblogs.com/itfly8/p/5155983.html" target="_blank" rel="noopener">å¤§å‹ç½‘ç«™æ¶æ„ç³»åˆ—ï¼šåˆ†å¸ƒå¼ MQï¼ˆä¸€ï¼‰</a></li>
<li><a href="https://www.cnblogs.com/itfly8/p/5156155.html" target="_blank" rel="noopener">å¤§å‹ç½‘ç«™æ¶æ„ç³»åˆ—ï¼šMQï¼ˆäºŒï¼‰</a></li>
<li><a href="https://www.jianshu.com/p/453c6e7ff81c" target="_blank" rel="noopener">åˆ†å¸ƒå¼å¼€æ”¾ MQ(RocketMQ)çš„åŸç†ä¸å®è·µ</a></li>
<li><a href="https://juejin.im/entry/5a0abfb5f265da43062a4a91" target="_blank" rel="noopener">é˜¿é‡Œ RocketMQ ä¼˜åŠ¿å¯¹æ¯”</a></li>
<li><a href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/mq-interview.md" target="_blank" rel="noopener">advanced-java ä¹‹ MQ</a></li>
<li><a href="https://juejin.im/post/6844903635046924296" target="_blank" rel="noopener">æµ…è°ˆæ¶ˆæ¯é˜Ÿåˆ—åŠå¸¸è§çš„æ¶ˆæ¯ä¸­é—´ä»¶</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/cache/" class="post-title-link" itemprop="url">ç¼“å­˜åŸºæœ¬åŸç†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-27 15:36:00" itemprop="dateCreated datePublished" datetime="2019-06-27T15:36:00+08:00">2019-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/cache/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/cache/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>12 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç¼“å­˜åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#ç¼“å­˜åŸºæœ¬åŸç†"></a> ç¼“å­˜åŸºæœ¬åŸç†</h1>
<blockquote>
<p>ç¼“å­˜æ˜¯ä¸€ç§åˆ©ç”¨ç©ºé—´æ¢æ—¶é—´çš„è®¾è®¡ï¼Œå…¶ç›®æ ‡å°±æ˜¯<strong>æ›´å¿«</strong>ã€<strong>æ›´è¿‘</strong>ã€‚</p>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
</blockquote>
<p><img src="http://dunwu.test.upcdn.net/snap/20200710163555.png" alt="img" /></p>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#%E4%B8%80%E7%BC%93%E5%AD%98%E7%AE%80%E4%BB%8B">ä¸€ã€ç¼“å­˜ç®€ä»‹</a>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98">ä»€ä¹ˆæ˜¯ç¼“å­˜</a></li>
<li><a href="#%E4%BD%95%E6%97%B6%E9%9C%80%E8%A6%81%E7%BC%93%E5%AD%98">ä½•æ—¶éœ€è¦ç¼“å­˜</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86">ç¼“å­˜çš„åŸºæœ¬åŸç†</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5">ç¼“å­˜æ·˜æ±°ç­–ç•¥</a></li>
<li><a href="#jsr-107">JSR 107</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C%E7%BC%93%E5%AD%98%E7%9A%84%E5%88%86%E7%B1%BB">äºŒã€ç¼“å­˜çš„åˆ†ç±»</a>
<ul>
<li><a href="#http-%E7%BC%93%E5%AD%98">HTTP ç¼“å­˜</a></li>
<li><a href="#cdn-%E7%BC%93%E5%AD%98">CDN ç¼“å­˜</a></li>
<li><a href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98">åå‘ä»£ç†ç¼“å­˜</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E8%BF%9B%E7%A8%8B%E5%86%85%E7%BC%93%E5%AD%98">ä¸‰ã€è¿›ç¨‹å†…ç¼“å­˜</a>
<ul>
<li><a href="#concurrenthashmap">ConcurrentHashMap</a></li>
<li><a href="#lruhashmap">LRUHashMap</a></li>
<li><a href="#guava-cache">Guava Cache</a></li>
<li><a href="#caffeine">Caffeine</a></li>
<li><a href="#ehcache">Ehcache</a></li>
<li><a href="#%E8%BF%9B%E7%A8%8B%E5%86%85%E7%BC%93%E5%AD%98%E5%AF%B9%E6%AF%94">è¿›ç¨‹å†…ç¼“å­˜å¯¹æ¯”</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98">å››ã€åˆ†å¸ƒå¼ç¼“å­˜</a>
<ul>
<li><a href="#memcached">Memcached</a></li>
<li><a href="#redis">Redis</a></li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E5%AF%B9%E6%AF%94">åˆ†å¸ƒå¼ç¼“å­˜å¯¹æ¯”</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98">äº”ã€å¤šçº§ç¼“å­˜</a>
<ul>
<li><a href="#%E6%95%B4%E4%BD%93%E7%BC%93%E5%AD%98%E6%A1%86%E6%9E%B6">æ•´ä½“ç¼“å­˜æ¡†æ¶</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E7%BC%93%E5%AD%98">ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98">ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98">ä½¿ç”¨å¤šçº§ç¼“å­˜</a></li>
</ul>
</li>
<li><a href="#%E5%85%AD%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98">å…­ã€ç¼“å­˜é—®é¢˜</a>
<ul>
<li><a href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9">ç¼“å­˜é›ªå´©</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">ç¼“å­˜ç©¿é€</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF">ç¼“å­˜å‡»ç©¿</a></li>
<li><a href="#%E5%B0%8F%E7%BB%93">å°ç»“</a></li>
</ul>
</li>
<li><a href="#%E4%B8%83%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5">ä¸ƒã€ç¼“å­˜ç­–ç•¥</a>
<ul>
<li><a href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD">ç¼“å­˜é¢„çƒ­</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E7%BC%93%E5%AD%98">å¦‚ä½•ç¼“å­˜</a></li>
<li><a href="#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0">ç¼“å­˜æ›´æ–°</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="ä¸€-ç¼“å­˜ç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-ç¼“å­˜ç®€ä»‹"></a> ä¸€ã€ç¼“å­˜ç®€ä»‹</h2>
<h3 id="ä»€ä¹ˆæ˜¯ç¼“å­˜"><a class="markdownIt-Anchor" href="#ä»€ä¹ˆæ˜¯ç¼“å­˜"></a> ä»€ä¹ˆæ˜¯ç¼“å­˜</h3>
<p><strong>ç¼“å­˜å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒº</strong>ã€‚<strong>ç¼“å­˜çš„æœ¬è´¨æ˜¯ä¸€ä¸ªå†…å­˜ Hash</strong>ã€‚</p>
<p>ç¼“å­˜æ˜¯ä¸€ç§åˆ©ç”¨ç©ºé—´æ¢æ—¶é—´çš„è®¾è®¡ï¼Œå…¶ç›®æ ‡å°±æ˜¯<strong>æ›´å¿«</strong>ã€<strong>æ›´è¿‘</strong>ï¼š</p>
<ul>
<li>å°†æ•°æ®å†™å…¥/è¯»å–é€Ÿåº¦<strong>æ›´å¿«</strong>çš„å­˜å‚¨ï¼ˆè®¾å¤‡ï¼‰ï¼›</li>
<li>å°†æ•°æ®ç¼“å­˜åˆ°ç¦»åº”ç”¨<strong>æœ€è¿‘</strong>çš„ä½ç½®ï¼›</li>
<li>å°†æ•°æ®ç¼“å­˜åˆ°ç¦»<strong>ç”¨æˆ·</strong>æœ€è¿‘çš„ä½ç½®ã€‚</li>
</ul>
<p>ç¼“å­˜æ˜¯ç”¨äºå­˜å‚¨æ•°æ®çš„ç¡¬ä»¶æˆ–è½¯ä»¶çš„ç»„æˆéƒ¨åˆ†ï¼Œä»¥ä½¿å¾—åç»­æ›´å¿«è®¿é—®ç›¸åº”çš„æ•°æ®ã€‚ç¼“å­˜ä¸­çš„æ•°æ®å¯èƒ½æ˜¯æå‰è®¡ç®—å¥½çš„ç»“æœã€æ•°æ®çš„å‰¯æœ¬ç­‰ã€‚å…¸å‹çš„åº”ç”¨åœºæ™¯ï¼šæœ‰ cpu cache, ç£ç›˜ cache ç­‰ã€‚æœ¬æ–‡ä¸­æåŠåˆ°ç¼“å­˜ä¸»è¦æ˜¯æŒ‡äº’è”ç½‘åº”ç”¨ä¸­æ‰€ä½¿ç”¨çš„ç¼“å­˜ç»„ä»¶ã€‚</p>
<p><strong>ç¼“å­˜å‘½ä¸­ç‡</strong>æ˜¯ç¼“å­˜çš„é‡è¦åº¦é‡æŒ‡æ ‡ï¼Œå‘½ä¸­ç‡è¶Šé«˜è¶Šå¥½ã€‚</p>
<figure class="highlight fix"><table><tr><td class="code"><pre><span class="line"><span class="attr">ç¼“å­˜å‘½ä¸­ç‡ </span>=<span class="string"> ä»ç¼“å­˜ä¸­è¯»å–æ¬¡æ•° / æ€»è¯»å–æ¬¡æ•°</span></span><br></pre></td></tr></table></figure>
<h3 id="ä½•æ—¶éœ€è¦ç¼“å­˜"><a class="markdownIt-Anchor" href="#ä½•æ—¶éœ€è¦ç¼“å­˜"></a> ä½•æ—¶éœ€è¦ç¼“å­˜</h3>
<p>å¼•å…¥ç¼“å­˜ï¼Œä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚æ‰€ä»¥ï¼Œå¼•å…¥ç¼“å­˜å‰ï¼Œéœ€è¦å…ˆæƒè¡¡æ˜¯å¦å€¼å¾—ï¼Œè€ƒé‡ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>CPU å¼€é”€</strong> - å¦‚æœåº”ç”¨æŸä¸ªè®¡ç®—éœ€è¦æ¶ˆè€—å¤§é‡ CPUï¼Œå¯ä»¥è€ƒè™‘ç¼“å­˜å…¶è®¡ç®—ç»“æœã€‚å…¸å‹åœºæ™¯ï¼šå¤æ‚çš„ã€é¢‘ç¹è°ƒç”¨çš„æ­£åˆ™è®¡ç®—ï¼›åˆ†å¸ƒå¼è®¡ç®—ä¸­é—´çŠ¶æ€ç­‰ã€‚</li>
<li><strong>IO å¼€é”€</strong> - å¦‚æœæ•°æ®åº“è¿æ¥æ± æ¯”è¾ƒç¹å¿™ï¼Œå¯ä»¥è€ƒè™‘ç¼“å­˜å…¶æŸ¥è¯¢ç»“æœã€‚</li>
</ul>
<p>åœ¨æ•°æ®å±‚å¼•å…¥ç¼“å­˜ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªå¥½å¤„ï¼š</p>
<ul>
<li>æå‡æ•°æ®è¯»å–é€Ÿåº¦ã€‚</li>
<li>æå‡ç³»ç»Ÿæ‰©å±•èƒ½åŠ›ï¼Œé€šè¿‡æ‰©å±•ç¼“å­˜ï¼Œæå‡ç³»ç»Ÿæ‰¿è½½èƒ½åŠ›ã€‚</li>
<li>é™ä½å­˜å‚¨æˆæœ¬ï¼ŒCache+DB çš„æ–¹å¼å¯ä»¥æ‰¿æ‹…åŸæœ‰éœ€è¦å¤šå° DB æ‰èƒ½æ‰¿æ‹…çš„è¯·æ±‚é‡ï¼ŒèŠ‚çœæœºå™¨æˆæœ¬ã€‚</li>
</ul>
<h3 id="ç¼“å­˜çš„åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#ç¼“å­˜çš„åŸºæœ¬åŸç†"></a> ç¼“å­˜çš„åŸºæœ¬åŸç†</h3>
<p>æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œé€šå¸¸ç¼“å­˜æœ‰ä»¥ä¸‹å‡ ç§ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li>æ‡’æ±‰å¼(è¯»æ—¶è§¦å‘)ï¼šå…ˆæŸ¥è¯¢ DB é‡Œçš„æ•°æ®, ç„¶åæŠŠç›¸å…³çš„æ•°æ®å†™å…¥ Cacheã€‚</li>
<li>é¥¥é¥¿å¼(å†™æ—¶è§¦å‘)ï¼šå†™å…¥ DB å, ç„¶åæŠŠç›¸å…³çš„æ•°æ®ä¹Ÿå†™å…¥ Cacheã€‚</li>
<li>å®šæœŸåˆ·æ–°ï¼šé€‚åˆå‘¨æœŸæ€§çš„è·‘æ•°æ®çš„ä»»åŠ¡ï¼Œæˆ–è€…åˆ—è¡¨å‹çš„æ•°æ®ï¼Œè€Œä¸”ä¸è¦æ±‚ç»å¯¹å®æ—¶æ€§ã€‚</li>
</ul>
<h3 id="ç¼“å­˜æ·˜æ±°ç­–ç•¥"><a class="markdownIt-Anchor" href="#ç¼“å­˜æ·˜æ±°ç­–ç•¥"></a> ç¼“å­˜æ·˜æ±°ç­–ç•¥</h3>
<p>ç¼“å­˜æ·˜æ±°çš„ç±»å‹ï¼š</p>
<ul>
<li><strong>åŸºäºç©ºé—´</strong> - è®¾ç½®ç¼“å­˜ç©ºé—´å¤§å°ã€‚</li>
<li><strong>åŸºäºå®¹é‡</strong> - è®¾ç½®ç¼“å­˜å­˜å‚¨è®°å½•æ•°ã€‚</li>
<li><strong>åŸºäºæ—¶é—´</strong>
<ul>
<li>TTLï¼ˆTime To Liveï¼Œå³å­˜æ´»æœŸï¼‰ç¼“å­˜æ•°æ®ä»åˆ›å»ºåˆ°è¿‡æœŸçš„æ—¶é—´ã€‚</li>
<li>TTIï¼ˆTime To Idleï¼Œå³ç©ºé—²æœŸï¼‰ç¼“å­˜æ•°æ®å¤šä¹…æ²¡è¢«è®¿é—®çš„æ—¶é—´ã€‚</li>
</ul>
</li>
</ul>
<p>ç¼“å­˜æ·˜æ±°ç®—æ³•ï¼š</p>
<ul>
<li><strong>FIFO</strong> - <strong>å…ˆè¿›å…ˆå‡º</strong>ã€‚åœ¨è¿™ç§æ·˜æ±°ç®—æ³•ä¸­ï¼Œå…ˆè¿›å…¥ç¼“å­˜çš„ä¼šå…ˆè¢«æ·˜æ±°ã€‚è¿™ç§å¯è°“æ˜¯æœ€ç®€å•çš„äº†ï¼Œä½†æ˜¯ä¼šå¯¼è‡´æˆ‘ä»¬å‘½ä¸­ç‡å¾ˆä½ã€‚è¯•æƒ³ä¸€ä¸‹æˆ‘ä»¬å¦‚æœæœ‰ä¸ªè®¿é—®é¢‘ç‡å¾ˆé«˜çš„æ•°æ®æ˜¯æ‰€æœ‰æ•°æ®ç¬¬ä¸€ä¸ªè®¿é—®çš„ï¼Œè€Œé‚£äº›ä¸æ˜¯å¾ˆé«˜çš„æ˜¯åé¢å†è®¿é—®çš„ï¼Œé‚£è¿™æ ·å°±ä¼šæŠŠæˆ‘ä»¬çš„é¦–ä¸ªæ•°æ®ä½†æ˜¯ä»–çš„è®¿é—®é¢‘ç‡å¾ˆé«˜ç»™æŒ¤å‡ºã€‚</li>
<li><strong>LRU</strong> - <strong>æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•</strong>ã€‚åœ¨è¿™ç§ç®—æ³•ä¸­é¿å…äº†ä¸Šé¢çš„é—®é¢˜ï¼Œæ¯æ¬¡è®¿é—®æ•°æ®éƒ½ä¼šå°†å…¶æ”¾åœ¨æˆ‘ä»¬çš„é˜Ÿå°¾ï¼Œå¦‚æœéœ€è¦æ·˜æ±°æ•°æ®ï¼Œå°±åªéœ€è¦æ·˜æ±°é˜Ÿé¦–å³å¯ã€‚ä½†æ˜¯è¿™ä¸ªä¾ç„¶æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæœ‰ä¸ªæ•°æ®åœ¨ 1 ä¸ªå°æ—¶çš„å‰ 59 åˆ†é’Ÿè®¿é—®äº† 1 ä¸‡æ¬¡(å¯è§è¿™æ˜¯ä¸ªçƒ­ç‚¹æ•°æ®),å†åä¸€åˆ†é’Ÿæ²¡æœ‰è®¿é—®è¿™ä¸ªæ•°æ®ï¼Œä½†æ˜¯æœ‰å…¶ä»–çš„æ•°æ®è®¿é—®ï¼Œå°±å¯¼è‡´äº†æˆ‘ä»¬è¿™ä¸ªçƒ­ç‚¹æ•°æ®è¢«æ·˜æ±°ã€‚</li>
<li><strong>LFU</strong> - <strong>æœ€è¿‘æœ€å°‘é¢‘ç‡ä½¿ç”¨</strong>ã€‚åœ¨è¿™ç§ç®—æ³•ä¸­åˆå¯¹ä¸Šé¢è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåˆ©ç”¨é¢å¤–çš„ç©ºé—´è®°å½•æ¯ä¸ªæ•°æ®çš„ä½¿ç”¨é¢‘ç‡ï¼Œç„¶åé€‰å‡ºé¢‘ç‡æœ€ä½è¿›è¡Œæ·˜æ±°ã€‚è¿™æ ·å°±é¿å…äº† LRU ä¸èƒ½å¤„ç†æ—¶é—´æ®µçš„é—®é¢˜ã€‚</li>
</ul>
<p>è¿™ä¸‰ç§ç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Œå®ç°å¤æ‚åº¦ä¸€ä¸ªæ¯”ä¸€ä¸ªé«˜ï¼ŒåŒæ ·çš„å‘½ä¸­ç‡ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”ä¸€ä¸ªå¥½ã€‚è€Œæˆ‘ä»¬ä¸€èˆ¬æ¥è¯´é€‰æ‹©çš„æ–¹æ¡ˆå±…ä¸­å³å¯ï¼Œå³å®ç°æˆæœ¬ä¸æ˜¯å¤ªé«˜ï¼Œè€Œå‘½ä¸­ç‡ä¹Ÿè¿˜è¡Œçš„ LRUã€‚</p>
<h2 id="äºŒ-ç¼“å­˜çš„åˆ†ç±»"><a class="markdownIt-Anchor" href="#äºŒ-ç¼“å­˜çš„åˆ†ç±»"></a> äºŒã€ç¼“å­˜çš„åˆ†ç±»</h2>
<p>ç¼“å­˜ä»éƒ¨ç½²è§’åº¦ï¼Œå¯ä»¥åˆ†ä¸ºå®¢æˆ·ç«¯ç¼“å­˜å’ŒæœåŠ¡ç«¯ç¼“å­˜ã€‚</p>
<p><strong>å®¢æˆ·ç«¯ç¼“å­˜</strong></p>
<ul>
<li><strong>HTTP ç¼“å­˜</strong></li>
<li><strong>æµè§ˆå™¨ç¼“å­˜</strong></li>
<li><strong>APP ç¼“å­˜</strong>
<ul>
<li>Android</li>
<li>IOS</li>
</ul>
</li>
</ul>
<p><strong>æœåŠ¡ç«¯ç¼“å­˜</strong></p>
<ul>
<li><strong>CDN ç¼“å­˜</strong> - å­˜æ”¾ HTMLã€CSSã€JS ç­‰é™æ€èµ„æºã€‚</li>
<li><strong>åå‘ä»£ç†ç¼“å­˜</strong> - åŠ¨é™åˆ†ç¦»ï¼Œåªç¼“å­˜ç”¨æˆ·è¯·æ±‚çš„é™æ€èµ„æºã€‚</li>
<li><strong>æ•°æ®åº“ç¼“å­˜</strong> - æ•°æ®åº“ï¼ˆå¦‚ Mysqlï¼‰è‡ªèº«ä¸€èˆ¬ä¹Ÿæœ‰ç¼“å­˜ï¼Œä½†å› ä¸ºå‘½ä¸­ç‡å’Œæ›´æ–°é¢‘ç‡é—®é¢˜ï¼Œä¸æ¨èä½¿ç”¨ã€‚</li>
<li><strong>è¿›ç¨‹å†…ç¼“å­˜</strong> - ç¼“å­˜åº”ç”¨å­—å…¸ç­‰å¸¸ç”¨æ•°æ®ã€‚</li>
<li><strong>åˆ†å¸ƒå¼ç¼“å­˜</strong> - ç¼“å­˜æ•°æ®åº“ä¸­çš„çƒ­ç‚¹æ•°æ®ã€‚</li>
</ul>
<blockquote>
<p>å…¶ä¸­ï¼ŒCDN ç¼“å­˜ã€åå‘ä»£ç†ç¼“å­˜ã€æ•°æ®åº“ç¼“å­˜ä¸€èˆ¬ç”±ä¸“èŒäººå‘˜ç»´æŠ¤ï¼ˆè¿ç»´ã€DBAï¼‰ã€‚</p>
<p>åç«¯å¼€å‘ä¸€èˆ¬èšç„¦äºè¿›ç¨‹å†…ç¼“å­˜ã€åˆ†å¸ƒå¼ç¼“å­˜ã€‚</p>
</blockquote>
<h3 id="http-ç¼“å­˜"><a class="markdownIt-Anchor" href="#http-ç¼“å­˜"></a> HTTP ç¼“å­˜</h3>
<h3 id="cdn-ç¼“å­˜"><a class="markdownIt-Anchor" href="#cdn-ç¼“å­˜"></a> CDN ç¼“å­˜</h3>
<blockquote>
<p><strong>CDN å°†æ•°æ®ç¼“å­˜åˆ°ç¦»ç”¨æˆ·ç‰©ç†è·ç¦»æœ€è¿‘çš„æœåŠ¡å™¨ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥å°±è¿‘è·å–è¯·æ±‚å†…å®¹ã€‚CDN ä¸€èˆ¬ç¼“å­˜é™æ€èµ„æºæ–‡ä»¶ï¼ˆé¡µé¢ï¼Œè„šæœ¬ï¼Œå›¾ç‰‡ï¼Œè§†é¢‘ï¼Œæ–‡ä»¶ç­‰ï¼‰</strong>ã€‚</p>
<p>å›½å†…ç½‘ç»œå¼‚å¸¸å¤æ‚ï¼Œè·¨è¿è¥å•†çš„ç½‘ç»œè®¿é—®ä¼šå¾ˆæ…¢ã€‚ä¸ºäº†è§£å†³è·¨è¿è¥å•†æˆ–å„åœ°ç”¨æˆ·è®¿é—®é—®é¢˜ï¼Œå¯ä»¥åœ¨é‡è¦çš„åŸå¸‚ï¼Œéƒ¨ç½² CDN åº”ç”¨ã€‚ä½¿ç”¨æˆ·å°±è¿‘è·å–æ‰€éœ€å†…å®¹ï¼Œé™ä½ç½‘ç»œæ‹¥å¡ï¼Œæé«˜ç”¨æˆ·è®¿é—®å“åº”é€Ÿåº¦å’Œå‘½ä¸­ç‡ã€‚</p>
</blockquote>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559138689425.png"/></div>
<h4 id="cdn-åŸç†"><a class="markdownIt-Anchor" href="#cdn-åŸç†"></a> CDN åŸç†</h4>
<p>CDN çš„åŸºæœ¬åŸç†æ˜¯å¹¿æ³›é‡‡ç”¨å„ç§ç¼“å­˜æœåŠ¡å™¨ï¼Œå°†è¿™äº›ç¼“å­˜æœåŠ¡å™¨åˆ†å¸ƒåˆ°ç”¨æˆ·è®¿é—®ç›¸å¯¹é›†ä¸­çš„åœ°åŒºæˆ–ç½‘ç»œä¸­ï¼Œåœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶ï¼Œåˆ©ç”¨å…¨å±€è´Ÿè½½æŠ€æœ¯å°†ç”¨æˆ·çš„è®¿é—®æŒ‡å‘è·ç¦»æœ€è¿‘çš„å·¥ä½œæ­£å¸¸çš„ç¼“å­˜æœåŠ¡å™¨ä¸Šï¼Œç”±ç¼“å­˜æœåŠ¡å™¨ç›´æ¥å“åº”ç”¨æˆ·è¯·æ±‚ã€‚</p>
<p>ï¼ˆ1ï¼‰æœªéƒ¨ç½² CDN åº”ç”¨å‰çš„ç½‘ç»œè·¯å¾„ï¼š</p>
<ul>
<li>è¯·æ±‚ï¼šæœ¬æœºç½‘ç»œï¼ˆå±€åŸŸç½‘ï¼‰=&gt; è¿è¥å•†ç½‘ç»œ =&gt; åº”ç”¨æœåŠ¡å™¨æœºæˆ¿</li>
<li>å“åº”ï¼šåº”ç”¨æœåŠ¡å™¨æœºæˆ¿ =&gt; è¿è¥å•†ç½‘ç»œ =&gt; æœ¬æœºç½‘ç»œï¼ˆå±€åŸŸç½‘ï¼‰</li>
</ul>
<p>åœ¨ä¸è€ƒè™‘å¤æ‚ç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œä»è¯·æ±‚åˆ°å“åº”éœ€è¦ç»è¿‡ 3 ä¸ªèŠ‚ç‚¹ï¼Œ6 ä¸ªæ­¥éª¤å®Œæˆä¸€æ¬¡ç”¨æˆ·è®¿é—®æ“ä½œã€‚</p>
<p>ï¼ˆ2ï¼‰éƒ¨ç½² CDN åº”ç”¨åç½‘ç»œè·¯å¾„ï¼š</p>
<ul>
<li>è¯·æ±‚ï¼šæœ¬æœºç½‘ç»œï¼ˆå±€åŸŸç½‘ï¼‰ =&gt; è¿è¥å•†ç½‘ç»œ</li>
<li>å“åº”ï¼šè¿è¥å•†ç½‘ç»œ =&gt; æœ¬æœºç½‘ç»œï¼ˆå±€åŸŸç½‘ï¼‰</li>
</ul>
<p>åœ¨ä¸è€ƒè™‘å¤æ‚ç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œä»è¯·æ±‚åˆ°å“åº”éœ€è¦ç»è¿‡ 2 ä¸ªèŠ‚ç‚¹ï¼Œ2 ä¸ªæ­¥éª¤å®Œæˆä¸€æ¬¡ç”¨æˆ·è®¿é—®æ“ä½œã€‚</p>
<p>ä¸ä¸éƒ¨ç½² CDN æœåŠ¡ç›¸æ¯”ï¼Œå‡å°‘äº† 1 ä¸ªèŠ‚ç‚¹ï¼Œ4 ä¸ªæ­¥éª¤çš„è®¿é—®ã€‚æå¤§çš„æé«˜çš„ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ã€‚</p>
<h4 id="cdn-ç‰¹ç‚¹"><a class="markdownIt-Anchor" href="#cdn-ç‰¹ç‚¹"></a> CDN ç‰¹ç‚¹</h4>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>æœ¬åœ° Cache åŠ é€Ÿ</strong> - æå‡è®¿é—®é€Ÿåº¦ï¼Œå°¤å…¶å«æœ‰å¤§é‡å›¾ç‰‡å’Œé™æ€é¡µé¢ç«™ç‚¹ï¼›</li>
<li><strong>å®ç°è·¨è¿è¥å•†çš„ç½‘ç»œåŠ é€Ÿ</strong> - æ¶ˆé™¤äº†ä¸åŒè¿è¥å•†ä¹‹é—´äº’è”çš„ç“¶é¢ˆé€ æˆçš„å½±å“ï¼Œå®ç°äº†è·¨è¿è¥å•†çš„ç½‘ç»œåŠ é€Ÿï¼Œä¿è¯ä¸åŒç½‘ç»œä¸­çš„ç”¨æˆ·éƒ½èƒ½å¾—åˆ°è‰¯å¥½çš„è®¿é—®è´¨é‡ï¼›</li>
<li><strong>è¿œç¨‹åŠ é€Ÿ</strong> - è¿œç¨‹è®¿é—®ç”¨æˆ·æ ¹æ® DNS è´Ÿè½½å‡è¡¡æŠ€æœ¯æ™ºèƒ½è‡ªåŠ¨é€‰æ‹© Cache æœåŠ¡å™¨ï¼Œé€‰æ‹©æœ€å¿«çš„ Cache æœåŠ¡å™¨ï¼ŒåŠ å¿«è¿œç¨‹è®¿é—®çš„é€Ÿåº¦ï¼›</li>
<li><strong>å¸¦å®½ä¼˜åŒ–</strong> - è‡ªåŠ¨ç”ŸæˆæœåŠ¡å™¨çš„è¿œç¨‹ Mirrorï¼ˆé•œåƒï¼‰cache æœåŠ¡å™¨ï¼Œè¿œç¨‹ç”¨æˆ·è®¿é—®æ—¶ä» cache æœåŠ¡å™¨ä¸Šè¯»å–æ•°æ®ï¼Œå‡å°‘è¿œç¨‹è®¿é—®çš„å¸¦å®½ã€åˆ†æ‹…ç½‘ç»œæµé‡ã€å‡è½»åŸç«™ç‚¹ WEB æœåŠ¡å™¨è´Ÿè½½ç­‰åŠŸèƒ½ã€‚</li>
<li><strong>é›†ç¾¤æŠ—æ”»å‡»</strong> - å¹¿æ³›åˆ†å¸ƒçš„ CDN èŠ‚ç‚¹åŠ ä¸ŠèŠ‚ç‚¹ä¹‹é—´çš„æ™ºèƒ½å†—ä½™æœºåˆ¶ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¢„é˜²é»‘å®¢å…¥ä¾µä»¥åŠé™ä½å„ç§ D.D.o.S æ”»å‡»å¯¹ç½‘ç«™çš„å½±å“ï¼ŒåŒæ—¶ä¿è¯è¾ƒå¥½çš„æœåŠ¡è´¨é‡ã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹</strong></p>
<ul>
<li><strong>ä¸é€‚å®œç¼“å­˜åŠ¨æ€èµ„æº</strong>
<ul>
<li>è§£å†³æ–¹æ¡ˆï¼šä¸»è¦ç¼“å­˜é™æ€èµ„æºï¼ŒåŠ¨æ€èµ„æºå»ºç«‹å¤šçº§ç¼“å­˜æˆ–å‡†å®æ—¶åŒæ­¥ï¼›</li>
</ul>
</li>
<li><strong>å­˜åœ¨æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜</strong>
<ul>
<li>è§£å†³æ–¹æ¡ˆï¼ˆä¸»è¦æ˜¯åœ¨æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§äºŒè€…é—´å¯»æ‰¾ä¸€ä¸ªå¹³è¡¡ï¼‰</li>
<li>è®¾ç½®ç¼“å­˜å¤±æ•ˆæ—¶é—´ï¼ˆ1 ä¸ªå°æ—¶ï¼Œè¿‡æœŸååŒæ­¥æ•°æ®ï¼‰ã€‚</li>
<li>é’ˆå¯¹èµ„æºè®¾ç½®ç‰ˆæœ¬å·ã€‚</li>
</ul>
</li>
</ul>
<h3 id="åå‘ä»£ç†ç¼“å­˜"><a class="markdownIt-Anchor" href="#åå‘ä»£ç†ç¼“å­˜"></a> åå‘ä»£ç†ç¼“å­˜</h3>
<blockquote>
<p><strong>åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰æ–¹å¼æ˜¯æŒ‡ä»¥ä»£ç†æœåŠ¡å™¨æ¥æ¥å— internet ä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨ï¼Œå¹¶å°†ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™ internet ä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä»£ç†æœåŠ¡å™¨å¯¹å¤–å°±è¡¨ç°ä¸ºä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ã€‚</strong></p>
</blockquote>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/web/nginx/reverse-proxy.png"/></div>
<h4 id="åå‘ä»£ç†ç¼“å­˜åŸç†"><a class="markdownIt-Anchor" href="#åå‘ä»£ç†ç¼“å­˜åŸç†"></a> åå‘ä»£ç†ç¼“å­˜åŸç†</h4>
<p>åå‘ä»£ç†ä½äºåº”ç”¨æœåŠ¡å™¨åŒä¸€ç½‘ç»œï¼Œå¤„ç†æ‰€æœ‰å¯¹ WEB æœåŠ¡å™¨çš„è¯·æ±‚ã€‚</p>
<p>åå‘ä»£ç†ç¼“å­˜çš„åŸç†ï¼š</p>
<ul>
<li>å¦‚æœç”¨æˆ·è¯·æ±‚çš„é¡µé¢åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæœ‰ç¼“å­˜çš„è¯ï¼Œä»£ç†æœåŠ¡å™¨ç›´æ¥å°†ç¼“å­˜å†…å®¹å‘é€ç»™ç”¨æˆ·ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ç¼“å­˜åˆ™å…ˆå‘ WEB æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå–å›æ•°æ®ï¼Œæœ¬åœ°ç¼“å­˜åå†å‘é€ç»™ç”¨æˆ·ã€‚</li>
</ul>
<p>è¿™ç§æ–¹å¼é€šè¿‡é™ä½å‘ WEB æœåŠ¡å™¨çš„è¯·æ±‚æ•°ï¼Œä»è€Œé™ä½äº† WEB æœåŠ¡å™¨çš„è´Ÿè½½ã€‚</p>
<p><strong>åå‘ä»£ç†ç¼“å­˜ä¸€èˆ¬é’ˆå¯¹çš„æ˜¯é™æ€èµ„æºï¼Œè€Œå°†åŠ¨æ€èµ„æºè¯·æ±‚è½¬å‘åˆ°åº”ç”¨æœåŠ¡å™¨å¤„ç†</strong>ã€‚å¸¸ç”¨çš„ç¼“å­˜åº”ç”¨æœåŠ¡å™¨æœ‰ Varnishï¼ŒNgnixï¼ŒSquidã€‚</p>
<h4 id="åå‘ä»£ç†ç¼“å­˜æ¯”è¾ƒ"><a class="markdownIt-Anchor" href="#åå‘ä»£ç†ç¼“å­˜æ¯”è¾ƒ"></a> åå‘ä»£ç†ç¼“å­˜æ¯”è¾ƒ</h4>
<p>å¸¸ç”¨çš„ä»£ç†ç¼“å­˜æœ‰ Varnishï¼ŒSquidï¼ŒNgnixï¼Œç®€å•æ¯”è¾ƒå¦‚ä¸‹ï¼š</p>
<ul>
<li>Varnish å’Œ Squid æ˜¯ä¸“ä¸šçš„ cache æœåŠ¡ï¼ŒNgnix éœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—æ”¯æŒï¼›</li>
<li>Varnish é‡‡ç”¨å†…å­˜å‹ç¼“å­˜ï¼Œé¿å…äº†é¢‘ç¹åœ¨å†…å­˜ã€ç£ç›˜ä¸­äº¤æ¢æ–‡ä»¶ï¼Œæ€§èƒ½æ¯” Squid é«˜ï¼›</li>
<li>Varnish ç”±äºæ˜¯å†…å­˜ cacheï¼Œæ‰€ä»¥å¯¹å°æ–‡ä»¶å¦‚ cssã€jsã€å°å›¾ç‰‡çš„æ”¯æŒå¾ˆæ£’ï¼Œåç«¯çš„æŒä¹…åŒ–ç¼“å­˜å¯ä»¥é‡‡ç”¨çš„æ˜¯ Squid æˆ– ATSï¼›</li>
<li>Squid åŠŸèƒ½å…¨è€Œå¤§ï¼Œé€‚åˆäºå„ç§é™æ€çš„æ–‡ä»¶ç¼“å­˜ï¼Œä¸€èˆ¬ä¼šåœ¨å‰ç«¯æŒ‚ä¸€ä¸ª HAProxy æˆ– Ngnix åšè´Ÿè½½å‡è¡¡è·‘å¤šä¸ªå®ä¾‹ï¼›</li>
<li>Nginx é‡‡ç”¨ç¬¬ä¸‰æ–¹æ¨¡å— ncache åšçš„ç¼“å†²ï¼Œæ€§èƒ½åŸºæœ¬è¾¾åˆ° Varnishï¼Œä¸€èˆ¬ä½œä¸ºåå‘ä»£ç†ä½¿ç”¨ï¼Œå¯ä»¥å®ç°ç®€å•çš„ç¼“å­˜ã€‚</li>
</ul>
<h2 id="ä¸‰-è¿›ç¨‹å†…ç¼“å­˜"><a class="markdownIt-Anchor" href="#ä¸‰-è¿›ç¨‹å†…ç¼“å­˜"></a> ä¸‰ã€è¿›ç¨‹å†…ç¼“å­˜</h2>
<blockquote>
<p>è¿›ç¨‹å†…ç¼“å­˜æ˜¯æŒ‡åº”ç”¨å†…éƒ¨çš„ç¼“å­˜ï¼Œæ ‡å‡†çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¸€èˆ¬æœ‰å¤šçº§ç¼“å­˜æ„æˆã€‚æœ¬åœ°ç¼“å­˜æ˜¯ç¦»åº”ç”¨æœ€è¿‘çš„ç¼“å­˜ï¼Œä¸€èˆ¬å¯ä»¥å°†æ•°æ®ç¼“å­˜åˆ°ç¡¬ç›˜æˆ–å†…å­˜ã€‚</p>
</blockquote>
<ul>
<li><code>ç¡¬ç›˜ç¼“å­˜</code> - å°†æ•°æ®ç¼“å­˜åˆ°ç¡¬ç›˜åˆ°ï¼Œè¯»å–æ—¶ä»ç¡¬ç›˜è¯»å–ã€‚åŸç†æ˜¯ç›´æ¥è¯»å–æœ¬æœºæ–‡ä»¶ï¼Œå‡å°‘äº†ç½‘ç»œä¼ è¾“æ¶ˆè€—ï¼Œæ¯”é€šè¿‡ç½‘ç»œè¯»å–æ•°æ®åº“é€Ÿåº¦æ›´å¿«ã€‚å¯ä»¥åº”ç”¨åœ¨å¯¹é€Ÿåº¦è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œä½†éœ€è¦å¤§é‡ç¼“å­˜å­˜å‚¨çš„åœºæ™¯ã€‚</li>
<li><code>å†…å­˜ç¼“å­˜</code> - ç›´æ¥å°†æ•°æ®å­˜å‚¨åˆ°æœ¬æœºå†…å­˜ä¸­ï¼Œé€šè¿‡ç¨‹åºç›´æ¥ç»´æŠ¤ç¼“å­˜å¯¹è±¡ï¼Œæ˜¯è®¿é—®é€Ÿåº¦æœ€å¿«çš„æ–¹å¼ã€‚</li>
</ul>
<p>å¸¸è§çš„æœ¬åœ°ç¼“å­˜å®ç°æ–¹æ¡ˆï¼šHashMapã€Guava Cacheã€Caffeineã€Ehcacheã€‚</p>
<h3 id="concurrenthashmap"><a class="markdownIt-Anchor" href="#concurrenthashmap"></a> ConcurrentHashMap</h3>
<p>æœ€ç®€å•çš„è¿›ç¨‹å†…ç¼“å­˜å¯ä»¥é€šè¿‡ JDK è‡ªå¸¦çš„ <code>HashMap</code> æˆ– <code>ConcurrentHashMap</code> å®ç°ã€‚</p>
<p>é€‚ç”¨åœºæ™¯ï¼š<strong>ä¸éœ€è¦æ·˜æ±°çš„ç¼“å­˜æ•°æ®</strong>ã€‚</p>
<p>ç¼ºç‚¹ï¼šæ— æ³•è¿›è¡Œç¼“å­˜æ·˜æ±°ï¼Œå†…å­˜ä¼šæ— é™åˆ¶çš„å¢é•¿ã€‚</p>
<h3 id="lruhashmap"><a class="markdownIt-Anchor" href="#lruhashmap"></a> LRUHashMap</h3>
<p>å¯ä»¥é€šè¿‡<strong>ç»§æ‰¿ <code>LinkedHashMap</code> æ¥å®ç°ä¸€ä¸ªç®€å•çš„ <code>LRUHashMap</code></strong>ã€‚é‡å†™ <code>removeEldestEntry</code> æ–¹æ³•ï¼Œå³å¯å®Œæˆä¸€ä¸ªç®€å•çš„æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>é”ç«äº‰ä¸¥é‡ï¼Œæ€§èƒ½æ¯”è¾ƒä½ã€‚</li>
<li>ä¸æ”¯æŒè¿‡æœŸæ—¶é—´</li>
<li>ä¸æ”¯æŒè‡ªåŠ¨åˆ·æ–°</li>
</ul>
<h3 id="guava-cache"><a class="markdownIt-Anchor" href="#guava-cache"></a> Guava Cache</h3>
<p>è§£å†³äº† <code>LRUHashMap</code> ä¸­çš„å‡ ä¸ªç¼ºç‚¹ã€‚</p>
<p>Guava Cache é‡‡ç”¨äº†ç±»ä¼¼ <code>ConcurrentHashMap</code> çš„æ€æƒ³ï¼Œåˆ†æ®µåŠ é”ï¼Œå‡å°‘é”ç«äº‰ã€‚</p>
<p>Guava Cache å¯¹äºè¿‡æœŸçš„ Entry å¹¶æ²¡æœ‰é©¬ä¸Šè¿‡æœŸ(ä¹Ÿå°±æ˜¯å¹¶æ²¡æœ‰åå°çº¿ç¨‹ä¸€ç›´åœ¨æ‰«)ï¼Œè€Œæ˜¯é€šè¿‡è¿›è¡Œè¯»å†™æ“ä½œçš„æ—¶å€™è¿›è¡Œè¿‡æœŸå¤„ç†ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯é¿å…åå°çº¿ç¨‹æ‰«æçš„æ—¶å€™è¿›è¡Œå…¨å±€åŠ é”ã€‚</p>
<p>ç›´æ¥é€šè¿‡æŸ¥è¯¢ï¼Œåˆ¤æ–­å…¶æ˜¯å¦æ»¡è¶³åˆ·æ–°æ¡ä»¶ï¼Œè¿›è¡Œåˆ·æ–°ã€‚</p>
<h3 id="caffeine"><a class="markdownIt-Anchor" href="#caffeine"></a> Caffeine</h3>
<p>Caffeine å®ç°äº† W-TinyLFU(<strong>LFU</strong> + <strong>LRU</strong> ç®—æ³•çš„å˜ç§)ï¼Œå…¶<strong>å‘½ä¸­ç‡å’Œè¯»å†™ååé‡å¤§å¤§ä¼˜äº Guava Cache</strong>ã€‚</p>
<p>å…¶å®ç°åŸç†è¾ƒå¤æ‚ï¼Œå¯ä»¥å‚è€ƒ<a href="https://juejin.im/post/5b7593496fb9a009b62904fa#comment" target="_blank" rel="noopener">ä½ åº”è¯¥çŸ¥é“çš„ç¼“å­˜è¿›åŒ–å²</a>ã€‚</p>
<h3 id="ehcache"><a class="markdownIt-Anchor" href="#ehcache"></a> Ehcache</h3>
<p>EhCache æ˜¯ä¸€ä¸ªçº¯ Java çš„è¿›ç¨‹å†…ç¼“å­˜æ¡†æ¶ï¼Œå…·æœ‰å¿«é€Ÿã€ç²¾å¹²ç­‰ç‰¹ç‚¹ï¼Œæ˜¯ Hibernate ä¸­é»˜è®¤çš„ CacheProviderã€‚</p>
<p>ä¼˜ç‚¹</p>
<ul>
<li>å¿«é€Ÿã€ç®€å•</li>
<li>æ”¯æŒå¤šç§ç¼“å­˜ç­–ç•¥ï¼šLRUã€LFUã€FIFO æ·˜æ±°ç®—æ³•</li>
<li>ç¼“å­˜æ•°æ®æœ‰ä¸¤çº§ï¼šå†…å­˜å’Œç£ç›˜ï¼Œå› æ­¤æ— éœ€æ‹…å¿ƒå®¹é‡é—®é¢˜</li>
<li>ç¼“å­˜æ•°æ®ä¼šåœ¨è™šæ‹Ÿæœºé‡å¯çš„è¿‡ç¨‹ä¸­å†™å…¥ç£ç›˜</li>
<li>å¯ä»¥é€šè¿‡ RMIã€å¯æ’å…¥ API ç­‰æ–¹å¼è¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜</li>
<li>å…·æœ‰ç¼“å­˜å’Œç¼“å­˜ç®¡ç†å™¨çš„ä¾¦å¬æ¥å£</li>
<li>æ”¯æŒå¤šç¼“å­˜ç®¡ç†å™¨å®ä¾‹ï¼Œä»¥åŠä¸€ä¸ªå®ä¾‹çš„å¤šä¸ªç¼“å­˜åŒºåŸŸ</li>
<li>æä¾› Hibernate çš„ç¼“å­˜å®ç°</li>
</ul>
<p>ç¼ºç‚¹</p>
<ul>
<li><strong>ä½¿ç”¨ç£ç›˜ Cache çš„æ—¶å€™éå¸¸å ç”¨ç£ç›˜ç©ºé—´</strong></li>
<li><strong>ä¸ä¿è¯æ•°æ®çš„å®‰å…¨</strong></li>
<li>è™½ç„¶æ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜ï¼Œä½†æ•ˆç‡ä¸é«˜ï¼ˆé€šè¿‡ç»„æ’­æ–¹å¼ï¼Œåœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´åŒæ­¥æ•°æ®ï¼‰ã€‚</li>
</ul>
<h3 id="è¿›ç¨‹å†…ç¼“å­˜å¯¹æ¯”"><a class="markdownIt-Anchor" href="#è¿›ç¨‹å†…ç¼“å­˜å¯¹æ¯”"></a> è¿›ç¨‹å†…ç¼“å­˜å¯¹æ¯”</h3>
<p>å¸¸ç”¨è¿›ç¨‹å†…ç¼“å­˜æŠ€æœ¯å¯¹æ¯”ï¼š</p>
<table>
<thead>
<tr>
<th>æ¯”è¾ƒé¡¹</th>
<th>ConcurrentHashMap</th>
<th>LRUMap</th>
<th>Ehcache</th>
<th>Guava Cache</th>
<th>Caffeine</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¯»å†™æ€§èƒ½</td>
<td>å¾ˆå¥½ï¼Œåˆ†æ®µé”</td>
<td>ä¸€èˆ¬ï¼Œå…¨å±€åŠ é”</td>
<td>å¥½</td>
<td>å¥½ï¼Œéœ€è¦åšæ·˜æ±°æ“ä½œ</td>
<td>å¾ˆå¥½</td>
</tr>
<tr>
<td>æ·˜æ±°ç®—æ³•</td>
<td>æ— </td>
<td>LRUï¼Œä¸€èˆ¬</td>
<td>æ”¯æŒå¤šç§æ·˜æ±°ç®—æ³•,LRU,LFU,FIFO</td>
<td>LRUï¼Œä¸€èˆ¬</td>
<td>W-TinyLFU, å¾ˆå¥½</td>
</tr>
<tr>
<td>åŠŸèƒ½ä¸°å¯Œç¨‹åº¦</td>
<td>åŠŸèƒ½æ¯”è¾ƒç®€å•</td>
<td>åŠŸèƒ½æ¯”è¾ƒå•ä¸€</td>
<td>åŠŸèƒ½å¾ˆä¸°å¯Œ</td>
<td>åŠŸèƒ½å¾ˆä¸°å¯Œï¼Œæ”¯æŒåˆ·æ–°å’Œè™šå¼•ç”¨ç­‰</td>
<td>åŠŸèƒ½å’Œ Guava Cache ç±»ä¼¼</td>
</tr>
<tr>
<td>å·¥å…·å¤§å°</td>
<td>jdk è‡ªå¸¦ç±»ï¼Œå¾ˆå°</td>
<td>åŸºäº LinkedHashMapï¼Œè¾ƒå°</td>
<td>å¾ˆå¤§ï¼Œæœ€æ–°ç‰ˆæœ¬ 1.4MB</td>
<td>æ˜¯ Guava å·¥å…·ç±»ä¸­çš„ä¸€ä¸ªå°éƒ¨åˆ†ï¼Œè¾ƒå°</td>
<td>ä¸€èˆ¬ï¼Œæœ€æ–°ç‰ˆæœ¬ 644KB</td>
</tr>
<tr>
<td>æ˜¯å¦æŒä¹…åŒ–</td>
<td>å¦</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>æ˜¯å¦æ”¯æŒé›†ç¾¤</td>
<td>å¦</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>å¦</td>
<td>å¦</td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>ConcurrentHashMap</code></strong> - æ¯”è¾ƒé€‚åˆç¼“å­˜æ¯”è¾ƒå›ºå®šä¸å˜çš„å…ƒç´ ï¼Œä¸”ç¼“å­˜çš„æ•°é‡è¾ƒå°çš„ã€‚è™½ç„¶ä»ä¸Šé¢è¡¨æ ¼ä¸­æ¯”èµ·æ¥æœ‰ç‚¹é€Šè‰²ï¼Œä½†æ˜¯å…¶ç”±äºæ˜¯ JDK è‡ªå¸¦çš„ç±»ï¼Œåœ¨å„ç§æ¡†æ¶ä¸­ä¾ç„¶æœ‰å¤§é‡çš„ä½¿ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ç”¨æ¥ç¼“å­˜æˆ‘ä»¬åå°„çš„ Methodï¼ŒField ç­‰ç­‰ï¼›ä¹Ÿå¯ä»¥ç¼“å­˜ä¸€äº›é“¾æ¥ï¼Œé˜²æ­¢å…¶é‡å¤å»ºç«‹ã€‚åœ¨ Caffeine ä¸­ä¹Ÿæ˜¯ä½¿ç”¨çš„ <code>ConcurrentHashMap</code> æ¥å­˜å‚¨å…ƒç´ ã€‚</li>
<li><strong><code>LRUMap</code></strong> - å¦‚æœä¸æƒ³å¼•å…¥ç¬¬ä¸‰æ–¹åŒ…ï¼Œåˆæƒ³ä½¿ç”¨æ·˜æ±°ç®—æ³•æ·˜æ±°æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªã€‚</li>
<li><strong><code>Ehcache</code></strong> - ç”±äºå…¶ jar åŒ…å¾ˆå¤§ï¼Œè¾ƒé‡é‡çº§ã€‚å¯¹äºéœ€è¦æŒä¹…åŒ–å’Œé›†ç¾¤çš„ä¸€äº›åŠŸèƒ½çš„ï¼Œå¯ä»¥é€‰æ‹© Ehcacheã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ Ehcache ä¹Ÿæ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜ï¼Œä½†æ˜¯ç”±äºå…¶èŠ‚ç‚¹é—´é€šä¿¡æ–¹å¼ä¸º rmiï¼Œè¡¨ç°ä¸å¦‚ Redisï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å»ºè®®ç”¨å®ƒæ¥ä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜ã€‚</li>
<li><strong><code>Guava Cache</code></strong> - Guava è¿™ä¸ª jar åŒ…åœ¨å¾ˆå¤š Java åº”ç”¨ç¨‹åºä¸­éƒ½æœ‰å¤§é‡çš„å¼•å…¥ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™å…¶å®æ˜¯ç›´æ¥ç”¨å°±å¥½äº†ï¼Œå¹¶ä¸”å…¶æœ¬èº«æ˜¯è½»é‡çº§çš„è€Œä¸”åŠŸèƒ½è¾ƒä¸ºä¸°å¯Œï¼Œåœ¨ä¸äº†è§£ Caffeine çš„æƒ…å†µä¸‹å¯ä»¥é€‰æ‹© Guava Cacheã€‚</li>
<li><strong><code>Caffeine</code></strong> - å…¶åœ¨å‘½ä¸­ç‡ï¼Œè¯»å†™æ€§èƒ½ä¸Šéƒ½æ¯” Guava Cache å¥½å¾ˆå¤šï¼Œå¹¶ä¸”å…¶ API å’Œ Guava cache åŸºæœ¬ä¸€è‡´ï¼Œç”šè‡³ä¼šå¤šä¸€ç‚¹ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ä½¿ç”¨ Caffeineï¼Œå–å¾—è¿‡ä¸é”™çš„æ•ˆæœã€‚</li>
</ul>
<p>æ€»ç»“ä¸€ä¸‹ï¼š<strong>å¦‚æœä¸éœ€è¦æ·˜æ±°ç®—æ³•åˆ™é€‰æ‹© <code>ConcurrentHashMap</code>ï¼Œå¦‚æœéœ€è¦æ·˜æ±°ç®—æ³•å’Œä¸€äº›ä¸°å¯Œçš„ APIï¼Œæ¨èé€‰æ‹© <code>Caffeine</code></strong>ã€‚</p>
<h2 id="å››-åˆ†å¸ƒå¼ç¼“å­˜"><a class="markdownIt-Anchor" href="#å››-åˆ†å¸ƒå¼ç¼“å­˜"></a> å››ã€åˆ†å¸ƒå¼ç¼“å­˜</h2>
<blockquote>
<p><strong>åˆ†å¸ƒå¼ç¼“å­˜è§£å†³äº†è¿›ç¨‹å†…ç¼“å­˜æœ€å¤§çš„é—®é¢˜ï¼šå¦‚æœåº”ç”¨æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒèŠ‚ç‚¹ä¹‹é—´æ— æ³•å…±äº«å½¼æ­¤çš„è¿›ç¨‹å†…ç¼“å­˜</strong>ã€‚</p>
<p>åˆ†å¸ƒå¼ç¼“å­˜çš„åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ç¼“å­˜ç»è¿‡å¤æ‚è®¡ç®—å¾—åˆ°çš„æ•°æ®</li>
<li>ç¼“å­˜ç³»ç»Ÿä¸­é¢‘ç¹è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›</li>
</ul>
</blockquote>
<p>ä¸åŒåˆ†å¸ƒå¼ç¼“å­˜çš„å®ç°åŸç†å¾€å¾€æœ‰æ¯”è¾ƒå¤§çš„å·®å¼‚ã€‚æœ¬æ–‡ä¸»è¦é’ˆå¯¹ Memcached å’Œ Redis è¿›è¡Œè¯´æ˜ã€‚</p>
<h3 id="memcached"><a class="markdownIt-Anchor" href="#memcached"></a> Memcached</h3>
<blockquote>
<p><a href="https://memcached.org/" target="_blank" rel="noopener">Memcached</a> æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ï¼Œåˆ†å¸ƒå¼å†…å­˜å¯¹è±¡ç¼“å­˜ç³»ç»Ÿï¼Œé€šè¿‡åœ¨å†…å­˜é‡Œç»´æŠ¤ä¸€ä¸ªç»Ÿä¸€çš„å·¨å¤§çš„ hash è¡¨ï¼Œå®ƒèƒ½å¤Ÿç”¨æ¥å­˜å‚¨å„ç§æ ¼å¼çš„æ•°æ®ï¼ŒåŒ…æ‹¬å›¾åƒã€è§†é¢‘ã€æ–‡ä»¶ä»¥åŠæ•°æ®åº“æ£€ç´¢çš„ç»“æœç­‰ã€‚</p>
<p>ç®€å•çš„è¯´å°±æ˜¯ï¼šå°†æ•°æ®ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œç„¶åä»å†…å­˜ä¸­è¯»å–ï¼Œä»è€Œå¤§å¤§æé«˜è¯»å–é€Ÿåº¦ã€‚</p>
</blockquote>
<h4 id="memcached-ç‰¹æ€§"><a class="markdownIt-Anchor" href="#memcached-ç‰¹æ€§"></a> Memcached ç‰¹æ€§</h4>
<ul>
<li><strong>ä½¿ç”¨ç‰©ç†å†…å­˜ä½œä¸ºç¼“å­˜åŒºï¼Œå¯ç‹¬ç«‹è¿è¡Œåœ¨æœåŠ¡å™¨ä¸Š</strong>ã€‚æ¯ä¸ªè¿›ç¨‹æœ€å¤§ 2Gï¼Œå¦‚æœæƒ³ç¼“å­˜æ›´å¤šçš„æ•°æ®ï¼Œå¯ä»¥å¼€è¾Ÿæ›´å¤šçš„ Memcached è¿›ç¨‹ï¼ˆä¸åŒç«¯å£ï¼‰æˆ–è€…ä½¿ç”¨åˆ†å¸ƒå¼ Memcached è¿›è¡Œç¼“å­˜ï¼Œå°†æ•°æ®ç¼“å­˜åˆ°ä¸åŒçš„ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºä¸Šã€‚</li>
<li><strong>ä½¿ç”¨ key-value çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®</strong>ã€‚è¿™æ˜¯ä¸€ç§å•ç´¢å¼•çš„ç»“æ„åŒ–æ•°æ®ç»„ç»‡å½¢å¼ï¼Œå¯ä½¿æ•°æ®é¡¹æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</li>
<li><strong>åè®®ç®€å•ï¼ŒåŸºäºæ–‡æœ¬è¡Œçš„åè®®</strong>ã€‚ç›´æ¥é€šè¿‡ telnet åœ¨ Memcached æœåŠ¡å™¨ä¸Šå¯è¿›è¡Œå­˜å–æ•°æ®æ“ä½œï¼Œç®€å•ï¼Œæ–¹ä¾¿å¤šç§ç¼“å­˜å‚è€ƒæ­¤åè®®ï¼›</li>
<li><strong>åŸºäº libevent é«˜æ€§èƒ½é€šä¿¡</strong>ã€‚Libevent æ˜¯ä¸€å¥—åˆ©ç”¨ C å¼€å‘çš„ç¨‹åºåº“ï¼Œå®ƒå°† BSD ç³»ç»Ÿçš„ kqueue,Linux ç³»ç»Ÿçš„ epoll ç­‰äº‹ä»¶å¤„ç†åŠŸèƒ½å°è£…æˆä¸€ä¸ªæ¥å£ï¼Œä¸ä¼ ç»Ÿçš„ select ç›¸æ¯”ï¼Œæé«˜äº†æ€§èƒ½ã€‚</li>
<li><strong>åˆ†å¸ƒå¼èƒ½åŠ›å–å†³äº Memcached å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨ä¹‹é—´äº’ä¸é€šä¿¡</strong>ã€‚å„ä¸ª Memcached æœåŠ¡å™¨ä¹‹é—´äº’ä¸é€šä¿¡ï¼Œå„è‡ªç‹¬ç«‹å­˜å–æ•°æ®ï¼Œä¸å…±äº«ä»»ä½•ä¿¡æ¯ã€‚æœåŠ¡å™¨å¹¶ä¸å…·æœ‰åˆ†å¸ƒå¼åŠŸèƒ½ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²å–å†³äº Memcached å®¢æˆ·ç«¯ã€‚</li>
<li><strong>é‡‡ç”¨ LRU ç¼“å­˜æ·˜æ±°ç­–ç•¥</strong>ã€‚åœ¨ Memcached å†…å­˜å‚¨æ•°æ®é¡¹æ—¶ï¼Œå¯ä»¥æŒ‡å®šå®ƒåœ¨ç¼“å­˜çš„å¤±æ•ˆæ—¶é—´ï¼Œé»˜è®¤ä¸ºæ°¸ä¹…ã€‚å½“ Memcached æœåŠ¡å™¨ç”¨å®Œåˆ†é…çš„å†…æ—¶ï¼Œå¤±æ•ˆçš„æ•°æ®è¢«é¦–å…ˆæ›¿æ¢ï¼Œç„¶åä¹Ÿæ˜¯æœ€è¿‘æœªä½¿ç”¨çš„æ•°æ®ã€‚åœ¨ LRU ä¸­ï¼ŒMemcached ä½¿ç”¨çš„æ˜¯ä¸€ç§ Lazy Expiration ç­–ç•¥ï¼Œè‡ªå·±ä¸ä¼šç›‘æ§å­˜å…¥çš„ key/vlue å¯¹æ˜¯å¦è¿‡æœŸï¼Œè€Œæ˜¯åœ¨è·å– key å€¼æ—¶æŸ¥çœ‹è®°å½•çš„æ—¶é—´æˆ³ï¼Œæ£€æŸ¥ key/value å¯¹ç©ºé—´æ˜¯å¦è¿‡æœŸï¼Œè¿™æ ·å¯å‡è½»æœåŠ¡å™¨çš„è´Ÿè½½ã€‚</li>
<li><strong>å†…ç½®äº†ä¸€å¥—é«˜æ•ˆçš„å†…å­˜ç®¡ç†ç®—æ³•</strong>ã€‚è¿™å¥—å†…å­˜ç®¡ç†æ•ˆç‡å¾ˆé«˜ï¼Œè€Œä¸”ä¸ä¼šé€ æˆå†…å­˜ç¢ç‰‡ï¼Œä½†æ˜¯å®ƒæœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯ä¼šå¯¼è‡´ç©ºé—´æµªè´¹ã€‚å½“å†…å­˜æ»¡åï¼Œé€šè¿‡ LRU ç®—æ³•è‡ªåŠ¨åˆ é™¤ä¸ä½¿ç”¨çš„ç¼“å­˜ã€‚</li>
<li><strong>ä¸æ”¯æŒæŒä¹…åŒ–</strong>ã€‚Memcached æ²¡æœ‰è€ƒè™‘æ•°æ®çš„å®¹ç¾é—®é¢˜ï¼Œé‡å¯æœåŠ¡ï¼Œæ‰€æœ‰æ•°æ®ä¼šä¸¢å¤±ã€‚</li>
</ul>
<h4 id="memcached-å·¥ä½œåŸç†"><a class="markdownIt-Anchor" href="#memcached-å·¥ä½œåŸç†"></a> Memcached å·¥ä½œåŸç†</h4>
<p>ï¼ˆ1ï¼‰å†…å­˜ç®¡ç†</p>
<p>Memcached åˆ©ç”¨ <strong>slab allocation</strong> æœºåˆ¶æ¥åˆ†é…å’Œç®¡ç†å†…å­˜ï¼Œå®ƒæŒ‰ç…§é¢„å…ˆè§„å®šçš„å¤§å°ï¼Œå°†åˆ†é…çš„å†…å­˜åˆ†å‰²æˆç‰¹å®šé•¿åº¦çš„å†…å­˜å—ï¼Œå†æŠŠå°ºå¯¸ç›¸åŒçš„å†…å­˜å—åˆ†æˆç»„ï¼Œæ•°æ®åœ¨å­˜æ”¾æ—¶ï¼Œæ ¹æ®é”®å€¼ å¤§å°å»åŒ¹é… slab å¤§å°ï¼Œæ‰¾å°±è¿‘çš„ slab å­˜æ”¾ï¼Œæ‰€ä»¥å­˜åœ¨ç©ºé—´æµªè´¹ç°è±¡ã€‚</p>
<p>è¿™å¥—å†…å­˜ç®¡ç†æ•ˆç‡å¾ˆé«˜ï¼Œè€Œä¸”ä¸ä¼šé€ æˆå†…å­˜ç¢ç‰‡ï¼Œä½†æ˜¯å®ƒæœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯ä¼šå¯¼è‡´ç©ºé—´æµªè´¹ã€‚</p>
<p>ï¼ˆ2ï¼‰ç¼“å­˜æ·˜æ±°ç­–ç•¥</p>
<p>Memcached çš„ç¼“å­˜æ·˜æ±°ç­–ç•¥æ˜¯ <strong>LRU</strong> + åˆ°æœŸå¤±æ•ˆç­–ç•¥ã€‚</p>
<p>å½“ä½ åœ¨ Memcached å†…å­˜å‚¨æ•°æ®é¡¹æ—¶ï¼Œä½ æœ‰å¯èƒ½ä¼šæŒ‡å®šå®ƒåœ¨ç¼“å­˜çš„å¤±æ•ˆæ—¶é—´ï¼Œé»˜è®¤ä¸ºæ°¸ä¹…ã€‚å½“ Memcached æœåŠ¡å™¨ç”¨å®Œåˆ†é…çš„å†…æ—¶ï¼Œå¤±æ•ˆçš„æ•°æ®è¢«é¦–å…ˆæ›¿æ¢ï¼Œç„¶åæ˜¯æœ€è¿‘æœªä½¿ç”¨çš„æ•°æ®ã€‚</p>
<p>åœ¨ LRU ä¸­ï¼ŒMemcached ä½¿ç”¨çš„æ˜¯ä¸€ç§ Lazy Expiration ç­–ç•¥ï¼š<strong>Memcached ä¸ä¼šç›‘æ§å­˜å…¥çš„ key/vlue å¯¹æ˜¯å¦è¿‡æœŸ</strong>ï¼Œè€Œæ˜¯åœ¨è·å– key å€¼æ—¶æŸ¥çœ‹è®°å½•çš„æ—¶é—´æˆ³ï¼Œ<strong>æ£€æŸ¥ key/value å¯¹ç©ºé—´æ˜¯å¦è¿‡æœŸ</strong>ï¼Œè¿™æ ·å¯å‡è½»æœåŠ¡å™¨çš„è´Ÿè½½ã€‚</p>
<p>ï¼ˆ3ï¼‰åˆ†åŒº</p>
<p>Memcached æœåŠ¡å™¨ä¹‹é—´å½¼æ­¤ä¸é€šä¿¡ï¼Œå®ƒçš„åˆ†å¸ƒå¼èƒ½åŠ›æ˜¯ä¾èµ–å®¢æˆ·ç«¯æ¥å®ç°ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åœ¨å®¢æˆ·ç«¯å®ç°ä¸€ç§ç®—æ³•ï¼Œæ ¹æ® key æ¥è®¡ç®—å‡ºæ•°æ®åº”è¯¥å‘å“ªä¸ªæœåŠ¡å™¨èŠ‚ç‚¹è¯»/å†™ã€‚</p>
<p>è€Œè¿™ç§é€‰å–é›†ç¾¤èŠ‚ç‚¹çš„ç®—æ³•å¸¸è§çš„æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li><strong>å“ˆå¸Œå–ä½™ç®—æ³•</strong> - ä½¿ç”¨å…¬å¼ï¼š<code>hashï¼ˆkeyï¼‰% N</code> è®¡ç®—å‡º <strong>å“ˆå¸Œå€¼</strong> æ¥å†³å®šæ•°æ®æ˜ å°„åˆ°å“ªä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li><strong>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</strong> - å¯ä»¥å¾ˆå¥½çš„è§£å†³ <strong>ç¨³å®šæ€§é—®é¢˜</strong>ï¼Œå¯ä»¥å°†æ‰€æœ‰çš„ <strong>å­˜å‚¨èŠ‚ç‚¹</strong> æ’åˆ—åœ¨ <strong>é¦–å°¾ç›¸æ¥</strong> çš„ <code>Hash</code> ç¯ä¸Šï¼Œæ¯ä¸ª <code>key</code> åœ¨è®¡ç®— <code>Hash</code> åä¼š <strong>é¡ºæ—¶é’ˆ</strong> æ‰¾åˆ° <strong>ä¸´æ¥</strong> çš„ <strong>å­˜å‚¨èŠ‚ç‚¹</strong> å­˜æ”¾ã€‚è€Œå½“æœ‰èŠ‚ç‚¹ <strong>åŠ å…¥</strong> æˆ– <strong>é€€å‡º</strong> æ—¶ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨ <code>Hash</code> ç¯ä¸Š <strong>é¡ºæ—¶é’ˆç›¸é‚»</strong> çš„ <strong>åç»­èŠ‚ç‚¹</strong>ã€‚</li>
<li><strong>è™šæ‹Ÿ Hash æ§½ç®—æ³•</strong> - ä½¿ç”¨ <strong>åˆ†æ•£åº¦è‰¯å¥½</strong> çš„ <strong>å“ˆå¸Œå‡½æ•°</strong> æŠŠæ‰€æœ‰æ•°æ® <strong>æ˜ å°„</strong> åˆ°ä¸€ä¸ª <strong>å›ºå®šèŒƒå›´</strong> çš„ <strong>æ•´æ•°é›†åˆ</strong> ä¸­ï¼Œæ•´æ•°å®šä¹‰ä¸º <strong>æ§½</strong>ï¼ˆ<code>slot</code>ï¼‰ï¼Œè¿™ä¸ªèŒƒå›´ä¸€èˆ¬ <strong>è¿œè¿œå¤§äº</strong> èŠ‚ç‚¹æ•°ã€‚<strong>æ§½</strong> æ˜¯é›†ç¾¤å†… <strong>æ•°æ®ç®¡ç†</strong> å’Œ <strong>è¿ç§»</strong> çš„ <strong>åŸºæœ¬å•ä½</strong>ã€‚é‡‡ç”¨ <strong>å¤§èŒƒå›´æ§½</strong> çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ <strong>æ•°æ®æ‹†åˆ†</strong> å’Œ <strong>é›†ç¾¤æ‰©å±•</strong>ã€‚æ¯ä¸ªèŠ‚ç‚¹ä¼šè´Ÿè´£ <strong>ä¸€å®šæ•°é‡çš„æ§½</strong>ã€‚</li>
</ul>
<h3 id="redis"><a class="markdownIt-Anchor" href="#redis"></a> Redis</h3>
<blockquote>
<p>Redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSD è®¸å¯ï¼‰çš„ï¼ŒåŸºäºå†…å­˜çš„ï¼Œå¤šæ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿã€‚å¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚</p>
<p>Redis è¿˜å¯ä»¥ä½¿ç”¨å®¢æˆ·ç«¯åˆ†ç‰‡æ¥æ‰©å±•å†™æ€§èƒ½ã€‚å†…ç½®äº† å¤åˆ¶ï¼ˆreplicationï¼‰ï¼ŒLUA è„šæœ¬ï¼ˆLua scriptingï¼‰ï¼ŒLRU é©±åŠ¨äº‹ä»¶ï¼ˆLRU evictionï¼‰ï¼Œäº‹åŠ¡ï¼ˆtransactionsï¼‰ å’Œä¸åŒçº§åˆ«çš„ ç£ç›˜æŒä¹…åŒ–ï¼ˆpersistenceï¼‰ï¼Œ å¹¶é€šè¿‡ Redis å“¨å…µï¼ˆSentinelï¼‰å’Œè‡ªåŠ¨åˆ†åŒºï¼ˆClusterï¼‰æä¾›é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰ã€‚</p>
</blockquote>
<h4 id="redis-ç‰¹æ€§"><a class="markdownIt-Anchor" href="#redis-ç‰¹æ€§"></a> Redis ç‰¹æ€§</h4>
<ul>
<li>
<p>æ”¯æŒå¤šç§æ•°æ®ç±»å‹ - stringã€hashã€listã€setã€sorted setã€‚</p>
</li>
<li>
<p>æ”¯æŒå¤šç§æ•°æ®æ·˜æ±°ç­–ç•¥</p>
<ul>
<li><strong>volatile-lru</strong> - ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</li>
<li><strong>volatile-ttl</strong> - ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</li>
<li><strong>volatile-random</strong> - ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°</li>
<li><strong>allkeys-lru</strong> - ä»æ‰€æœ‰æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</li>
<li><strong>allkeys-random</strong> - ä»æ‰€æœ‰æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®è¿›è¡Œæ·˜æ±°</li>
<li><strong>noeviction</strong> - ç¦æ­¢é©±é€æ•°æ®</li>
</ul>
</li>
<li>
<p>æä¾›ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ - RDB å’Œ AOF</p>
</li>
<li>
<p>é€šè¿‡ Redis cluster æä¾›é›†ç¾¤æ¨¡å¼ã€‚</p>
</li>
</ul>
<h4 id="redis-åŸç†"><a class="markdownIt-Anchor" href="#redis-åŸç†"></a> Redis åŸç†</h4>
<ul>
<li>ç¼“å­˜æ·˜æ±°
<ul>
<li>Redis æœ‰ä¸¤ç§æ•°æ®æ·˜æ±°å®ç°
<ul>
<li>æ¶ˆææ–¹å¼ - è®¿é—® Redis key æ—¶ï¼Œå¦‚æœå‘ç°å®ƒå·²ç»å¤±æ•ˆï¼Œåˆ™åˆ é™¤å®ƒ</li>
<li>ç§¯ææ–¹å¼ - å‘¨æœŸæ€§ä»è®¾ç½®äº†å¤±æ•ˆæ—¶é—´çš„ key ä¸­ï¼Œæ ¹æ®æ·˜æ±°ç­–ç•¥ï¼Œé€‰æ‹©ä¸€éƒ¨åˆ†å¤±æ•ˆçš„ key è¿›è¡Œåˆ é™¤ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>åˆ†åŒº
<ul>
<li>Redis Cluster é›†ç¾¤åŒ…å« 16384 ä¸ªè™šæ‹Ÿ Hash æ§½ï¼Œå®ƒé€šè¿‡ä¸€ä¸ªé«˜æ•ˆçš„ç®—æ³•æ¥è®¡ç®— key å±äºå“ªä¸ª Hash æ§½ã€‚</li>
<li>Redis Cluster æ”¯æŒè¯·æ±‚åˆ†å‘ - èŠ‚ç‚¹åœ¨æ¥åˆ°ä¸€ä¸ªå‘½ä»¤è¯·æ±‚æ—¶ï¼Œä¼šå…ˆæ£€æµ‹è¿™ä¸ªå‘½ä»¤è¯·æ±‚è¦å¤„ç†çš„é”®æ‰€åœ¨çš„æ§½æ˜¯å¦ç”±è‡ªå·±è´Ÿè´£ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼ŒèŠ‚ç‚¹å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª MOVED é”™è¯¯ï¼ŒMOVED é”™è¯¯æºå¸¦çš„ä¿¡æ¯å¯ä»¥æŒ‡å¼•å®¢æˆ·ç«¯å°†è¯·æ±‚é‡å®šå‘è‡³æ­£åœ¨è´Ÿè´£ç›¸å…³æ§½çš„èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li>ä¸»ä»å¤åˆ¶
<ul>
<li>Redis 2.8 åæ”¯æŒå¼‚æ­¥å¤åˆ¶ã€‚å®ƒæœ‰ä¸¤ç§æ¨¡å¼ï¼š
<ul>
<li><code>å®Œæ•´é‡åŒæ­¥ï¼ˆfull resychronizationï¼‰</code> - ç”¨äºåˆæ¬¡å¤åˆ¶ã€‚æ‰§è¡Œæ­¥éª¤ä¸ <code>SYNC</code> å‘½ä»¤åŸºæœ¬ä¸€è‡´ã€‚</li>
<li><code>éƒ¨åˆ†é‡åŒæ­¥ï¼ˆpartial resychronizationï¼‰</code> - ç”¨äºæ–­çº¿åé‡å¤åˆ¶ã€‚å¦‚æœæ¡ä»¶å…è®¸ï¼Œä¸»æœåŠ¡å™¨å¯ä»¥å°†ä¸»ä»æœåŠ¡å™¨è¿æ¥æ–­å¼€æœŸé—´æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨åªéœ€æ¥æ”¶å¹¶æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ï¼Œå³å¯å°†ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€ä¿æŒä¸€è‡´ã€‚</li>
</ul>
</li>
<li>é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå®šæœŸå‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œä»¥æ­¤æ¥æ£€æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿ã€‚</li>
<li>å¦‚æœä¸€ä¸ªä¸»èŠ‚ç‚¹è¢«è®¤ä¸ºä¸‹çº¿ï¼Œåˆ™åœ¨å…¶ä»èŠ‚ç‚¹ä¸­ï¼Œæ ¹æ® Raft ç®—æ³•ï¼Œé€‰ä¸¾å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå‡çº§ä¸ºä¸»èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li>æ•°æ®ä¸€è‡´æ€§
<ul>
<li>Redis ä¸ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—é›†ç¾¤æ€§èƒ½å¤§å¤§é™ä½ã€‚</li>
<li>Redis æ˜¯é€šè¿‡å¼‚æ­¥å¤åˆ¶æ¥å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
</ul>
</li>
</ul>
<h3 id="åˆ†å¸ƒå¼ç¼“å­˜å¯¹æ¯”"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼ç¼“å­˜å¯¹æ¯”"></a> åˆ†å¸ƒå¼ç¼“å­˜å¯¹æ¯”</h3>
<p>ä¸åŒçš„åˆ†å¸ƒå¼ç¼“å­˜åŠŸèƒ½ç‰¹æ€§å’Œå®ç°åŸç†æ–¹é¢æœ‰å¾ˆå¤§çš„å·®å¼‚ï¼Œå› æ­¤ä»–ä»¬æ‰€é€‚åº”çš„åœºæ™¯ä¹Ÿæœ‰æ‰€ä¸åŒã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200709224247.png" alt="img" /></p>
<p>è¿™é‡Œé€‰å–ä¸‰ä¸ªæ¯”è¾ƒå‡ºåçš„åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆMemCacheï¼ŒRedisï¼ŒTairï¼‰æ¥ä½œä¸ºæ¯”è¾ƒï¼š</p>
<table>
<thead>
<tr>
<th>æ¯”è¾ƒé¡¹</th>
<th>MemCache</th>
<th>Redis</th>
<th>Tair</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®ç»“æ„</td>
<td>åªæ”¯æŒç®€å•çš„ Key-Value ç»“æ„</td>
<td>String,Hash, List, Set, Sorted Set</td>
<td>String,HashMap, Listï¼ŒSet</td>
</tr>
<tr>
<td>æŒä¹…åŒ–</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>å®¹é‡å¤§å°</td>
<td>æ•°æ®çº¯å†…å­˜ï¼Œæ•°æ®å­˜å‚¨ä¸å®œè¿‡å¤š</td>
<td>æ•°æ®å…¨å†…å­˜ï¼Œèµ„æºæˆæœ¬è€ƒé‡ä¸å®œè¶…è¿‡ 100GB</td>
<td>å¯ä»¥é…ç½®å…¨å†…å­˜æˆ–å†…å­˜+ç£ç›˜å¼•æ“ï¼Œæ•°æ®å®¹é‡å¯æ— é™æ‰©å……</td>
</tr>
<tr>
<td>è¯»å†™æ€§èƒ½</td>
<td>å¾ˆé«˜</td>
<td>å¾ˆé«˜(RT0.5ms å·¦å³)</td>
<td>String ç±»å‹æ¯”è¾ƒé«˜(RT1ms å·¦å³)ï¼Œå¤æ‚ç±»å‹æ¯”è¾ƒæ…¢(RT5ms å·¦å³)</td>
</tr>
<tr>
<td>è¿‡æœŸç­–ç•¥</td>
<td>è¿‡æœŸåï¼Œä¸åˆ é™¤ç¼“å­˜</td>
<td>æœ‰å…­ç§ç­–ç•¥æ¥å¤„ç†è¿‡æœŸæ•°æ®</td>
<td>æ”¯æŒ</td>
</tr>
</tbody>
</table>
<ul>
<li><code>MemCache</code> - åªé€‚åˆåŸºäºå†…å­˜çš„ç¼“å­˜æ¡†æ¶ï¼›ä¸”ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–å’Œå®¹ç¾ã€‚</li>
<li><code>Redis</code> - æ”¯æŒä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼Œè¯»å†™æ€§èƒ½å¾ˆé«˜ï¼Œä½†æ˜¯æ•°æ®å…¨å†…å­˜ï¼Œå¿…é¡»è¦è€ƒè™‘èµ„æºæˆæœ¬ï¼Œæ”¯æŒæŒä¹…åŒ–ã€‚</li>
<li><code>Tair</code> - æ”¯æŒä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼Œè¯»å†™æ€§èƒ½è¾ƒé«˜ï¼Œéƒ¨åˆ†ç±»å‹æ¯”è¾ƒæ…¢ï¼Œç†è®ºä¸Šå®¹é‡å¯ä»¥æ— é™æ‰©å……ã€‚</li>
</ul>
<p>æ€»ç»“ï¼šå¦‚æœæœåŠ¡å¯¹å»¶è¿Ÿæ¯”è¾ƒæ•æ„Ÿï¼ŒMap/Set æ•°æ®ä¹Ÿæ¯”è¾ƒå¤šçš„è¯ï¼Œæ¯”è¾ƒé€‚åˆ Redisã€‚å¦‚æœæœåŠ¡éœ€è¦æ”¾å…¥ç¼“å­˜é‡çš„æ•°æ®å¾ˆå¤§ï¼Œå¯¹å»¶è¿Ÿåˆä¸æ˜¯ç‰¹åˆ«æ•æ„Ÿçš„è¯ï¼Œé‚£å°±å¯ä»¥é€‰æ‹© Memcachedã€‚</p>
<h2 id="äº”-å¤šçº§ç¼“å­˜"><a class="markdownIt-Anchor" href="#äº”-å¤šçº§ç¼“å­˜"></a> äº”ã€å¤šçº§ç¼“å­˜</h2>
<h3 id="æ•´ä½“ç¼“å­˜æ¡†æ¶"><a class="markdownIt-Anchor" href="#æ•´ä½“ç¼“å­˜æ¡†æ¶"></a> æ•´ä½“ç¼“å­˜æ¡†æ¶</h3>
<p>é€šå¸¸ï¼Œä¸€ä¸ªå¤§å‹è½¯ä»¶ç³»ç»Ÿçš„ç¼“å­˜é‡‡ç”¨å¤šçº§ç¼“å­˜æ–¹æ¡ˆï¼š</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/technology/cache/ç¼“å­˜æ•´ä½“æ¶æ„.png" /></div>
<p>è¯·æ±‚è¿‡ç¨‹ï¼š</p>
<ol>
<li>æµè§ˆå™¨å‘å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå¦‚æœ CDN æœ‰ç¼“å­˜åˆ™ç›´æ¥è¿”å›ï¼›</li>
<li>å¦‚æœ CDN æ— ç¼“å­˜ï¼Œåˆ™è®¿é—®åå‘ä»£ç†æœåŠ¡å™¨ï¼›</li>
<li>å¦‚æœåå‘ä»£ç†æœåŠ¡å™¨æœ‰ç¼“å­˜åˆ™ç›´æ¥è¿”å›ï¼›</li>
<li>å¦‚æœåå‘ä»£ç†æœåŠ¡å™¨æ— ç¼“å­˜æˆ–åŠ¨æ€è¯·æ±‚ï¼Œåˆ™è®¿é—®åº”ç”¨æœåŠ¡å™¨ï¼›</li>
<li>åº”ç”¨æœåŠ¡å™¨è®¿é—®è¿›ç¨‹å†…ç¼“å­˜ï¼›å¦‚æœæœ‰ç¼“å­˜ï¼Œåˆ™è¿”å›ä»£ç†æœåŠ¡å™¨ï¼Œå¹¶ç¼“å­˜æ•°æ®ï¼›ï¼ˆåŠ¨æ€è¯·æ±‚ä¸ç¼“å­˜ï¼‰</li>
<li>å¦‚æœè¿›ç¨‹å†…ç¼“å­˜æ— æ•°æ®ï¼Œåˆ™è¯»å–åˆ†å¸ƒå¼ç¼“å­˜ï¼›å¹¶è¿”å›åº”ç”¨æœåŠ¡å™¨ï¼›åº”ç”¨æœåŠ¡å™¨å°†æ•°æ®ç¼“å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆéƒ¨åˆ†ï¼‰ï¼›</li>
<li>å¦‚æœåˆ†å¸ƒå¼ç¼“å­˜æ— æ•°æ®ï¼Œåˆ™åº”ç”¨ç¨‹åºè¯»å–æ•°æ®åº“æ•°æ®ï¼Œå¹¶æ”¾å…¥åˆ†å¸ƒå¼ç¼“å­˜ï¼›</li>
</ol>
<h3 id="ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜"><a class="markdownIt-Anchor" href="#ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜"></a> ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜</h3>
<p><strong>å¦‚æœåº”ç”¨æœåŠ¡æ˜¯å•ç‚¹åº”ç”¨ï¼Œé‚£ä¹ˆè¿›ç¨‹å†…ç¼“å­˜å½“ç„¶æ˜¯ç¼“å­˜çš„é¦–é€‰æ–¹æ¡ˆ</strong>ã€‚</p>
<p>å¯¹äºè¿›ç¨‹å†…ç¼“å­˜ï¼Œå…¶æœ¬æ¥å—é™äºå†…å­˜çš„å¤§å°çš„é™åˆ¶ï¼Œä»¥åŠè¿›ç¨‹ç¼“å­˜æ›´æ–°åå…¶ä»–ç¼“å­˜æ— æ³•å¾—çŸ¥ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´è¿›ç¨‹ç¼“å­˜é€‚ç”¨äº:</p>
<ul>
<li>æ•°æ®é‡ä¸æ˜¯å¾ˆå¤§ä¸”æ›´æ–°é¢‘ç‡è¾ƒä½çš„æ•°æ®ã€‚</li>
<li>å¦‚æœæ›´æ–°é¢‘ç¹çš„æ•°æ®ï¼Œä¹Ÿæƒ³ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶è¿‡æœŸæ—¶é—´è®¾ç½®ä¸ºè¾ƒçŸ­çš„æ—¶é—´ï¼Œæˆ–è€…è®¾ç½®è¾ƒçŸ­çš„è‡ªåŠ¨åˆ·æ–°æ—¶é—´ã€‚</li>
</ul>
<p>è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>å¦‚æœåº”ç”¨æœåŠ¡æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåº”ç”¨èŠ‚ç‚¹ä¹‹é—´æ— æ³•å…±äº«ç¼“å­˜ï¼Œå­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</li>
<li>ç”±äºè¿›ç¨‹å†…ç¼“å­˜å—é™äºå†…å­˜å¤§å°çš„é™åˆ¶ï¼Œæ‰€ä»¥ç¼“å­˜ä¸èƒ½æ— é™æ‰©å±•ã€‚</li>
</ul>
<h3 id="ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜"><a class="markdownIt-Anchor" href="#ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜"></a> ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜</h3>
<p>å¦‚æœåº”ç”¨æœåŠ¡æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œé‚£ä¹ˆæœ€ç®€å•çš„ç¼“å­˜æ–¹æ¡ˆå°±æ˜¯ç›´æ¥ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ã€‚</p>
<p>å…¶åº”ç”¨åœºæ™¯å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200611141419.png" alt="img" /></p>
<p>Redis ç”¨æ¥å­˜å‚¨çƒ­ç‚¹æ•°æ®ï¼Œå¦‚æœç¼“å­˜ä¸å‘½ä¸­ï¼Œåˆ™å»æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶æ›´æ–°ç¼“å­˜ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>ç¼“å­˜æœåŠ¡å¦‚æœæŒ‚äº†ï¼Œè¿™æ—¶åº”ç”¨åªèƒ½è®¿é—®æ•°æ®åº“ï¼Œå®¹æ˜“é€ æˆç¼“å­˜é›ªå´©ã€‚</li>
<li>è®¿é—®åˆ†å¸ƒå¼ç¼“å­˜æœåŠ¡ä¼šæœ‰ä¸€å®šçš„ I/O ä»¥åŠåºåˆ—åŒ–ååºåˆ—åŒ–çš„å¼€é”€ï¼Œè™½ç„¶æ€§èƒ½å¾ˆé«˜ï¼Œä½†æ˜¯å…¶ç»ˆç©¶æ²¡æœ‰åœ¨å†…å­˜ä¸­æŸ¥è¯¢å¿«ã€‚</li>
</ol>
<h3 id="ä½¿ç”¨å¤šçº§ç¼“å­˜"><a class="markdownIt-Anchor" href="#ä½¿ç”¨å¤šçº§ç¼“å­˜"></a> ä½¿ç”¨å¤šçº§ç¼“å­˜</h3>
<p>å•çº¯ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜å’Œåˆ†å¸ƒå¼ç¼“å­˜éƒ½å­˜åœ¨å„è‡ªçš„ä¸è¶³ã€‚å¦‚æœéœ€è¦æ›´é«˜çš„æ€§èƒ½ä»¥åŠæ›´å¥½çš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç¼“å­˜è®¾è®¡ä¸ºå¤šçº§ç»“æ„ã€‚å°†æœ€çƒ­çš„æ•°æ®ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿›ä¸€æ­¥æå‡è®¿é—®é€Ÿåº¦ã€‚</p>
<p>è¿™ä¸ªè®¾è®¡æ€è·¯åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ä¹Ÿå­˜åœ¨ï¼Œæ¯”å¦‚ CPU ä½¿ç”¨ L1ã€L2ã€L3 å¤šçº§ç¼“å­˜ï¼Œç”¨æ¥å‡å°‘å¯¹å†…å­˜çš„ç›´æ¥è®¿é—®ï¼Œä»è€ŒåŠ å¿«è®¿é—®é€Ÿåº¦ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¤šçº§ç¼“å­˜æ¶æ„ä½¿ç”¨äºŒçº§ç¼“å­˜å·²å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†ä¸šåŠ¡éœ€æ±‚ï¼Œè¿‡å¤šçš„åˆ†çº§ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ä»¥åŠç»´æŠ¤çš„æˆæœ¬ã€‚å› æ­¤ï¼Œå¤šçº§ç¼“å­˜ä¸æ˜¯åˆ†çº§è¶Šå¤šè¶Šå¥½ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œæƒè¡¡ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„äºŒçº§ç¼“å­˜æ¶æ„ï¼Œå¯ä»¥ä½¿ç”¨è¿›ç¨‹å†…ç¼“å­˜ï¼ˆå¦‚ï¼š Caffeine/Google Guava/Ehcache/HashMapï¼‰ä½œä¸ºä¸€çº§ç¼“å­˜ï¼›ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ï¼šRedis/Memcachedï¼‰ä½œä¸ºäºŒçº§ç¼“å­˜ã€‚</p>
<h4 id="å¤šçº§ç¼“å­˜æŸ¥è¯¢"><a class="markdownIt-Anchor" href="#å¤šçº§ç¼“å­˜æŸ¥è¯¢"></a> å¤šçº§ç¼“å­˜æŸ¥è¯¢</h4>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/technology/cache/å¤šçº§ç¼“å­˜2.png" width="600" /></div>
<p>å¤šçº§ç¼“å­˜æŸ¥è¯¢æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆï¼ŒæŸ¥è¯¢ L1 ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›ç»“æœï¼›å¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥ã€‚</li>
<li>æ¥ä¸‹æ¥ï¼ŒæŸ¥è¯¢ L2 ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›ç»“æœå¹¶å›å¡« L1 ç¼“å­˜ï¼›å¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œæ‰§è¡Œä¸‹ä¸€æ­¥ã€‚</li>
<li>æœ€åï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œè¿”å›ç»“æœå¹¶ä¾æ¬¡å›å¡« L2 ç¼“å­˜ã€L1 ç¼“å­˜ã€‚</li>
</ol>
<h4 id="å¤šçº§ç¼“å­˜æ›´æ–°"><a class="markdownIt-Anchor" href="#å¤šçº§ç¼“å­˜æ›´æ–°"></a> å¤šçº§ç¼“å­˜æ›´æ–°</h4>
<p>å¯¹äº L1 ç¼“å­˜ï¼Œå¦‚æœæœ‰æ•°æ®æ›´æ–°ï¼Œåªèƒ½åˆ é™¤å¹¶æ›´æ–°æ‰€åœ¨æœºå™¨ä¸Šçš„ç¼“å­˜ï¼Œå…¶ä»–æœºå™¨åªèƒ½é€šè¿‡è¶…æ—¶æœºåˆ¶æ¥åˆ·æ–°ç¼“å­˜ã€‚è¶…æ—¶è®¾å®šå¯ä»¥æœ‰ä¸¤ç§ç­–ç•¥:</p>
<ul>
<li>è®¾ç½®æˆå†™å…¥åå¤šå°‘æ—¶é—´åè¿‡æœŸ</li>
<li>è®¾ç½®æˆå†™å…¥åå¤šå°‘æ—¶é—´åˆ·æ–°</li>
</ul>
<p>å¯¹äº L2 ç¼“å­˜ï¼Œå¦‚æœæœ‰æ•°æ®æ›´æ–°ï¼Œå…¶ä»–æœºå™¨ç«‹é©¬å¯è§ã€‚ä½†æ˜¯ï¼Œä¹Ÿå¿…é¡»è¦è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå…¶æ—¶é—´åº”è¯¥æ¯” L1 ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´é•¿ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿›ç¨‹å†…ç¼“å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè®¾è®¡å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–:</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/technology/cache/å¤šçº§ç¼“å­˜3.png" /></div>
<p>é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—çš„å‘å¸ƒã€è®¢é˜…æœºåˆ¶ï¼Œå¯ä»¥é€šçŸ¥å…¶ä»–åº”ç”¨èŠ‚ç‚¹å¯¹è¿›ç¨‹å†…ç¼“å­˜è¿›è¡Œæ›´æ–°ã€‚ä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œå³ä½¿æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡æŒ‚äº†æˆ–ä¸å¯é ï¼Œç”±äºå…ˆæ‰§è¡Œäº†æ•°æ®åº“æ›´æ–°ï¼Œä½†è¿›ç¨‹å†…ç¼“å­˜è¿‡æœŸï¼Œåˆ·æ–°ç¼“å­˜æ—¶ï¼Œä¹Ÿèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<h2 id="å…­-ç¼“å­˜é—®é¢˜"><a class="markdownIt-Anchor" href="#å…­-ç¼“å­˜é—®é¢˜"></a> å…­ã€ç¼“å­˜é—®é¢˜</h2>
<h3 id="ç¼“å­˜é›ªå´©"><a class="markdownIt-Anchor" href="#ç¼“å­˜é›ªå´©"></a> ç¼“å­˜é›ªå´©</h3>
<p><strong>ç¼“å­˜é›ªå´©æ˜¯æŒ‡ç¼“å­˜ä¸å¯ç”¨æˆ–è€…å¤§é‡ç¼“å­˜ç”±äºè¶…æ—¶æ—¶é—´ç›¸åŒåœ¨åŒä¸€æ—¶é—´æ®µå¤±æ•ˆï¼Œå¤§é‡è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œæ•°æ®åº“å‹åŠ›è¿‡å¤§å¯¼è‡´ç³»ç»Ÿé›ªå´©</strong>ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œå¯¹äºç³»ç»Ÿ Aï¼Œå‡è®¾æ¯å¤©é«˜å³°æœŸæ¯ç§’ 5000 ä¸ªè¯·æ±‚ï¼Œæœ¬æ¥ç¼“å­˜åœ¨é«˜å³°æœŸå¯ä»¥æ‰›ä½æ¯ç§’ 4000 ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯ç¼“å­˜æœºå™¨æ„å¤–å‘ç”Ÿäº†å…¨ç›˜å®•æœºã€‚ç¼“å­˜æŒ‚äº†ï¼Œæ­¤æ—¶ 1 ç§’ 5000 ä¸ªè¯·æ±‚å…¨éƒ¨è½æ•°æ®åº“ï¼Œæ•°æ®åº“å¿…ç„¶æ‰›ä¸ä½ï¼Œå®ƒä¼šæŠ¥ä¸€ä¸‹è­¦ï¼Œç„¶åå°±æŒ‚äº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰é‡‡ç”¨ä»€ä¹ˆç‰¹åˆ«çš„æ–¹æ¡ˆæ¥å¤„ç†è¿™ä¸ªæ•…éšœï¼ŒDBA å¾ˆç€æ€¥ï¼Œé‡å¯æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ç«‹é©¬åˆè¢«æ–°çš„æµé‡ç»™æ‰“æ­»äº†ã€‚</p>
<p>è§£å†³ç¼“å­˜é›ªå´©çš„ä¸»è¦æ‰‹æ®µå¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>å¢åŠ ç¼“å­˜ç³»ç»Ÿå¯ç”¨æ€§</strong>ï¼ˆäº‹å‰ï¼‰ã€‚ä¾‹å¦‚ï¼šéƒ¨ç½² Redis Clusterï¼ˆä¸»ä»+å“¨å…µï¼‰ï¼Œä»¥å®ç° Redis çš„é«˜å¯ç”¨ï¼Œé¿å…å…¨ç›˜å´©æºƒã€‚</li>
<li><strong>é‡‡ç”¨å¤šçº§ç¼“å­˜æ–¹æ¡ˆ</strong>ï¼ˆäº‹ä¸­ï¼‰ã€‚ä¾‹å¦‚ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆ<strong>Ehcache</strong>/<strong>Caffine</strong>/<strong>Guava Cache</strong>ï¼‰ + åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆ<strong>Redis</strong>/ <strong>Memcached</strong>ï¼‰ã€‚</li>
<li><strong>é™æµã€é™çº§ã€ç†”æ–­æ–¹æ¡ˆ</strong>ï¼ˆäº‹ä¸­ï¼‰ï¼Œé¿å…è¢«æµé‡æ‰“æ­»ã€‚å¦‚ï¼šä½¿ç”¨ <strong>Hystrix</strong> è¿›è¡Œç†”æ–­ã€é™çº§ã€‚</li>
<li>ç¼“å­˜å¦‚æœæ”¯æŒ<strong>æŒä¹…åŒ–</strong>ï¼Œå¯ä»¥åœ¨æ¢å¤å·¥ä½œåæ¢å¤æ•°æ®ï¼ˆäº‹åï¼‰ã€‚å¦‚ï¼š<strong>Redis</strong> æ”¯æŒæŒä¹…åŒ–ï¼Œä¸€æ—¦é‡å¯ï¼Œè‡ªåŠ¨ä»ç£ç›˜ä¸ŠåŠ è½½æ•°æ®ï¼Œå¿«é€Ÿæ¢å¤ç¼“å­˜æ•°æ®ã€‚</li>
</ul>
<p>ä¸Šé¢çš„è§£å†³æ–¹æ¡ˆç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¤šçº§ç¼“å­˜æ–¹æ¡ˆã€‚ç³»ç»Ÿæ”¶åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚ï¼Œå…ˆæŸ¥æœ¬åœ°ç¼“å­˜ï¼Œå†æŸ¥åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæœ€åæŸ¥æ•°æ®åº“ï¼Œåªè¦å‘½ä¸­ï¼Œç«‹å³è¿”å›ã€‚</p>
<p>è§£å†³ç¼“å­˜é›ªå´©çš„è¾…åŠ©æ‰‹æ®µå¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>ç›‘æ§ç¼“å­˜ï¼Œå¼¹æ€§æ‰©å®¹</strong>ã€‚</li>
<li><strong>ç¼“å­˜çš„è¿‡æœŸæ—¶é—´å¯ä»¥å–ä¸ªéšæœºå€¼</strong>ã€‚è¿™ä¹ˆåšæ˜¯ä¸ºé¿å…ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œä½¿å¾—æ•°æ®åº“ IO éª¤å‡ã€‚æ¯”å¦‚ï¼šä»¥å‰æ˜¯è®¾ç½® 10 åˆ†é’Ÿçš„è¶…æ—¶æ—¶é—´ï¼Œé‚£æ¯ä¸ª Key éƒ½å¯ä»¥éšæœº 8-13 åˆ†é’Ÿè¿‡æœŸï¼Œå°½é‡è®©ä¸åŒ Key çš„è¿‡æœŸæ—¶é—´ä¸åŒã€‚</li>
</ul>
<h3 id="ç¼“å­˜ç©¿é€"><a class="markdownIt-Anchor" href="#ç¼“å­˜ç©¿é€"></a> ç¼“å­˜ç©¿é€</h3>
<blockquote>
<p><strong>ç¼“å­˜ç©¿é€æ˜¯æŒ‡ï¼šæŸ¥è¯¢çš„æ•°æ®åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆç¼“å­˜ä¸­è‡ªç„¶ä¹Ÿä¸å­˜åœ¨ã€‚æ‰€ä»¥ï¼Œåº”ç”¨åœ¨ç¼“å­˜ä¸­æŸ¥ä¸åˆ°ï¼Œåˆ™ä¼šå»æŸ¥è¯¢æ•°æ®åº“ã€‚å½“è¿™æ ·çš„è¯·æ±‚å¤šäº†åï¼Œæ•°æ®åº“çš„å‹åŠ›å°±ä¼šå¢å¤§ã€‚</strong></p>
</blockquote>
<p>è§£å†³ç¼“å­˜ç©¿é€ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<p>ï¼ˆä¸€ï¼‰ç¼“å­˜ç©ºå€¼</p>
<p><strong>å¯¹äºè¿”å›ä¸º NULL çš„ä¾ç„¶ç¼“å­˜ï¼Œå¯¹äºæŠ›å‡ºå¼‚å¸¸çš„è¿”å›ä¸è¿›è¡Œç¼“å­˜</strong>ã€‚</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/technology/cache/ç¼“å­˜ç©¿é€1.png" width="350px"/></div>
<p>é‡‡ç”¨è¿™ç§æ‰‹æ®µçš„ä¼šå¢åŠ æˆ‘ä»¬ç¼“å­˜çš„ç»´æŠ¤æˆæœ¬ï¼Œéœ€è¦åœ¨æ’å…¥ç¼“å­˜çš„æ—¶å€™åˆ é™¤è¿™ä¸ªç©ºç¼“å­˜ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ï¼ˆäºŒï¼‰è¿‡æ»¤ä¸å¯èƒ½å­˜åœ¨çš„æ•°æ®</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/technology/cache/ç¼“å­˜ç©¿é€2.png" width="350px"/></div>
<p><strong>åˆ¶å®šä¸€äº›è§„åˆ™è¿‡æ»¤ä¸€äº›ä¸å¯èƒ½å­˜åœ¨çš„æ•°æ®</strong>ã€‚å¯ä»¥ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆé’ˆå¯¹äºŒè¿›åˆ¶æ“ä½œçš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥æ€§èƒ½é«˜ï¼‰ï¼Œæ¯”å¦‚ä½ çš„è®¢å• ID æ˜æ˜¾æ˜¯åœ¨ä¸€ä¸ªèŒƒå›´ 1-1000ï¼Œå¦‚æœä¸æ˜¯ 1-1000 ä¹‹å†…çš„æ•°æ®é‚£å…¶å®å¯ä»¥ç›´æ¥ç»™è¿‡æ»¤æ‰ã€‚</p>
<blockquote>
<p>é’ˆå¯¹äºä¸€äº›æ¶æ„æ”»å‡»ï¼Œæ”»å‡»å¸¦è¿‡æ¥çš„å¤§é‡ key æ˜¯ä¸å­˜åœ¨çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡‡ç”¨ç¬¬ä¸€ç§æ–¹æ¡ˆå°±ä¼šç¼“å­˜å¤§é‡ä¸å­˜åœ¨ key çš„æ•°æ®ã€‚</p>
<p>æ­¤æ—¶æˆ‘ä»¬é‡‡ç”¨ç¬¬ä¸€ç§æ–¹æ¡ˆå°±ä¸åˆé€‚äº†ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å…ˆå¯¹ä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆè¿›è¡Œè¿‡æ»¤æ‰è¿™äº› keyã€‚</p>
<p>é’ˆå¯¹è¿™ç§ key å¼‚å¸¸å¤šã€è¯·æ±‚é‡å¤ç‡æ¯”è¾ƒä½çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±æ²¡æœ‰å¿…è¦è¿›è¡Œç¼“å­˜ï¼Œä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆç›´æ¥è¿‡æ»¤æ‰ã€‚</p>
<p>è€Œå¯¹äºç©ºæ•°æ®çš„ key æœ‰é™çš„ï¼Œé‡å¤ç‡æ¯”è¾ƒé«˜çš„ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥é‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼è¿›è¡Œç¼“å­˜ã€‚</p>
</blockquote>
<h3 id="ç¼“å­˜å‡»ç©¿"><a class="markdownIt-Anchor" href="#ç¼“å­˜å‡»ç©¿"></a> ç¼“å­˜å‡»ç©¿</h3>
<p>ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ï¼Œ<strong>çƒ­ç‚¹æ•°æ®å¤±æ•ˆç¬é—´ï¼Œå¤§é‡è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“</strong>ã€‚ä¾‹å¦‚ï¼ŒæŸäº› key æ˜¯çƒ­ç‚¹æ•°æ®ï¼Œè®¿é—®éå¸¸é¢‘ç¹ã€‚å¦‚æœæŸä¸ª key å¤±æ•ˆçš„ç¬é—´ï¼Œå¤§é‡çš„è¯·æ±‚è¿‡æ¥ï¼Œç¼“å­˜æœªå‘½ä¸­ï¼Œç„¶åå»æ•°æ®åº“è®¿é—®ï¼Œæ­¤æ—¶æ•°æ®åº“è®¿é—®é‡ä¼šæ€¥å‰§å¢åŠ ã€‚</p>
<p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–ä¸‹é¢çš„ä¸¤ä¸ªæ‰‹æ®µ:</p>
<ul>
<li><strong>åˆ†å¸ƒå¼é”</strong> - é”ä½çƒ­ç‚¹æ•°æ®çš„ keyï¼Œé¿å…å¤§é‡çº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ª keyã€‚</li>
<li><strong>å®šæ—¶å¼‚æ­¥åˆ·æ–°</strong> - å¯ä»¥å¯¹éƒ¨åˆ†æ•°æ®é‡‡å–å¤±æ•ˆå‰è‡ªåŠ¨åˆ·æ–°çš„ç­–ç•¥ï¼Œè€Œä¸æ˜¯åˆ°æœŸè‡ªåŠ¨æ·˜æ±°ã€‚æ·˜æ±°å…¶å®ä¹Ÿæ˜¯ä¸ºäº†æ•°æ®çš„æ—¶æ•ˆæ€§ï¼Œæ‰€ä»¥é‡‡ç”¨è‡ªåŠ¨åˆ·æ–°ä¹Ÿå¯ä»¥ã€‚</li>
</ul>
<h3 id="å°ç»“"><a class="markdownIt-Anchor" href="#å°ç»“"></a> å°ç»“</h3>
<p>ä¸Šé¢é€ä¸€ä»‹ç»äº†ç¼“å­˜ä½¿ç”¨ä¸­å¸¸è§çš„é—®é¢˜ã€‚è¿™é‡Œï¼Œä»å‘ç”Ÿæ—¶é—´æ®µçš„è§’åº¦æ•´ä½“å½’çº³ä¸€ä¸‹ç¼“å­˜é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚</p>
<ul>
<li>äº‹å‰ï¼šRedis é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆ<strong>Redis Cluster</strong> + <strong>ä¸»ä»</strong> + <strong>å“¨å…µ</strong>ï¼‰ï¼Œé¿å…ç¼“å­˜å…¨é¢å´©æºƒã€‚</li>
<li>äº‹ä¸­ï¼šï¼ˆä¸€ï¼‰é‡‡ç”¨å¤šçº§ç¼“å­˜æ–¹æ¡ˆï¼Œæœ¬åœ°ç¼“å­˜ï¼ˆ<strong>Ehcache</strong>/<strong>Caffine</strong>/<strong>Guava Cache</strong>ï¼‰ + åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆ<strong>Redis</strong>/ <strong>Memcached</strong>ï¼‰ã€‚ï¼ˆäºŒï¼‰é™æµ + ç†”æ–­ + é™çº§ï¼ˆ<strong>Hystrix</strong>ï¼‰ï¼Œé¿å…æç«¯æƒ…å†µä¸‹ï¼Œæ•°æ®åº“è¢«æ‰“æ­»ã€‚</li>
<li>äº‹åï¼š<strong>Redis</strong> æŒä¹…åŒ–ï¼ˆ<strong>RDB</strong>+<strong>AOF</strong>ï¼‰ï¼Œä¸€æ—¦é‡å¯ï¼Œè‡ªåŠ¨ä»ç£ç›˜ä¸ŠåŠ è½½æ•°æ®ï¼Œå¿«é€Ÿæ¢å¤ç¼“å­˜æ•°æ®ã€‚</li>
</ul>
<blockquote>
<p>åˆ†å¸ƒå¼ç¼“å­˜ Memcached ï¼Œç”±äºæ•°æ®ç±»å‹ä¸å¦‚ Redis ä¸°å¯Œï¼Œå¹¶ä¸”ä¸æ”¯æŒæŒä¹…åŒ–ã€å®¹ç¾ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬ä¼šé€‰æ‹© Redis åšåˆ†å¸ƒå¼ç¼“å­˜ã€‚</p>
</blockquote>
<h2 id="ä¸ƒ-ç¼“å­˜ç­–ç•¥"><a class="markdownIt-Anchor" href="#ä¸ƒ-ç¼“å­˜ç­–ç•¥"></a> ä¸ƒã€ç¼“å­˜ç­–ç•¥</h2>
<h3 id="ç¼“å­˜é¢„çƒ­"><a class="markdownIt-Anchor" href="#ç¼“å­˜é¢„çƒ­"></a> ç¼“å­˜é¢„çƒ­</h3>
<p>ç¼“å­˜é¢„çƒ­æ˜¯æŒ‡ç³»ç»Ÿå¯åŠ¨åï¼Œç›´æ¥æŸ¥è¯¢çƒ­ç‚¹æ•°æ®å¹¶ç¼“å­˜ã€‚è¿™æ ·å°±å¯ä»¥é¿å…ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå†æ›´æ–°ç¼“å­˜çš„é—®é¢˜ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li><strong>æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜</strong>ï¼šç›´æ¥å†™ä¸ªç¼“å­˜åˆ·æ–°é¡µé¢ï¼Œä¸Šçº¿æ—¶æ‰‹å·¥æ“ä½œä¸‹ã€‚</li>
<li><strong>åº”ç”¨å¯åŠ¨æ—¶åˆ·æ–°ç¼“å­˜</strong>ï¼šæ•°æ®é‡ä¸å¤§ï¼Œå¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨è¿›è¡ŒåŠ è½½ã€‚</li>
<li><strong>å®šæ—¶å¼‚æ­¥åˆ·æ–°ç¼“å­˜</strong></li>
</ul>
<h3 id="å¦‚ä½•ç¼“å­˜"><a class="markdownIt-Anchor" href="#å¦‚ä½•ç¼“å­˜"></a> å¦‚ä½•ç¼“å­˜</h3>
<h4 id="ä¸è¿‡æœŸç¼“å­˜"><a class="markdownIt-Anchor" href="#ä¸è¿‡æœŸç¼“å­˜"></a> ä¸è¿‡æœŸç¼“å­˜</h4>
<p>ç¼“å­˜æ›´æ–°æ¨¡å¼ï¼š</p>
<ol>
<li>å¼€å¯äº‹åŠ¡</li>
<li>å†™ SQL</li>
<li>æäº¤äº‹åŠ¡</li>
<li>å†™ç¼“å­˜</li>
</ol>
<p><strong>ä¸è¦æŠŠå†™ç¼“å­˜æ“ä½œæ”¾åœ¨äº‹åŠ¡ä¸­ï¼Œå°¤å…¶æ˜¯å†™åˆ†å¸ƒå¼ç¼“å­˜</strong>ã€‚å› ä¸ºç½‘ç»œæŠ–åŠ¨å¯èƒ½å¯¼è‡´å†™ç¼“å­˜å“åº”æ—¶é—´å¾ˆæ…¢ï¼Œå¼•èµ·æ•°æ®åº“äº‹åŠ¡é˜»å¡ã€‚å¦‚æœå¯¹ç¼“å­˜æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯é‚£ä¹ˆé«˜ï¼Œæ•°æ®é‡ä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œå¯ä»¥è€ƒè™‘å®šæœŸå…¨é‡åŒæ­¥ç¼“å­˜ã€‚</p>
<p>è¿™ç§æ¨¡å¼å­˜åœ¨è¿™æ ·çš„æƒ…å†µï¼šå­˜åœ¨äº‹åŠ¡æˆåŠŸï¼Œä½†ç¼“å­˜å†™å¤±è´¥çš„å¯èƒ½ã€‚ä½†è¿™ç§æƒ…å†µç›¸å¯¹äºä¸Šé¢çš„é—®é¢˜ï¼Œå½±å“è¾ƒå°ã€‚</p>
<h4 id="è¿‡æœŸç¼“å­˜"><a class="markdownIt-Anchor" href="#è¿‡æœŸç¼“å­˜"></a> è¿‡æœŸç¼“å­˜</h4>
<p>é‡‡ç”¨<strong>æ‡’åŠ è½½</strong>ã€‚å¯¹äºçƒ­ç‚¹æ•°æ®ï¼Œå¯ä»¥è®¾ç½®è¾ƒçŸ­çš„ç¼“å­˜æ—¶é—´ï¼Œå¹¶å®šæœŸå¼‚æ­¥åŠ è½½ã€‚</p>
<h3 id="ç¼“å­˜æ›´æ–°"><a class="markdownIt-Anchor" href="#ç¼“å­˜æ›´æ–°"></a> ç¼“å­˜æ›´æ–°</h3>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œç³»ç»Ÿå¦‚æœä¸æ˜¯ä¸¥æ ¼è¦æ±‚ç¼“å­˜å’Œæ•°æ®åº“ä¿æŒä¸€è‡´æ€§çš„è¯ï¼Œå°½é‡ä¸è¦å°†<strong>è¯»è¯·æ±‚å’Œå†™è¯·æ±‚ä¸²è¡ŒåŒ–</strong>ã€‚ä¸²è¡ŒåŒ–å¯ä»¥ä¿è¯ä¸€å®šä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†æ˜¯å®ƒä¼šå¯¼è‡´ç³»ç»Ÿçš„ååé‡å¤§å¹…åº¦ä¸‹é™ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ç¼“å­˜çš„æ›´æ–°æœ‰ä¸¤ç§æƒ…å†µ:</p>
<ul>
<li>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ã€‚</li>
<li>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ã€‚</li>
</ul>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯åˆ é™¤ç¼“å­˜ï¼Œè€Œä¸æ˜¯æ›´æ–°ç¼“å­˜å‘¢ï¼Ÿ</strong></p>
<p>ä½ å¯ä»¥æƒ³æƒ³å½“æœ‰å¤šä¸ªå¹¶å‘çš„è¯·æ±‚æ›´æ–°æ•°æ®ï¼Œä½ å¹¶ä¸èƒ½ä¿è¯æ›´æ–°æ•°æ®åº“çš„é¡ºåºå’Œæ›´æ–°ç¼“å­˜çš„é¡ºåºä¸€è‡´ï¼Œé‚£å°±ä¼šå‡ºç°æ•°æ®åº“ä¸­å’Œç¼“å­˜ä¸­æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´è€ƒè™‘åˆ é™¤ç¼“å­˜ã€‚</p>
</blockquote>
<ul>
<li><strong>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“</strong></li>
</ul>
<p>å¯¹äºä¸€ä¸ªæ›´æ–°æ“ä½œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å…ˆå»å„çº§ç¼“å­˜è¿›è¡Œåˆ é™¤ï¼Œç„¶åæ›´æ–°æ•°æ®åº“ã€‚</p>
<p>è¿™ä¸ªæ“ä½œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œåœ¨å¯¹ç¼“å­˜åˆ é™¤å®Œä¹‹åï¼Œæœ‰ä¸€ä¸ªè¯»è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™ç”±äºç¼“å­˜è¢«åˆ é™¤æ‰€ä»¥ç›´æ¥ä¼šè¯»åº“ï¼Œè¯»æ“ä½œçš„æ•°æ®æ˜¯è€çš„å¹¶ä¸”ä¼šè¢«åŠ è½½è¿›å…¥ç¼“å­˜å½“ä¸­ï¼Œåç»­è¯»è¯·æ±‚å…¨éƒ¨è®¿é—®çš„è€æ•°æ®ã€‚</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/java/javaweb/technology/cache/ç¼“å­˜æ›´æ–°.png" width="400px"/></div>
<p>å¯¹ç¼“å­˜çš„æ“ä½œä¸è®ºæˆåŠŸå¤±è´¥éƒ½ä¸èƒ½é˜»å¡æˆ‘ä»¬å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œé‚£ä¹ˆå¾ˆå¤šæ—¶å€™åˆ é™¤ç¼“å­˜å¯ä»¥ç”¨å¼‚æ­¥çš„æ“ä½œï¼Œä½†æ˜¯å…ˆåˆ é™¤ç¼“å­˜ä¸èƒ½å¾ˆå¥½çš„é€‚ç”¨äºè¿™ä¸ªåœºæ™¯ã€‚</p>
<p>å…ˆåˆ é™¤ç¼“å­˜ä¹Ÿæœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¦‚æœå¯¹æ•°æ®åº“æ“ä½œå¤±è´¥äº†ï¼Œé‚£ä¹ˆç”±äºå…ˆåˆ é™¤çš„ç¼“å­˜ï¼Œæœ€å¤šåªæ˜¯é€ æˆ Cache Missã€‚</p>
<ul>
<li><strong>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</strong></li>
</ul>
<blockquote>
<p>æ³¨ï¼šæ›´æ¨èä½¿ç”¨è¿™ç§ç­–ç•¥</p>
</blockquote>
<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨æ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜å°±èƒ½é¿å…ä¸Šé¢çš„é—®é¢˜ã€‚</p>
<p>ä½†æ˜¯åŒæ ·çš„å¼•å…¥äº†æ–°çš„é—®é¢˜ï¼šå‡è®¾æ‰§è¡Œæ›´æ–°æ“ä½œæ—¶ï¼Œåˆæ¥æ”¶åˆ°æŸ¥è¯¢è¯·æ±‚ï¼Œæ­¤æ—¶å°±ä¼šè¿”å›ç¼“å­˜ä¸­çš„è€æ•°æ®ã€‚æ›´éº»çƒ¦çš„æ˜¯ï¼Œå¦‚æœæ•°æ®åº“æ›´æ–°æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œåˆ™ç¼“å­˜ä¸­å¯èƒ½æ°¸è¿œæ˜¯è„æ•°æ®ã€‚</p>
<ul>
<li>åº”è¯¥é€‰æ‹©å“ªç§æ›´æ–°ç­–ç•¥</li>
</ul>
<p>é€šè¿‡ä¸Šé¢çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸¤ç§æ›´æ–°ç­–ç•¥éƒ½å­˜åœ¨å¹¶å‘é—®é¢˜ã€‚</p>
<p>ä½†æ˜¯å»ºè®®é€‰æ‹©å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼Œå› ä¸ºå…¶å¹¶å‘é—®é¢˜å‡ºç°çš„æ¦‚ç‡å¯èƒ½éå¸¸ä½ï¼Œå› ä¸ºè¿™ä¸ªæ¡ä»¶éœ€è¦å‘ç”Ÿåœ¨è¯»ç¼“å­˜æ—¶ç¼“å­˜å¤±æ•ˆï¼Œè€Œä¸”åŒæ—¶æœ‰ä¸€ä¸ªå¹¶å‘å†™æ“ä½œã€‚è€Œå®é™…ä¸Šæ•°æ®åº“çš„å†™æ“ä½œä¼šæ¯”è¯»æ“ä½œæ…¢å¾—å¤šï¼Œè€Œä¸”è¿˜è¦é”è¡¨ï¼Œè€Œè¯»æ“ä½œå¿…éœ€åœ¨å†™æ“ä½œå‰è¿›å…¥æ•°æ®åº“æ“ä½œï¼Œè€Œåˆè¦æ™šäºå†™æ“ä½œæ›´æ–°ç¼“å­˜ï¼Œæ‰€æœ‰çš„è¿™äº›æ¡ä»¶éƒ½å…·å¤‡çš„æ¦‚ç‡åŸºæœ¬å¹¶ä¸å¤§ã€‚</p>
<p>å¦‚æœéœ€è¦æ•°æ®åº“å’Œç¼“å­˜ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œåˆ™å¯ä»¥é€šè¿‡ 2PC æˆ– Paxos åè®®æ¥å®ç°ã€‚ä½†æ˜¯ 2PC å¤ªæ…¢ï¼Œè€Œ Paxos å¤ªå¤æ‚ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯éå¸¸é‡è¦çš„æ•°æ®ï¼Œä¸å»ºè®®ä½¿ç”¨å¼ºä¸€è‡´æ€§æ–¹æ¡ˆã€‚</p>
<blockquote>
<p>æ›´è¯¦ç»†çš„åˆ†æå¯ä»¥å‚è€ƒï¼š<a href="https://www.cnblogs.com/rjzheng/p/9041659.html" target="_blank" rel="noopener">åˆ†å¸ƒå¼ä¹‹æ•°æ®åº“å’Œç¼“å­˜åŒå†™ä¸€è‡´æ€§æ–¹æ¡ˆè§£æ </a></p>
</blockquote>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://item.jd.com/11322972.html" target="_blank" rel="noopener">ã€Šå¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„ï¼šæ ¸å¿ƒåŸç†ä¸æ¡ˆä¾‹åˆ†æã€‹</a></li>
<li><a href="https://link.juejin.im/?target=https%3A%2F%2Fjuejin.im%2Fpost%2F5b7593496fb9a009b62904fa">ä½ åº”è¯¥çŸ¥é“çš„ç¼“å­˜è¿›åŒ–å²</a></li>
<li><a href="https://link.juejin.im/?target=https%3A%2F%2Fjuejin.im%2Fpost%2F5b849878e51d4538c77a974a">å¦‚ä½•ä¼˜é›…çš„è®¾è®¡å’Œä½¿ç”¨ç¼“å­˜ï¼Ÿ</a></li>
<li><a href="https://www.jianshu.com/p/73ce0ef820f9" target="_blank" rel="noopener">ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ç¼“å­˜æ¶æ„(ä¸Š)</a></li>
<li><a href="https://tech.meituan.com/2017/03/17/cache-about.html" target="_blank" rel="noopener">ç¼“å­˜é‚£äº›äº‹</a></li>
<li><a href="https://www.cnblogs.com/rjzheng/p/9041659.html" target="_blank" rel="noopener">åˆ†å¸ƒå¼ä¹‹æ•°æ®åº“å’Œç¼“å­˜åŒå†™ä¸€è‡´æ€§æ–¹æ¡ˆè§£æ </a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/distributed-transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/distributed-transaction/" class="post-title-link" itemprop="url">åˆ†å¸ƒå¼äº‹åŠ¡åŸºæœ¬åŸç†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-21 11:30:00" itemprop="dateCreated datePublished" datetime="2019-06-21T11:30:00+08:00">2019-06-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/distributed-transaction/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/distributed-transaction/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>10 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åˆ†å¸ƒå¼äº‹åŠ¡åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼äº‹åŠ¡åŸºæœ¬åŸç†"></a> åˆ†å¸ƒå¼äº‹åŠ¡åŸºæœ¬åŸç†</h1>
<blockquote>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
<p><strong>åˆ†å¸ƒå¼äº‹åŠ¡æŒ‡çš„æ˜¯äº‹åŠ¡æ“ä½œè·¨è¶Šå¤šä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”è¦æ±‚æ»¡è¶³äº‹åŠ¡çš„ ACID ç‰¹æ€§ã€‚</strong></p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#%E4%B8%80%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%AE%80%E4%BB%8B">ä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡ç®€ä»‹</a>
<ul>
<li><a href="#%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1">æœ¬åœ°äº‹åŠ¡</a></li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1">åˆ†å¸ƒå¼äº‹åŠ¡</a></li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%BE%E7%82%B9">åˆ†å¸ƒå¼äº‹åŠ¡çš„éš¾ç‚¹</a></li>
<li><a href="#cap-%E5%92%8C-base">CAP å’Œ BASE</a></li>
<li><a href="#%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1">æŸ”æ€§äº‹åŠ¡</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A42pc">äºŒã€ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰</a>
<ul>
<li><a href="#%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B">æ–¹æ¡ˆç®€ä»‹</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B">å¤„ç†æµç¨‹</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93">æ–¹æ¡ˆæ€»ç»“</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A43pc">ä¸‰ã€ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰</a>
<ul>
<li><a href="#%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B-1">æ–¹æ¡ˆç®€ä»‹</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B-1">å¤„ç†æµç¨‹</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93-1">æ–¹æ¡ˆæ€»ç»“</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9B%E8%A1%A5%E5%81%BF%E4%BA%8B%E5%8A%A1tcc">å››ã€è¡¥å¿äº‹åŠ¡ï¼ˆTCCï¼‰</a>
<ul>
<li><a href="#%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B-2">æ–¹æ¡ˆç®€ä»‹</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B-2">å¤„ç†æµç¨‹</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93-2">æ–¹æ¡ˆæ€»ç»“</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8">äº”ã€æœ¬åœ°æ¶ˆæ¯è¡¨</a>
<ul>
<li><a href="#%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B-3">æ–¹æ¡ˆç®€ä»‹</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B-3">å¤„ç†æµç¨‹</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93-3">æ–¹æ¡ˆæ€»ç»“</a></li>
</ul>
</li>
<li><a href="#%E5%85%ADmq-%E4%BA%8B%E5%8A%A1">å…­ã€MQ äº‹åŠ¡</a>
<ul>
<li><a href="#%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B-4">æ–¹æ¡ˆç®€ä»‹</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B-4">å¤„ç†æµç¨‹</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93-4">æ–¹æ¡ˆæ€»ç»“</a></li>
</ul>
</li>
<li><a href="#%E4%B8%83saga">ä¸ƒã€SAGA</a>
<ul>
<li><a href="#%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B-5">æ–¹æ¡ˆç®€ä»‹</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B-5">å¤„ç†æµç¨‹</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93-5">æ–¹æ¡ˆæ€»ç»“</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a>
<ul>
<li><a href="#%E5%90%84%E6%96%B9%E6%A1%88%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">å„æ–¹æ¡ˆä½¿ç”¨åœºæ™¯</a></li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1">åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆè®¾è®¡</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="ä¸€-åˆ†å¸ƒå¼äº‹åŠ¡ç®€ä»‹"><a class="markdownIt-Anchor" href="#ä¸€-åˆ†å¸ƒå¼äº‹åŠ¡ç®€ä»‹"></a> ä¸€ã€åˆ†å¸ƒå¼äº‹åŠ¡ç®€ä»‹</h2>
<h3 id="æœ¬åœ°äº‹åŠ¡"><a class="markdownIt-Anchor" href="#æœ¬åœ°äº‹åŠ¡"></a> æœ¬åœ°äº‹åŠ¡</h3>
<p>å­¦ä¹ åˆ†å¸ƒå¼ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹æœ¬åœ°äº‹åŠ¡çš„æ¦‚å¿µã€‚</p>
<p>äº‹åŠ¡ç®€å•æ¥è¯´ï¼š<strong>ä¸€ä¸ªä¼šè¯ä¸­æ‰€è¿›è¡Œæ‰€æœ‰çš„æ“ä½œï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥</strong>ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/cs/database/RDB/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1.png" alt="img" /></p>
<p>å…·ä½“æ¥è¯´ï¼Œäº‹åŠ¡æŒ‡çš„æ˜¯æ»¡è¶³ ACID ç‰¹æ€§çš„ä¸€ç»„æ“ä½œï¼Œå¯ä»¥é€šè¿‡ <code>Commit</code> æäº¤ä¸€ä¸ªäº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>Rollback</code> è¿›è¡Œå›æ»šã€‚</p>
<ul>
<li>åŸå­æ€§ï¼ˆAtomicityï¼‰</li>
<li>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</li>
<li>éš”ç¦»æ€§ï¼ˆIsolationï¼‰</li>
<li>æŒä¹…æ€§ï¼ˆDurabilityï¼‰</li>
</ul>
<blockquote>
<p>ğŸ’¡ æ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥å‚è€ƒï¼š<a href="https://dunwu.github.io/db-tutorial/#/sql/sql-interview?id=%e4%ba%8c%e3%80%81%e4%ba%8b%e5%8a%a1">äº‹åŠ¡</a></p>
</blockquote>
<h3 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼äº‹åŠ¡"></a> åˆ†å¸ƒå¼äº‹åŠ¡</h3>
<p><strong>åˆ†å¸ƒå¼äº‹åŠ¡æŒ‡çš„æ˜¯äº‹åŠ¡æ“ä½œè·¨è¶Šå¤šä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”è¦æ±‚æ»¡è¶³äº‹åŠ¡çš„ ACID ç‰¹æ€§ã€‚</strong></p>
<p>éšç€äº’è”ç½‘å¿«é€Ÿå‘å±•ï¼Œå¾®æœåŠ¡ï¼ŒSOA ç­‰æœåŠ¡æ¶æ„æ¨¡å¼æ­£åœ¨è¢«å¤§è§„æ¨¡çš„ä½¿ç”¨ï¼Œç°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸€èˆ¬ç”±å¤šä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿç»„æˆï¼Œå¤šä¸ªå­ç³»ç»Ÿé€šè¿‡ç½‘ç»œé€šä¿¡äº’ç›¸åä½œé…åˆå®Œæˆå„ä¸ªåŠŸèƒ½ã€‚</p>
<p>æœ‰å¾ˆå¤šç”¨ä¾‹ä¼šè·¨å¤šä¸ªå­ç³»ç»Ÿæ‰èƒ½å®Œæˆï¼Œæ¯”è¾ƒå…¸å‹çš„æ˜¯ç”µå­å•†åŠ¡ç½‘ç«™çš„ä¸‹å•æ”¯ä»˜æµç¨‹ï¼Œè‡³å°‘ä¼šæ¶‰åŠäº¤æ˜“ç³»ç»Ÿå’Œæ”¯ä»˜ç³»ç»Ÿï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ°äº‹åŠ¡çš„æ¦‚å¿µï¼Œå³ä¿è¯äº¤æ˜“ç³»ç»Ÿå’Œæ”¯ä»˜ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ï¼Œæ­¤å¤„æˆ‘ä»¬ç§°è¿™ç§<strong>è·¨ç³»ç»Ÿçš„äº‹åŠ¡ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼Œå…·ä½“ä¸€ç‚¹è€Œè¨€ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡æ˜¯æŒ‡äº‹åŠ¡çš„å‚ä¸è€…ã€æ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠäº‹åŠ¡ç®¡ç†å™¨åˆ†åˆ«ä½äºä¸åŒçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹ä¹‹ä¸Šã€‚</p>
<p>ä¸¾ä¸ªäº’è”ç½‘å¸¸ç”¨çš„äº¤æ˜“ä¸šåŠ¡ä¸ºä¾‹ï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205112615.png" alt="img" /></p>
<p>ä¸Šå›¾ä¸­åŒ…å«äº†åº“å­˜å’Œè®¢å•ä¸¤ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œæ¯ä¸ªå¾®æœåŠ¡ç»´æŠ¤äº†è‡ªå·±çš„æ•°æ®åº“ã€‚åœ¨äº¤æ˜“ç³»ç»Ÿçš„ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œä¸€ä¸ªå•†å“åœ¨ä¸‹å•ä¹‹å‰éœ€è¦å…ˆè°ƒç”¨åº“å­˜æœåŠ¡ï¼Œè¿›è¡Œæ‰£é™¤åº“å­˜ï¼Œå†è°ƒç”¨è®¢å•æœåŠ¡ï¼Œåˆ›å»ºè®¢å•è®°å½•ã€‚</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205112518.png" alt="img" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå¤šä¸ªæ•°æ®åº“ä¹‹é—´çš„æ•°æ®æ›´æ–°æ²¡æœ‰ä¿è¯äº‹åŠ¡ï¼Œå°†ä¼šå¯¼è‡´å‡ºç°å­ç³»ç»Ÿæ•°æ®ä¸ä¸€è‡´ï¼Œä¸šåŠ¡å‡ºç°é—®é¢˜ã€‚</p>
<h3 id="åˆ†å¸ƒå¼äº‹åŠ¡çš„éš¾ç‚¹"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼äº‹åŠ¡çš„éš¾ç‚¹"></a> åˆ†å¸ƒå¼äº‹åŠ¡çš„éš¾ç‚¹</h3>
<ul>
<li><strong>äº‹åŠ¡çš„åŸå­æ€§</strong> äº‹åŠ¡æ“ä½œè·¨ä¸åŒèŠ‚ç‚¹ï¼Œå½“å¤šä¸ªèŠ‚ç‚¹æŸä¸€èŠ‚ç‚¹æ“ä½œå¤±è´¥æ—¶ï¼Œéœ€è¦ä¿è¯å¤šèŠ‚ç‚¹æ“ä½œçš„**éƒ½åšæˆ–éƒ½ä¸åšï¼ˆAll or Nothingï¼‰**çš„åŸå­æ€§ã€‚</li>
<li><strong>äº‹åŠ¡çš„ä¸€è‡´æ€§</strong> å½“å‘ç”Ÿç½‘ç»œä¼ è¾“æ•…éšœæˆ–è€…èŠ‚ç‚¹æ•…éšœï¼ŒèŠ‚ç‚¹é—´æ•°æ®å¤åˆ¶é€šé“ä¸­æ–­ï¼Œåœ¨è¿›è¡Œäº‹åŠ¡æ“ä½œæ—¶éœ€è¦ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä¿è¯äº‹åŠ¡çš„ä»»ä½•æ“ä½œéƒ½ä¸ä¼šä½¿å¾—æ•°æ®è¿åæ•°æ®åº“å®šä¹‰çš„çº¦æŸã€è§¦å‘å™¨ç­‰è§„åˆ™ã€‚</li>
<li><strong>äº‹åŠ¡çš„éš”ç¦»æ€§</strong> äº‹åŠ¡éš”ç¦»æ€§çš„æœ¬è´¨å°±æ˜¯å¦‚ä½•æ­£ç¡®å¤šä¸ªå¹¶å‘äº‹åŠ¡çš„å¤„ç†çš„è¯»å†™å†²çªå’Œå†™å†™å†²çªï¼Œå› ä¸ºåœ¨åˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°æäº¤ä¸åŒæ­¥çš„ç°è±¡ï¼Œè¿™ä¸ªæ—¶å€™å°±æœ‰å¯èƒ½å‡ºç°â€œéƒ¨åˆ†å·²ç»æäº¤â€çš„äº‹åŠ¡ã€‚æ­¤æ—¶å¹¶å‘åº”ç”¨è®¿é—®æ•°æ®å¦‚æœæ²¡æœ‰åŠ ä»¥æ§åˆ¶ï¼Œæœ‰å¯èƒ½å‡ºç°â€œè„è¯»â€é—®é¢˜ã€‚</li>
</ul>
<h3 id="cap-å’Œ-base"><a class="markdownIt-Anchor" href="#cap-å’Œ-base"></a> CAP å’Œ BASE</h3>
<p>CAP å®šç†åˆç§°ä¸º CAP åŸåˆ™ï¼ŒæŒ‡çš„æ˜¯ï¼š<strong>åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œ <code>ä¸€è‡´æ€§ï¼ˆCï¼šConsistencyï¼‰</code>ã€<code>å¯ç”¨æ€§ï¼ˆAï¼šAvailabilityï¼‰</code> å’Œ <code>åˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼šPartition Toleranceï¼‰</code>ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤é¡¹</strong>ã€‚</p>
<p>BASE æ˜¯ <strong><code>åŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰</code></strong>ã€<strong><code>è½¯çŠ¶æ€ï¼ˆSoft Stateï¼‰</code></strong> å’Œ <strong><code>æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually Consistentï¼‰</code></strong> ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œå®ƒçš„ç†è®ºçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<blockquote>
<p>ğŸ’¡ æ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥å‚è€ƒï¼š<a href="#distributed-base-theory.md">åˆ†å¸ƒå¼åŸºç¡€ç†è®º</a></p>
</blockquote>
<h3 id="æŸ”æ€§äº‹åŠ¡"><a class="markdownIt-Anchor" href="#æŸ”æ€§äº‹åŠ¡"></a> æŸ”æ€§äº‹åŠ¡</h3>
<h4 id="æŸ”æ€§äº‹åŠ¡çš„æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#æŸ”æ€§äº‹åŠ¡çš„æ¦‚å¿µ"></a> æŸ”æ€§äº‹åŠ¡çš„æ¦‚å¿µ</h4>
<p>åœ¨ç”µå•†ç­‰äº’è”ç½‘åœºæ™¯ä¸‹ï¼Œä¼ ç»Ÿçš„äº‹åŠ¡åœ¨æ•°æ®åº“æ€§èƒ½å’Œå¤„ç†èƒ½åŠ›ä¸Šéƒ½æš´éœ²å‡ºäº†ç“¶é¢ˆã€‚åœ¨åˆ†å¸ƒå¼é¢†åŸŸåŸºäº CAP ç†è®ºä»¥åŠ BASE ç†è®ºï¼Œæœ‰äººå°±æå‡ºäº†<strong>æŸ”æ€§äº‹åŠ¡</strong>çš„æ¦‚å¿µã€‚</p>
<p>åŸºäº BASE ç†è®ºçš„è®¾è®¡æ€æƒ³ï¼ŒæŸ”æ€§äº‹åŠ¡ä¸‹ï¼Œåœ¨ä¸å½±å“ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§çš„æƒ…å†µä¸‹(Basically Available åŸºæœ¬å¯ç”¨)ï¼Œå…è®¸ç³»ç»Ÿå­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„ä¸­é—´çŠ¶æ€(Soft State è½¯çŠ¶æ€)ï¼Œåœ¨ç»è¿‡æ•°æ®åŒæ­¥çš„å»¶æ—¶ä¹‹åï¼Œæœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ã€‚<strong>å¹¶ä¸æ˜¯å®Œå…¨æ”¾å¼ƒäº† ACIDï¼Œè€Œæ˜¯é€šè¿‡æ”¾å®½ä¸€è‡´æ€§è¦æ±‚ï¼Œå€ŸåŠ©æœ¬åœ°äº‹åŠ¡æ¥å®ç°æœ€ç»ˆåˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§çš„åŒæ—¶ä¹Ÿä¿è¯ç³»ç»Ÿçš„åå</strong>ã€‚</p>
<h4 id="æŸ”æ€§äº‹åŠ¡çš„ç‰¹æ€§"><a class="markdownIt-Anchor" href="#æŸ”æ€§äº‹åŠ¡çš„ç‰¹æ€§"></a> æŸ”æ€§äº‹åŠ¡çš„ç‰¹æ€§</h4>
<p>ä¸‹é¢ä»‹ç»çš„æ˜¯å®ç°æŸ”æ€§äº‹åŠ¡çš„ä¸€äº›å¸¸è§ç‰¹æ€§ï¼Œè¿™äº›ç‰¹æ€§åœ¨å…·ä½“çš„æ–¹æ¡ˆä¸­ä¸ä¸€å®šéƒ½è¦æ»¡è¶³ï¼Œå› ä¸ºä¸åŒçš„æ–¹æ¡ˆè¦æ±‚ä¸ä¸€æ ·ã€‚</p>
<p><strong>å¯è§æ€§(å¯¹å¤–å¯æŸ¥è¯¢)</strong> åœ¨åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæŸä¸€ä¸ªæ­¥éª¤æ‰§è¡Œå‡ºé”™ï¼Œå°±éœ€è¦æ˜ç¡®çš„çŸ¥é“å…¶ä»–å‡ ä¸ªæ“ä½œçš„å¤„ç†æƒ…å†µï¼Œè¿™å°±éœ€è¦å…¶ä»–çš„æœåŠ¡éƒ½èƒ½å¤Ÿæä¾›æŸ¥è¯¢æ¥å£ï¼Œä¿è¯å¯ä»¥é€šè¿‡æŸ¥è¯¢æ¥åˆ¤æ–­æ“ä½œçš„å¤„ç†æƒ…å†µã€‚</p>
<p>ä¸ºäº†ä¿è¯æ“ä½œçš„å¯æŸ¥è¯¢ï¼Œéœ€è¦å¯¹äºæ¯ä¸€ä¸ªæœåŠ¡çš„æ¯ä¸€æ¬¡è°ƒç”¨éƒ½æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æ ‡è¯†ï¼Œå¯ä»¥æ˜¯ä¸šåŠ¡å•æ®å·ï¼ˆå¦‚è®¢å•å·ï¼‰ã€ä¹Ÿå¯ä»¥æ˜¯ç³»ç»Ÿåˆ†é…çš„æ“ä½œæµæ°´å·ï¼ˆå¦‚æ”¯ä»˜è®°å½•æµæ°´å·ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ“ä½œçš„æ—¶é—´ä¿¡æ¯ä¹Ÿè¦æœ‰å®Œæ•´çš„è®°å½•ã€‚</p>
<p><strong>æ“ä½œå¹‚ç­‰æ€§</strong> å¹‚ç­‰æ€§ï¼Œå…¶å®æ˜¯ä¸€ä¸ªæ•°å­¦æ¦‚å¿µã€‚å¹‚ç­‰å‡½æ•°ï¼Œæˆ–å¹‚ç­‰æ–¹æ³•ï¼Œæ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚å¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨åŒæ ·çš„å‚æ•°ï¼Œè°ƒç”¨å¤šæ¬¡äº§ç”Ÿçš„ä¸šåŠ¡ç»“æœä¸è°ƒç”¨ä¸€æ¬¡äº§ç”Ÿçš„ä¸šåŠ¡ç»“æœç›¸åŒã€‚</p>
<p>ä¹‹æ‰€ä»¥éœ€è¦æ“ä½œå¹‚ç­‰æ€§ï¼Œæ˜¯å› ä¸ºä¸ºäº†ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¾ˆå¤šäº‹åŠ¡åè®®éƒ½ä¼šæœ‰å¾ˆå¤šé‡è¯•çš„æ“ä½œï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•ä¸ä¿è¯å¹‚ç­‰ï¼Œé‚£ä¹ˆå°†æ— æ³•è¢«é‡è¯•ã€‚å¹‚ç­‰æ“ä½œçš„å®ç°æ–¹å¼æœ‰å¤šç§ï¼Œå¦‚åœ¨ç³»ç»Ÿä¸­ç¼“å­˜æ‰€æœ‰çš„è¯·æ±‚ä¸å¤„ç†ç»“æœã€æ£€æµ‹åˆ°é‡å¤æ“ä½œåï¼Œç›´æ¥è¿”å›ä¸Šä¸€æ¬¡çš„å¤„ç†ç»“æœç­‰ã€‚</p>
<h2 id="äºŒ-ä¸¤é˜¶æ®µæäº¤2pc"><a class="markdownIt-Anchor" href="#äºŒ-ä¸¤é˜¶æ®µæäº¤2pc"></a> äºŒã€ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰</h2>
<h3 id="æ–¹æ¡ˆç®€ä»‹"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆç®€ä»‹"></a> æ–¹æ¡ˆç®€ä»‹</h3>
<p>äºŒé˜¶æ®µæäº¤åè®®ï¼ˆTwo-phase Commitï¼Œå³ 2PCï¼‰æ˜¯å¸¸ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå³<strong>å°†äº‹åŠ¡çš„æäº¤è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µæ¥è¿›è¡Œå¤„ç†ï¼šå‡†å¤‡é˜¶æ®µå’Œæäº¤é˜¶æ®µ</strong>ã€‚äº‹åŠ¡çš„å‘èµ·è€…ç§°åè°ƒè€…ï¼Œäº‹åŠ¡çš„æ‰§è¡Œè€…ç§°å‚ä¸è€…ã€‚</p>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥çŸ¥æ™“è‡ªå·±æ“ä½œçš„æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œå´æ— æ³•çŸ¥é“å…¶ä»–èŠ‚ç‚¹æ“ä½œçš„æˆåŠŸæˆ–å¤±è´¥ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è·¨å¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡çš„åŸå­æ€§ä¸ä¸€è‡´æ€§ï¼Œè€Œå¼•å…¥ä¸€ä¸ªåè°ƒè€…æ¥ç»Ÿä¸€æŒæ§æ‰€æœ‰å‚ä¸è€…çš„æ“ä½œç»“æœï¼Œå¹¶æŒ‡ç¤ºå®ƒä»¬æ˜¯å¦è¦æŠŠæ“ä½œç»“æœè¿›è¡ŒçœŸæ­£çš„æäº¤æˆ–è€…å›æ»šï¼ˆrollbackï¼‰ã€‚</p>
<p>äºŒé˜¶æ®µæäº¤çš„æ€è·¯å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š<strong>å‚ä¸è€…å°†æ“ä½œæˆè´¥é€šçŸ¥åè°ƒè€…ï¼Œå†ç”±åè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆæƒ…æŠ¥å†³å®šå„å‚ä¸è€…æ˜¯å¦è¦æäº¤æ“ä½œè¿˜æ˜¯ä¸­æ­¢æ“ä½œ</strong>ã€‚</p>
<p>æ ¸å¿ƒæ€æƒ³å°±æ˜¯å¯¹æ¯ä¸€ä¸ªäº‹åŠ¡éƒ½é‡‡ç”¨å…ˆå°è¯•åæäº¤çš„å¤„ç†æ–¹å¼ï¼Œå¤„ç†åæ‰€æœ‰çš„è¯»æ“ä½œéƒ½è¦èƒ½è·å¾—æœ€æ–°çš„æ•°æ®ï¼Œå› æ­¤ä¹Ÿå¯ä»¥å°†äºŒé˜¶æ®µæäº¤çœ‹ä½œæ˜¯ä¸€ä¸ªå¼ºä¸€è‡´æ€§ç®—æ³•ã€‚</p>
<h3 id="å¤„ç†æµç¨‹"><a class="markdownIt-Anchor" href="#å¤„ç†æµç¨‹"></a> å¤„ç†æµç¨‹</h3>
<p>ç®€å•ä¸€ç‚¹ç†è§£ï¼Œå¯ä»¥æŠŠåè°ƒè€…èŠ‚ç‚¹æ¯”å–»ä¸ºå¸¦å¤´å¤§å“¥ï¼Œå‚ä¸è€…ç†è§£æ¯”å–»ä¸ºè·Ÿç­å°å¼Ÿï¼Œå¸¦å¤´å¤§å“¥ç»Ÿä¸€åè°ƒè·Ÿç­å°å¼Ÿçš„ä»»åŠ¡æ‰§è¡Œã€‚</p>
<h4 id="é˜¶æ®µ-1å‡†å¤‡é˜¶æ®µ"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-1å‡†å¤‡é˜¶æ®µ"></a> é˜¶æ®µ 1ï¼šå‡†å¤‡é˜¶æ®µ</h4>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€äº‹åŠ¡å†…å®¹ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰å‚ä¸è€…ç­”å¤ã€‚</li>
<li>å„å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå°† undo å’Œ redo ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼ˆä½†ä¸æäº¤äº‹åŠ¡ï¼‰ã€‚</li>
<li>å¦‚å‚ä¸è€…æ‰§è¡ŒæˆåŠŸï¼Œç»™åè°ƒè€…åé¦ˆ yesï¼Œå³å¯ä»¥æäº¤ï¼›å¦‚æ‰§è¡Œå¤±è´¥ï¼Œç»™åè°ƒè€…åé¦ˆ noï¼Œå³ä¸å¯æäº¤ã€‚</li>
</ol>
<h4 id="é˜¶æ®µ-2æäº¤é˜¶æ®µ"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-2æäº¤é˜¶æ®µ"></a> é˜¶æ®µ 2ï¼šæäº¤é˜¶æ®µ</h4>
<p>å¦‚æœåè°ƒè€…æ”¶åˆ°äº†å‚ä¸è€…çš„å¤±è´¥æ¶ˆæ¯æˆ–è€…è¶…æ—¶ï¼Œç›´æ¥ç»™æ¯ä¸ªå‚ä¸è€…å‘é€å›æ»š(rollback)æ¶ˆæ¯ï¼›å¦åˆ™ï¼Œå‘é€æäº¤(commit)æ¶ˆæ¯ï¼›å‚ä¸è€…æ ¹æ®åè°ƒè€…çš„æŒ‡ä»¤æ‰§è¡Œæäº¤æˆ–è€…å›æ»šæ“ä½œï¼Œé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨çš„é”èµ„æºã€‚(æ³¨æ„:å¿…é¡»åœ¨æœ€åé˜¶æ®µé‡Šæ”¾é”èµ„æº) æ¥ä¸‹æ¥åˆ†ä¸¤ç§æƒ…å†µåˆ†åˆ«è®¨è®ºæäº¤é˜¶æ®µçš„è¿‡ç¨‹ã€‚</p>
<p><strong>æƒ…å†µ 1ï¼Œå½“æ‰€æœ‰å‚ä¸è€…å‡åé¦ˆ yesï¼Œæäº¤äº‹åŠ¡</strong>ï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205153529.png" alt="img" /></p>
<blockquote>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘å‡ºæ­£å¼æäº¤äº‹åŠ¡çš„è¯·æ±‚ï¼ˆå³ commit è¯·æ±‚ï¼‰ã€‚</li>
<li>å‚ä¸è€…æ‰§è¡Œ commit è¯·æ±‚ï¼Œå¹¶é‡Šæ”¾æ•´ä¸ªäº‹åŠ¡æœŸé—´å ç”¨çš„èµ„æºã€‚</li>
<li>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆ ack(åº”ç­”)å®Œæˆçš„æ¶ˆæ¯ã€‚</li>
<li>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„ ack æ¶ˆæ¯åï¼Œå³å®Œæˆäº‹åŠ¡æäº¤ã€‚</li>
</ol>
</blockquote>
<p><strong>æƒ…å†µ 2ï¼Œå½“ä»»ä½•é˜¶æ®µ 1 ä¸€ä¸ªå‚ä¸è€…åé¦ˆ noï¼Œä¸­æ–­äº‹åŠ¡</strong>ï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205154145.png" alt="img" /></p>
<blockquote>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘å‡ºå›æ»šè¯·æ±‚ï¼ˆå³ rollback è¯·æ±‚ï¼‰ã€‚</li>
<li>å‚ä¸è€…ä½¿ç”¨é˜¶æ®µ 1 ä¸­çš„ undo ä¿¡æ¯æ‰§è¡Œå›æ»šæ“ä½œï¼Œå¹¶é‡Šæ”¾æ•´ä¸ªäº‹åŠ¡æœŸé—´å ç”¨çš„èµ„æºã€‚</li>
<li>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆ ack å®Œæˆçš„æ¶ˆæ¯ã€‚</li>
<li>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„ ack æ¶ˆæ¯åï¼Œå³å®Œæˆäº‹åŠ¡ä¸­æ–­ã€‚</li>
</ol>
</blockquote>
<h3 id="æ–¹æ¡ˆæ€»ç»“"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆæ€»ç»“"></a> æ–¹æ¡ˆæ€»ç»“</h3>
<p>2PC æ–¹æ¡ˆå®ç°èµ·æ¥ç®€å•ï¼Œå®é™…é¡¹ç›®ä¸­ä½¿ç”¨æ¯”è¾ƒå°‘ï¼Œä¸»è¦å› ä¸ºä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li><strong>æ€§èƒ½é—®é¢˜</strong> - æ‰€æœ‰å‚ä¸è€…åœ¨äº‹åŠ¡æäº¤é˜¶æ®µå¤„äºåŒæ­¥é˜»å¡çŠ¶æ€ï¼Œå ç”¨ç³»ç»Ÿèµ„æºï¼Œå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚</li>
<li><strong>å¯é æ€§é—®é¢˜</strong> - å¦‚æœåè°ƒè€…å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå¦‚æœåè°ƒè€…å‡ºç°æ•…éšœï¼Œå‚ä¸è€…å°†ä¸€ç›´å¤„äºé”å®šçŠ¶æ€ã€‚</li>
<li><strong>æ•°æ®ä¸€è‡´æ€§é—®é¢˜</strong> - åœ¨é˜¶æ®µ 2 ä¸­ï¼Œå¦‚æœå‘ç”Ÿå±€éƒ¨ç½‘ç»œé—®é¢˜ï¼Œä¸€éƒ¨åˆ†äº‹åŠ¡å‚ä¸è€…æ”¶åˆ°äº†æäº¤æ¶ˆæ¯ï¼Œå¦ä¸€éƒ¨åˆ†äº‹åŠ¡å‚ä¸è€…æ²¡æ”¶åˆ°æäº¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±å¯¼è‡´äº†èŠ‚ç‚¹ä¹‹é—´æ•°æ®çš„ä¸ä¸€è‡´ã€‚</li>
</ul>
<h2 id="ä¸‰-ä¸‰é˜¶æ®µæäº¤3pc"><a class="markdownIt-Anchor" href="#ä¸‰-ä¸‰é˜¶æ®µæäº¤3pc"></a> ä¸‰ã€ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰</h2>
<h3 id="æ–¹æ¡ˆç®€ä»‹-2"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆç®€ä»‹-2"></a> æ–¹æ¡ˆç®€ä»‹</h3>
<p>ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆThree-phase Commitï¼Œ3PCï¼‰ï¼Œæ˜¯äºŒé˜¶æ®µæäº¤åè®®çš„æ”¹è¿›ç‰ˆæœ¬ï¼Œä¸äºŒé˜¶æ®µæäº¤ä¸åŒçš„æ˜¯ï¼Œå¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚åŒæ—¶åœ¨åè°ƒè€…å’Œå‚ä¸è€…ä¸­éƒ½å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚</p>
<p>ä¸‰é˜¶æ®µæäº¤å°†äºŒé˜¶æ®µçš„å‡†å¤‡é˜¶æ®µæ‹†åˆ†ä¸º 2 ä¸ªé˜¶æ®µï¼Œæ’å…¥äº†ä¸€ä¸ª preCommit é˜¶æ®µï¼Œä½¿å¾—åŸå…ˆåœ¨äºŒé˜¶æ®µæäº¤ä¸­ï¼Œå‚ä¸è€…åœ¨å‡†å¤‡ä¹‹åï¼Œç”±äºåè°ƒè€…å‘ç”Ÿå´©æºƒæˆ–é”™è¯¯ï¼Œè€Œå¯¼è‡´å‚ä¸è€…å¤„äºæ— æ³•çŸ¥æ™“æ˜¯å¦æäº¤æˆ–è€…ä¸­æ­¢çš„â€œä¸ç¡®å®šçŠ¶æ€â€æ‰€äº§ç”Ÿçš„å¯èƒ½ç›¸å½“é•¿çš„å»¶æ—¶çš„é—®é¢˜å¾—ä»¥è§£å†³ã€‚</p>
<h3 id="å¤„ç†æµç¨‹-2"><a class="markdownIt-Anchor" href="#å¤„ç†æµç¨‹-2"></a> å¤„ç†æµç¨‹</h3>
<h4 id="é˜¶æ®µ-1cancommit"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-1cancommit"></a> é˜¶æ®µ 1ï¼šcanCommit</h4>
<p>åè°ƒè€…å‘å‚ä¸è€…å‘é€ commit è¯·æ±‚ï¼Œå‚ä¸è€…å¦‚æœå¯ä»¥æäº¤å°±è¿”å› yes å“åº”(å‚ä¸è€…ä¸æ‰§è¡Œäº‹åŠ¡æ“ä½œ)ï¼Œå¦åˆ™è¿”å› no å“åº”ï¼š</p>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘å‡ºåŒ…å«äº‹åŠ¡å†…å®¹çš„ canCommit è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰å‚ä¸è€…ç­”å¤ã€‚</li>
<li>å‚ä¸è€…æ”¶åˆ° canCommit è¯·æ±‚åï¼Œå¦‚æœè®¤ä¸ºå¯ä»¥æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œåˆ™åé¦ˆ yes å¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™åé¦ˆ noã€‚</li>
</ol>
<h4 id="é˜¶æ®µ-2precommit"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-2precommit"></a> é˜¶æ®µ 2ï¼špreCommit</h4>
<p>åè°ƒè€…æ ¹æ®é˜¶æ®µ 1 canCommit å‚ä¸è€…çš„ååº”æƒ…å†µæ¥å†³å®šæ˜¯å¦å¯ä»¥åŸºäºäº‹åŠ¡çš„ preCommit æ“ä½œã€‚æ ¹æ®å“åº”æƒ…å†µï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ã€‚</p>
<p><strong>æƒ…å†µ 1ï¼šé˜¶æ®µ 1 æ‰€æœ‰å‚ä¸è€…å‡åé¦ˆ yesï¼Œå‚ä¸è€…é¢„æ‰§è¡Œäº‹åŠ¡ï¼š</strong></p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205180242.png" alt="img" /></p>
<blockquote>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘å‡º preCommit è¯·æ±‚ï¼Œè¿›å…¥å‡†å¤‡é˜¶æ®µã€‚</li>
<li>å‚ä¸è€…æ”¶åˆ° preCommit è¯·æ±‚åï¼Œæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå°† undo å’Œ redo ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼ˆä½†ä¸æäº¤äº‹åŠ¡ï¼‰ã€‚</li>
<li>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆ ack å“åº”æˆ– no å“åº”ï¼Œå¹¶ç­‰å¾…æœ€ç»ˆæŒ‡ä»¤ã€‚</li>
</ol>
</blockquote>
<p><strong>æƒ…å†µ 2ï¼šé˜¶æ®µ 1 ä»»ä½•ä¸€ä¸ªå‚ä¸è€…åé¦ˆ noï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ååè°ƒè€…å°šæ— æ³•æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆï¼Œå³ä¸­æ–­äº‹åŠ¡:</strong></p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205205117.png" alt="img" /></p>
<blockquote>
<ol>
<li>åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘å‡º abort è¯·æ±‚ã€‚</li>
<li>æ— è®ºæ”¶åˆ°åè°ƒè€…å‘å‡ºçš„ abort è¯·æ±‚ï¼Œæˆ–è€…åœ¨ç­‰å¾…åè°ƒè€…è¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°è¶…æ—¶ï¼Œå‚ä¸è€…å‡ä¼šä¸­æ–­äº‹åŠ¡ã€‚</li>
</ol>
</blockquote>
<h4 id="é˜¶æ®µ-3docommit"><a class="markdownIt-Anchor" href="#é˜¶æ®µ-3docommit"></a> é˜¶æ®µ 3ï¼šdoCommit</h4>
<p>è¯¥é˜¶æ®µè¿›è¡ŒçœŸæ­£çš„äº‹åŠ¡æäº¤ï¼Œä¹Ÿå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<p><strong>æƒ…å†µ 1ï¼šé˜¶æ®µ 2 æ‰€æœ‰å‚ä¸è€…å‡åé¦ˆ ack å“åº”ï¼Œæ‰§è¡ŒçœŸæ­£çš„äº‹åŠ¡æäº¤ï¼š</strong></p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205180425.png" alt="img" /></p>
<blockquote>
<ol>
<li>å¦‚æœåè°ƒè€…å¤„äºå·¥ä½œçŠ¶æ€ï¼Œåˆ™å‘æ‰€æœ‰å‚ä¸è€…å‘å‡º do Commit è¯·æ±‚ã€‚</li>
<li>å‚ä¸è€…æ”¶åˆ° do Commit è¯·æ±‚åï¼Œä¼šæ­£å¼æ‰§è¡Œäº‹åŠ¡æäº¤ï¼Œå¹¶é‡Šæ”¾æ•´ä¸ªäº‹åŠ¡æœŸé—´å ç”¨çš„èµ„æºã€‚</li>
<li>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆ ack å®Œæˆçš„æ¶ˆæ¯ã€‚</li>
<li>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„ ack æ¶ˆæ¯åï¼Œå³å®Œæˆäº‹åŠ¡æäº¤ã€‚</li>
</ol>
</blockquote>
<p><strong>é˜¶æ®µ 2 ä»»ä½•ä¸€ä¸ªå‚ä¸è€…åé¦ˆ noï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ååè°ƒè€…å°šæ— æ³•æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆï¼Œå³ä¸­æ–­äº‹åŠ¡ï¼š</strong></p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205180515.png" alt="img" /></p>
<blockquote>
<ol>
<li>å¦‚æœåè°ƒè€…å¤„äºå·¥ä½œçŠ¶æ€ï¼Œå‘æ‰€æœ‰å‚ä¸è€…å‘å‡º abort è¯·æ±‚ã€‚</li>
<li>å‚ä¸è€…ä½¿ç”¨é˜¶æ®µ 1 ä¸­çš„ undo ä¿¡æ¯æ‰§è¡Œå›æ»šæ“ä½œï¼Œå¹¶é‡Šæ”¾æ•´ä¸ªäº‹åŠ¡æœŸé—´å ç”¨çš„èµ„æºã€‚</li>
<li>å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆ ack å®Œæˆçš„æ¶ˆæ¯ã€‚</li>
<li>åè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„ ack æ¶ˆæ¯åï¼Œå³å®Œæˆäº‹åŠ¡ä¸­æ–­ã€‚</li>
</ol>
</blockquote>
<p>æ³¨æ„ï¼šè¿›å…¥é˜¶æ®µ 3 åï¼Œæ— è®ºåè°ƒè€…å‡ºç°é—®é¢˜ï¼Œæˆ–è€…åè°ƒè€…ä¸å‚ä¸è€…ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šå¯¼è‡´å‚ä¸è€…æ— æ³•æ¥æ”¶åˆ°åè°ƒè€…å‘å‡ºçš„ do Commit è¯·æ±‚æˆ– abort è¯·æ±‚ã€‚æ­¤æ—¶ï¼Œå‚ä¸è€…éƒ½ä¼šåœ¨ç­‰å¾…è¶…æ—¶ä¹‹åï¼Œç»§ç»­æ‰§è¡Œäº‹åŠ¡æäº¤ã€‚</p>
<h3 id="æ–¹æ¡ˆæ€»ç»“-2"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆæ€»ç»“-2"></a> æ–¹æ¡ˆæ€»ç»“</h3>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç›¸æ¯”äºŒé˜¶æ®µæäº¤ï¼Œä¸‰é˜¶æ®µé™ä½äº†é˜»å¡èŒƒå›´ï¼Œåœ¨ç­‰å¾…è¶…æ—¶ååè°ƒè€…æˆ–å‚ä¸è€…ä¼šä¸­æ–­äº‹åŠ¡ã€‚é¿å…äº†åè°ƒè€…å•ç‚¹é—®é¢˜ï¼Œé˜¶æ®µ 3 ä¸­åè°ƒè€…å‡ºç°é—®é¢˜æ—¶ï¼Œå‚ä¸è€…ä¼šç»§ç»­æäº¤äº‹åŠ¡ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ•°æ®ä¸ä¸€è‡´é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œå½“åœ¨å‚ä¸è€…æ”¶åˆ° preCommit è¯·æ±‚åç­‰å¾… do commite æŒ‡ä»¤æ—¶ï¼Œæ­¤æ—¶å¦‚æœåè°ƒè€…è¯·æ±‚ä¸­æ–­äº‹åŠ¡ï¼Œè€Œåè°ƒè€…æ— æ³•ä¸å‚ä¸è€…æ­£å¸¸é€šä¿¡ï¼Œä¼šå¯¼è‡´å‚ä¸è€…ç»§ç»­æäº¤äº‹åŠ¡ï¼Œé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚</li>
</ul>
<h2 id="å››-è¡¥å¿äº‹åŠ¡tcc"><a class="markdownIt-Anchor" href="#å››-è¡¥å¿äº‹åŠ¡tcc"></a> å››ã€è¡¥å¿äº‹åŠ¡ï¼ˆTCCï¼‰</h2>
<h3 id="æ–¹æ¡ˆç®€ä»‹-3"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆç®€ä»‹-3"></a> æ–¹æ¡ˆç®€ä»‹</h3>
<p>TCCï¼ˆTry-Confirm-Cancelï¼‰çš„æ¦‚å¿µï¼Œæœ€æ—©æ˜¯ç”± Pat Helland äº 2007 å¹´å‘è¡¨çš„ä¸€ç¯‡åä¸ºã€ŠLife beyond Distributed Transactions:an Apostateâ€™s Opinionã€‹çš„è®ºæ–‡æå‡ºã€‚</p>
<p>TCC æ˜¯æœåŠ¡åŒ–çš„äºŒé˜¶æ®µç¼–ç¨‹æ¨¡å‹ï¼Œå…¶ Tryã€Confirmã€Cancel 3 ä¸ªæ–¹æ³•å‡ç”±ä¸šåŠ¡ç¼–ç å®ç°ï¼›</p>
<ul>
<li><strong>Try</strong> - æ“ä½œä½œä¸ºä¸€é˜¶æ®µï¼Œè´Ÿè´£èµ„æºçš„æ£€æŸ¥å’Œé¢„ç•™ã€‚</li>
<li><strong>Confirm</strong> - æ“ä½œä½œä¸ºäºŒé˜¶æ®µæäº¤æ“ä½œï¼Œæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡ã€‚</li>
<li><strong>Cancel</strong> - æ˜¯é¢„ç•™èµ„æºçš„å–æ¶ˆã€‚</li>
</ul>
<p>TCC äº‹åŠ¡çš„ Tryã€Confirmã€Cancel å¯ä»¥ç†è§£ä¸º SQL äº‹åŠ¡ä¸­çš„ Lockã€Commitã€Rollbackã€‚</p>
<h3 id="å¤„ç†æµç¨‹-3"><a class="markdownIt-Anchor" href="#å¤„ç†æµç¨‹-3"></a> å¤„ç†æµç¨‹</h3>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä¸‹é¢ä»¥ç”µå•†ä¸‹å•ä¸ºä¾‹è¿›è¡Œæ–¹æ¡ˆè§£æï¼Œè¿™é‡ŒæŠŠæ•´ä¸ªè¿‡ç¨‹ç®€å•åˆ†ä¸ºæ‰£å‡åº“å­˜ï¼Œè®¢å•åˆ›å»º 2 ä¸ªæ­¥éª¤ï¼Œåº“å­˜æœåŠ¡å’Œè®¢å•æœåŠ¡åˆ†åˆ«åœ¨ä¸åŒçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šã€‚</p>
<h4 id="try-é˜¶æ®µ"><a class="markdownIt-Anchor" href="#try-é˜¶æ®µ"></a> Try é˜¶æ®µ</h4>
<p>ä»æ‰§è¡Œé˜¶æ®µæ¥çœ‹ï¼Œä¸ä¼ ç»Ÿäº‹åŠ¡æœºåˆ¶ä¸­ä¸šåŠ¡é€»è¾‘ç›¸åŒã€‚ä½†ä»ä¸šåŠ¡è§’åº¦æ¥çœ‹ï¼Œå´ä¸ä¸€æ ·ã€‚TCC æœºåˆ¶ä¸­çš„ Try ä»…æ˜¯ä¸€ä¸ªåˆæ­¥æ“ä½œï¼Œå®ƒå’Œåç»­çš„ç¡®è®¤ä¸€èµ·æ‰èƒ½çœŸæ­£æ„æˆä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™ä¸ªé˜¶æ®µä¸»è¦å®Œæˆï¼š</p>
<ul>
<li>å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥( ä¸€è‡´æ€§ )</li>
<li>é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æº( å‡†éš”ç¦»æ€§ )</li>
<li>Try å°è¯•æ‰§è¡Œä¸šåŠ¡ TCC äº‹åŠ¡æœºåˆ¶ä»¥åˆæ­¥æ“ä½œï¼ˆTryï¼‰ä¸ºä¸­å¿ƒçš„ï¼Œç¡®è®¤æ“ä½œï¼ˆConfirmï¼‰å’Œå–æ¶ˆæ“ä½œï¼ˆCancelï¼‰éƒ½æ˜¯å›´ç»•åˆæ­¥æ“ä½œï¼ˆTryï¼‰è€Œå±•å¼€ã€‚å› æ­¤ï¼ŒTry é˜¶æ®µä¸­çš„æ“ä½œï¼Œå…¶ä¿éšœæ€§æ˜¯æœ€å¥½çš„ï¼Œå³ä½¿å¤±è´¥ï¼Œä»ç„¶æœ‰å–æ¶ˆæ“ä½œï¼ˆCancelï¼‰å¯ä»¥å°†å…¶æ‰§è¡Œç»“æœæ’¤é”€ã€‚</li>
</ul>
<p>å‡è®¾å•†å“åº“å­˜ä¸º 100ï¼Œè´­ä¹°æ•°é‡ä¸º 2ï¼Œè¿™é‡Œæ£€æŸ¥å’Œæ›´æ–°åº“å­˜çš„åŒæ—¶ï¼Œå†»ç»“ç”¨æˆ·è´­ä¹°æ•°é‡çš„åº“å­˜ï¼ŒåŒæ—¶åˆ›å»ºè®¢å•ï¼Œè®¢å•çŠ¶æ€ä¸ºå¾…ç¡®è®¤ã€‚</p>
<h4 id="confirm-cancel-é˜¶æ®µ"><a class="markdownIt-Anchor" href="#confirm-cancel-é˜¶æ®µ"></a> Confirm / Cancel é˜¶æ®µ</h4>
<p>æ ¹æ® Try é˜¶æ®µæœåŠ¡æ˜¯å¦å…¨éƒ¨æ­£å¸¸æ‰§è¡Œï¼Œç»§ç»­æ‰§è¡Œç¡®è®¤æ“ä½œï¼ˆConfirmï¼‰æˆ–å–æ¶ˆæ“ä½œï¼ˆCancelï¼‰ã€‚ Confirm å’Œ Cancel æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ï¼Œå¦‚æœ Confirm æˆ– Cancel æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œå°†ä¼šä¸æ–­é‡è¯•ç›´åˆ°æ‰§è¡Œå®Œæˆã€‚</p>
<p><strong>Confirmï¼šå½“ Try é˜¶æ®µæœåŠ¡å…¨éƒ¨æ­£å¸¸æ‰§è¡Œï¼Œ æ‰§è¡Œç¡®è®¤ä¸šåŠ¡é€»è¾‘æ“ä½œ</strong></p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205205200.png" alt="img" /></p>
<p>è¿™é‡Œä½¿ç”¨çš„èµ„æºä¸€å®šæ˜¯ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚åœ¨ TCC äº‹åŠ¡æœºåˆ¶ä¸­è®¤ä¸ºï¼Œå¦‚æœåœ¨ Try é˜¶æ®µèƒ½æ­£å¸¸çš„é¢„ç•™èµ„æºï¼Œé‚£ Confirm ä¸€å®šèƒ½å®Œæ•´æ­£ç¡®çš„æäº¤ã€‚Confirm é˜¶æ®µä¹Ÿå¯ä»¥çœ‹æˆæ˜¯å¯¹ Try é˜¶æ®µçš„ä¸€ä¸ªè¡¥å……ï¼ŒTry+Confirm ä¸€èµ·ç»„æˆäº†ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p><strong>Cancelï¼šå½“ Try é˜¶æ®µå­˜åœ¨æœåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œ è¿›å…¥ Cancel é˜¶æ®µ</strong></p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205205221.png" alt="img" /></p>
<p>Cancel å–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒCancel æ“ä½œä¼šæŠŠå†»ç»“çš„åº“å­˜é‡Šæ”¾ï¼Œå¹¶æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå–æ¶ˆã€‚</p>
<h3 id="æ–¹æ¡ˆæ€»ç»“-3"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆæ€»ç»“-3"></a> æ–¹æ¡ˆæ€»ç»“</h3>
<p>TCC äº‹åŠ¡æœºåˆ¶ç›¸å¯¹äºä¼ ç»Ÿäº‹åŠ¡æœºåˆ¶ï¼ˆX/Open XAï¼‰ï¼ŒTCC äº‹åŠ¡æœºåˆ¶ç›¸æ¯”äºä¸Šé¢ä»‹ç»çš„ XA äº‹åŠ¡æœºåˆ¶ï¼Œæœ‰ä»¥ä¸‹ä¼˜ç‚¹:</p>
<ul>
<li><strong>æ€§èƒ½æå‡</strong> - å…·ä½“ä¸šåŠ¡æ¥å®ç°æ§åˆ¶èµ„æºé”çš„ç²’åº¦å˜å°ï¼Œä¸ä¼šé”å®šæ•´ä¸ªèµ„æºã€‚</li>
<li><strong>æ•°æ®æœ€ç»ˆä¸€è‡´æ€§</strong> - åŸºäº Confirm å’Œ Cancel çš„å¹‚ç­‰æ€§ï¼Œä¿è¯äº‹åŠ¡æœ€ç»ˆå®Œæˆç¡®è®¤æˆ–è€…å–æ¶ˆï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</li>
<li><strong>å¯é æ€§</strong> - è§£å†³äº† XA åè®®çš„åè°ƒè€…å•ç‚¹æ•…éšœé—®é¢˜ï¼Œç”±ä¸»ä¸šåŠ¡æ–¹å‘èµ·å¹¶æ§åˆ¶æ•´ä¸ªä¸šåŠ¡æ´»åŠ¨ï¼Œä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ä¹Ÿå˜æˆå¤šç‚¹ï¼Œå¼•å…¥é›†ç¾¤ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š TCC çš„ Tryã€Confirm å’Œ Cancel æ“ä½œåŠŸèƒ½è¦æŒ‰å…·ä½“ä¸šåŠ¡æ¥å®ç°ï¼Œä¸šåŠ¡è€¦åˆåº¦è¾ƒé«˜ï¼Œæé«˜äº†å¼€å‘æˆæœ¬ã€‚</p>
<h2 id="äº”-æœ¬åœ°æ¶ˆæ¯è¡¨"><a class="markdownIt-Anchor" href="#äº”-æœ¬åœ°æ¶ˆæ¯è¡¨"></a> äº”ã€æœ¬åœ°æ¶ˆæ¯è¡¨</h2>
<h3 id="æ–¹æ¡ˆç®€ä»‹-4"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆç®€ä»‹-4"></a> æ–¹æ¡ˆç®€ä»‹</h3>
<p>æœ¬åœ°æ¶ˆæ¯è¡¨çš„æ–¹æ¡ˆæœ€åˆæ˜¯ç”± ebay æå‡ºï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆæœ¬åœ°äº‹åŠ¡è¿›è¡Œå¤„ç†ã€‚</p>
<p>æ–¹æ¡ˆé€šè¿‡åœ¨äº‹åŠ¡ä¸»åŠ¨å‘èµ·æ–¹é¢å¤–æ–°å»ºäº‹åŠ¡æ¶ˆæ¯è¡¨ï¼Œäº‹åŠ¡å‘èµ·æ–¹å¤„ç†ä¸šåŠ¡å’Œè®°å½•äº‹åŠ¡æ¶ˆæ¯åœ¨æœ¬åœ°äº‹åŠ¡ä¸­å®Œæˆï¼Œè½®è¯¢äº‹åŠ¡æ¶ˆæ¯è¡¨çš„æ•°æ®å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œäº‹åŠ¡è¢«åŠ¨æ–¹åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶æ¶ˆè´¹äº‹åŠ¡æ¶ˆæ¯è¡¨ä¸­çš„äº‹åŠ¡ã€‚</p>
<p>è¿™æ ·è®¾è®¡å¯ä»¥é¿å…â€<strong>ä¸šåŠ¡å¤„ç†æˆåŠŸ + äº‹åŠ¡æ¶ˆæ¯å‘é€å¤±è´¥</strong>&quot;ï¼Œæˆ–&quot;<strong>ä¸šåŠ¡å¤„ç†å¤±è´¥ + äº‹åŠ¡æ¶ˆæ¯å‘é€æˆåŠŸ</strong>&quot;çš„æ£˜æ‰‹æƒ…å†µå‡ºç°ï¼Œä¿è¯ 2 ä¸ªç³»ç»Ÿäº‹åŠ¡çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p>
<h3 id="å¤„ç†æµç¨‹-4"><a class="markdownIt-Anchor" href="#å¤„ç†æµç¨‹-4"></a> å¤„ç†æµç¨‹</h3>
<p>ä¸‹é¢æŠŠåˆ†å¸ƒå¼äº‹åŠ¡æœ€å…ˆå¼€å§‹å¤„ç†çš„äº‹åŠ¡æ–¹æˆä¸ºäº‹åŠ¡ä¸»åŠ¨æ–¹ï¼Œåœ¨äº‹åŠ¡ä¸»åŠ¨æ–¹ä¹‹åå¤„ç†çš„ä¸šåŠ¡å†…çš„å…¶ä»–äº‹åŠ¡æˆä¸ºäº‹åŠ¡è¢«åŠ¨æ–¹ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä¸‹é¢ç»§ç»­ä»¥ç”µå•†ä¸‹å•ä¸ºä¾‹è¿›è¡Œæ–¹æ¡ˆè§£æï¼Œè¿™é‡ŒæŠŠæ•´ä¸ªè¿‡ç¨‹ç®€å•åˆ†ä¸ºæ‰£å‡åº“å­˜ï¼Œè®¢å•åˆ›å»º 2 ä¸ªæ­¥éª¤ï¼Œåº“å­˜æœåŠ¡å’Œè®¢å•æœåŠ¡åˆ†åˆ«åœ¨ä¸åŒçš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šï¼Œå…¶ä¸­åº“å­˜æœåŠ¡æ˜¯äº‹åŠ¡ä¸»åŠ¨æ–¹ï¼Œè®¢å•æœåŠ¡æ˜¯äº‹åŠ¡è¢«åŠ¨æ–¹ã€‚</p>
<p>äº‹åŠ¡çš„ä¸»åŠ¨æ–¹éœ€è¦é¢å¤–æ–°å»ºäº‹åŠ¡æ¶ˆæ¯è¡¨ï¼Œç”¨äºè®°å½•åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¶ˆæ¯çš„å‘ç”Ÿã€å¤„ç†çŠ¶æ€ã€‚</p>
<p>æ•´ä¸ªä¸šåŠ¡å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205220246.png" alt="img" /></p>
<blockquote>
<ol>
<li><strong>æ­¥éª¤ 1 äº‹åŠ¡ä¸»åŠ¨æ–¹å¤„ç†æœ¬åœ°äº‹åŠ¡ã€‚</strong> äº‹åŠ¡ä¸»åŠ¨å‘åœ¨æœ¬åœ°äº‹åŠ¡ä¸­å¤„ç†ä¸šåŠ¡æ›´æ–°æ“ä½œå’Œå†™æ¶ˆæ¯è¡¨æ“ä½œã€‚ ä¸Šé¢ä¾‹å­ä¸­åº“å­˜æœåŠ¡é˜¶æ®µå†æœ¬åœ°äº‹åŠ¡ä¸­å®Œæˆæ‰£å‡åº“å­˜å’Œå†™æ¶ˆæ¯è¡¨(å›¾ä¸­ 1ã€2)ã€‚</li>
<li><strong>æ­¥éª¤ 2 äº‹åŠ¡ä¸»åŠ¨æ–¹é€šè¿‡ MQ é€šçŸ¥äº‹åŠ¡è¢«åŠ¨æ–¹å¤„ç†äº‹åŠ¡</strong>ã€‚ æ¶ˆæ¯ä¸­é—´ä»¶å¯ä»¥åŸºäº Kafkaã€RocketMQ æ¶ˆæ¯é˜Ÿåˆ—ï¼Œäº‹åŠ¡ä¸»åŠ¨æ–¹æ³•ä¸»åŠ¨å†™æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œäº‹åŠ¡æ¶ˆè´¹æ–¹æ¶ˆè´¹å¹¶å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚ ä¸Šé¢ä¾‹å­ä¸­ï¼Œåº“å­˜æœåŠ¡æŠŠäº‹åŠ¡å¾…å¤„ç†æ¶ˆæ¯å†™åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œè®¢å•æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯ä¸­é—´ä»¶çš„æ¶ˆæ¯ï¼Œå®Œæˆæ–°å¢è®¢å•ï¼ˆå›¾ä¸­ 3 - 5ï¼‰ã€‚</li>
<li><strong>æ­¥éª¤ 3 äº‹åŠ¡è¢«åŠ¨æ–¹é€šè¿‡ MQ åä¼šå¤„ç†ç»“æœã€‚</strong> ä¸Šé¢ä¾‹å­ä¸­ï¼Œè®¢å•æœåŠ¡æŠŠäº‹åŠ¡å·²å¤„ç†æ¶ˆæ¯å†™åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œåº“å­˜æœåŠ¡æ¶ˆè´¹ä¸­é—´ä»¶çš„æ¶ˆæ¯ï¼Œå¹¶å°†äº‹åŠ¡æ¶ˆæ¯çš„çŠ¶æ€æ›´æ–°ä¸ºå·²å®Œæˆ(å›¾ä¸­ 6 - 8)</li>
</ol>
</blockquote>
<p>ä¸ºäº†æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå½“å¤„ç†é”™è¯¯éœ€è¦é‡è¯•ï¼Œäº‹åŠ¡å‘é€æ–¹å’Œäº‹åŠ¡æ¥æ”¶æ–¹ç›¸å…³ä¸šåŠ¡å¤„ç†éœ€è¦æ”¯æŒå¹‚ç­‰ã€‚å…·ä½“ä¿å­˜ä¸€è‡´æ€§çš„å®¹é”™å¤„ç†å¦‚ä¸‹ï¼š</p>
<blockquote>
<ul>
<li>å½“æ­¥éª¤ 1 å¤„ç†å‡ºé”™ï¼Œäº‹åŠ¡å›æ»šï¼Œç›¸å½“äºä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿã€‚</li>
<li>å½“æ­¥éª¤ 2ã€æ­¥éª¤ 3 å¤„ç†å‡ºé”™ï¼Œç”±äºæœªå¤„ç†çš„äº‹åŠ¡æ¶ˆæ¯è¿˜æ˜¯ä¿å­˜åœ¨äº‹åŠ¡å‘é€æ–¹ï¼Œäº‹åŠ¡å‘é€æ–¹å¯ä»¥å®šæ—¶è½®è¯¢ä¸ºè¶…æ—¶æ¶ˆæ¯æ•°æ®ï¼Œå†æ¬¡å‘é€çš„æ¶ˆæ¯ä¸­é—´ä»¶è¿›è¡Œå¤„ç†ã€‚äº‹åŠ¡è¢«åŠ¨æ–¹æ¶ˆè´¹äº‹åŠ¡æ¶ˆæ¯é‡è¯•å¤„ç†ã€‚</li>
<li>å¦‚æœæ˜¯ä¸šåŠ¡ä¸Šçš„å¤±è´¥ï¼Œäº‹åŠ¡è¢«åŠ¨æ–¹å¯ä»¥å‘æ¶ˆæ¯ç»™äº‹åŠ¡ä¸»åŠ¨æ–¹è¿›è¡Œå›æ»šã€‚</li>
<li>å¦‚æœå¤šä¸ªäº‹åŠ¡è¢«åŠ¨æ–¹å·²ç»æ¶ˆè´¹æ¶ˆæ¯ï¼Œäº‹åŠ¡ä¸»åŠ¨æ–¹éœ€è¦å›æ»šäº‹åŠ¡æ—¶éœ€è¦é€šçŸ¥äº‹åŠ¡è¢«åŠ¨æ–¹å›æ»šã€‚</li>
</ul>
</blockquote>
<h3 id="æ–¹æ¡ˆæ€»ç»“-4"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆæ€»ç»“-4"></a> æ–¹æ¡ˆæ€»ç»“</h3>
<p>æ–¹æ¡ˆçš„ä¼˜ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä»åº”ç”¨è®¾è®¡å¼€å‘çš„è§’åº¦å®ç°äº†æ¶ˆæ¯æ•°æ®çš„å¯é æ€§ï¼Œæ¶ˆæ¯æ•°æ®çš„å¯é æ€§ä¸ä¾èµ–äºæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¼±åŒ–äº†å¯¹ MQ ä¸­é—´ä»¶ç‰¹æ€§çš„ä¾èµ–ã€‚</li>
<li>æ–¹æ¡ˆè½»é‡ï¼Œå®¹æ˜“å®ç°ã€‚</li>
</ul>
<p>ç¼ºç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸å…·ä½“çš„ä¸šåŠ¡åœºæ™¯ç»‘å®šï¼Œè€¦åˆæ€§å¼ºï¼Œä¸å¯å¤ç”¨ã€‚</li>
<li>æ¶ˆæ¯æ•°æ®ä¸ä¸šåŠ¡æ•°æ®åŒåº“ï¼Œå ç”¨ä¸šåŠ¡ç³»ç»Ÿèµ„æºã€‚</li>
<li>ä¸šåŠ¡ç³»ç»Ÿåœ¨ä½¿ç”¨å…³ç³»å‹æ•°æ®åº“çš„æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯æœåŠ¡æ€§èƒ½ä¼šå—åˆ°å…³ç³»å‹æ•°æ®åº“å¹¶å‘æ€§èƒ½çš„å±€é™ã€‚</li>
</ul>
<h2 id="å…­-mq-äº‹åŠ¡"><a class="markdownIt-Anchor" href="#å…­-mq-äº‹åŠ¡"></a> å…­ã€MQ äº‹åŠ¡</h2>
<h3 id="æ–¹æ¡ˆç®€ä»‹-5"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆç®€ä»‹-5"></a> æ–¹æ¡ˆç®€ä»‹</h3>
<p>åŸºäº MQ çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆå…¶å®æ˜¯å¯¹æœ¬åœ°æ¶ˆæ¯è¡¨çš„å°è£…ï¼Œå°†æœ¬åœ°æ¶ˆæ¯è¡¨åŸºäº MQ å†…éƒ¨ï¼Œå…¶ä»–æ–¹é¢çš„åè®®åŸºæœ¬ä¸æœ¬åœ°æ¶ˆæ¯è¡¨ä¸€è‡´ã€‚</p>
<h3 id="å¤„ç†æµç¨‹-5"><a class="markdownIt-Anchor" href="#å¤„ç†æµç¨‹-5"></a> å¤„ç†æµç¨‹</h3>
<p>ä¸‹é¢ä¸»è¦åŸºäº RocketMQ4.3 ä¹‹åçš„ç‰ˆæœ¬ä»‹ç» MQ çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆã€‚</p>
<p>åœ¨æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆä¸­ï¼Œä¿è¯äº‹åŠ¡ä¸»åŠ¨æ–¹å‘å†™ä¸šåŠ¡è¡¨æ•°æ®å’Œå†™æ¶ˆæ¯è¡¨æ•°æ®çš„ä¸€è‡´æ€§æ˜¯åŸºäºæ•°æ®åº“äº‹åŠ¡ï¼ŒRocketMQ çš„äº‹åŠ¡æ¶ˆæ¯ç›¸å¯¹äºæ™®é€š MQï¼Œç›¸å¯¹äºæä¾›äº† 2PC çš„æäº¤æ¥å£ï¼Œæ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<p><strong>æ­£å¸¸æƒ…å†µâ€”â€”äº‹åŠ¡ä¸»åŠ¨æ–¹å‘æ¶ˆæ¯</strong> è¿™ç§æƒ…å†µä¸‹ï¼Œäº‹åŠ¡ä¸»åŠ¨æ–¹æœåŠ¡æ­£å¸¸ï¼Œæ²¡æœ‰å‘ç”Ÿæ•…éšœï¼Œå‘æ¶ˆæ¯æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205230320.png" alt="img" /></p>
<blockquote>
<ol>
<li>å‘é€æ–¹å‘ MQ æœåŠ¡ç«¯(MQ Server)å‘é€ half æ¶ˆæ¯ã€‚</li>
<li>MQ Server å°†æ¶ˆæ¯æŒä¹…åŒ–æˆåŠŸä¹‹åï¼Œå‘å‘é€æ–¹ ACK ç¡®è®¤æ¶ˆæ¯å·²ç»å‘é€æˆåŠŸã€‚</li>
<li>å‘é€æ–¹å¼€å§‹æ‰§è¡Œæœ¬åœ°äº‹åŠ¡é€»è¾‘ã€‚</li>
<li>å‘é€æ–¹æ ¹æ®æœ¬åœ°äº‹åŠ¡æ‰§è¡Œç»“æœå‘ MQ Server æäº¤äºŒæ¬¡ç¡®è®¤ï¼ˆcommit æˆ–æ˜¯ rollbackï¼‰ã€‚</li>
<li>MQ Server æ”¶åˆ° commit çŠ¶æ€åˆ™å°†åŠæ¶ˆæ¯æ ‡è®°ä¸ºå¯æŠ•é€’ï¼Œè®¢é˜…æ–¹æœ€ç»ˆå°†æ”¶åˆ°è¯¥æ¶ˆæ¯ï¼›MQ Server æ”¶åˆ° rollback çŠ¶æ€åˆ™åˆ é™¤åŠæ¶ˆæ¯ï¼Œè®¢é˜…æ–¹å°†ä¸ä¼šæ¥å—è¯¥æ¶ˆæ¯ã€‚</li>
</ol>
</blockquote>
<p><strong>å¼‚å¸¸æƒ…å†µâ€”â€”äº‹åŠ¡ä¸»åŠ¨æ–¹æ¶ˆæ¯æ¢å¤</strong> åœ¨æ–­ç½‘æˆ–è€…åº”ç”¨é‡å¯ç­‰å¼‚å¸¸æƒ…å†µä¸‹ï¼Œå›¾ä¸­ 4 æäº¤çš„äºŒæ¬¡ç¡®è®¤è¶…æ—¶æœªåˆ°è¾¾ MQ Serverï¼Œæ­¤æ—¶å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p>
<p><img src="http://dunwu.test.upcdn.net/snap/20200205230412.png" alt="img" /></p>
<blockquote>
<ol start="5">
<li>MQ Server å¯¹è¯¥æ¶ˆæ¯å‘èµ·æ¶ˆæ¯å›æŸ¥ã€‚</li>
<li>å‘é€æ–¹æ”¶åˆ°æ¶ˆæ¯å›æŸ¥åï¼Œéœ€è¦æ£€æŸ¥å¯¹åº”æ¶ˆæ¯çš„æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„æœ€ç»ˆç»“æœã€‚</li>
<li>å‘é€æ–¹æ ¹æ®æ£€æŸ¥å¾—åˆ°çš„æœ¬åœ°äº‹åŠ¡çš„æœ€ç»ˆçŠ¶æ€å†æ¬¡æäº¤äºŒæ¬¡ç¡®è®¤</li>
<li>MQ Server åŸºäº commit / rollback å¯¹æ¶ˆæ¯è¿›è¡ŒæŠ•é€’æˆ–è€…åˆ é™¤</li>
</ol>
</blockquote>
<h3 id="æ–¹æ¡ˆæ€»ç»“-5"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆæ€»ç»“-5"></a> æ–¹æ¡ˆæ€»ç»“</h3>
<p>ç›¸æ¯”æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼ŒMQ äº‹åŠ¡æ–¹æ¡ˆä¼˜ç‚¹æ˜¯ï¼š</p>
<ul>
<li>æ¶ˆæ¯æ•°æ®ç‹¬ç«‹å­˜å‚¨ ï¼Œé™ä½ä¸šåŠ¡ç³»ç»Ÿä¸æ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„è€¦åˆã€‚</li>
<li>ååé‡ä¼˜äºä½¿ç”¨æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆã€‚</li>
</ul>
<p>ç¼ºç‚¹æ˜¯ï¼š</p>
<ul>
<li>ä¸€æ¬¡æ¶ˆæ¯å‘é€éœ€è¦ä¸¤æ¬¡ç½‘ç»œè¯·æ±‚(half æ¶ˆæ¯ + commit/rollback æ¶ˆæ¯)</li>
<li>ä¸šåŠ¡å¤„ç†æœåŠ¡éœ€è¦å®ç°æ¶ˆæ¯çŠ¶æ€å›æŸ¥æ¥å£</li>
</ul>
<h2 id="ä¸ƒ-saga"><a class="markdownIt-Anchor" href="#ä¸ƒ-saga"></a> ä¸ƒã€SAGA</h2>
<h3 id="æ–¹æ¡ˆç®€ä»‹-6"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆç®€ä»‹-6"></a> æ–¹æ¡ˆç®€ä»‹</h3>
<p>Saga äº‹åŠ¡æºäº 1987 å¹´æ™®æ—æ–¯é¡¿å¤§å­¦çš„ Hecto å’Œ Kenneth å‘è¡¨çš„å¦‚ä½•å¤„ç† long lived transactionï¼ˆé•¿æ´»äº‹åŠ¡ï¼‰è®ºæ–‡ï¼ŒSaga äº‹åŠ¡æ ¸å¿ƒæ€æƒ³æ˜¯å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡ï¼Œç”± Saga äº‹åŠ¡åè°ƒå™¨åè°ƒï¼Œå¦‚æœæ­£å¸¸ç»“æŸé‚£å°±æ­£å¸¸å®Œæˆï¼Œå¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œåˆ™æ ¹æ®ç›¸åé¡ºåºä¸€æ¬¡è°ƒç”¨è¡¥å¿æ“ä½œã€‚</p>
<h3 id="å¤„ç†æµç¨‹-6"><a class="markdownIt-Anchor" href="#å¤„ç†æµç¨‹-6"></a> å¤„ç†æµç¨‹</h3>
<p><strong>Saga äº‹åŠ¡åŸºæœ¬åè®®å¦‚ä¸‹</strong>ï¼š</p>
<ul>
<li>æ¯ä¸ª Saga äº‹åŠ¡ç”±ä¸€ç³»åˆ—å¹‚ç­‰çš„æœ‰åºå­äº‹åŠ¡(sub-transaction) Ti ç»„æˆã€‚</li>
<li>æ¯ä¸ª Ti éƒ½æœ‰å¯¹åº”çš„å¹‚ç­‰è¡¥å¿åŠ¨ä½œ Ciï¼Œè¡¥å¿åŠ¨ä½œç”¨äºæ’¤é”€ Ti é€ æˆçš„ç»“æœã€‚</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå’Œ TCC ç›¸æ¯”ï¼ŒSaga æ²¡æœ‰â€œé¢„ç•™â€åŠ¨ä½œï¼Œå®ƒçš„ Ti å°±æ˜¯ç›´æ¥æäº¤åˆ°åº“ã€‚</p>
<p>ä¸‹é¢ä»¥ä¸‹å•æµç¨‹ä¸ºä¾‹ï¼Œæ•´ä¸ªæ“ä½œåŒ…æ‹¬ï¼šåˆ›å»ºè®¢å•ã€æ‰£å‡åº“å­˜ã€æ”¯ä»˜ã€å¢åŠ ç§¯åˆ† Saga çš„æ‰§è¡Œé¡ºåºæœ‰ä¸¤ç§ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/10/1679817d8ce9b4b7?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Sagaäº‹åŠ¡æ‰§è¡Œé¡ºåº" /></p>
<ul>
<li>äº‹åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæˆ T1, T2, T3, â€¦, Tnï¼Œä¾‹å¦‚ï¼šæ‰£å‡åº“å­˜(T1)ï¼Œåˆ›å»ºè®¢å•(T2)ï¼Œæ”¯ä»˜(T3)ï¼Œä¾æ¬¡æœ‰åºå®Œæˆæ•´ä¸ªäº‹åŠ¡ã€‚</li>
<li>äº‹åŠ¡å›æ»š T1, T2, â€¦, Tj, Cj,â€¦, C2, C1ï¼Œå…¶ä¸­ 0 &lt; j &lt; nï¼Œä¾‹å¦‚ï¼šæ‰£å‡åº“å­˜(T1)ï¼Œåˆ›å»ºè®¢å•(T2)ï¼Œæ”¯ä»˜(T3ï¼Œæ”¯ä»˜å¤±è´¥)ï¼Œæ”¯ä»˜å›æ»š(C3)ï¼Œè®¢å•å›æ»š(C2)ï¼Œæ¢å¤åº“å­˜(C1)ã€‚</li>
</ul>
<h4 id="æ¢å¤ç­–ç•¥"><a class="markdownIt-Anchor" href="#æ¢å¤ç­–ç•¥"></a> æ¢å¤ç­–ç•¥</h4>
<p>Saga å®šä¹‰äº†ä¸¤ç§æ¢å¤ç­–ç•¥ï¼š</p>
<ul>
<li>å‘å‰æ¢å¤(forward recovery)</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/10/1679817da631d59c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Sagaäº‹åŠ¡å‘å‰æ¢å¤" /></p>
<p>å¯¹åº”äºä¸Šé¢ç¬¬ä¸€ç§æ‰§è¡Œé¡ºåºï¼Œé€‚ç”¨äºå¿…é¡»è¦æˆåŠŸçš„åœºæ™¯ï¼Œå‘ç”Ÿå¤±è´¥è¿›è¡Œé‡è¯•ï¼Œæ‰§è¡Œé¡ºåºæ˜¯ç±»ä¼¼äºè¿™æ ·çš„ï¼šT1, T2, â€¦, Tj(å¤±è´¥), Tj(é‡è¯•),â€¦, Tnï¼Œå…¶ä¸­ j æ˜¯å‘ç”Ÿé”™è¯¯çš„å­äº‹åŠ¡(sub-transaction)ã€‚è¯¥æƒ…å†µä¸‹ä¸éœ€è¦ Ciã€‚</p>
<ul>
<li>å‘åæ¢å¤(backward recovery)</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/10/1679817da706b3c2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Sagaäº‹åŠ¡å‘åæ¢å¤" /></p>
<p>å¯¹åº”äºä¸Šé¢æåˆ°çš„ç¬¬äºŒç§æ‰§è¡Œé¡ºåºï¼Œå…¶ä¸­ j æ˜¯å‘ç”Ÿé”™è¯¯çš„å­äº‹åŠ¡(sub-transaction)ï¼Œè¿™ç§åšæ³•çš„æ•ˆæœæ˜¯æ’¤é”€æ‰ä¹‹å‰æ‰€æœ‰æˆåŠŸçš„å­äº‹åŠ¡ï¼Œä½¿å¾—æ•´ä¸ª Saga çš„æ‰§è¡Œç»“æœæ’¤é”€ã€‚</p>
<p>Saga äº‹åŠ¡å¸¸è§çš„æœ‰ä¸¤ç§ä¸åŒçš„å®ç°æ–¹å¼ï¼šå‘½ä»¤åè°ƒå’Œäº‹ä»¶ç¼–æ’ã€‚</p>
<h4 id="å‘½ä»¤åè°ƒ"><a class="markdownIt-Anchor" href="#å‘½ä»¤åè°ƒ"></a> å‘½ä»¤åè°ƒ</h4>
<ul>
<li><strong>å‘½ä»¤åè°ƒ(Order Orchestrator)ï¼šä¸­å¤®åè°ƒå™¨è´Ÿè´£é›†ä¸­å¤„ç†äº‹ä»¶çš„å†³ç­–å’Œä¸šåŠ¡é€»è¾‘æ’åºã€‚</strong></li>
</ul>
<p>ä¸­å¤®åè°ƒå™¨ï¼ˆOrchestratorï¼Œç®€ç§° OSOï¼‰ä»¥å‘½ä»¤/å›å¤çš„æ–¹å¼ä¸æ¯é¡¹æœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œå…¨æƒè´Ÿè´£å‘Šè¯‰æ¯ä¸ªå‚ä¸è€…è¯¥åšä»€ä¹ˆä»¥åŠä»€ä¹ˆæ—¶å€™è¯¥åšä»€ä¹ˆã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/10/1679817daa1798dd?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="å‘½ä»¤åè°ƒæ¨¡å¼" /></p>
<p>ä»¥ç”µå•†è®¢å•çš„ä¾‹å­ä¸ºä¾‹ï¼š</p>
<blockquote>
<ol>
<li>äº‹åŠ¡å‘èµ·æ–¹çš„ä¸»ä¸šåŠ¡é€»è¾‘è¯·æ±‚ OSO æœåŠ¡å¼€å¯è®¢å•äº‹åŠ¡ã€‚</li>
<li>OSO å‘åº“å­˜æœåŠ¡è¯·æ±‚æ‰£å‡åº“å­˜ï¼Œåº“å­˜æœåŠ¡å›å¤å¤„ç†ç»“æœã€‚</li>
<li>OSO å‘è®¢å•æœåŠ¡è¯·æ±‚åˆ›å»ºè®¢å•ï¼Œè®¢å•æœåŠ¡å›å¤åˆ›å»ºç»“æœã€‚</li>
<li>OSO å‘æ”¯ä»˜æœåŠ¡è¯·æ±‚æ”¯ä»˜ï¼Œæ”¯ä»˜æœåŠ¡å›å¤å¤„ç†ç»“æœã€‚</li>
<li>ä¸»ä¸šåŠ¡é€»è¾‘æ¥æ”¶å¹¶å¤„ç† OSO äº‹åŠ¡å¤„ç†ç»“æœå›å¤ã€‚</li>
</ol>
</blockquote>
<p>ä¸­å¤®åè°ƒå™¨å¿…é¡»äº‹å…ˆçŸ¥é“æ‰§è¡Œæ•´ä¸ªè®¢å•äº‹åŠ¡æ‰€éœ€çš„æµç¨‹(ä¾‹å¦‚é€šè¿‡è¯»å–é…ç½®)ã€‚å¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œå®ƒè¿˜è´Ÿè´£é€šè¿‡å‘æ¯ä¸ªå‚ä¸è€…å‘é€å‘½ä»¤æ¥æ’¤é”€ä¹‹å‰çš„æ“ä½œæ¥åè°ƒåˆ†å¸ƒå¼çš„å›æ»šã€‚åŸºäºä¸­å¤®åè°ƒå™¨åè°ƒä¸€åˆ‡æ—¶ï¼Œå›æ»šè¦å®¹æ˜“å¾—å¤šï¼Œå› ä¸ºåè°ƒå™¨é»˜è®¤æ˜¯æ‰§è¡Œæ­£å‘æµç¨‹ï¼Œå›æ»šæ—¶åªè¦æ‰§è¡Œåå‘æµç¨‹å³å¯ã€‚</p>
<h4 id="äº‹ä»¶ç¼–æ’"><a class="markdownIt-Anchor" href="#äº‹ä»¶ç¼–æ’"></a> äº‹ä»¶ç¼–æ’</h4>
<ul>
<li><strong>äº‹ä»¶ç¼–æ’ (Event Choreography0ï¼šæ²¡æœ‰ä¸­å¤®åè°ƒå™¨ï¼ˆæ²¡æœ‰å•ç‚¹é£é™©ï¼‰æ—¶ï¼Œæ¯ä¸ªæœåŠ¡äº§ç”Ÿå¹¶è§‚å¯Ÿå…¶ä»–æœåŠ¡çš„äº‹ä»¶ï¼Œå¹¶å†³å®šæ˜¯å¦åº”é‡‡å–è¡ŒåŠ¨</strong>ã€‚</li>
</ul>
<p>åœ¨äº‹ä»¶ç¼–æ’æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€ä¸ªæœåŠ¡æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ï¼Œç„¶åå‘å¸ƒä¸€ä¸ªäº‹ä»¶ã€‚è¯¥äº‹ä»¶è¢«ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡è¿›è¡Œç›‘å¬ï¼Œè¿™äº›æœåŠ¡å†æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶å‘å¸ƒï¼ˆæˆ–ä¸å‘å¸ƒï¼‰æ–°çš„äº‹ä»¶ã€‚</p>
<p>å½“æœ€åä¸€ä¸ªæœåŠ¡æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶ä¸”ä¸å‘å¸ƒä»»ä½•äº‹ä»¶æ—¶ï¼Œæ„å‘³ç€åˆ†å¸ƒå¼äº‹åŠ¡ç»“æŸï¼Œæˆ–è€…å®ƒå‘å¸ƒçš„äº‹ä»¶æ²¡æœ‰è¢«ä»»ä½• Saga å‚ä¸è€…å¬åˆ°éƒ½æ„å‘³ç€äº‹åŠ¡ç»“æŸã€‚</p>
<p>ä»¥ç”µå•†è®¢å•çš„ä¾‹å­ä¸ºä¾‹ï¼š</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/10/1679817dba9b2b61?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="äº‹ä»¶ç¼–æ’æ¨¡å¼" /></p>
<blockquote>
<ol>
<li>äº‹åŠ¡å‘èµ·æ–¹çš„ä¸»ä¸šåŠ¡é€»è¾‘å‘å¸ƒå¼€å§‹è®¢å•äº‹ä»¶</li>
<li>åº“å­˜æœåŠ¡ç›‘å¬å¼€å§‹è®¢å•äº‹ä»¶ï¼Œæ‰£å‡åº“å­˜ï¼Œå¹¶å‘å¸ƒåº“å­˜å·²æ‰£å‡äº‹ä»¶</li>
<li>è®¢å•æœåŠ¡ç›‘å¬åº“å­˜å·²æ‰£å‡äº‹ä»¶ï¼Œåˆ›å»ºè®¢å•ï¼Œå¹¶å‘å¸ƒè®¢å•å·²åˆ›å»ºäº‹ä»¶</li>
<li>æ”¯ä»˜æœåŠ¡ç›‘å¬è®¢å•å·²åˆ›å»ºäº‹ä»¶ï¼Œè¿›è¡Œæ”¯ä»˜ï¼Œå¹¶å‘å¸ƒè®¢å•å·²æ”¯ä»˜äº‹ä»¶</li>
<li>ä¸»ä¸šåŠ¡é€»è¾‘ç›‘å¬è®¢å•å·²æ”¯ä»˜äº‹ä»¶å¹¶å¤„ç†ã€‚</li>
</ol>
</blockquote>
<p>äº‹ä»¶/ç¼–æ’æ˜¯å®ç° Saga æ¨¡å¼çš„è‡ªç„¶æ–¹å¼ï¼Œå®ƒå¾ˆç®€å•ï¼Œå®¹æ˜“ç†è§£ï¼Œä¸éœ€è¦å¤ªå¤šçš„ä»£ç æ¥æ„å»ºã€‚å¦‚æœäº‹åŠ¡æ¶‰åŠ 2 è‡³ 4 ä¸ªæ­¥éª¤ï¼Œåˆ™å¯èƒ½æ˜¯éå¸¸åˆé€‚çš„ã€‚</p>
<h3 id="æ–¹æ¡ˆæ€»ç»“-6"><a class="markdownIt-Anchor" href="#æ–¹æ¡ˆæ€»ç»“-6"></a> æ–¹æ¡ˆæ€»ç»“</h3>
<p><strong>å‘½ä»¤åè°ƒè®¾è®¡çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼š</strong></p>
<p>ä¼˜ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æœåŠ¡ä¹‹é—´å…³ç³»ç®€å•ï¼Œé¿å…æœåŠ¡ä¹‹é—´çš„å¾ªç¯ä¾èµ–å…³ç³»ï¼Œå› ä¸º Saga åè°ƒå™¨ä¼šè°ƒç”¨ Saga å‚ä¸è€…ï¼Œä½†å‚ä¸è€…ä¸ä¼šè°ƒç”¨åè°ƒå™¨</li>
<li>ç¨‹åºå¼€å‘ç®€å•ï¼Œåªéœ€è¦æ‰§è¡Œå‘½ä»¤/å›å¤(å…¶å®å›å¤æ¶ˆæ¯ä¹Ÿæ˜¯ä¸€ç§äº‹ä»¶æ¶ˆæ¯)ï¼Œé™ä½å‚ä¸è€…çš„å¤æ‚æ€§ã€‚</li>
<li>æ˜“ç»´æŠ¤æ‰©å±•ï¼Œåœ¨æ·»åŠ æ–°æ­¥éª¤æ—¶ï¼Œäº‹åŠ¡å¤æ‚æ€§ä¿æŒçº¿æ€§ï¼Œå›æ»šæ›´å®¹æ˜“ç®¡ç†ï¼Œæ›´å®¹æ˜“å®æ–½å’Œæµ‹è¯•</li>
</ul>
<p>ç¼ºç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸­å¤®åè°ƒå™¨å®¹æ˜“å¤„ç†é€»è¾‘å®¹æ˜“è¿‡äºå¤æ‚ï¼Œå¯¼è‡´éš¾ä»¥ç»´æŠ¤ã€‚</li>
<li>å­˜åœ¨åè°ƒå™¨å•ç‚¹æ•…éšœé£é™©ã€‚</li>
</ul>
<p><strong>äº‹ä»¶/ç¼–æ’è®¾è®¡çš„ä¼˜ç‚¹å’Œç¼ºç‚¹</strong></p>
<p>ä¼˜ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¿å…ä¸­å¤®åè°ƒå™¨å•ç‚¹æ•…éšœé£é™©ã€‚</li>
<li>å½“æ¶‰åŠçš„æ­¥éª¤è¾ƒå°‘æœåŠ¡å¼€å‘ç®€å•ï¼Œå®¹æ˜“å®ç°ã€‚</li>
</ul>
<p>ç¼ºç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æœåŠ¡ä¹‹é—´å­˜åœ¨å¾ªç¯ä¾èµ–çš„é£é™©ã€‚</li>
<li>å½“æ¶‰åŠçš„æ­¥éª¤è¾ƒå¤šï¼ŒæœåŠ¡é—´å…³ç³»æ··ä¹±ï¼Œéš¾ä»¥è¿½è¸ªè°ƒæµ‹ã€‚</li>
</ul>
<p>å€¼å¾—è¡¥å……çš„æ˜¯ï¼Œç”±äº Saga æ¨¡å‹ä¸­æ²¡æœ‰ Prepare é˜¶æ®µï¼Œå› æ­¤äº‹åŠ¡é—´ä¸èƒ½ä¿è¯éš”ç¦»æ€§ï¼Œå½“å¤šä¸ª Saga äº‹åŠ¡æ“ä½œåŒä¸€èµ„æºæ—¶ï¼Œå°±ä¼šäº§ç”Ÿæ›´æ–°ä¸¢å¤±ã€è„æ•°æ®è¯»å–ç­‰é—®é¢˜ï¼Œè¿™æ—¶éœ€è¦åœ¨ä¸šåŠ¡å±‚æ§åˆ¶å¹¶å‘ï¼Œä¾‹å¦‚ï¼šåœ¨åº”ç”¨å±‚é¢åŠ é”ï¼Œæˆ–è€…åº”ç”¨å±‚é¢é¢„å…ˆå†»ç»“èµ„æºã€‚</p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<h3 id="å„æ–¹æ¡ˆä½¿ç”¨åœºæ™¯"><a class="markdownIt-Anchor" href="#å„æ–¹æ¡ˆä½¿ç”¨åœºæ™¯"></a> å„æ–¹æ¡ˆä½¿ç”¨åœºæ™¯</h3>
<p>ä»‹ç»å®Œåˆ†å¸ƒå¼äº‹åŠ¡ç›¸å…³ç†è®ºå’Œå¸¸è§è§£å†³æ–¹æ¡ˆåï¼Œæœ€ç»ˆçš„ç›®çš„åœ¨å®é™…é¡¹ç›®ä¸­è¿ç”¨ï¼Œå› æ­¤ï¼Œæ€»ç»“ä¸€ä¸‹å„ä¸ªæ–¹æ¡ˆçš„å¸¸è§çš„ä½¿ç”¨åœºæ™¯ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/12/10/1679817dc68ae74d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="æ–¹æ¡ˆæ¯”è¾ƒ" /></p>
<ul>
<li>2PC/3PC ä¾èµ–äºæ•°æ®åº“ï¼Œèƒ½å¤Ÿå¾ˆå¥½çš„æä¾›å¼ºä¸€è‡´æ€§å’Œå¼ºäº‹åŠ¡æ€§ï¼Œä½†ç›¸å¯¹æ¥è¯´å»¶è¿Ÿæ¯”è¾ƒé«˜ï¼Œæ¯”è¾ƒé€‚åˆä¼ ç»Ÿçš„å•ä½“åº”ç”¨ï¼Œåœ¨åŒä¸€ä¸ªæ–¹æ³•ä¸­å­˜åœ¨è·¨åº“æ“ä½œçš„æƒ…å†µï¼Œä¸é€‚åˆé«˜å¹¶å‘å’Œé«˜æ€§èƒ½è¦æ±‚çš„åœºæ™¯ã€‚</li>
<li>TCC é€‚ç”¨äºæ‰§è¡Œæ—¶é—´ç¡®å®šä¸”è¾ƒçŸ­ï¼Œå®æ—¶æ€§è¦æ±‚é«˜ï¼Œå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜ï¼Œæ¯”å¦‚äº’è”ç½‘é‡‘èä¼ä¸šæœ€æ ¸å¿ƒçš„ä¸‰ä¸ªæœåŠ¡ï¼šäº¤æ˜“ã€æ”¯ä»˜ã€è´¦åŠ¡ã€‚</li>
<li>æœ¬åœ°æ¶ˆæ¯è¡¨/MQ äº‹åŠ¡ éƒ½é€‚ç”¨äºäº‹åŠ¡ä¸­å‚ä¸æ–¹æ”¯æŒæ“ä½œå¹‚ç­‰ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜ï¼Œä¸šåŠ¡ä¸Šèƒ½å®¹å¿æ•°æ®ä¸ä¸€è‡´åˆ°ä¸€ä¸ªäººå·¥æ£€æŸ¥å‘¨æœŸï¼Œäº‹åŠ¡æ¶‰åŠçš„å‚ä¸æ–¹ã€å‚ä¸ç¯èŠ‚è¾ƒå°‘ï¼Œä¸šåŠ¡ä¸Šæœ‰å¯¹è´¦/æ ¡éªŒç³»ç»Ÿå…œåº•ã€‚</li>
<li>Saga äº‹åŠ¡ ç”±äº Saga äº‹åŠ¡ä¸èƒ½ä¿è¯éš”ç¦»æ€§ï¼Œéœ€è¦åœ¨ä¸šåŠ¡å±‚æ§åˆ¶å¹¶å‘ï¼Œé€‚åˆäºä¸šåŠ¡åœºæ™¯äº‹åŠ¡å¹¶å‘æ“ä½œåŒä¸€èµ„æºè¾ƒå°‘çš„æƒ…å†µã€‚ Saga ç›¸æ¯”ç¼ºå°‘é¢„æäº¤åŠ¨ä½œï¼Œå¯¼è‡´è¡¥å¿åŠ¨ä½œçš„å®ç°æ¯”è¾ƒéº»çƒ¦ï¼Œä¾‹å¦‚ä¸šåŠ¡æ˜¯å‘é€çŸ­ä¿¡ï¼Œè¡¥å¿åŠ¨ä½œåˆ™å¾—å†å‘é€ä¸€æ¬¡çŸ­ä¿¡è¯´æ˜æ’¤é”€ï¼Œç”¨æˆ·ä½“éªŒæ¯”è¾ƒå·®ã€‚Saga äº‹åŠ¡è¾ƒé€‚ç”¨äºè¡¥å¿åŠ¨ä½œå®¹æ˜“å¤„ç†çš„åœºæ™¯ã€‚</li>
</ul>
<h3 id="åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆè®¾è®¡"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆè®¾è®¡"></a> åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆè®¾è®¡</h3>
<p>æœ¬æ–‡ä»‹ç»çš„åå‘äºåŸç†ï¼Œä¸šç•Œå·²ç»æœ‰ä¸å°‘å¼€æºçš„æˆ–è€…æ”¶è´¹çš„è§£å†³æ–¹æ¡ˆï¼Œç¯‡å¹…æ‰€é™ï¼Œå°±ä¸å†å±•å¼€ä»‹ç»ã€‚</p>
<p>å®é™…è¿ç”¨ç†è®ºæ—¶è¿›è¡Œæ¶æ„è®¾è®¡æ—¶ï¼Œè®¸å¤šäººå®¹æ˜“çŠ¯â€œæ‰‹é‡Œæœ‰äº†é”¤å­ï¼Œçœ‹ä»€ä¹ˆéƒ½è§‰å¾—åƒé’‰å­â€çš„é”™è¯¯ï¼Œè®¾è®¡æ–¹æ¡ˆæ—¶è€ƒè™‘çš„é—®é¢˜åœºæ™¯è¿‡å¤šï¼Œå„ç§é‡è¯•ï¼Œå„ç§è¡¥å¿æœºåˆ¶å¼•å…¥ç³»ç»Ÿï¼Œå¯¼è‡´è®¾è®¡å‡ºæ¥çš„ç³»ç»Ÿè¿‡äºå¤æ‚ï¼Œè½åœ°é¥é¥æ— æœŸã€‚</p>
<blockquote>
<p>ä¸–ç•Œä¸Šè§£å†³ä¸€ä¸ªè®¡ç®—æœºé—®é¢˜æœ€ç®€å•çš„æ–¹æ³•ï¼šâ€œæ°å¥½â€ä¸éœ€è¦è§£å†³å®ƒï¼â€”â€” é˜¿é‡Œä¸­é—´ä»¶æŠ€æœ¯ä¸“å®¶æ²ˆè¯¢</p>
</blockquote>
<p>æœ‰äº›é—®é¢˜ï¼Œçœ‹èµ·æ¥å¾ˆé‡è¦ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>åˆç†çš„è®¾è®¡</strong>æˆ–è€…å°†<strong>é—®é¢˜åˆ†è§£</strong>æ¥è§„é¿ã€‚è®¾è®¡åˆ†å¸ƒå¼äº‹åŠ¡ç³»ç»Ÿä¹Ÿä¸æ˜¯éœ€è¦è€ƒè™‘æ‰€æœ‰å¼‚å¸¸æƒ…å†µï¼Œä¸å¿…è¿‡åº¦è®¾è®¡å„ç§å›æ»šï¼Œè¡¥å¿æœºåˆ¶ã€‚å¦‚æœç¡¬è¦æŠŠæ—¶é—´èŠ±åœ¨è§£å†³é—®é¢˜æœ¬èº«ï¼Œå®é™…ä¸Šä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”ä¹Ÿæ˜¯ä¸€ç§æµªè´¹ã€‚</p>
<p>å¦‚æœç³»ç»Ÿè¦å®ç°å›æ»šæµç¨‹çš„è¯ï¼Œæœ‰å¯èƒ½ç³»ç»Ÿå¤æ‚åº¦å°†å¤§å¤§æå‡ï¼Œä¸”å¾ˆå®¹æ˜“å‡ºç° Bugï¼Œä¼°è®¡å‡ºç° Bug çš„æ¦‚ç‡ä¼šæ¯”éœ€è¦äº‹åŠ¡å›æ»šçš„æ¦‚ç‡å¤§å¾ˆå¤šã€‚åœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¡¡é‡æ˜¯å¦å€¼å¾—èŠ±è¿™ä¹ˆå¤§çš„ä»£ä»·æ¥è§£å†³è¿™æ ·ä¸€ä¸ªå‡ºç°æ¦‚ç‡éå¸¸å°çš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘å½“å‡ºç°è¿™ä¸ªæ¦‚ç‡å¾ˆå°çš„é—®é¢˜ï¼Œèƒ½å¦é‡‡ç”¨<strong>äººå·¥è§£å†³</strong>çš„æ–¹å¼ï¼Œè¿™ä¹Ÿæ˜¯å¤§å®¶åœ¨è§£å†³ç–‘éš¾é—®é¢˜æ—¶éœ€è¦å¤šå¤šæ€è€ƒçš„åœ°æ–¹ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html" target="_blank" rel="noopener">èŠèŠåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå†è¯´è¯´è§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="https://juejin.im/post/5c0e5bf8e51d45063322fe50" target="_blank" rel="noopener">ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/distributed-session/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/distributed-session/" class="post-title-link" itemprop="url">åˆ†å¸ƒå¼ä¼šè¯åŸºæœ¬åŸç†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-04 23:42:00" itemprop="dateCreated datePublished" datetime="2019-06-04T23:42:00+08:00">2019-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/distributed-session/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/distributed-session/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>6.2k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>6 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åˆ†å¸ƒå¼ä¼šè¯åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼ä¼šè¯åŸºæœ¬åŸç†"></a> åˆ†å¸ƒå¼ä¼šè¯åŸºæœ¬åŸç†</h1>
<blockquote>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
<p>ç”±äº Http æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ï¼ŒæœåŠ¡å™¨å•å•ä»ç½‘ç»œè¿æ¥ä¸Šæ— ä»çŸ¥é“å®¢æˆ·èº«ä»½ã€‚</p>
<p>ä¼šè¯è·Ÿè¸ªæ˜¯ Web ç¨‹åºä¸­å¸¸ç”¨çš„æŠ€æœ¯ï¼Œç”¨æ¥è·Ÿè¸ªç”¨æˆ·çš„æ•´ä¸ªä¼šè¯ã€‚å¸¸ç”¨ä¼šè¯è·Ÿè¸ªæŠ€æœ¯æ˜¯ Cookie ä¸ Sessionã€‚</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#1-%E7%AE%80%E4%BB%8B">1. ç®€ä»‹</a>
<ul>
<li><a href="#11-%E4%BB%80%E4%B9%88%E6%98%AF-cookie">1.1. ä»€ä¹ˆæ˜¯ Cookie</a></li>
<li><a href="#12-%E4%BB%80%E4%B9%88%E6%98%AF-session">1.2. ä»€ä¹ˆæ˜¯ Session</a></li>
<li><a href="#13-cookie-%E5%92%8C-session-%E7%9A%84%E5%8C%BA%E5%88%AB">1.3. Cookie å’Œ Session çš„åŒºåˆ«</a></li>
<li><a href="#14-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-cookie-%E5%92%8C-session%E4%BB%96%E4%BB%AC%E6%9C%89%E4%BB%80%E4%B9%88%E5%85%B3%E8%81%94">1.4. ä¸ºä»€ä¹ˆéœ€è¦ Cookie å’Œ Sessionï¼Œä»–ä»¬æœ‰ä»€ä¹ˆå…³è”ï¼Ÿ</a></li>
<li><a href="#15-%E5%A6%82%E6%9E%9C%E6%B5%8F%E8%A7%88%E5%99%A8%E7%A6%81%E7%94%A8-cookie-%E6%80%8E%E4%B9%88%E5%8A%9E">1.5. å¦‚æœæµè§ˆå™¨ç¦ç”¨ Cookie æ€ä¹ˆåŠ</a></li>
</ul>
</li>
<li><a href="#2-%E5%88%86%E5%B8%83%E5%BC%8F-session">2. åˆ†å¸ƒå¼ Session</a>
<ul>
<li><a href="#21-%E7%B2%98%E6%80%A7-session">2.1. ç²˜æ€§ Session</a></li>
<li><a href="#22-session-%E5%A4%8D%E5%88%B6%E5%85%B1%E4%BA%AB">2.2. Session å¤åˆ¶å…±äº«</a></li>
<li><a href="#23-%E5%9F%BA%E4%BA%8E%E7%BC%93%E5%AD%98%E7%9A%84-session-%E5%85%B1%E4%BA%AB">2.3. åŸºäºç¼“å­˜çš„ session å…±äº«</a></li>
</ul>
</li>
<li><a href="#3-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0">3. å…·ä½“å®ç°</a>
<ul>
<li><a href="#31-jwt-token">3.1. JWT Token</a></li>
<li><a href="#32-tomcat--redis">3.2. tomcat + redis</a></li>
<li><a href="#33-spring-session--redis">3.3. spring session + redis</a></li>
</ul>
</li>
<li><a href="#4-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">4. å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="1-ç®€ä»‹"><a class="markdownIt-Anchor" href="#1-ç®€ä»‹"></a> 1. ç®€ä»‹</h2>
<h3 id="11-ä»€ä¹ˆæ˜¯-cookie"><a class="markdownIt-Anchor" href="#11-ä»€ä¹ˆæ˜¯-cookie"></a> 1.1. ä»€ä¹ˆæ˜¯ Cookie</h3>
<p>Cookie å®é™…ä¸Šæ˜¯å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸Šçš„æ–‡æœ¬ä¿¡æ¯ï¼Œå¹¶ä¿ç•™äº†å„ç§è·Ÿè¸ªçš„ä¿¡æ¯ã€‚</p>
<p>Cookie å·¥ä½œæ­¥éª¤ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡å™¨ï¼Œå¦‚æœæœåŠ¡å™¨éœ€è¦è®°å½•è¯¥ç”¨æˆ·çš„çŠ¶æ€ï¼Œå°±æ˜¯ç”¨ response å‘å®¢æˆ·ç«¯æµè§ˆå™¨é¢å‘ä¸€ä¸ª Cookieã€‚</li>
<li>å®¢æˆ·ç«¯æµè§ˆå™¨ä¼šæŠŠ Cookie ä¿å­˜ä¸‹æ¥ã€‚</li>
<li>å½“æµè§ˆå™¨å†è¯·æ±‚è¯¥ç½‘ç«™æ—¶ï¼Œæµè§ˆå™¨æŠŠè¯¥è¯·æ±‚çš„ç½‘å€è¿åŒ Cookie ä¸€åŒæäº¤ç»™æœåŠ¡å™¨ã€‚æœåŠ¡å™¨æ£€æŸ¥è¯¥ Cookieï¼Œä»¥æ­¤æ¥è¾¨è®¤ç”¨æˆ·çŠ¶æ€ã€‚</li>
</ol>
<p>Cookie ä¸»è¦ç”¨äºä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆå¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ã€æ¸¸æˆåˆ†æ•°æˆ–å…¶å®ƒéœ€è¦è®°å½•çš„ä¿¡æ¯ï¼‰</li>
<li>ä¸ªæ€§åŒ–è®¾ç½®ï¼ˆå¦‚ç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®ã€ä¸»é¢˜ç­‰ï¼‰</li>
<li>æµè§ˆå™¨è¡Œä¸ºè·Ÿè¸ªï¼ˆå¦‚è·Ÿè¸ªåˆ†æç”¨æˆ·è¡Œä¸ºç­‰ï¼‰</li>
</ul>
<p><em><strong>æ³¨ï¼šCookie åŠŸèƒ½éœ€è¦æµè§ˆå™¨çš„æ”¯æŒï¼Œå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ Cookie æˆ–è€… Cookie ç¦ç”¨äº†ï¼ŒCookie åŠŸèƒ½å°±ä¼šå¤±æ•ˆã€‚</strong></em></p>
<h3 id="12-ä»€ä¹ˆæ˜¯-session"><a class="markdownIt-Anchor" href="#12-ä»€ä¹ˆæ˜¯-session"></a> 1.2. ä»€ä¹ˆæ˜¯ Session</h3>
<p>Session ä»£è¡¨ç€æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¸€æ¬¡ä¼šè¯çš„è¿‡ç¨‹ã€‚Session å¯¹è±¡å­˜å‚¨ç‰¹å®šç”¨æˆ·ä¼šè¯æ‰€éœ€çš„å±æ€§åŠé…ç½®ä¿¡æ¯ã€‚è¿™æ ·ï¼Œå½“ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºçš„ Web é¡µä¹‹é—´è·³è½¬æ—¶ï¼Œå­˜å‚¨åœ¨ Session å¯¹è±¡ä¸­çš„å˜é‡å°†ä¸ä¼šä¸¢å¤±ï¼Œè€Œæ˜¯åœ¨æ•´ä¸ªç”¨æˆ·ä¼šè¯ä¸­ä¸€ç›´å­˜åœ¨ä¸‹å»ã€‚å½“å®¢æˆ·ç«¯å…³é—­ä¼šè¯ï¼Œæˆ–è€… Session è¶…æ—¶å¤±æ•ˆæ—¶ä¼šè¯ç»“æŸã€‚</p>
<h3 id="13-cookie-å’Œ-session-çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#13-cookie-å’Œ-session-çš„åŒºåˆ«"></a> 1.3. Cookie å’Œ Session çš„åŒºåˆ«</h3>
<ul>
<li><strong>ä½œç”¨èŒƒå›´ä¸åŒ</strong>ï¼ŒCookie ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼ŒSession ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚</li>
<li><strong>å­˜å–æ–¹å¼çš„ä¸åŒ</strong>ï¼ŒCookie åªèƒ½ä¿å­˜ ASCIIï¼ŒSession å¯ä»¥å­˜ä»»æ„æ•°æ®ç±»å‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥åœ¨ Session ä¸­ä¿æŒä¸€äº›å¸¸ç”¨å˜é‡ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´ UserId ç­‰ã€‚</li>
<li><strong>æœ‰æ•ˆæœŸä¸åŒ</strong>ï¼ŒCookie å¯è®¾ç½®ä¸ºé•¿æ—¶é—´ä¿æŒï¼Œæ¯”å¦‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„é»˜è®¤ç™»å½•åŠŸèƒ½ï¼ŒSession ä¸€èˆ¬å¤±æ•ˆæ—¶é—´è¾ƒçŸ­ï¼Œå®¢æˆ·ç«¯å…³é—­æˆ–è€… Session è¶…æ—¶éƒ½ä¼šå¤±æ•ˆã€‚</li>
<li><strong>éšç§ç­–ç•¥ä¸åŒ</strong>ï¼ŒCookie å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œæ¯”è¾ƒå®¹æ˜“é­åˆ°ä¸æ³•è·å–ï¼Œæ—©æœŸæœ‰äººå°†ç”¨æˆ·çš„ç™»å½•åå’Œå¯†ç å­˜å‚¨åœ¨ Cookie ä¸­å¯¼è‡´ä¿¡æ¯è¢«çªƒå–ï¼›Session å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œå®‰å…¨æ€§ç›¸å¯¹ Cookie è¦å¥½ä¸€äº›ã€‚</li>
<li><strong>å­˜å‚¨å¤§å°ä¸åŒ</strong>ï¼Œ å•ä¸ª Cookie ä¿å­˜çš„æ•°æ®ä¸èƒ½è¶…è¿‡ 4Kï¼ŒSession å¯å­˜å‚¨æ•°æ®è¿œé«˜äº Cookieã€‚</li>
</ul>
<h3 id="14-ä¸ºä»€ä¹ˆéœ€è¦-cookie-å’Œ-sessionä»–ä»¬æœ‰ä»€ä¹ˆå…³è”"><a class="markdownIt-Anchor" href="#14-ä¸ºä»€ä¹ˆéœ€è¦-cookie-å’Œ-sessionä»–ä»¬æœ‰ä»€ä¹ˆå…³è”"></a> 1.4. ä¸ºä»€ä¹ˆéœ€è¦ Cookie å’Œ Sessionï¼Œä»–ä»¬æœ‰ä»€ä¹ˆå…³è”ï¼Ÿ</h3>
<p>è¯´èµ·æ¥ä¸ºä»€ä¹ˆéœ€è¦ Cookie ï¼Œè¿™å°±éœ€è¦ä»æµè§ˆå™¨å¼€å§‹è¯´èµ·ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æµè§ˆå™¨æ˜¯æ²¡æœ‰çŠ¶æ€çš„(HTTP åè®®æ— çŠ¶æ€)ï¼Œè¿™æ„å‘³ç€æµè§ˆå™¨å¹¶ä¸çŸ¥é“æ˜¯å¼ ä¸‰è¿˜æ˜¯æå››åœ¨å’ŒæœåŠ¡ç«¯æ‰“äº¤é“ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦æœ‰ä¸€ä¸ªæœºåˆ¶æ¥å‘Šè¯‰æœåŠ¡ç«¯ï¼Œæœ¬æ¬¡æ“ä½œç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œæ˜¯å“ªä¸ªç”¨æˆ·åœ¨æ‰§è¡Œçš„æ“ä½œï¼Œé‚£è¿™å¥—æœºåˆ¶çš„å®ç°å°±éœ€è¦ Cookie å’Œ Session çš„é…åˆã€‚</p>
<p>é‚£ä¹ˆ Cookie å’Œ Session æ˜¯å¦‚ä½•é…åˆçš„å‘¢ï¼Ÿæˆ‘ç”»äº†ä¸€å¼ å›¾å¤§å®¶å¯ä»¥å…ˆäº†è§£ä¸‹ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/13/16aafb5d90f398e2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>
<p>ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚æœåŠ¡å™¨çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨æ ¹æ®ç”¨æˆ·æäº¤çš„ç›¸å…³ä¿¡æ¯ï¼Œåˆ›å»ºåˆ›å»ºå¯¹åº”çš„ Session ï¼Œè¯·æ±‚è¿”å›æ—¶å°†æ­¤ Session çš„å”¯ä¸€æ ‡è¯†ä¿¡æ¯ SessionID è¿”å›ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨æ¥æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ SessionID ä¿¡æ¯åï¼Œä¼šå°†æ­¤ä¿¡æ¯å­˜å…¥åˆ° Cookie ä¸­ï¼ŒåŒæ—¶ Cookie è®°å½•æ­¤ SessionID å±äºå“ªä¸ªåŸŸåã€‚</p>
<p>å½“ç”¨æˆ·ç¬¬äºŒæ¬¡è®¿é—®æœåŠ¡å™¨çš„æ—¶å€™ï¼Œè¯·æ±‚ä¼šè‡ªåŠ¨åˆ¤æ–­æ­¤åŸŸåä¸‹æ˜¯å¦å­˜åœ¨ Cookie ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨è‡ªåŠ¨å°† Cookie ä¿¡æ¯ä¹Ÿå‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä¼šä» Cookie ä¸­è·å– SessionIDï¼Œå†æ ¹æ® SessionID æŸ¥æ‰¾å¯¹åº”çš„ Session ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¯´æ˜ç”¨æˆ·æ²¡æœ‰ç™»å½•æˆ–è€…ç™»å½•å¤±æ•ˆï¼Œå¦‚æœæ‰¾åˆ° Session è¯æ˜ç”¨æˆ·å·²ç»ç™»å½•å¯æ‰§è¡Œåé¢æ“ä½œã€‚</p>
<p>æ ¹æ®ä»¥ä¸Šæµç¨‹å¯çŸ¥ï¼ŒSessionID æ˜¯è¿æ¥ Cookie å’Œ Session çš„ä¸€é“æ¡¥æ¢ï¼Œå¤§éƒ¨åˆ†ç³»ç»Ÿä¹Ÿæ˜¯æ ¹æ®æ­¤åŸç†æ¥éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€ã€‚</p>
<h3 id="15-å¦‚æœæµè§ˆå™¨ç¦ç”¨-cookie-æ€ä¹ˆåŠ"><a class="markdownIt-Anchor" href="#15-å¦‚æœæµè§ˆå™¨ç¦ç”¨-cookie-æ€ä¹ˆåŠ"></a> 1.5. å¦‚æœæµè§ˆå™¨ç¦ç”¨ Cookie æ€ä¹ˆåŠ</h3>
<p>æ—¢ç„¶æœåŠ¡ç«¯æ˜¯æ ¹æ® Cookie ä¸­çš„ä¿¡æ¯åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œé‚£ä¹ˆå¦‚æœæµè§ˆå™¨ä¸­ç¦æ­¢äº† Cookieï¼Œå¦‚ä½•ä¿éšœæ•´ä¸ªæœºåˆ¶çš„æ­£å¸¸è¿è½¬ã€‚</p>
<p>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œæ¯æ¬¡è¯·æ±‚ä¸­éƒ½æºå¸¦ä¸€ä¸ª SessionID çš„å‚æ•°ï¼Œä¹Ÿå¯ä»¥ Post çš„æ–¹å¼æäº¤ï¼Œä¹Ÿå¯ä»¥åœ¨è¯·æ±‚çš„åœ°å€åé¢æ‹¼æ¥ <code>xxx?SessionID=123456...</code>ã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ¡ˆï¼ŒToken æœºåˆ¶ã€‚Token æœºåˆ¶å¤šç”¨äº App å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’çš„æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ç”¨äº Web ç«¯åšç”¨æˆ·çŠ¶æ€ç®¡ç†ã€‚</p>
<p>Token çš„æ„æ€æ˜¯â€œä»¤ç‰Œâ€ï¼Œæ˜¯æœåŠ¡ç«¯ç”Ÿæˆçš„ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œä½œä¸ºå®¢æˆ·ç«¯è¿›è¡Œè¯·æ±‚çš„ä¸€ä¸ªæ ‡è¯†ã€‚Token æœºåˆ¶å’Œ Cookie å’Œ Session çš„ä½¿ç”¨æœºåˆ¶æ¯”è¾ƒç±»ä¼¼ã€‚</p>
<p>å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½•åï¼ŒæœåŠ¡å™¨æ ¹æ®æäº¤çš„ç”¨æˆ·ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª Tokenï¼Œå“åº”æ—¶å°† Token è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä»¥åå®¢æˆ·ç«¯åªéœ€å¸¦ä¸Šè¿™ä¸ª Token å‰æ¥è¯·æ±‚æ•°æ®å³å¯ï¼Œæ— éœ€å†æ¬¡ç™»å½•éªŒè¯ã€‚</p>
<h2 id="2-åˆ†å¸ƒå¼-session"><a class="markdownIt-Anchor" href="#2-åˆ†å¸ƒå¼-session"></a> 2. åˆ†å¸ƒå¼ Session</h2>
<p>åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªç”¨æˆ·çš„ Session å¦‚æœåªå­˜å‚¨åœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šï¼Œé‚£ä¹ˆå½“è´Ÿè½½å‡è¡¡å™¨æŠŠç”¨æˆ·çš„ä¸‹ä¸€ä¸ªè¯·æ±‚è½¬å‘åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨ä¸Šï¼Œè¯¥æœåŠ¡å™¨æ²¡æœ‰ç”¨æˆ·çš„ Sessionï¼Œå°±å¯èƒ½å¯¼è‡´ç”¨æˆ·éœ€è¦é‡æ–°è¿›è¡Œç™»å½•ç­‰æ“ä½œã€‚</p>
<p>åˆ†å¸ƒå¼ Session çš„å‡ ç§å®ç°ç­–ç•¥ï¼š</p>
<ol>
<li>ç²˜æ€§ session</li>
<li>åº”ç”¨æœåŠ¡å™¨é—´çš„ session å¤åˆ¶å…±äº«</li>
<li>åŸºäºç¼“å­˜çš„ session å…±äº« âœ…</li>
</ol>
<blockquote>
<p>æ¨èï¼šåŸºäºç¼“å­˜çš„ session å…±äº«</p>
</blockquote>
<h3 id="21-ç²˜æ€§-session"><a class="markdownIt-Anchor" href="#21-ç²˜æ€§-session"></a> 2.1. ç²˜æ€§ Session</h3>
<blockquote>
<p>ç²˜æ€§ Sessionï¼ˆSticky Sessionsï¼‰<strong>éœ€è¦é…ç½®è´Ÿè½½å‡è¡¡å™¨ï¼Œä½¿å¾—ä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚éƒ½è·¯ç”±åˆ°ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä¸Š</strong>ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠç”¨æˆ·çš„ Session å­˜æ”¾åœ¨è¯¥æœåŠ¡å™¨èŠ‚ç‚¹ä¸­ã€‚</p>
<p>ç¼ºç‚¹ï¼š<strong>å½“æœåŠ¡å™¨èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå°†ä¸¢å¤±è¯¥æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Session</strong>ã€‚</p>
</blockquote>
<div align="center">
<img src="http://dunwu.test.upcdn.net/cs/design/architecture/MultiNode-StickySessions.jpg!zp" />
</div>
<h3 id="22-session-å¤åˆ¶å…±äº«"><a class="markdownIt-Anchor" href="#22-session-å¤åˆ¶å…±äº«"></a> 2.2. Session å¤åˆ¶å…±äº«</h3>
<blockquote>
<p>Session å¤åˆ¶å…±äº«ï¼ˆSession Replicationï¼‰<strong>åœ¨æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œ Session åŒæ­¥æ“ä½œ</strong>ï¼Œè¿™æ ·çš„è¯ç”¨æˆ·å¯ä»¥è®¿é—®ä»»ä½•ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ã€‚</p>
<p>ç¼ºç‚¹ï¼š<strong>å ç”¨è¿‡å¤šå†…å­˜</strong>ï¼›<strong>åŒæ­¥è¿‡ç¨‹å ç”¨ç½‘ç»œå¸¦å®½ä»¥åŠæœåŠ¡å™¨å¤„ç†å™¨æ—¶é—´</strong>ã€‚</p>
</blockquote>
<div align="center">
<img src="http://dunwu.test.upcdn.net/cs/design/architecture/MultiNode-SessionReplication.jpg!zp" />
</div>
<h3 id="23-åŸºäºç¼“å­˜çš„-session-å…±äº«"><a class="markdownIt-Anchor" href="#23-åŸºäºç¼“å­˜çš„-session-å…±äº«"></a> 2.3. åŸºäºç¼“å­˜çš„ session å…±äº«</h3>
<blockquote>
<p><strong>ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„å­˜å‚¨æœåŠ¡å™¨å­˜å‚¨ Session æ•°æ®</strong>ï¼Œå¯ä»¥å­˜åœ¨ MySQL æ•°æ®åº“ä¸Šï¼Œä¹Ÿå¯ä»¥å­˜åœ¨ Redis æˆ–è€… Memcached è¿™ç§å†…å­˜å‹æ•°æ®åº“ã€‚</p>
<p>ç¼ºç‚¹ï¼šéœ€è¦å»å®ç°å­˜å– Session çš„ä»£ç ã€‚</p>
</blockquote>
<div align="center">
<img src="http://dunwu.test.upcdn.net/cs/design/architecture/MultiNode-SpringSession.jpg!zp" />
</div>
<h2 id="3-å…·ä½“å®ç°"><a class="markdownIt-Anchor" href="#3-å…·ä½“å®ç°"></a> 3. å…·ä½“å®ç°</h2>
<h3 id="31-jwt-token"><a class="markdownIt-Anchor" href="#31-jwt-token"></a> 3.1. JWT Token</h3>
<p>ä½¿ç”¨ JWT Token å‚¨å­˜ç”¨æˆ·èº«ä»½ï¼Œç„¶åå†ä»æ•°æ®åº“æˆ–è€… cache ä¸­è·å–å…¶ä»–çš„ä¿¡æ¯ã€‚è¿™æ ·æ— è®ºè¯·æ±‚åˆ†é…åˆ°å“ªä¸ªæœåŠ¡å™¨éƒ½æ— æ‰€è°“ã€‚</p>
<h3 id="32-tomcat-redis"><a class="markdownIt-Anchor" href="#32-tomcat-redis"></a> 3.2. tomcat + redis</h3>
<p>è¿™ä¸ªå…¶å®è¿˜æŒºæ–¹ä¾¿çš„ï¼Œå°±æ˜¯ä½¿ç”¨ session çš„ä»£ç ï¼Œè·Ÿä»¥å‰ä¸€æ ·ï¼Œè¿˜æ˜¯åŸºäº tomcat åŸç”Ÿçš„ session æ”¯æŒå³å¯ï¼Œç„¶åå°±æ˜¯ç”¨ä¸€ä¸ªå«åš <code>Tomcat RedisSessionManager</code> çš„ä¸œè¥¿ï¼Œè®©æ‰€æœ‰æˆ‘ä»¬éƒ¨ç½²çš„ tomcat éƒ½å°† session æ•°æ®å­˜å‚¨åˆ° redis å³å¯ã€‚</p>
<p>åœ¨ tomcat çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">"com.orangefunction.tomcat.redissessions.RedisSessionManager"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">host</span>=<span class="string">"&#123;redis.host&#125;"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">port</span>=<span class="string">"&#123;redis.port&#125;"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">database</span>=<span class="string">"&#123;redis.dbnum&#125;"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">maxInactiveInterval</span>=<span class="string">"60"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åæŒ‡å®š redis çš„ host å’Œ port å°± ok äº†ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">"com.orangefunction.tomcat.redissessions.RedisSessionManager"</span></span></span><br><span class="line"><span class="tag">	 <span class="attr">sentinelMaster</span>=<span class="string">"mymaster"</span></span></span><br><span class="line"><span class="tag">	 <span class="attr">sentinels</span>=<span class="string">"&lt;sentinel1-ip&gt;:26379,&lt;sentinel2-ip&gt;:26379,&lt;sentinel3-ip&gt;:26379"</span></span></span><br><span class="line"><span class="tag">	 <span class="attr">maxInactiveInterval</span>=<span class="string">"60"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿˜å¯ä»¥ç”¨ä¸Šé¢è¿™ç§æ–¹å¼åŸºäº redis å“¨å…µæ”¯æŒçš„ redis é«˜å¯ç”¨é›†ç¾¤æ¥ä¿å­˜ session æ•°æ®ï¼Œéƒ½æ˜¯ ok çš„ã€‚</p>
<h3 id="33-spring-session-redis"><a class="markdownIt-Anchor" href="#33-spring-session-redis"></a> 3.3. spring session + redis</h3>
<p>ä¸Šé¢é‚£ç§ tomcat + redis çš„æ–¹å¼å¥½ç”¨ï¼Œä½†æ˜¯ä¼š<strong>ä¸¥é‡ä¾èµ–äº web å®¹å™¨</strong>ï¼Œä¸å¥½å°†ä»£ç ç§»æ¤åˆ°å…¶ä»– web å®¹å™¨ä¸Šå»ï¼Œå°¤å…¶æ˜¯ä½ è¦æ˜¯æ¢äº†æŠ€æœ¯æ ˆå’‹æ•´ï¼Ÿæ¯”å¦‚æ¢æˆäº† spring cloud æˆ–è€…æ˜¯ spring boot ä¹‹ç±»çš„å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥ç°åœ¨æ¯”è¾ƒå¥½çš„è¿˜æ˜¯åŸºäº Java ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯ springã€‚äººå®¶ spring åŸºæœ¬ä¸Šæ‰¿åŒ…äº†å¤§éƒ¨åˆ†æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ¡†æ¶ï¼Œspirng cloud åšå¾®æœåŠ¡ï¼Œspring boot åšè„šæ‰‹æ¶ï¼Œæ‰€ä»¥ç”¨ <a href="https://github.com/spring-projects/spring-session" target="_blank" rel="noopener">sping session</a> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
<p>åœ¨ pom.xml ä¸­é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ spring é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisHttpSessionConfiguration"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">class</span>=<span class="string">"org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxInactiveIntervalInSeconds"</span> <span class="attr">value</span>=<span class="string">"600"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPoolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisConnectionFactory"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span> <span class="attr">destroy-method</span>=<span class="string">"destroy"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hostName"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis_hostname&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis_port&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis_pwd&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"3000"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"usePool"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"jedisPoolConfig"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ web.xml ä¸­é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSessionRepositoryFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSessionRepositoryFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/putIntoSession"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">putIntoSession</span><span class="params">(HttpServletRequest request, String username)</span> </span>&#123;</span><br><span class="line">        request.getSession().setAttribute(<span class="string">"name"</span>,  <span class="string">"leo"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ok"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/getFromSession"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFromSession</span><span class="params">(HttpServletRequest request, Model model)</span></span>&#123;</span><br><span class="line">        String name = request.getSession().getAttribute(<span class="string">"name"</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å°±æ˜¯ ok çš„ï¼Œç»™ sping session é…ç½®åŸºäº redis æ¥å­˜å‚¨ session æ•°æ®ï¼Œç„¶åé…ç½®äº†ä¸€ä¸ª spring session çš„è¿‡æ»¤å™¨ï¼Œè¿™æ ·çš„è¯ï¼Œsession ç›¸å…³æ“ä½œéƒ½ä¼šäº¤ç»™ spring session æ¥ç®¡äº†ã€‚æ¥ç€åœ¨ä»£ç ä¸­ï¼Œå°±ç”¨åŸç”Ÿçš„ session æ“ä½œï¼Œå°±æ˜¯ç›´æ¥åŸºäº spring sesion ä» redis ä¸­è·å–æ•°æ®äº†ã€‚</p>
<p>å®ç°åˆ†å¸ƒå¼çš„ä¼šè¯æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œæˆ‘è¯´çš„åªä¸è¿‡æ˜¯æ¯”è¾ƒå¸¸è§çš„å‡ ç§æ–¹å¼ï¼Œtomcat + redis æ—©æœŸæ¯”è¾ƒå¸¸ç”¨ï¼Œä½†æ˜¯ä¼šé‡è€¦åˆåˆ° tomcat ä¸­ï¼›è¿‘äº›å¹´ï¼Œé€šè¿‡ spring session æ¥å®ç°ã€‚</p>
<h2 id="4-å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#4-å‚è€ƒèµ„æ–™"></a> 4. å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://github.com/L316476844/distributed-session" target="_blank" rel="noopener">é›†ç¾¤/åˆ†å¸ƒå¼ç¯å¢ƒ Session çš„å‡ ç§ç­–ç•¥</a></li>
<li><a href="https://juejin.im/post/5cd9037ee51d456e5c5babca" target="_blank" rel="noopener">ä½ çœŸçš„äº†è§£ Cookie å’Œ Session å—</a></li>
<li><a href="https://juejin.im/post/5aede266f265da0ba266e0ef" target="_blank" rel="noopener">èŠä¸€èŠ session å’Œ cookie</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/theory/distributed-lock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/theory/distributed-lock/" class="post-title-link" itemprop="url">åˆ†å¸ƒå¼é”åŸºæœ¬åŸç†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-04 23:42:00" itemprop="dateCreated datePublished" datetime="2019-06-04T23:42:00+08:00">2019-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index">
                    <span itemprop="name">åˆ†å¸ƒå¼</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/theory/distributed-lock/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="theory/distributed-lock/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>9 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åˆ†å¸ƒå¼é”åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼é”åŸºæœ¬åŸç†"></a> åˆ†å¸ƒå¼é”åŸºæœ¬åŸç†</h1>
<blockquote>
<p>åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºäº†ä¿è¯å¹¶å‘å®‰å…¨ï¼Œæˆ‘ä»¬å¸¸å¸¸è¦é€šè¿‡äº’æ–¥ï¼ˆåŠ é”ï¼‰æ‰‹æ®µæ¥ä¿è¯æ•°æ®åŒæ­¥å®‰å…¨ã€‚</p>
<p>JDK è™½ç„¶æä¾›äº†å¤§é‡é”å·¥å…·ï¼Œä½†æ˜¯åªèƒ½ä½œç”¨äºå•ä¸€ Java è¿›ç¨‹ï¼Œæ— æ³•åº”ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚</p>
<p>åˆ†å¸ƒå¼é”çš„è§£å†³æ–¹æ¡ˆå¤§è‡´æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>åŸºäºæ•°æ®åº“å®ç°</li>
<li>åŸºäºç¼“å­˜ï¼ˆredisï¼Œmemcached ç­‰ï¼‰å®ç°</li>
<li>åŸºäº Zookeeper å®ç° âœ…</li>
</ul>
<p>æ³¨ï¼šæ¨èåŸºäº ZooKeeper å®ç°åˆ†å¸ƒå¼é”ï¼Œå…·ä½“åŸå› çœ‹å®Œæœ¬æ–‡å³å¯æ˜äº†ã€‚</p>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#%E4%B8%80%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%80%9D%E8%B7%AF">ä¸€ã€åˆ†å¸ƒå¼é”æ€è·¯</a></li>
<li><a href="#%E4%BA%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">äºŒã€æ•°æ®åº“åˆ†å¸ƒå¼é”</a>
<ul>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%8E%9F%E7%90%86">æ•°æ®åº“åˆ†å¸ƒå¼é”åŸç†</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E9%97%AE%E9%A2%98">æ•°æ®åº“åˆ†å¸ƒå¼é”é—®é¢˜</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%B0%8F%E7%BB%93">æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">ä¸‰ã€Redis åˆ†å¸ƒå¼é”</a>
<ul>
<li><a href="#redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%8E%9F%E7%90%86">Redis åˆ†å¸ƒå¼é”åŸç†</a></li>
<li><a href="#redis-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0">Redis åˆ†å¸ƒå¼é”å®ç°</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%B0%8F%E7%BB%93-1">æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“</a></li>
<li><a href="#redlock-%E7%AE%97%E6%B3%95">RedLock ç®—æ³•</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9Bzookeeper-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">å››ã€ZooKeeper åˆ†å¸ƒå¼é”</a>
<ul>
<li><a href="#zookeeper-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%8E%9F%E7%90%86">ZooKeeper åˆ†å¸ƒå¼é”åŸç†</a></li>
<li><a href="#zookeeper-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0">ZooKeeper åˆ†å¸ƒå¼é”å®ç°</a></li>
<li><a href="#zookeeper-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%B0%8F%E7%BB%93">ZooKeeper åˆ†å¸ƒå¼é”å°ç»“</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94">äº”ã€ åˆ†å¸ƒå¼é”æ–¹æ¡ˆå¯¹æ¯”</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="ä¸€-åˆ†å¸ƒå¼é”æ€è·¯"><a class="markdownIt-Anchor" href="#ä¸€-åˆ†å¸ƒå¼é”æ€è·¯"></a> ä¸€ã€åˆ†å¸ƒå¼é”æ€è·¯</h2>
<p>åˆ†å¸ƒå¼é”çš„æ€»ä½“æ€è·¯å¤§åŒå°å¼‚ï¼Œä»…åœ¨å®ç°ç»†èŠ‚ä¸Šæœ‰æ‰€ä¸åŒã€‚</p>
<p>åˆ†å¸ƒå¼é”çš„ä¸»è¦æ€è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>äº’æ–¥ã€å¯é‡å…¥</strong> - åˆ›å»ºé”å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œè¡¨ç°å½¢å¼ä¸ºå‘æ•°æ®å­˜å‚¨æœåŠ¡å™¨æˆ–å®¹å™¨æ’å…¥ä¸€ä¸ªå”¯ä¸€çš„ keyï¼Œä¸€æ—¦æœ‰ä¸€ä¸ªçº¿ç¨‹æ’å…¥è¿™ä¸ª keyï¼Œå…¶ä»–çº¿ç¨‹å°±ä¸èƒ½å†æ’å…¥äº†ã€‚
<ul>
<li>ä¿è¯ key å”¯ä¸€æ€§çš„æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ UUIDã€‚</li>
<li>å­˜å‚¨é”çš„é‡å…¥æ¬¡æ•°ï¼Œä»¥åŠåˆ†å¸ƒå¼ç¯å¢ƒä¸‹å”¯ä¸€çš„çº¿ç¨‹æ ‡è¯†ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨ json å­˜å‚¨ç»“æ„åŒ–æ•°æ®ï¼Œä¸ºäº†ä¿è¯å”¯ä¸€ï¼Œå¯ä»¥è€ƒè™‘å°† mac åœ°å€ï¼ˆIP åœ°å€ã€æœºå™¨ IDï¼‰ã€Jvm è¿›ç¨‹ IDï¼ˆåº”ç”¨ IDã€æœåŠ¡ IDï¼‰ã€çº¿ç¨‹ ID æ‹¼æ¥èµ·æ¥ä½œä¸ºå”¯ä¸€æ ‡è¯†ã€‚<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"count"</span>:<span class="number">1</span>,<span class="attr">"expireAt"</span>:<span class="number">147506817232</span>,<span class="attr">"jvmPid"</span>:<span class="number">22224</span>,<span class="attr">"mac"</span>:<span class="string">"28-D2-44-0E-0D-9A"</span>,<span class="attr">"threadId"</span>:<span class="number">14</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><strong>é¿å…æ­»é”</strong> - æ•°æ®åº“åˆ†å¸ƒå¼é”å’Œç¼“å­˜åˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰çš„æ€è·¯éƒ½æ˜¯å¼•å…¥è¶…æ—¶æœºåˆ¶ï¼Œå³æˆåŠŸç”³è¯·é”åï¼Œè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œé”å¤±æ•ˆï¼ˆåˆ é™¤ keyï¼‰ï¼ŒåŸå› åœ¨äºå®ƒä»¬æ— æ³•æ„ŸçŸ¥ç”³è¯·é”çš„å®¢æˆ·ç«¯èŠ‚ç‚¹çŠ¶æ€ã€‚è€Œ ZooKeeper ç”±äºå…¶ znode ä»¥ç›®å½•ã€æ–‡ä»¶å½¢å¼ç»„ç»‡ï¼Œå¤©ç„¶å°±å­˜åœ¨ç‰©ç†ç©ºé—´éš”ç¦»ï¼Œåªè¦ znode å­˜åœ¨ï¼Œå³è¡¨ç¤ºå®¢æˆ·ç«¯èŠ‚ç‚¹è¿˜åœ¨å·¥ä½œï¼Œæ‰€ä»¥ä¸å­˜åœ¨è¿™ç§é—®é¢˜ã€‚</li>
<li><strong>å®¹é”™</strong> - åªè¦å¤§éƒ¨åˆ† Redis èŠ‚ç‚¹å¯ç”¨ï¼Œå®¢æˆ·ç«¯å°±èƒ½æ­£å¸¸åŠ é”ã€‚</li>
<li><strong>è‡ªæ—‹é‡è¯•</strong> - è·å–ä¸åˆ°é”æ—¶ï¼Œä¸è¦ç›´æ¥è¿”å›å¤±è´¥ï¼Œè€Œæ˜¯æ”¯æŒä¸€å®šçš„å‘¨æœŸè‡ªæ—‹é‡è¯•ï¼Œè®¾ç½®ä¸€ä¸ªæ€»çš„è¶…æ—¶æ—¶é—´ï¼Œå½“è¿‡äº†è¶…æ—¶æ—¶é—´ä»¥åè¿˜æ²¡æœ‰è·å–åˆ°é”åˆ™è¿”å›å¤±è´¥ã€‚</li>
</ul>
<h2 id="äºŒ-æ•°æ®åº“åˆ†å¸ƒå¼é”"><a class="markdownIt-Anchor" href="#äºŒ-æ•°æ®åº“åˆ†å¸ƒå¼é”"></a> äºŒã€æ•°æ®åº“åˆ†å¸ƒå¼é”</h2>
<h3 id="æ•°æ®åº“åˆ†å¸ƒå¼é”åŸç†"><a class="markdownIt-Anchor" href="#æ•°æ®åº“åˆ†å¸ƒå¼é”åŸç†"></a> æ•°æ®åº“åˆ†å¸ƒå¼é”åŸç†</h3>
<p>ï¼ˆ1ï¼‰åˆ›å»ºè¡¨</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`methodLock`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'ä¸»é”®'</span>,</span><br><span class="line">  <span class="string">`method_name`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'é”å®šçš„æ–¹æ³•å'</span>,</span><br><span class="line">  <span class="string">`desc`</span> <span class="built_in">varchar</span>(<span class="number">1024</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'å¤‡æ³¨ä¿¡æ¯'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'ä¿å­˜æ•°æ®æ—¶é—´ï¼Œè‡ªåŠ¨ç”Ÿæˆ'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uidx_method_name`</span> (<span class="string">`method_name `</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'é”å®šä¸­çš„æ–¹æ³•'</span>;</span><br></pre></td></tr></table></figure>
<p>ï¼ˆ2ï¼‰è·å–é”</p>
<p>æƒ³è¦é”ä½æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ‰§è¡Œä»¥ä¸‹ SQLï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> methodLock(method_name,<span class="keyword">desc</span>) <span class="keyword">values</span> (â€˜method_nameâ€™,â€˜<span class="keyword">desc</span>â€™)</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæˆ‘ä»¬å¯¹ <code>method_name</code> åšäº†å”¯ä¸€æ€§çº¦æŸï¼Œè¿™é‡Œå¦‚æœæœ‰å¤šä¸ªè¯·æ±‚åŒæ—¶æäº¤åˆ°æ•°æ®åº“çš„è¯ï¼Œæ•°æ®åº“ä¼šä¿è¯åªæœ‰ä¸€ä¸ªæ“ä½œå¯ä»¥æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºæ“ä½œæˆåŠŸçš„é‚£ä¸ªçº¿ç¨‹è·å¾—äº†è¯¥æ–¹æ³•çš„é”ï¼Œå¯ä»¥æ‰§è¡Œæ–¹æ³•ä½“å†…å®¹ã€‚</p>
<p>æˆåŠŸæ’å…¥åˆ™è·å–é”ã€‚</p>
<p>ï¼ˆ3ï¼‰é‡Šæ”¾é”</p>
<p>å½“æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæƒ³è¦é‡Šæ”¾é”çš„è¯ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹ Sql:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> methodLock <span class="keyword">where</span> method_name =<span class="string">'method_name'</span></span><br></pre></td></tr></table></figure>
<h3 id="æ•°æ®åº“åˆ†å¸ƒå¼é”é—®é¢˜"><a class="markdownIt-Anchor" href="#æ•°æ®åº“åˆ†å¸ƒå¼é”é—®é¢˜"></a> æ•°æ®åº“åˆ†å¸ƒå¼é”é—®é¢˜</h3>
<ul>
<li>è¿™æŠŠé”å¼ºä¾èµ–æ•°æ®åº“çš„å¯ç”¨æ€§ã€‚å¦‚æœæ•°æ®åº“æ˜¯ä¸€ä¸ªå•ç‚¹ï¼Œä¸€æ—¦æ•°æ®åº“æŒ‚æ‰ï¼Œä¼šå¯¼è‡´ä¸šåŠ¡ç³»ç»Ÿä¸å¯ç”¨ã€‚</li>
<li>è¿™æŠŠé”æ²¡æœ‰å¤±æ•ˆæ—¶é—´ï¼Œä¸€æ—¦è§£é”æ“ä½œå¤±è´¥ï¼Œå°±ä¼šå¯¼è‡´é”è®°å½•ä¸€ç›´åœ¨æ•°æ®åº“ä¸­ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†è·å¾—åˆ°é”ã€‚</li>
<li>è¿™æŠŠé”åªèƒ½æ˜¯éé˜»å¡çš„ï¼Œå› ä¸ºæ•°æ®çš„ insert æ“ä½œï¼Œä¸€æ—¦æ’å…¥å¤±è´¥å°±ä¼šç›´æ¥æŠ¥é”™ã€‚æ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹å¹¶ä¸ä¼šè¿›å…¥æ’é˜Ÿé˜Ÿåˆ—ï¼Œè¦æƒ³å†æ¬¡è·å¾—é”å°±è¦å†æ¬¡è§¦å‘è·å¾—é”æ“ä½œã€‚</li>
<li>è¿™æŠŠé”æ˜¯éé‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰é‡Šæ”¾é”ä¹‹å‰æ— æ³•å†æ¬¡è·å¾—è¯¥é”ã€‚å› ä¸ºæ•°æ®ä¸­æ•°æ®å·²ç»å­˜åœ¨äº†ã€‚</li>
</ul>
<p>è§£å†³åŠæ³•ï¼š</p>
<ul>
<li>å•ç‚¹é—®é¢˜å¯ä»¥ç”¨å¤šæ•°æ®åº“å®ä¾‹ï¼ŒåŒæ—¶å¡ N ä¸ªè¡¨ï¼ŒN/2+1 ä¸ªæˆåŠŸå°±ä»»åŠ¡é”å®šæˆåŠŸ</li>
<li>å†™ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œéš”ä¸€æ®µæ—¶é—´æ¸…é™¤ä¸€æ¬¡è¿‡æœŸçš„æ•°æ®ã€‚</li>
<li>å†™ä¸€ä¸ª while å¾ªç¯ï¼Œä¸æ–­çš„é‡è¯•æ’å…¥ï¼Œç›´åˆ°æˆåŠŸã€‚</li>
<li>åœ¨æ•°æ®åº“è¡¨ä¸­åŠ ä¸ªå­—æ®µï¼Œè®°å½•å½“å‰è·å¾—é”çš„æœºå™¨çš„ä¸»æœºä¿¡æ¯å’Œçº¿ç¨‹ä¿¡æ¯ï¼Œé‚£ä¹ˆä¸‹æ¬¡å†è·å–é”çš„æ—¶å€™å…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚æœå½“å‰æœºå™¨çš„ä¸»æœºä¿¡æ¯å’Œçº¿ç¨‹ä¿¡æ¯åœ¨æ•°æ®åº“å¯ä»¥æŸ¥åˆ°çš„è¯ï¼Œç›´æ¥æŠŠé”åˆ†é…ç»™ä»–å°±å¯ä»¥äº†ã€‚</li>
</ul>
<h3 id="æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“"><a class="markdownIt-Anchor" href="#æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“"></a> æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“</h3>
<ul>
<li>ä¼˜ç‚¹: ç›´æ¥å€ŸåŠ©æ•°æ®åº“ï¼Œå®¹æ˜“ç†è§£ã€‚</li>
<li>ç¼ºç‚¹: ä¼šæœ‰å„ç§å„æ ·çš„é—®é¢˜ï¼Œåœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ä¼šä½¿æ•´ä¸ªæ–¹æ¡ˆå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚æ“ä½œæ•°æ®åº“éœ€è¦ä¸€å®šçš„å¼€é”€ï¼Œæ€§èƒ½é—®é¢˜éœ€è¦è€ƒè™‘ã€‚</li>
</ul>
<h2 id="ä¸‰-redis-åˆ†å¸ƒå¼é”"><a class="markdownIt-Anchor" href="#ä¸‰-redis-åˆ†å¸ƒå¼é”"></a> ä¸‰ã€Redis åˆ†å¸ƒå¼é”</h2>
<p>ç›¸æ¯”äºç”¨æ•°æ®åº“æ¥å®ç°åˆ†å¸ƒå¼é”ï¼ŒåŸºäºç¼“å­˜å®ç°çš„åˆ†å¸ƒå¼é”çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚ç›®å‰æœ‰å¾ˆå¤šæˆç†Ÿçš„åˆ†å¸ƒå¼äº§å“ï¼ŒåŒ…æ‹¬ Redisã€memcacheã€Tair ç­‰ã€‚è¿™é‡Œä»¥ Redis ä¸¾ä¾‹ã€‚</p>
<h3 id="redis-åˆ†å¸ƒå¼é”åŸç†"><a class="markdownIt-Anchor" href="#redis-åˆ†å¸ƒå¼é”åŸç†"></a> Redis åˆ†å¸ƒå¼é”åŸç†</h3>
<p>è¿™ä¸ªåˆ†å¸ƒå¼é”æœ‰ 3 ä¸ªé‡è¦çš„è€ƒé‡ç‚¹ï¼š</p>
<ol>
<li>äº’æ–¥ï¼ˆåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è·å–é”ï¼‰</li>
<li>ä¸èƒ½æ­»é”</li>
<li>å®¹é”™ï¼ˆåªè¦å¤§éƒ¨åˆ† redis èŠ‚ç‚¹åˆ›å»ºäº†è¿™æŠŠé”å°±å¯ä»¥ï¼‰</li>
</ol>
<p>å¯¹åº”çš„ Redis æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>setnx</code> - <code>setnx key val</code>ï¼šå½“ä¸”ä»…å½“ key ä¸å­˜åœ¨æ—¶ï¼Œset ä¸€ä¸ª key ä¸º val çš„å­—ç¬¦ä¸²ï¼Œè¿”å› 1ï¼›è‹¥ key å­˜åœ¨ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œè¿”å› 0ã€‚</li>
<li><code>expire</code> - <code>expire key timeout</code>ï¼šä¸º key è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸º secondï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´é”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œé¿å…æ­»é”ã€‚</li>
<li><code>delete</code> - <code>delete key</code>ï¼šåˆ é™¤ key</li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<p>ä¸è¦å°† <code>setnx</code> å’Œ <code>expire</code> ä½œä¸ºä¸¤ä¸ªå‘½ä»¤ç»„åˆå®ç°åŠ é”ï¼Œè¿™æ ·å°±<strong>æ— æ³•ä¿è¯åŸå­æ€§</strong>ã€‚å¦‚æœå®¢æˆ·ç«¯åœ¨ <code>setnx</code> ä¹‹åå´©æºƒï¼Œé‚£ä¹ˆå°†å¯¼è‡´é”æ— æ³•é‡Šæ”¾ã€‚æ­£ç¡®çš„åšæ³•åº”æ˜¯åœ¨ <code>setnx</code> å‘½ä»¤ä¸­æŒ‡å®š <code>expire</code> æ—¶é—´ã€‚</p>
</blockquote>
<h3 id="redis-åˆ†å¸ƒå¼é”å®ç°"><a class="markdownIt-Anchor" href="#redis-åˆ†å¸ƒå¼é”å®ç°"></a> Redis åˆ†å¸ƒå¼é”å®ç°</h3>
<p>ï¼ˆ1ï¼‰ç”³è¯·é”</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> resource_name <span class="comment">my_random_value NX PX 30000</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œè¿™ä¸ªå‘½ä»¤å°± okã€‚</p>
<ul>
<li><code>NX</code>ï¼šè¡¨ç¤ºåªæœ‰ <code>key</code> ä¸å­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®æˆåŠŸã€‚ï¼ˆå¦‚æœæ­¤æ—¶ redis ä¸­å­˜åœ¨è¿™ä¸ª keyï¼Œé‚£ä¹ˆè®¾ç½®å¤±è´¥ï¼Œè¿”å› <code>nil</code>ï¼‰</li>
<li><code>PX 30000</code>ï¼šæ„æ€æ˜¯ 30s åé”è‡ªåŠ¨é‡Šæ”¾ã€‚åˆ«äººåˆ›å»ºçš„æ—¶å€™å¦‚æœå‘ç°å·²ç»æœ‰äº†å°±ä¸èƒ½åŠ é”äº†ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰é‡Šæ”¾é”</p>
<p>é‡Šæ”¾é”å°±æ˜¯åˆ é™¤ key ï¼Œä½†æ˜¯ä¸€èˆ¬å¯ä»¥ç”¨ <code>lua</code> è„šæœ¬åˆ é™¤ï¼Œåˆ¤æ–­ value ä¸€æ ·æ‰åˆ é™¤ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">-- åˆ é™¤é”çš„æ—¶å€™ï¼Œæ‰¾åˆ° key å¯¹åº”çš„ valueï¼Œè·Ÿè‡ªå·±ä¼ è¿‡å»çš„ value åšæ¯”è¾ƒï¼Œå¦‚æœæ˜¯ä¸€æ ·çš„æ‰åˆ é™¤ã€‚</span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">"get"</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] then</span><br><span class="line">    <span class="keyword">return</span> redis.call(<span class="string">"del"</span>,KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“-2"><a class="markdownIt-Anchor" href="#æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“-2"></a> æ•°æ®åº“åˆ†å¸ƒå¼é”å°ç»“</h3>
<p>ä¸ºå•¥è¦ç”¨ <code>random_value</code> éšæœºå€¼å‘¢ï¼Ÿå› ä¸ºå¦‚æœæŸä¸ªå®¢æˆ·ç«¯è·å–åˆ°äº†é”ï¼Œä½†æ˜¯é˜»å¡äº†å¾ˆé•¿æ—¶é—´æ‰æ‰§è¡Œå®Œï¼Œæ¯”å¦‚è¯´è¶…è¿‡äº† 30sï¼Œæ­¤æ—¶å¯èƒ½å·²ç»è‡ªåŠ¨é‡Šæ”¾é”äº†ï¼Œæ­¤æ—¶å¯èƒ½åˆ«çš„å®¢æˆ·ç«¯å·²ç»è·å–åˆ°äº†è¿™ä¸ªé”ï¼Œè¦æ˜¯ä½ è¿™ä¸ªæ—¶å€™ç›´æ¥åˆ é™¤ key çš„è¯ä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥å¾—ç”¨éšæœºå€¼åŠ ä¸Šé¢çš„ <code>lua</code> è„šæœ¬æ¥é‡Šæ”¾é”ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·æ˜¯è‚¯å®šä¸è¡Œçš„ã€‚å› ä¸ºå¦‚æœæ˜¯æ™®é€šçš„ redis å•å®ä¾‹ï¼Œé‚£å°±æ˜¯å•ç‚¹æ•…éšœã€‚æˆ–è€…æ˜¯ redis æ™®é€šä¸»ä»ï¼Œé‚£ redis ä¸»ä»å¼‚æ­¥å¤åˆ¶ï¼Œå¦‚æœä¸»èŠ‚ç‚¹æŒ‚äº†ï¼ˆkey å°±æ²¡æœ‰äº†ï¼‰ï¼Œkey è¿˜æ²¡åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œæ­¤æ—¶ä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œåˆ«äººå°±å¯ä»¥ set keyï¼Œä»è€Œæ‹¿åˆ°é”ã€‚</p>
<h3 id="redlock-ç®—æ³•"><a class="markdownIt-Anchor" href="#redlock-ç®—æ³•"></a> RedLock ç®—æ³•</h3>
<p>è¿™ä¸ªåœºæ™¯æ˜¯å‡è®¾æœ‰ä¸€ä¸ª redis clusterï¼Œæœ‰ 5 ä¸ª redis master å®ä¾‹ã€‚ç„¶åæ‰§è¡Œå¦‚ä¸‹æ­¥éª¤è·å–ä¸€æŠŠé”ï¼š</p>
<ol>
<li>è·å–å½“å‰æ—¶é—´æˆ³ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼›</li>
<li>è·Ÿä¸Šé¢ç±»ä¼¼ï¼Œè½®æµå°è¯•åœ¨æ¯ä¸ª master èŠ‚ç‚¹ä¸Šåˆ›å»ºé”ï¼Œè¿‡æœŸæ—¶é—´è¾ƒçŸ­ï¼Œä¸€èˆ¬å°±å‡ åæ¯«ç§’ï¼›</li>
<li>å°è¯•åœ¨<strong>å¤§å¤šæ•°èŠ‚ç‚¹</strong>ä¸Šå»ºç«‹ä¸€ä¸ªé”ï¼Œæ¯”å¦‚ 5 ä¸ªèŠ‚ç‚¹å°±è¦æ±‚æ˜¯ 3 ä¸ªèŠ‚ç‚¹ <code>n / 2 + 1</code>ï¼›</li>
<li>å®¢æˆ·ç«¯è®¡ç®—å»ºç«‹å¥½é”çš„æ—¶é—´ï¼Œå¦‚æœå»ºç«‹é”çš„æ—¶é—´å°äºè¶…æ—¶æ—¶é—´ï¼Œå°±ç®—å»ºç«‹æˆåŠŸäº†ï¼›</li>
<li>è¦æ˜¯é”å»ºç«‹å¤±è´¥äº†ï¼Œé‚£ä¹ˆå°±ä¾æ¬¡ä¹‹å‰å»ºç«‹è¿‡çš„é”åˆ é™¤ï¼›</li>
<li>åªè¦åˆ«äººå»ºç«‹äº†ä¸€æŠŠåˆ†å¸ƒå¼é”ï¼Œä½ å°±å¾—<strong>ä¸æ–­è½®è¯¢å»å°è¯•è·å–é”</strong>ã€‚</li>
</ol>
<p><a href="https://redis.io/" target="_blank" rel="noopener">Redis å®˜æ–¹</a>ç»™å‡ºäº†ä»¥ä¸Šä¸¤ç§åŸºäº Redis å®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ³•ï¼Œè¯¦ç»†è¯´æ˜å¯ä»¥æŸ¥çœ‹ï¼š<a href="https://redis.io/topics/distlock" target="_blank" rel="noopener">https://redis.io/topics/distlock</a> ã€‚</p>
<h2 id="å››-zookeeper-åˆ†å¸ƒå¼é”"><a class="markdownIt-Anchor" href="#å››-zookeeper-åˆ†å¸ƒå¼é”"></a> å››ã€ZooKeeper åˆ†å¸ƒå¼é”</h2>
<h3 id="zookeeper-åˆ†å¸ƒå¼é”åŸç†"><a class="markdownIt-Anchor" href="#zookeeper-åˆ†å¸ƒå¼é”åŸç†"></a> ZooKeeper åˆ†å¸ƒå¼é”åŸç†</h3>
<p>ZooKeeper å®ç°åˆ†å¸ƒå¼é”åŸºäº ZooKeeper çš„ä¸¤ä¸ªç‰¹æ€§ï¼š</p>
<ul>
<li><strong>é¡ºåºä¸´æ—¶èŠ‚ç‚¹</strong>ï¼šZooKeeper çš„å­˜å‚¨ç±»ä¼¼äº DNS é‚£æ ·çš„å…·æœ‰å±‚çº§çš„å‘½åç©ºé—´ã€‚ZooKeeper èŠ‚ç‚¹ç±»å‹å¯ä»¥åˆ†ä¸ºæŒä¹…èŠ‚ç‚¹ï¼ˆPERSISTENT ï¼‰ã€ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEPHEMERALï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¿˜èƒ½è¢«æ ‡è®°ä¸ºæœ‰åºæ€§ï¼ˆSEQUENTIALï¼‰ï¼Œä¸€æ—¦èŠ‚ç‚¹è¢«æ ‡è®°ä¸ºæœ‰åºæ€§ï¼Œé‚£ä¹ˆæ•´ä¸ªèŠ‚ç‚¹å°±å…·æœ‰é¡ºåºè‡ªå¢çš„ç‰¹ç‚¹ã€‚</li>
<li><strong>Watch æœºåˆ¶</strong>ï¼šZooKeeper å…è®¸ç”¨æˆ·åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€äº› Watcherï¼Œå¹¶ä¸”åœ¨ç‰¹å®šäº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼ŒZooKeeper æœåŠ¡ç«¯ä¼šå°†äº‹ä»¶é€šçŸ¥ç»™ç”¨æˆ·ã€‚</li>
</ul>
<p>è¿™ä¹Ÿæ˜¯ ZooKeeper å®¢æˆ·ç«¯ curator çš„åˆ†å¸ƒå¼é”å®ç°ã€‚</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªç›®å½• mylockï¼›</li>
<li>çº¿ç¨‹ A æƒ³è·å–é”å°±åœ¨ mylock ç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼›</li>
<li>è·å– mylock ç›®å½•ä¸‹æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œç„¶åè·å–æ¯”è‡ªå·±å°çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹é¡ºåºå·æœ€å°ï¼Œè·å¾—é”ï¼›</li>
<li>çº¿ç¨‹ B è·å–æ‰€æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±ä¸æ˜¯æœ€å°èŠ‚ç‚¹ï¼Œè®¾ç½®ç›‘å¬æ¯”è‡ªå·±æ¬¡å°çš„èŠ‚ç‚¹ï¼›</li>
<li>çº¿ç¨‹ A å¤„ç†å®Œï¼Œåˆ é™¤è‡ªå·±çš„èŠ‚ç‚¹ï¼Œçº¿ç¨‹ B ç›‘å¬åˆ°å˜æ›´äº‹ä»¶ï¼Œåˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯æœ€å°çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™è·å¾—é”ã€‚</li>
</ol>
<h3 id="zookeeper-åˆ†å¸ƒå¼é”å®ç°"><a class="markdownIt-Anchor" href="#zookeeper-åˆ†å¸ƒå¼é”å®ç°"></a> ZooKeeper åˆ†å¸ƒå¼é”å®ç°</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ZooKeeperSession</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> bingo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/11/29</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperSession</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch connectedSemaphore = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zookeeper;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZooKeeperSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.zookeeper = <span class="keyword">new</span> ZooKeeper(<span class="string">"192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181"</span>, <span class="number">50000</span>, <span class="keyword">new</span> ZooKeeperWatcher());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connectedSemaphore.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"ZooKeeper session established......"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–åˆ†å¸ƒå¼é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">acquireDistributedLock</span><span class="params">(Long productId)</span> </span>&#123;</span><br><span class="line">        String path = <span class="string">"/product-lock-"</span> + productId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zookeeper.create(path, <span class="string">""</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ç›¸å½“äºæ˜¯ç»™nodeæ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼Œå»çœ‹çœ‹è¿™ä¸ªç›‘å¬å™¨æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">                    Stat stat = zk.exists(path, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (stat != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">this</span>.latch.await(waitTime, TimeUnit.MILLISECONDS);</span><br><span class="line">                        <span class="keyword">this</span>.latch = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    zookeeper.create(path, <span class="string">""</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ee) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾æ‰ä¸€ä¸ªåˆ†å¸ƒå¼é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseDistributedLock</span><span class="params">(Long productId)</span> </span>&#123;</span><br><span class="line">        String path = <span class="string">"/product-lock-"</span> + productId;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zookeeper.delete(path, -<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">"release the lock for product[id="</span> + productId + <span class="string">"]......"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å»ºç«‹zk sessionçš„watcher</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> bingo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2018/11/29</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperWatcher</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Receive watched event: "</span> + event.getState());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (KeeperState.SyncConnected == event.getState()) &#123;</span><br><span class="line">                connectedSemaphore.countDown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.latch != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è£…å•ä¾‹çš„é™æ€å†…éƒ¨ç±»</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> bingo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 2018/11/29</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> ZooKeeperSession instance;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> ZooKeeperSession();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeperSession <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å•ä¾‹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeperSession <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Singleton.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–å•ä¾‹çš„ä¾¿æ·æ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥é‡‡ç”¨å¦ä¸€ç§æ–¹å¼ï¼Œåˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼š</p>
<p>å¦‚æœæœ‰ä¸€æŠŠé”ï¼Œè¢«å¤šä¸ªäººç»™ç«äº‰ï¼Œæ­¤æ—¶å¤šä¸ªäººä¼šæ’é˜Ÿï¼Œç¬¬ä¸€ä¸ªæ‹¿åˆ°é”çš„äººä¼šæ‰§è¡Œï¼Œç„¶åé‡Šæ”¾é”ï¼›åé¢çš„æ¯ä¸ªäººéƒ½ä¼šå»ç›‘å¬<strong>æ’åœ¨è‡ªå·±å‰é¢</strong>çš„é‚£ä¸ªäººåˆ›å»ºçš„ node ä¸Šï¼Œä¸€æ—¦æŸä¸ªäººé‡Šæ”¾äº†é”ï¼Œæ’åœ¨è‡ªå·±åé¢çš„äººå°±ä¼šè¢« zookeeper ç»™é€šçŸ¥ï¼Œä¸€æ—¦è¢«é€šçŸ¥äº†ä¹‹åï¼Œå°± ok äº†ï¼Œè‡ªå·±å°±è·å–åˆ°äº†é”ï¼Œå°±å¯ä»¥æ‰§è¡Œä»£ç äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperDistributedLock</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk;</span><br><span class="line">    <span class="keyword">private</span> String locksRoot = <span class="string">"/locks"</span>;</span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line">    <span class="keyword">private</span> String waitNode;</span><br><span class="line">    <span class="keyword">private</span> String lockNode;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch connectedLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> sessionTimeout = <span class="number">30000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZooKeeperDistributedLock</span><span class="params">(String productId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.productId = productId;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String address = <span class="string">"192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181"</span>;</span><br><span class="line">            zk = <span class="keyword">new</span> ZooKeeper(address, sessionTimeout, <span class="keyword">this</span>);</span><br><span class="line">            connectedLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event.getState() == KeeperState.SyncConnected) &#123;</span><br><span class="line">            connectedLatch.countDown();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.latch != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquireDistributedLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                waitForLock(waitNode, sessionTimeout);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"> 		    <span class="comment">// ä¼ å…¥è¿›å»çš„locksRoot + â€œ/â€ + productId</span></span><br><span class="line">		    <span class="comment">// å‡è®¾productIdä»£è¡¨äº†ä¸€ä¸ªå•†å“idï¼Œæ¯”å¦‚è¯´1</span></span><br><span class="line">		    <span class="comment">// locksRoot = locks</span></span><br><span class="line">		    <span class="comment">// /locks/10000000000ï¼Œ/locks/10000000001ï¼Œ/locks/10000000002</span></span><br><span class="line">            lockNode = zk.create(locksRoot + <span class="string">"/"</span> + productId, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// çœ‹çœ‹åˆšåˆ›å»ºçš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯æœ€å°çš„èŠ‚ç‚¹</span></span><br><span class="line">	 	    <span class="comment">// locksï¼š10000000000ï¼Œ10000000001ï¼Œ10000000002</span></span><br><span class="line">            List&lt;String&gt; locks = zk.getChildren(locksRoot, <span class="keyword">false</span>);</span><br><span class="line">            Collections.sort(locks);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(lockNode.equals(locksRoot+<span class="string">"/"</span>+ locks.get(<span class="number">0</span>)))&#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ˜¯æœ€å°çš„èŠ‚ç‚¹,åˆ™è¡¨ç¤ºå–å¾—é”</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å¦‚æœä¸æ˜¯æœ€å°çš„èŠ‚ç‚¹ï¼Œæ‰¾åˆ°æ¯”è‡ªå·±å°1çš„èŠ‚ç‚¹</span></span><br><span class="line">	  <span class="keyword">int</span> previousLockIndex = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; locks.size(); i++) &#123;</span><br><span class="line">		<span class="keyword">if</span>(lockNode.equals(locksRoot + â€œ/â€ + locks.get(i))) &#123;</span><br><span class="line">	         	    previousLockIndex = i - <span class="number">1</span>;</span><br><span class="line">		    <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	   &#125;</span><br><span class="line"></span><br><span class="line">	   <span class="keyword">this</span>.waitNode = locks.get(previousLockIndex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitForLock</span><span class="params">(String waitNode, <span class="keyword">long</span> waitTime)</span> <span class="keyword">throws</span> InterruptedException, KeeperException </span>&#123;</span><br><span class="line">        Stat stat = zk.exists(locksRoot + <span class="string">"/"</span> + waitNode, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (stat != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">this</span>.latch.await(waitTime, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">this</span>.latch = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ é™¤/locks/10000000000èŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">// åˆ é™¤/locks/10000000001èŠ‚ç‚¹</span></span><br><span class="line">            System.out.println(<span class="string">"unlock "</span> + lockNode);</span><br><span class="line">            zk.delete(lockNode, -<span class="number">1</span>);</span><br><span class="line">            lockNode = <span class="keyword">null</span>;</span><br><span class="line">            zk.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LockException</span><span class="params">(String e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LockException</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="zookeeper-åˆ†å¸ƒå¼é”å°ç»“"><a class="markdownIt-Anchor" href="#zookeeper-åˆ†å¸ƒå¼é”å°ç»“"></a> ZooKeeper åˆ†å¸ƒå¼é”å°ç»“</h3>
<p>ZooKeeper ç‰ˆæœ¬çš„åˆ†å¸ƒå¼é”é—®é¢˜ç›¸å¯¹æ¯”è¾ƒæ¥è¯´å°‘ã€‚</p>
<ul>
<li>é”çš„å ç”¨æ—¶é—´é™åˆ¶ï¼šredis å°±æœ‰å ç”¨æ—¶é—´é™åˆ¶ï¼Œè€Œ ZooKeeper åˆ™æ²¡æœ‰ï¼Œæœ€ä¸»è¦çš„åŸå› æ˜¯ redis ç›®å‰æ²¡æœ‰åŠæ³•çŸ¥é“å·²ç»è·å–é”çš„å®¢æˆ·ç«¯çš„çŠ¶æ€ï¼Œæ˜¯å·²ç»æŒ‚äº†å‘¢è¿˜æ˜¯æ­£åœ¨æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä¸šåŠ¡é€»è¾‘ã€‚è€Œ ZooKeeper é€šè¿‡ä¸´æ—¶èŠ‚ç‚¹å°±èƒ½æ¸…æ™°çŸ¥é“ï¼Œå¦‚æœä¸´æ—¶èŠ‚ç‚¹å­˜åœ¨è¯´æ˜è¿˜åœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æœä¸´æ—¶èŠ‚ç‚¹ä¸å­˜åœ¨è¯´æ˜å·²ç»æ‰§è¡Œå®Œæ¯•é‡Šæ”¾é”æˆ–è€…æ˜¯æŒ‚äº†ã€‚ç”±æ­¤çœ‹æ¥ redis å¦‚æœèƒ½åƒ ZooKeeper ä¸€æ ·æ·»åŠ ä¸€äº›ä¸å®¢æˆ·ç«¯ç»‘å®šçš„ä¸´æ—¶é”®ï¼Œä¹Ÿæ˜¯ä¸€å¤§å¥½äº‹ã€‚</li>
<li>æ˜¯å¦å•ç‚¹æ•…éšœï¼šredis æœ¬èº«æœ‰å¾ˆå¤šä¸­ç©æ³•ï¼Œå¦‚å®¢æˆ·ç«¯ä¸€è‡´æ€§ hashï¼ŒæœåŠ¡å™¨ç«¯ sentinel æ–¹æ¡ˆæˆ–è€… cluster æ–¹æ¡ˆï¼Œå¾ˆéš¾åšåˆ°ä¸€ç§åˆ†å¸ƒå¼é”æ–¹å¼èƒ½åº”å¯¹æ‰€æœ‰è¿™äº›æ–¹æ¡ˆã€‚è€Œ ZooKeeper åªæœ‰ä¸€ç§ç©æ³•ï¼Œå¤šå°æœºå™¨çš„èŠ‚ç‚¹æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œæ²¡æœ‰ redis çš„é‚£ä¹ˆå¤šçš„éº»çƒ¦å› ç´ è¦è€ƒè™‘ã€‚</li>
</ul>
<p>æ€»ä½“ä¸Šæ¥è¯´ ZooKeeper å®ç°åˆ†å¸ƒå¼é”æ›´åŠ çš„ç®€å•ï¼Œå¯é æ€§æ›´é«˜ã€‚ä½† ZooKeeper å› ä¸ºéœ€è¦é¢‘ç¹çš„åˆ›å»ºå’Œåˆ é™¤èŠ‚ç‚¹ï¼Œæ€§èƒ½ä¸Šä¸å¦‚ Redis æ–¹å¼ã€‚</p>
<h2 id="äº”-åˆ†å¸ƒå¼é”æ–¹æ¡ˆå¯¹æ¯”"><a class="markdownIt-Anchor" href="#äº”-åˆ†å¸ƒå¼é”æ–¹æ¡ˆå¯¹æ¯”"></a> äº”ã€ åˆ†å¸ƒå¼é”æ–¹æ¡ˆå¯¹æ¯”</h2>
<p>æ•°æ®åº“åˆ†å¸ƒå¼é”ï¼Œé—®é¢˜æ¯”è¾ƒå¤šï¼Œè§£å†³èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œä¸æ¨èã€‚</p>
<p>æ€§èƒ½ï¼š</p>
<ul>
<li>Redis åˆ†å¸ƒå¼é”ï¼Œå…¶å®<strong>éœ€è¦è‡ªå·±ä¸æ–­è‡ªæ—‹å»å°è¯•è·å–é”</strong>ï¼Œæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½ã€‚</li>
<li>ZooKeeper åˆ†å¸ƒå¼é”ï¼Œè·å–ä¸åˆ°é”ï¼Œæ³¨å†Œä¸ªç›‘å¬å™¨å³å¯ï¼Œä¸éœ€è¦ä¸æ–­ä¸»åŠ¨å°è¯•è·å–é”ï¼Œæ€§èƒ½å¼€é”€è¾ƒå°ã€‚</li>
</ul>
<p>å¯é æ€§ï¼š</p>
<ul>
<li>å¦‚æœæ˜¯ redis è·å–é”çš„é‚£ä¸ªå®¢æˆ·ç«¯å‡ºç° bug æŒ‚äº†ï¼Œé‚£ä¹ˆåªèƒ½ç­‰å¾…è¶…æ—¶æ—¶é—´ä¹‹åæ‰èƒ½é‡Šæ”¾é”ï¼›</li>
<li>è€Œ zk çš„è¯ï¼Œå› ä¸ºåˆ›å»ºçš„æ˜¯ä¸´æ—¶ znodeï¼Œåªè¦å®¢æˆ·ç«¯æŒ‚äº†ï¼Œznode å°±æ²¡äº†ï¼Œæ­¤æ—¶å°±è‡ªåŠ¨é‡Šæ”¾é”ã€‚</li>
</ul>
<p>ç»¼ä¸Šåˆ†æï¼Œ<strong>ZooKeeper å®ç°åˆ†å¸ƒå¼é”æ›´åŠ çš„ç®€å•ï¼Œå¯é æ€§æ›´é«˜</strong>ã€‚âœ…</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://juejin.im/post/5a20cd8bf265da43163cdd9a" target="_blank" rel="noopener">åˆ†å¸ƒå¼é”å®ç°æ±‡æ€»</a></li>
<li><a href="https://www.jianshu.com/p/1c5c1a592088" target="_blank" rel="noopener">Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œä»¥åŠå¯é‡å…¥é”æ€è·¯</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/network/network-interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/network/network-interview/" class="post-title-link" itemprop="url">ç½‘ç»œé€šä¿¡çŸ¥è¯†ç‚¹é¢ç»</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-02 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-02T00:00:00+08:00">2019-06-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index">
                    <span itemprop="name">ç½‘ç»œ</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/network/network-interview/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="network/network-interview/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>4 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç½‘ç»œé€šä¿¡çŸ¥è¯†ç‚¹é¢ç»"><a class="markdownIt-Anchor" href="#ç½‘ç»œé€šä¿¡çŸ¥è¯†ç‚¹é¢ç»"></a> ç½‘ç»œé€šä¿¡çŸ¥è¯†ç‚¹é¢ç»</h1>
<blockquote>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
<p>å¦‚æœä½ ä¸æ˜¯ä»äº‹äºé€šä¿¡é¢†åŸŸï¼Œé¢è¯•æ—¶é—®åŠè®¡ç®—æœºç½‘ç»œçš„çŸ¥è¯†ï¼Œä¸€èˆ¬ä¹Ÿå°±é™å®šåœ¨ï¼šHTTPï¼ˆå« HTTPSã€Cookieã€Sessionï¼‰ã€TCPã€UDPã€Socket è¿™äº›</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#1-%E7%BB%BC%E5%90%88">1. ç»¼åˆ</a>
<ul>
<li><a href="#11-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%A6%82%E4%BD%95%E5%88%86%E5%B1%82">1.1. è®¡ç®—æœºç½‘ç»œå¦‚ä½•åˆ†å±‚ï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#2-http">2. HTTP</a></li>
<li><a href="#3-dns">3. DNS</a></li>
<li><a href="#4-tcpudp">4. TCP/UDP</a>
<ul>
<li><a href="#41-%E4%BB%80%E4%B9%88%E6%98%AF-tcp">4.1. ä»€ä¹ˆæ˜¯ TCPï¼Ÿ</a></li>
<li><a href="#42-tcp-%E7%9A%84%E7%89%B9%E6%80%A7%E6%98%AF%E4%BB%80%E4%B9%88">4.2. TCP çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="#43-tcp-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B">4.3. TCP ä¸‰æ¬¡æ¡æ‰‹</a></li>
<li><a href="#44-tcp-%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B">4.4. TCP å››æ¬¡æŒ¥æ‰‹</a></li>
<li><a href="#45-tcp-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3">4.5. TCP æ»‘åŠ¨çª—å£</a></li>
<li><a href="#46-tcp-%E9%87%8D%E4%BC%A0%E6%9C%BA%E5%88%B6">4.6. TCP é‡ä¼ æœºåˆ¶</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="1-ç»¼åˆ"><a class="markdownIt-Anchor" href="#1-ç»¼åˆ"></a> 1. ç»¼åˆ</h2>
<h3 id="11-è®¡ç®—æœºç½‘ç»œå¦‚ä½•åˆ†å±‚"><a class="markdownIt-Anchor" href="#11-è®¡ç®—æœºç½‘ç»œå¦‚ä½•åˆ†å±‚"></a> 1.1. è®¡ç®—æœºç½‘ç»œå¦‚ä½•åˆ†å±‚ï¼Ÿ</h3>
<blockquote>
<p>â“ é—®é¢˜ï¼šè®¡ç®—æœºç½‘ç»œå¦‚ä½•åˆ†å±‚ï¼Ÿå„å±‚çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå„å±‚çš„ä¸»è¦åè®®ã€è®¾å¤‡åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>è¿™æ˜¯å­¦ä¹ è®¡ç®—æœºç½‘ç»œçŸ¥è¯†å®è§‚å±‚é¢å¿…é¡»è¦äº†è§£çš„æ ¸å¿ƒç‚¹ã€‚çŸ¥é“äº†è¿™äº›ï¼Œå¯¹äºç½‘ç»œçš„ä½“ç³»ç»“æ„å°±åŸºæœ¬ä¸Šäº†è§£äº†ã€‚</p>
</blockquote>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/network/overview/network-layers.png!zp"/></div>
è®¡ç®—æœºç½‘ç»œåˆ†å±‚ä¸€èˆ¬æœ‰ä¸‰ç§åˆ’åˆ†ä½“ç³»ï¼šOSI åˆ†å±‚ï¼›äº”å±‚åè®®åˆ†å±‚ï¼›TCP/IP åè®®åˆ†å±‚ã€‚
<ul>
<li>OSI çš„ä¸ƒå±‚ä½“ç³»ç»“æ„æ¦‚å¿µæ¸…æ¥šï¼Œç†è®ºå®Œæ•´ï¼Œä½†æ˜¯æ¯”è¾ƒå¤æ‚ä¸”ä¸å®ç”¨ï¼Œæ‰€ä»¥å¹¶ä¸æµè¡Œã€‚</li>
<li>äº”å±‚åè®®åˆ†å±‚æ˜¯ä¸€ç§æŠ˜ä¸­æ–¹æ¡ˆï¼Œåœ¨ç°å®ä¸­æ›´ä¸ºæµè¡Œã€‚</li>
</ul>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/network/overview/ç½‘ç»œåˆ†å±‚æ¶æ„å›¾.png!zp"/></div>
**ç‰©ç†å±‚**
<blockquote>
<p>ç‰©ç†å±‚ï¼ˆPhysical Layerï¼‰åªæ¥æ”¶å’Œå‘é€ä¸€ä¸²æ¯”ç‰¹(bit)æµï¼Œä¸è€ƒè™‘ä¿¡æ¯çš„æ„ä¹‰å’Œä¿¡æ¯ç»“æ„ã€‚</p>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="network-physical.md">è®¡ç®—æœºç½‘ç»œä¹‹ç‰©ç†å±‚</a></p>
</blockquote>
<ul>
<li>å…³é”®è¯ï¼šè°ƒåˆ¶ã€è§£è°ƒã€æ•°å­—ä¿¡å·ã€æ¨¡æ‹Ÿä¿¡å·ã€é€šä¿¡åª’ä»‹ã€ä¿¡é“å¤ç”¨</li>
<li>æ•°æ®å•å…ƒï¼šæ¯”ç‰¹æµã€‚</li>
<li>å…¸å‹è®¾å¤‡ï¼šå…‰çº¤ã€åŒè½´ç”µç¼†ã€åŒç»çº¿ã€ä¸­ç»§å™¨å’Œé›†çº¿å™¨ã€‚</li>
</ul>
<p><strong>æ•°æ®é“¾è·¯å±‚</strong></p>
<blockquote>
<p>ç½‘ç»œå±‚é’ˆå¯¹çš„è¿˜æ˜¯ä¸»æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“æœåŠ¡ï¼Œè€Œä¸»æœºä¹‹é—´å¯ä»¥æœ‰å¾ˆå¤šé“¾è·¯ï¼Œæ•°æ®é“¾è·¯å±‚ï¼ˆData Link Layerï¼‰å°±æ˜¯ä¸ºåŒä¸€é“¾è·¯çš„ä¸»æœºæä¾›æ•°æ®ä¼ è¾“æœåŠ¡ã€‚æ•°æ®é“¾è·¯å±‚æŠŠç½‘ç»œå±‚ä¼ ä¸‹æ¥çš„åˆ†ç»„å°è£…æˆå¸§ã€‚</p>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="network-data-link.md">è®¡ç®—æœºç½‘ç»œä¹‹æ•°æ®é“¾è·¯å±‚</a></p>
</blockquote>
<ul>
<li>å…³é”®è¯ï¼šç‚¹å¯¹ç‚¹ä¿¡é“ã€å¹¿æ’­ä¿¡é“ã€<code>PPP</code>ã€<code>CSMA/CD</code>ã€å±€åŸŸç½‘ã€ä»¥å¤ªç½‘ã€<code>MAC</code>ã€é€‚é…å™¨ã€é›†çº¿å™¨ã€ç½‘æ¡¥ã€äº¤æ¢æœº</li>
<li>ä¸»è¦åè®®ï¼š<code>PPP</code>ã€<code>CSMA/CD</code> ç­‰ã€‚</li>
<li>æ•°æ®å•å…ƒï¼šå¸§ï¼ˆframeï¼‰ã€‚</li>
<li>å…¸å‹è®¾å¤‡ï¼šäºŒå±‚äº¤æ¢æœºã€ç½‘æ¡¥ã€ç½‘å¡ã€‚</li>
</ul>
<p><strong>ç½‘ç»œå±‚</strong></p>
<blockquote>
<p>ç½‘ç»œå±‚ï¼ˆnetwork layerï¼‰ä¸ºåˆ†ç»„äº¤æ¢ç½‘ä¸Šçš„ä¸åŒä¸»æœºæä¾›é€šä¿¡æœåŠ¡ã€‚åœ¨å‘é€æ•°æ®æ—¶ï¼Œç½‘ç»œå±‚æŠŠè¿è¾“å±‚äº§ç”Ÿçš„æŠ¥æ–‡æ®µæˆ–ç”¨æˆ·æ•°æ®æŠ¥å°è£…æˆåˆ†ç»„æˆ–åŒ…è¿›è¡Œä¼ é€ã€‚</p>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="network-network.md">è®¡ç®—æœºç½‘ç»œä¹‹ç½‘ç»œå±‚</a></p>
</blockquote>
<ul>
<li>å…³é”®è¯ï¼š<code>IP</code>ã€<code>ICMP</code>ã€<code>ARP</code>ã€è·¯ç”±</li>
<li>ä¸»è¦åè®®ï¼š<code>IP</code>ã€‚</li>
<li>æ•°æ®å•å…ƒï¼šIP æ•°æ®æŠ¥ï¼ˆpacketï¼‰ã€‚</li>
<li>å…¸å‹è®¾å¤‡ï¼šç½‘å…³ã€è·¯ç”±å™¨ã€‚</li>
</ul>
<p><strong>ä¼ è¾“å±‚</strong></p>
<blockquote>
<p>ä¼ è¾“å±‚ï¼ˆtransport layerï¼‰ä¸ºä¸¤å°ä¸»æœºä¸­è¿›ç¨‹é—´çš„é€šä¿¡æä¾›é€šç”¨çš„æ•°æ®ä¼ è¾“æœåŠ¡ã€‚</p>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="network-network.md">è®¡ç®—æœºç½‘ç»œä¹‹ç½‘ç»œå±‚</a></p>
</blockquote>
<ul>
<li>å…³é”®è¯ï¼š<code>UDP</code>ã€<code>TCP</code>ã€æ»‘åŠ¨çª—å£ã€æ‹¥å¡æ§åˆ¶ã€ä¸‰æ¬¡æ¡æ‰‹</li>
<li>ä¸»è¦åè®®ï¼š<code>TCP</code>ã€<code>UDP</code>ã€‚</li>
<li>æ•°æ®å•å…ƒï¼šæŠ¥æ–‡æ®µï¼ˆsegmentï¼‰æˆ–ç”¨æˆ·æ•°æ®æŠ¥ã€‚</li>
</ul>
<p><sub>~**ä¼šè¯å±‚**~</sub></p>
<blockquote>
<p>~~ä¼šè¯å±‚ï¼ˆSession Layerï¼‰ä¸å‚ä¸å…·ä½“çš„ä¼ è¾“ï¼Œå®ƒæä¾›åŒ…æ‹¬è®¿é—®éªŒè¯å’Œä¼šè¯ç®¡ç†åœ¨å†…çš„å»ºç«‹å’Œç»´æŠ¤åº”ç”¨ä¹‹é—´é€šä¿¡çš„æœºåˆ¶ã€‚~~</p>
</blockquote>
<p><sub>~**è¡¨ç¤ºå±‚**~</sub></p>
<blockquote>
<p>~~è¡¨ç¤ºå±‚ï¼ˆPresentation Layerï¼‰æ˜¯ä¸ºåœ¨åº”ç”¨è¿‡ç¨‹ä¹‹é—´ä¼ é€çš„ä¿¡æ¯æä¾›è¡¨ç¤ºæ–¹æ³•çš„æœåŠ¡ï¼Œå®ƒå…³å¿ƒçš„åªæ˜¯å‘å‡ºä¿¡æ¯çš„è¯­æ³•ä¸è¯­ä¹‰ã€‚è¡¨ç¤ºå±‚è¦å®ŒæˆæŸäº›ç‰¹å®šçš„åŠŸèƒ½ï¼Œä¸»è¦æœ‰ä¸åŒæ•°æ®ç¼–ç æ ¼å¼çš„è½¬æ¢ï¼Œæä¾›æ•°æ®å‹ç¼©ã€è§£å‹ç¼©æœåŠ¡ï¼Œå¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ã€è§£å¯†ã€‚~~</p>
</blockquote>
<p><strong>åº”ç”¨å±‚</strong></p>
<blockquote>
<p>åº”ç”¨å±‚ï¼ˆapplication layerï¼‰é€šè¿‡åº”ç”¨è¿›ç¨‹é—´çš„äº¤äº’æ¥å®Œæˆç‰¹å®šç½‘ç»œåº”ç”¨ã€‚åº”ç”¨å±‚åè®®å®šä¹‰çš„æ˜¯åº”ç”¨è¿›ç¨‹é—´é€šä¿¡å’Œäº¤äº’çš„è§„åˆ™ã€‚</p>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="network-application.md">è®¡ç®—æœºç½‘ç»œä¹‹åº”ç”¨å±‚</a></p>
</blockquote>
<ul>
<li>å…³é”®è¯ï¼š<code>HTTP</code>ã€<code>DNS</code>ã€<code>FTP</code>ã€<code>TELNET</code>ã€<code>DHCP</code></li>
<li>ä¸»è¦åè®®ï¼š<code>HTTP</code>ã€<code>DNS</code>ã€<code>SMTP</code>ã€<code>Telnet</code>ã€<code>FTP</code>ã€<code>SNMP</code> ç­‰ã€‚</li>
<li>æ•°æ®å•å…ƒï¼šæŠ¥æ–‡ï¼ˆmessageï¼‰ã€‚</li>
</ul>
<h2 id="2-http"><a class="markdownIt-Anchor" href="#2-http"></a> 2. HTTP</h2>
<blockquote>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="http.md">è¶…æ–‡æœ¬ä¼ è¾“åè®® HTTP</a></p>
</blockquote>
<h2 id="3-dns"><a class="markdownIt-Anchor" href="#3-dns"></a> 3. DNS</h2>
<blockquote>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="dns.md">åŸŸåç³»ç»Ÿ DNS</a></p>
</blockquote>
<h2 id="4-tcpudp"><a class="markdownIt-Anchor" href="#4-tcpudp"></a> 4. TCP/UDP</h2>
<blockquote>
<p>æ‰©å±•é˜…è¯»ï¼š<a href="tcp.md">ä¼ è¾“æ§åˆ¶åè®® TCP</a>ï¼Œ<a href="udp.md">ç”¨æˆ·æ•°æ®æŠ¥åè®® UDP</a></p>
</blockquote>
<h3 id="41-ä»€ä¹ˆæ˜¯-tcp"><a class="markdownIt-Anchor" href="#41-ä»€ä¹ˆæ˜¯-tcp"></a> 4.1. ä»€ä¹ˆæ˜¯ TCPï¼Ÿ</h3>
<p><strong>TCPï¼ˆTransmission Control Protocolï¼‰ï¼Œå³ä¼ è¾“æ§åˆ¶åè®®ï¼Œå®ƒæ˜¯ä¸€ç§<code>é¢å‘è¿æ¥çš„</code>ã€<code>å¯é çš„</code>ã€<code>åŸºäºå­—èŠ‚æµçš„</code>ä¼ è¾“å±‚é€šä¿¡åè®®</strong>ã€‚</p>
<h3 id="42-tcp-çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#42-tcp-çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆ"></a> 4.2. TCP çš„ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<ul>
<li><code>é¢å‘è¿æ¥çš„</code> - é¢å‘è¿æ¥æ˜¯æŒ‡ TCP éœ€è¦é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹åŸåˆ™å»ºç«‹å’Œæ–­å¼€åŒå‘è¿æ¥ã€‚</li>
<li><code>å¯é çš„</code> - å¯é æ˜¯æŒ‡ TCP ä¼ è¾“çš„æ•°æ®åŒ…ä¿è¯ä»¥åŸå§‹é¡ºåºåˆ°è¾¾ç›®çš„åœ°ï¼Œä¸”æ•°æ®åŒ…ä¸è¢«æŸåã€‚ä¸ºäº†å®ç°è¿™ç‚¹ï¼ŒTCP é€šè¿‡ä»¥ä¸‹æŠ€æœ¯æ¥ä¿è¯ï¼š
<ul>
<li>æ•°æ®åŒ…çš„åºåˆ—å·å’Œæ ¡éªŒç </li>
<li>ç¡®è®¤åŒ…å’Œè‡ªåŠ¨é‡ä¼ 
<ul>
<li>å¦‚æœå‘é€è€…æ²¡æœ‰æ”¶åˆ°æ­£ç¡®çš„å“åº”ï¼Œå®ƒå°†é‡æ–°å‘é€æ•°æ®åŒ…ã€‚å¦‚æœå¤šæ¬¡è¶…æ—¶ï¼Œè¿æ¥å°±ä¼šæ–­å¼€ã€‚</li>
<li>TCP å®è¡Œæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶ã€‚è¿™äº›ç¡®ä¿æªæ–½ä¼šå¯¼è‡´å»¶è¿Ÿï¼Œè€Œä¸”é€šå¸¸å¯¼è‡´ä¼ è¾“æ•ˆç‡æ¯” UDP ä½ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>åŸºäºå­—èŠ‚æµçš„</code>
<ul>
<li>è™½ç„¶åº”ç”¨ç¨‹åºå’Œ TCP çš„äº¤äº’æ˜¯ä¸€æ¬¡ä¸€ä¸ªæ•°æ®å—ï¼ˆå¤§å°ä¸ç­‰ï¼‰ï¼Œä½† TCP æŠŠåº”ç”¨ç¨‹åºçœ‹æˆæ˜¯ä¸€è¿ä¸²çš„æ— ç»“æ„çš„å­—èŠ‚æµã€‚TCP æœ‰ä¸€ä¸ªç¼“å†²ï¼Œå½“åº”ç”¨ç¨‹åºä¼ é€çš„æ•°æ®å—å¤ªé•¿ï¼ŒTCP å°±å¯ä»¥æŠŠå®ƒåˆ’åˆ†çŸ­ä¸€äº›å†ä¼ é€ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¸€æ¬¡åªå‘é€ä¸€ä¸ªå­—èŠ‚ï¼ŒTCP ä¹Ÿå¯ä»¥ç­‰å¾…ç§¯ç´¯æœ‰è¶³å¤Ÿå¤šçš„å­—èŠ‚åå†æ„æˆæŠ¥æ–‡æ®µå‘é€å‡ºå»ã€‚</li>
<li>åœ¨ TCP å»ºç«‹è¿æ¥å‰ä¸¤æ¬¡æ¡æ‰‹çš„ SYN æŠ¥æ–‡ä¸­é€‰é¡¹å­—æ®µçš„ MSS å€¼ï¼Œé€šä¿¡åŒæ–¹å•†å®šé€šä¿¡çš„æœ€å¤§æŠ¥æ–‡é•¿åº¦ã€‚å¦‚æœåº”ç”¨å±‚äº¤ä»˜ä¸‹æ¥çš„æ•°æ®è¿‡å¤§ï¼Œå°±ä¼šå¯¹æ•°æ®åˆ†æ®µï¼Œç„¶åå‘é€ï¼›å¦åˆ™é€šè¿‡æ»‘åŠ¨çª—å£æ¥æ§åˆ¶é€šä¿¡åŒå‘çš„æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<h3 id="43-tcp-ä¸‰æ¬¡æ¡æ‰‹"><a class="markdownIt-Anchor" href="#43-tcp-ä¸‰æ¬¡æ¡æ‰‹"></a> 4.3. TCP ä¸‰æ¬¡æ¡æ‰‹</h3>
<blockquote>
<p>â“ é—®é¢˜ï¼šä¸‰æ¬¡æ¡æ‰‹æœ‰ä»€ä¹ˆç”¨ï¼Ÿä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</p>
</blockquote>
<p>ï¼ˆ1ï¼‰ä¸‰æ¬¡æ¡æ‰‹æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<ul>
<li>ä¸‰æ¬¡æ¡æ‰‹è´Ÿè´£å»ºç«‹ TCP åŒå‘è¿æ¥ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰ä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/network/transport/ä¸‰æ¬¡æ¡æ‰‹.gif!zp"/></div>
å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸‰æ¬¡æ¡æ‰‹æµç¨‹å¦‚ä¸‹ï¼š
<ol>
<li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¸¦æœ‰ SYN æ ‡å¿—çš„æ•°æ®åŒ…ã€‚</li>
<li>ç¬¬äºŒæ¬¡æ¡æ‰‹ - æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€å¸¦æœ‰ SYN/ACK æ ‡å¿—çš„æ•°æ®åŒ…ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¸¦æœ‰å¸¦æœ‰ ACK æ ‡å¿—çš„æ•°æ®åŒ…ã€‚</li>
</ol>
<p>è‡³æ­¤ï¼ŒTCP ä¸‰æ¬¡æ¡æ‰‹å®Œæˆï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å·²å»ºç«‹åŒå‘è¿æ¥ã€‚</p>
<blockquote>
<p>ğŸ’¡ è¯´æ˜ï¼šSYN ä¸º synchronize çš„ç¼©å†™ï¼ŒACK ä¸º acknowledgment çš„ç¼©å†™ã€‚</p>
</blockquote>
<p>ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</p>
<p>ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œå‡è®¾å®¢æˆ·ç«¯ä¸º A, æœåŠ¡ç«¯ä¸º Bã€‚</p>
<ol>
<li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ŒA å‘ B å‘åŒæ­¥æ¶ˆæ¯ã€‚B æ”¶åˆ°æ¶ˆæ¯åï¼ŒB è®¤ä¸ºï¼šA å‘æ¶ˆæ¯æ²¡é—®é¢˜ï¼›B æ”¶æ¶ˆæ¯æ²¡é—®é¢˜ã€‚</li>
<li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼ŒB å‘ A å‘åŒæ­¥æ¶ˆæ¯å’Œç¡®è®¤æ¶ˆæ¯ã€‚A æ”¶åˆ°æ¶ˆæ¯åï¼ŒA è®¤ä¸ºï¼šA å‘æ¶ˆæ¯ã€æ”¶æ¶ˆæ¯éƒ½æ²¡é—®é¢˜ï¼›B å‘æ¶ˆæ¯ã€æ”¶æ¶ˆæ¯éƒ½æ²¡é—®é¢˜ã€‚<strong>ä½†æ˜¯ï¼Œæ­¤æ—¶ B ä¸ç¡®å®šè‡ªå·±å‘æ¶ˆæ¯æ˜¯å¦æ²¡é—®é¢˜</strong>ï¼Œæ‰€ä»¥å°±éœ€è¦ç¬¬ä¸‰æ¬¡æ¡æ‰‹ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼ŒA å‘ B å‘ç¡®è®¤æ¶ˆæ¯ã€‚B æ”¶åˆ°æ¶ˆæ¯åã€‚B è®¤ä¸ºï¼šB å‘æ¶ˆæ¯æ²¡é—®é¢˜ã€‚</li>
</ol>
<h3 id="44-tcp-å››æ¬¡æŒ¥æ‰‹"><a class="markdownIt-Anchor" href="#44-tcp-å››æ¬¡æŒ¥æ‰‹"></a> 4.4. TCP å››æ¬¡æŒ¥æ‰‹</h3>
<blockquote>
<p>â“ é—®é¢˜ï¼šå››æ¬¡æŒ¥æ‰‹æœ‰ä»€ä¹ˆç”¨ï¼Ÿä»€ä¹ˆæ˜¯å››æ¬¡æŒ¥æ‰‹ï¼Ÿä¸ºä»€ä¹ˆå»ºç«‹è¿æ¥æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œå…³é—­è¿æ¥ç¡®æ˜¯å››æ¬¡æŒ¥æ‰‹å‘¢ï¼Ÿ</p>
</blockquote>
<p>ï¼ˆ1ï¼‰å››æ¬¡æŒ¥æ‰‹æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<ul>
<li>å››æ¬¡æŒ¥æ‰‹è´Ÿè´£æ–­å¼€ TCP è¿æ¥ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰ä»€ä¹ˆæ˜¯å››æ¬¡æŒ¥æ‰‹ï¼Ÿ</p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå››æ¬¡æŒ¥æ‰‹æµç¨‹å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/network/transport/å››æ¬¡æŒ¥æ‰‹.gif!zp"/></div>
1. ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ª FIN åŒ…ï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„æ•°æ®ä¼ é€ã€‚
2. ç¬¬äºŒæ¬¡æŒ¥æ‰‹ - æœåŠ¡ç«¯æ”¶åˆ°è¿™ä¸ª FIN åŒ…ï¼Œå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª ACK åŒ…ï¼Œç¡®è®¤åºå·ä¸ºæ”¶åˆ°çš„åºå·åŠ  1ã€‚å’Œ SYN ä¸€æ ·ï¼Œä¸€ä¸ª FIN å°†å ç”¨ä¸€ä¸ªåºå·ã€‚
3. ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ - æœåŠ¡ç«¯å…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª FIN åŒ…ã€‚
4. ç¬¬å››æ¬¡æŒ¥æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ ACK åŒ…ï¼Œå¹¶å°†ç¡®è®¤åºå·è®¾ç½®ä¸ºæ”¶åˆ°åºå·åŠ  1ã€‚
<p>ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆå»ºç«‹è¿æ¥æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œå…³é—­è¿æ¥ç¡®æ˜¯å››æ¬¡æŒ¥æ‰‹å‘¢ï¼Ÿ</p>
<ul>
<li>å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œ æœåŠ¡å™¨åœ¨ LISTEN çŠ¶æ€ä¸‹ï¼Œæ”¶åˆ°å»ºç«‹è¿æ¥è¯·æ±‚çš„ SYN æŠ¥æ–‡åï¼ŒæŠŠ ACK å’Œ SYN æ”¾åœ¨ä¸€ä¸ªæŠ¥æ–‡é‡Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>è€Œå…³é—­è¿æ¥æ—¶ï¼ŒæœåŠ¡å™¨æ”¶åˆ°å¯¹æ–¹çš„ FIN æŠ¥æ–‡æ—¶ï¼Œä»…ä»…è¡¨ç¤ºå¯¹æ–¹ä¸å†å‘é€æ•°æ®äº†ä½†æ˜¯è¿˜èƒ½æ¥æ”¶æ•°æ®ï¼Œè€Œè‡ªå·±ä¹Ÿæœªå¿…å…¨éƒ¨æ•°æ®éƒ½å‘é€ç»™å¯¹æ–¹äº†ï¼Œæ‰€ä»¥å·±æ–¹å¯ä»¥ç«‹å³å…³é—­ï¼Œä¹Ÿå¯ä»¥å‘é€ä¸€äº›æ•°æ®ç»™å¯¹æ–¹åï¼Œå†å‘é€ FIN æŠ¥æ–‡ç»™å¯¹æ–¹æ¥è¡¨ç¤ºåŒæ„ç°åœ¨å…³é—­è¿æ¥ï¼Œå› æ­¤ï¼Œå·±æ–¹ ACK å’Œ FIN ä¸€èˆ¬éƒ½ä¼šåˆ†å¼€å‘é€ï¼Œä»è€Œå¯¼è‡´å¤šäº†ä¸€æ¬¡ã€‚</li>
</ul>
<h3 id="45-tcp-æ»‘åŠ¨çª—å£"><a class="markdownIt-Anchor" href="#45-tcp-æ»‘åŠ¨çª—å£"></a> 4.5. TCP æ»‘åŠ¨çª—å£</h3>
<blockquote>
<p>â“ é—®é¢˜ï¼šä»€ä¹ˆæ˜¯æ»‘åŠ¨çª—å£ï¼Ÿæ»‘åŠ¨çª—å£åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<p>ä»€ä¹ˆæ˜¯æ»‘åŠ¨çª—å£ï¼Ÿ</p>
<p><strong>æ»‘åŠ¨çª—å£æ˜¯ TCP çš„ä¸€ç§æ§åˆ¶ç½‘ç»œæµé‡çš„æŠ€æœ¯ã€‚</strong></p>
<p><strong>TCP å¿…éœ€è¦è§£å†³çš„å¯é ä¼ è¾“ä»¥åŠåŒ…ä¹±åºï¼ˆreorderingï¼‰çš„é—®é¢˜</strong>ï¼Œæ‰€ä»¥ï¼ŒTCP å¿…éœ€è¦çŸ¥é“ç½‘ç»œå®é™…çš„æ•°æ®å¤„ç†å¸¦å®½æˆ–æ˜¯æ•°æ®å¤„ç†é€Ÿåº¦ï¼Œè¿™æ ·æ‰ä¸ä¼šå¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´ä¸¢åŒ…ã€‚</p>
<p>TCP å¤´é‡Œæœ‰ä¸€ä¸ªå­—æ®µå« Windowï¼Œåˆå« Advertised-Windowï¼Œè¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶ç«¯å‘Šè¯‰å‘é€ç«¯è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥æ”¶æ•°æ®ã€‚<strong>äºæ˜¯å‘é€ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›æ¥å‘é€æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥</strong>ã€‚</p>
<p>æ»‘åŠ¨çª—å£åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559265819762.png!zp"/></div>
1. å·²å‘é€å·²ç¡®è®¤ - æ•°æ®æµä¸­æœ€æ—©çš„å­—èŠ‚å·²ç»å‘é€å¹¶å¾—åˆ°ç¡®è®¤ã€‚è¿™äº›æ•°æ®æ˜¯ç«™åœ¨å‘é€ç«¯çš„è§’åº¦æ¥çœ‹çš„ã€‚ä¸Šå›¾ä¸­çš„ 31 ä¸ªå­—èŠ‚å·²ç»å‘é€å¹¶ç¡®è®¤ã€‚
2. å·²å‘é€ä½†å°šæœªç¡®è®¤ - å·²å‘é€ä½†å°šæœªå¾—åˆ°ç¡®è®¤çš„å­—èŠ‚ã€‚å‘é€æ–¹åœ¨ç¡®è®¤ä¹‹å‰ï¼Œä¸è®¤ä¸ºè¿™äº›æ•°æ®å·²ç»è¢«å¤„ç†ã€‚ä¸Šå›¾ä¸­çš„ 32 \~ 45 å­—èŠ‚ä¸ºç¬¬ 2 ç±»ã€‚
3. æœªå‘é€è€Œæ¥æ”¶æ–¹å·² Ready - è®¾å¤‡å°šæœªå°†æ•°æ®å‘å‡º ï¼Œä½†æ¥æ”¶æ–¹æ ¹æ®æœ€è¿‘ä¸€æ¬¡å…³äºå‘é€æ–¹ä¸€æ¬¡è¦å‘é€å¤šå°‘å­—èŠ‚ç¡®è®¤è‡ªå·±æœ‰è¶³å¤Ÿç©ºé—´ã€‚å‘é€æ–¹ä¼šç«‹å³å°è¯•å‘é€ã€‚ä¸Šå›¾ä¸­çš„ 46 \~ 51 å­—èŠ‚ä¸ºç¬¬ 3 ç±»ã€‚
4. æœªå‘é€è€Œæ¥æ”¶æ–¹ Not Ready - ç”±äºæ¥æ”¶æ–¹ not readyï¼Œè¿˜ä¸å…è®¸å°†è¿™éƒ¨åˆ†æ•°æ®å‘å‡ºã€‚ä¸Šå›¾ä¸­çš„ 52 ä»¥åçš„å­—èŠ‚ä¸ºç¬¬ 4 ç±»ã€‚
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559265927658.png!zp"/></div>
è¿™å¼ å›¾ç‰‡ç›¸å¯¹äºä¸Šä¸€å¼ å›¾ç‰‡ï¼Œæ»‘åŠ¨çª—å£åç§»äº† 5 ä¸ªå­—èŠ‚ï¼Œæ„å‘³ç€æœ‰ 5 ä¸ªå·²å‘é€çš„å­—èŠ‚å¾—åˆ°äº†ç¡®è®¤ã€‚
<h3 id="46-tcp-é‡ä¼ æœºåˆ¶"><a class="markdownIt-Anchor" href="#46-tcp-é‡ä¼ æœºåˆ¶"></a> 4.6. TCP é‡ä¼ æœºåˆ¶</h3>
<blockquote>
<p>â“ é—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦é‡ä¼ æœºåˆ¶ï¼ŸTCP æœ‰å“ªäº›é‡ä¼ æœºåˆ¶ï¼ŒåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<p>TCP è¦ä¿è¯æ‰€æœ‰çš„æ•°æ®åŒ…éƒ½å¯ä»¥åˆ°è¾¾ï¼Œæ‰€ä»¥ï¼Œå¿…éœ€è¦æœ‰é‡ä¼ æœºåˆ¶ã€‚</p>
<p>TCP é‡ä¼ æœºåˆ¶ä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>è¶…æ—¶é‡ä¼ æœºåˆ¶</li>
<li>å¿«é€Ÿé‡ä¼ æœºåˆ¶</li>
</ul>
<p>ï¼ˆ1ï¼‰è¶…æ—¶é‡ä¼ æœºåˆ¶</p>
<p>è¶…æ—¶é‡ä¼ æœºåˆ¶æ˜¯æŒ‡ï¼šå‘é€æ•°æ®åŒ…åœ¨ä¸€å®šçš„æ—¶é—´å‘¨æœŸå†…æ²¡æœ‰æ”¶åˆ°ç›¸åº”çš„ ACKï¼Œç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œè¶…æ—¶ä¹‹åå°±è®¤ä¸ºè¿™ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œå°±ä¼šé‡æ–°å‘é€ã€‚è¿™ä¸ªç­‰å¾…æ—¶é—´è¢«ç§°ä¸º RTO(Retransmission TimeOut)ï¼Œå³é‡ä¼ è¶…æ—¶æ—¶é—´ã€‚</p>
<p>æ²¡æœ‰ç¡®è®¤çš„æ•°æ®åŒ…ä¸ä¼šä»çª—å£ä¸­ç§»èµ°ï¼Œå®šæ—¶å™¨åœ¨é‡ä¼ æ—¶é—´åˆ°æœŸå†…ï¼Œæ¯ä¸ªç‰‡æ®µçš„ä½ç½®ä¸å˜ã€‚</p>
<p>è¿™ç§æœºåˆ¶çš„é‡ç‚¹æ˜¯ RTO çš„è®¾ç½®ï¼š</p>
<ul>
<li>RTO è®¾é•¿äº†ï¼Œé‡å‘å°±æ…¢ï¼Œä¸¢äº†è€åŠå¤©æ‰é‡å‘ï¼Œæ²¡æœ‰æ•ˆç‡ï¼Œæ€§èƒ½å·®ï¼›</li>
<li>RTO è®¾çŸ­äº†ï¼Œä¼šå¯¼è‡´å¯èƒ½å¹¶æ²¡æœ‰ä¸¢å°±é‡å‘ã€‚äºæ˜¯é‡å‘çš„å°±å¿«ï¼Œä¼šå¢åŠ ç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´æ›´å¤šçš„è¶…æ—¶ï¼Œæ›´å¤šçš„è¶…æ—¶å¯¼è‡´æ›´å¤šçš„é‡å‘</li>
</ul>
<p>ï¼ˆ2ï¼‰å¿«é€Ÿé‡ä¼ æœºåˆ¶</p>
<p>å¿«é€Ÿé‡ä¼ æœºåˆ¶ï¼Œå®ç°äº†å¦å¤–çš„ä¸€ç§ä¸¢åŒ…è¯„å®šæ ‡å‡†ï¼Œå³å¦‚æœè¿ç»­æ”¶åˆ° 3 æ¬¡é‡å¤ ACKï¼Œå‘é€æ–¹å°±è®¤ä¸ºè¿™ä¸ª seq çš„åŒ…ä¸¢å¤±äº†ï¼Œç«‹åˆ»è¿›è¡Œé‡ä¼ ã€‚</p>
<p>å½“æ¥æ”¶æ–¹æ”¶åˆ°ä¹±åºç‰‡æ®µæ—¶ï¼Œéœ€è¦é‡å¤å‘é€ ACKã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/blog/network/tcp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content="Dunwu's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/network/tcp/" class="post-title-link" itemprop="url">ç½‘ç»œåè®®ä¹‹ TCP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-05-31 11:51:00" itemprop="dateCreated datePublished" datetime="2019-05-31T11:51:00+08:00">2019-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-20 17:57:52" itemprop="dateModified" datetime="2021-01-20T17:57:52+08:00">2021-01-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index">
                    <span itemprop="name">ç½‘ç»œ</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/blog/network/tcp/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="network/tcp/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>3 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç½‘ç»œåè®®ä¹‹-tcp"><a class="markdownIt-Anchor" href="#ç½‘ç»œåè®®ä¹‹-tcp"></a> ç½‘ç»œåè®®ä¹‹ TCP</h1>
<blockquote>
<p>ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ<a href="https://github.com/dunwu/blog" target="_blank" rel="noopener">blog</a>ã€</p>
</blockquote>
<!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-tcp">ä»€ä¹ˆæ˜¯ TCP</a></li>
<li><a href="#tcp-%E7%9A%84%E7%89%B9%E6%80%A7">TCP çš„ç‰¹æ€§</a></li>
<li><a href="#tcp-%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF">TCP çš„é€‚ç”¨åœºæ™¯</a></li>
<li><a href="#tcp-%E6%8A%A5%E6%96%87">TCP æŠ¥æ–‡</a></li>
</ul>
</li>
<li><a href="#tcp-%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B">TCP é€šä¿¡æµç¨‹</a>
<ul>
<li><a href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B">ä¸‰æ¬¡æ¡æ‰‹</a></li>
<li><a href="#%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B">å››æ¬¡æŒ¥æ‰‹</a></li>
</ul>
</li>
<li><a href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3">æ»‘åŠ¨çª—å£</a></li>
<li><a href="#tcp-%E9%87%8D%E4%BC%A0%E6%9C%BA%E5%88%B6">TCP é‡ä¼ æœºåˆ¶</a>
<ul>
<li><a href="#%E8%B6%85%E6%97%B6%E9%87%8D%E4%BC%A0%E6%9C%BA%E5%88%B6">è¶…æ—¶é‡ä¼ æœºåˆ¶</a></li>
<li><a href="#%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0%E6%9C%BA%E5%88%B6">å¿«é€Ÿé‡ä¼ æœºåˆ¶</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
</ul>
<!-- /TOC -->
<h2 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h2>
<h3 id="ä»€ä¹ˆæ˜¯-tcp"><a class="markdownIt-Anchor" href="#ä»€ä¹ˆæ˜¯-tcp"></a> ä»€ä¹ˆæ˜¯ TCP</h3>
<p><strong>TCPï¼ˆTransmission Control Protocolï¼‰ï¼Œå³ä¼ è¾“æ§åˆ¶åè®®ï¼Œå®ƒæ˜¯ä¸€ç§<code>é¢å‘è¿æ¥çš„</code>ã€<code>å¯é çš„</code>ã€<code>åŸºäºå­—èŠ‚æµçš„</code>ä¼ è¾“å±‚é€šä¿¡åè®®</strong>ã€‚TCP ç”± RFC 793 å®šä¹‰ã€‚</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559263786555.png!zp"/></div>
<h3 id="tcp-çš„ç‰¹æ€§"><a class="markdownIt-Anchor" href="#tcp-çš„ç‰¹æ€§"></a> TCP çš„ç‰¹æ€§</h3>
<ul>
<li><code>é¢å‘è¿æ¥çš„</code> - é¢å‘è¿æ¥æ˜¯æŒ‡ TCP éœ€è¦é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹åŸåˆ™å»ºç«‹å’Œæ–­å¼€åŒå‘è¿æ¥ã€‚</li>
<li><code>å¯é çš„</code> - å¯é æ˜¯æŒ‡ TCP ä¼ è¾“çš„æ•°æ®åŒ…ä¿è¯ä»¥åŸå§‹é¡ºåºåˆ°è¾¾ç›®çš„åœ°ï¼Œä¸”æ•°æ®åŒ…ä¸è¢«æŸåã€‚ä¸ºäº†å®ç°è¿™ç‚¹ï¼ŒTCP é€šè¿‡ä»¥ä¸‹æŠ€æœ¯æ¥ä¿è¯ï¼š
<ul>
<li>æ•°æ®åŒ…çš„åºåˆ—å·å’Œæ ¡éªŒç </li>
<li>ç¡®è®¤åŒ…å’Œè‡ªåŠ¨é‡ä¼ 
<ul>
<li>å¦‚æœå‘é€è€…æ²¡æœ‰æ”¶åˆ°æ­£ç¡®çš„å“åº”ï¼Œå®ƒå°†é‡æ–°å‘é€æ•°æ®åŒ…ã€‚å¦‚æœå¤šæ¬¡è¶…æ—¶ï¼Œè¿æ¥å°±ä¼šæ–­å¼€ã€‚</li>
<li>TCP å®è¡Œæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶ã€‚è¿™äº›ç¡®ä¿æªæ–½ä¼šå¯¼è‡´å»¶è¿Ÿï¼Œè€Œä¸”é€šå¸¸å¯¼è‡´ä¼ è¾“æ•ˆç‡æ¯” UDP ä½ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>åŸºäºå­—èŠ‚æµçš„</code>
<ul>
<li>è™½ç„¶åº”ç”¨ç¨‹åºå’Œ TCP çš„äº¤äº’æ˜¯ä¸€æ¬¡ä¸€ä¸ªæ•°æ®å—ï¼ˆå¤§å°ä¸ç­‰ï¼‰ï¼Œä½† TCP æŠŠåº”ç”¨ç¨‹åºçœ‹æˆæ˜¯ä¸€è¿ä¸²çš„æ— ç»“æ„çš„å­—èŠ‚æµã€‚TCP æœ‰ä¸€ä¸ªç¼“å†²ï¼Œå½“åº”ç”¨ç¨‹åºä¼ é€çš„æ•°æ®å—å¤ªé•¿ï¼ŒTCP å°±å¯ä»¥æŠŠå®ƒåˆ’åˆ†çŸ­ä¸€äº›å†ä¼ é€ã€‚å¦‚æœåº”ç”¨ç¨‹åºä¸€æ¬¡åªå‘é€ä¸€ä¸ªå­—èŠ‚ï¼ŒTCP ä¹Ÿå¯ä»¥ç­‰å¾…ç§¯ç´¯æœ‰è¶³å¤Ÿå¤šçš„å­—èŠ‚åå†æ„æˆæŠ¥æ–‡æ®µå‘é€å‡ºå»ã€‚</li>
<li>åœ¨ TCP å»ºç«‹è¿æ¥å‰ä¸¤æ¬¡æ¡æ‰‹çš„ SYN æŠ¥æ–‡ä¸­é€‰é¡¹å­—æ®µçš„ MSS å€¼ï¼Œé€šä¿¡åŒæ–¹å•†å®šé€šä¿¡çš„æœ€å¤§æŠ¥æ–‡é•¿åº¦ã€‚å¦‚æœåº”ç”¨å±‚äº¤ä»˜ä¸‹æ¥çš„æ•°æ®è¿‡å¤§ï¼Œå°±ä¼šå¯¹æ•°æ®åˆ†æ®µï¼Œç„¶åå‘é€ï¼›å¦åˆ™é€šè¿‡æ»‘åŠ¨çª—å£æ¥æ§åˆ¶é€šä¿¡åŒå‘çš„æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<h3 id="tcp-çš„é€‚ç”¨åœºæ™¯"><a class="markdownIt-Anchor" href="#tcp-çš„é€‚ç”¨åœºæ™¯"></a> TCP çš„é€‚ç”¨åœºæ™¯</h3>
<p>åŸºäºä»¥ä¸Šç‰¹æ€§ï¼Œä¸ºäº†ç¡®ä¿é«˜ååé‡ï¼ŒWeb æœåŠ¡å™¨å¯ä»¥ä¿æŒå¤§é‡çš„ TCP è¿æ¥ï¼Œä»è€Œå¯¼è‡´é«˜å†…å­˜ä½¿ç”¨ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Web æœåŠ¡å™¨çº¿ç¨‹é—´æ‹¥æœ‰å¤§é‡å¼€æ”¾è¿æ¥å¯èƒ½å¼€é”€å·¨å¤§ï¼Œæ¶ˆè€—èµ„æºè¿‡å¤šï¼Œè¿™æ—¶å¯ä»¥è€ƒè™‘åœ¨é€‚ç”¨æƒ…å†µä¸‹åˆ‡æ¢åˆ° UDPã€‚</p>
<p>TCP å¯¹äºéœ€è¦é«˜å¯é æ€§ä½†æ—¶é—´ç´§è¿«çš„åº”ç”¨ç¨‹åºå¾ˆæœ‰ç”¨ã€‚æ¯”å¦‚åŒ…æ‹¬ Web æœåŠ¡å™¨ï¼Œæ•°æ®åº“ä¿¡æ¯ï¼ŒSMTPï¼ŒFTP å’Œ SSHã€‚</p>
<p>ä»¥ä¸‹æƒ…å†µä½¿ç”¨ TCP ä»£æ›¿ UDPï¼š</p>
<ul>
<li>ä½ éœ€è¦æ•°æ®å®Œå¥½æ— æŸã€‚</li>
<li>ä½ æƒ³å¯¹ç½‘ç»œååé‡è‡ªåŠ¨è¿›è¡Œæœ€ä½³è¯„ä¼°ã€‚</li>
</ul>
<h3 id="tcp-æŠ¥æ–‡"><a class="markdownIt-Anchor" href="#tcp-æŠ¥æ–‡"></a> TCP æŠ¥æ–‡</h3>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559264511812.png!zp"/></div>
<p>æŠ¥æ–‡å­—æ®µä¸ä¸€ä¸€é˜è¿°ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>TCP çš„åŒ…æ˜¯æ²¡æœ‰ IP åœ°å€çš„ï¼Œé‚£æ˜¯ IP å±‚ä¸Šçš„äº‹ã€‚ä½†æ˜¯æœ‰æºç«¯å£å’Œç›®æ ‡ç«¯å£ã€‚</li>
<li>ä¸€ä¸ª TCP è¿æ¥éœ€è¦å››ä¸ªå…ƒç»„æ¥è¡¨ç¤ºæ˜¯åŒä¸€ä¸ªè¿æ¥ï¼ˆsrc_ip, src_port, dst_ip, dst_portï¼‰å‡†ç¡®è¯´æ˜¯äº”å…ƒç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åè®®ã€‚ä½†å› ä¸ºè¿™é‡Œåªæ˜¯è¯´ TCP åè®®ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘åªè¯´å››å…ƒç»„ã€‚</li>
<li>æ³¨æ„ä¸Šå›¾ä¸­çš„å››ä¸ªéå¸¸é‡è¦çš„ä¸œè¥¿ï¼š
<ul>
<li><strong>Sequence Number</strong>æ˜¯åŒ…çš„åºå·ï¼Œ<strong>ç”¨æ¥è§£å†³ç½‘ç»œåŒ…ä¹±åºï¼ˆreorderingï¼‰é—®é¢˜ã€‚</strong></li>
<li><strong>Acknowledgement Number</strong>å°±æ˜¯ ACKâ€”â€”ç”¨äºç¡®è®¤æ”¶åˆ°ï¼Œ<strong>ç”¨æ¥è§£å†³ä¸ä¸¢åŒ…çš„é—®é¢˜</strong>ã€‚</li>
<li><strong>Window åˆå« Advertised-Window</strong>ï¼Œä¹Ÿå°±æ˜¯è‘—åçš„æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰ï¼Œ<strong>ç”¨äºè§£å†³æµæ§çš„</strong>ã€‚</li>
<li><strong>TCP Flag</strong>ï¼Œä¹Ÿå°±æ˜¯åŒ…çš„ç±»å‹ï¼Œ<strong>ä¸»è¦æ˜¯ç”¨äºæ“æ§ TCP çš„çŠ¶æ€æœºçš„</strong>ã€‚</li>
</ul>
</li>
</ul>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559264593860.png!zp"/></div>
<h2 id="tcp-é€šä¿¡æµç¨‹"><a class="markdownIt-Anchor" href="#tcp-é€šä¿¡æµç¨‹"></a> TCP é€šä¿¡æµç¨‹</h2>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559264679371.png!zp"/></div>
<p>TCP å®Œæ•´çš„é€šä¿¡åˆ†ä¸ºä¸‰å—ï¼š</p>
<ol>
<li>ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥</li>
<li>æ•°æ®ä¼ è¾“</li>
<li>å››æ¬¡æŒ¥æ‰‹ç«¯å£è¿æ¥</li>
</ol>
<h3 id="ä¸‰æ¬¡æ¡æ‰‹"><a class="markdownIt-Anchor" href="#ä¸‰æ¬¡æ¡æ‰‹"></a> ä¸‰æ¬¡æ¡æ‰‹</h3>
<p>ï¼ˆ1ï¼‰ä¸‰æ¬¡æ¡æ‰‹æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<ul>
<li>ä¸‰æ¬¡æ¡æ‰‹è´Ÿè´£å»ºç«‹ TCP åŒå‘è¿æ¥ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰ä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/network/transport/ä¸‰æ¬¡æ¡æ‰‹.gif!zp"/></div>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸‰æ¬¡æ¡æ‰‹æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¸¦æœ‰ SYN æ ‡å¿—çš„æ•°æ®åŒ…ã€‚</li>
<li>ç¬¬äºŒæ¬¡æ¡æ‰‹ - æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€å¸¦æœ‰ SYN/ACK æ ‡å¿—çš„æ•°æ®åŒ…ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€å¸¦æœ‰å¸¦æœ‰ ACK æ ‡å¿—çš„æ•°æ®åŒ…ã€‚</li>
</ol>
<p>è‡³æ­¤ï¼ŒTCP ä¸‰æ¬¡æ¡æ‰‹å®Œæˆï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å·²å»ºç«‹åŒå‘è¿æ¥ã€‚</p>
<blockquote>
<p>ğŸ’¡ è¯´æ˜ï¼šSYN ä¸º synchronize çš„ç¼©å†™ï¼ŒACK ä¸º acknowledgment çš„ç¼©å†™ã€‚</p>
</blockquote>
<p>ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿ</p>
<p>ä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œå‡è®¾å®¢æˆ·ç«¯ä¸º A, æœåŠ¡ç«¯ä¸º Bã€‚</p>
<ol>
<li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼ŒA å‘ B å‘åŒæ­¥æ¶ˆæ¯ã€‚B æ”¶åˆ°æ¶ˆæ¯åï¼ŒB è®¤ä¸ºï¼šA å‘æ¶ˆæ¯æ²¡é—®é¢˜ï¼›B æ”¶æ¶ˆæ¯æ²¡é—®é¢˜ã€‚</li>
<li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼ŒB å‘ A å‘åŒæ­¥æ¶ˆæ¯å’Œç¡®è®¤æ¶ˆæ¯ã€‚A æ”¶åˆ°æ¶ˆæ¯åï¼ŒA è®¤ä¸ºï¼šA å‘æ¶ˆæ¯ã€æ”¶æ¶ˆæ¯éƒ½æ²¡é—®é¢˜ï¼›B å‘æ¶ˆæ¯ã€æ”¶æ¶ˆæ¯éƒ½æ²¡é—®é¢˜ã€‚<strong>ä½†æ˜¯ï¼Œæ­¤æ—¶ B ä¸ç¡®å®šè‡ªå·±å‘æ¶ˆæ¯æ˜¯å¦æ²¡é—®é¢˜</strong>ï¼Œæ‰€ä»¥å°±éœ€è¦ç¬¬ä¸‰æ¬¡æ¡æ‰‹ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼ŒA å‘ B å‘ç¡®è®¤æ¶ˆæ¯ã€‚B æ”¶åˆ°æ¶ˆæ¯åã€‚B è®¤ä¸ºï¼šB å‘æ¶ˆæ¯æ²¡é—®é¢˜ã€‚</li>
</ol>
<h3 id="å››æ¬¡æŒ¥æ‰‹"><a class="markdownIt-Anchor" href="#å››æ¬¡æŒ¥æ‰‹"></a> å››æ¬¡æŒ¥æ‰‹</h3>
<p>ï¼ˆ1ï¼‰å››æ¬¡æŒ¥æ‰‹æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<ul>
<li>å››æ¬¡æŒ¥æ‰‹è´Ÿè´£æ–­å¼€ TCP è¿æ¥ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰ä»€ä¹ˆæ˜¯å››æ¬¡æŒ¥æ‰‹ï¼Ÿ</p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå››æ¬¡æŒ¥æ‰‹æµç¨‹å¦‚ä¸‹ï¼š</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/cs/network/transport/å››æ¬¡æŒ¥æ‰‹.gif!zp"/></div>
<ol>
<li>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ª FIN åŒ…ï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„æ•°æ®ä¼ é€ã€‚</li>
<li>ç¬¬äºŒæ¬¡æŒ¥æ‰‹ - æœåŠ¡ç«¯æ”¶åˆ°è¿™ä¸ª FIN åŒ…ï¼Œå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª ACK åŒ…ï¼Œç¡®è®¤åºå·ä¸ºæ”¶åˆ°çš„åºå·åŠ  1ã€‚å’Œ SYN ä¸€æ ·ï¼Œä¸€ä¸ª FIN å°†å ç”¨ä¸€ä¸ªåºå·ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ - æœåŠ¡ç«¯å…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª FIN åŒ…ã€‚</li>
<li>ç¬¬å››æ¬¡æŒ¥æ‰‹ - å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ ACK åŒ…ï¼Œå¹¶å°†ç¡®è®¤åºå·è®¾ç½®ä¸ºæ”¶åˆ°åºå·åŠ  1ã€‚</li>
</ol>
<p>ï¼ˆ3ï¼‰ä¸ºä»€ä¹ˆå»ºç«‹è¿æ¥æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œå…³é—­è¿æ¥ç¡®æ˜¯å››æ¬¡æŒ¥æ‰‹å‘¢ï¼Ÿ</p>
<ul>
<li>å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œ æœåŠ¡å™¨åœ¨ LISTEN çŠ¶æ€ä¸‹ï¼Œæ”¶åˆ°å»ºç«‹è¿æ¥è¯·æ±‚çš„ SYN æŠ¥æ–‡åï¼ŒæŠŠ ACK å’Œ SYN æ”¾åœ¨ä¸€ä¸ªæŠ¥æ–‡é‡Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>è€Œå…³é—­è¿æ¥æ—¶ï¼ŒæœåŠ¡å™¨æ”¶åˆ°å¯¹æ–¹çš„ FIN æŠ¥æ–‡æ—¶ï¼Œä»…ä»…è¡¨ç¤ºå¯¹æ–¹ä¸å†å‘é€æ•°æ®äº†ä½†æ˜¯è¿˜èƒ½æ¥æ”¶æ•°æ®ï¼Œè€Œè‡ªå·±ä¹Ÿæœªå¿…å…¨éƒ¨æ•°æ®éƒ½å‘é€ç»™å¯¹æ–¹äº†ï¼Œæ‰€ä»¥å·±æ–¹å¯ä»¥ç«‹å³å…³é—­ï¼Œä¹Ÿå¯ä»¥å‘é€ä¸€äº›æ•°æ®ç»™å¯¹æ–¹åï¼Œå†å‘é€ FIN æŠ¥æ–‡ç»™å¯¹æ–¹æ¥è¡¨ç¤ºåŒæ„ç°åœ¨å…³é—­è¿æ¥ï¼Œå› æ­¤ï¼Œå·±æ–¹ ACK å’Œ FIN ä¸€èˆ¬éƒ½ä¼šåˆ†å¼€å‘é€ï¼Œä»è€Œå¯¼è‡´å¤šäº†ä¸€æ¬¡ã€‚</li>
</ul>
<h2 id="æ»‘åŠ¨çª—å£"><a class="markdownIt-Anchor" href="#æ»‘åŠ¨çª—å£"></a> æ»‘åŠ¨çª—å£</h2>
<p>ä»€ä¹ˆæ˜¯æ»‘åŠ¨çª—å£ï¼Ÿ</p>
<p><strong>æ»‘åŠ¨çª—å£æ˜¯ TCP çš„ä¸€ç§æ§åˆ¶ç½‘ç»œæµé‡çš„æŠ€æœ¯ã€‚</strong></p>
<p><strong>TCP å¿…éœ€è¦è§£å†³çš„å¯é ä¼ è¾“ä»¥åŠåŒ…ä¹±åºï¼ˆreorderingï¼‰çš„é—®é¢˜</strong>ï¼Œæ‰€ä»¥ï¼ŒTCP å¿…éœ€è¦çŸ¥é“ç½‘ç»œå®é™…çš„æ•°æ®å¤„ç†å¸¦å®½æˆ–æ˜¯æ•°æ®å¤„ç†é€Ÿåº¦ï¼Œè¿™æ ·æ‰ä¸ä¼šå¼•èµ·ç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´ä¸¢åŒ…ã€‚</p>
<p>TCP å¤´é‡Œæœ‰ä¸€ä¸ªå­—æ®µå« Windowï¼Œåˆå« Advertised-Windowï¼Œè¿™ä¸ªå­—æ®µæ˜¯æ¥æ”¶ç«¯å‘Šè¯‰å‘é€ç«¯è‡ªå·±è¿˜æœ‰å¤šå°‘ç¼“å†²åŒºå¯ä»¥æ¥æ”¶æ•°æ®ã€‚<strong>äºæ˜¯å‘é€ç«¯å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›æ¥å‘é€æ•°æ®ï¼Œè€Œä¸ä¼šå¯¼è‡´æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥</strong>ã€‚</p>
<p>æ»‘åŠ¨çª—å£åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559265819762.png!zp"/></div>
<ol>
<li>å·²å‘é€å·²ç¡®è®¤ - æ•°æ®æµä¸­æœ€æ—©çš„å­—èŠ‚å·²ç»å‘é€å¹¶å¾—åˆ°ç¡®è®¤ã€‚è¿™äº›æ•°æ®æ˜¯ç«™åœ¨å‘é€ç«¯çš„è§’åº¦æ¥çœ‹çš„ã€‚ä¸Šå›¾ä¸­çš„ 31 ä¸ªå­—èŠ‚å·²ç»å‘é€å¹¶ç¡®è®¤ã€‚</li>
<li>å·²å‘é€ä½†å°šæœªç¡®è®¤ - å·²å‘é€ä½†å°šæœªå¾—åˆ°ç¡®è®¤çš„å­—èŠ‚ã€‚å‘é€æ–¹åœ¨ç¡®è®¤ä¹‹å‰ï¼Œä¸è®¤ä¸ºè¿™äº›æ•°æ®å·²ç»è¢«å¤„ç†ã€‚ä¸Šå›¾ä¸­çš„ 32 ~ 45 å­—èŠ‚ä¸ºç¬¬ 2 ç±»ã€‚</li>
<li>æœªå‘é€è€Œæ¥æ”¶æ–¹å·² Ready - è®¾å¤‡å°šæœªå°†æ•°æ®å‘å‡º ï¼Œä½†æ¥æ”¶æ–¹æ ¹æ®æœ€è¿‘ä¸€æ¬¡å…³äºå‘é€æ–¹ä¸€æ¬¡è¦å‘é€å¤šå°‘å­—èŠ‚ç¡®è®¤è‡ªå·±æœ‰è¶³å¤Ÿç©ºé—´ã€‚å‘é€æ–¹ä¼šç«‹å³å°è¯•å‘é€ã€‚ä¸Šå›¾ä¸­çš„ 46 ~ 51 å­—èŠ‚ä¸ºç¬¬ 3 ç±»ã€‚</li>
<li>æœªå‘é€è€Œæ¥æ”¶æ–¹ Not Ready - ç”±äºæ¥æ”¶æ–¹ not readyï¼Œè¿˜ä¸å…è®¸å°†è¿™éƒ¨åˆ†æ•°æ®å‘å‡ºã€‚ä¸Šå›¾ä¸­çš„ 52 ä»¥åçš„å­—èŠ‚ä¸ºç¬¬ 4 ç±»ã€‚</li>
</ol>
<div align="center"><img src="http://dunwu.test.upcdn.net/snap/1559265927658.png!zp"/></div>
<p>è¿™å¼ å›¾ç‰‡ç›¸å¯¹äºä¸Šä¸€å¼ å›¾ç‰‡ï¼Œæ»‘åŠ¨çª—å£åç§»äº† 5 ä¸ªå­—èŠ‚ï¼Œæ„å‘³ç€æœ‰ 5 ä¸ªå·²å‘é€çš„å­—èŠ‚å¾—åˆ°äº†ç¡®è®¤ã€‚</p>
<h2 id="tcp-é‡ä¼ æœºåˆ¶"><a class="markdownIt-Anchor" href="#tcp-é‡ä¼ æœºåˆ¶"></a> TCP é‡ä¼ æœºåˆ¶</h2>
<p>TCP è¦ä¿è¯æ‰€æœ‰çš„æ•°æ®åŒ…éƒ½å¯ä»¥åˆ°è¾¾ï¼Œæ‰€ä»¥ï¼Œå¿…éœ€è¦æœ‰é‡ä¼ æœºåˆ¶ã€‚</p>
<p>TCP é‡ä¼ æœºåˆ¶ä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>è¶…æ—¶é‡ä¼ æœºåˆ¶</li>
<li>å¿«é€Ÿé‡ä¼ æœºåˆ¶</li>
</ul>
<h3 id="è¶…æ—¶é‡ä¼ æœºåˆ¶"><a class="markdownIt-Anchor" href="#è¶…æ—¶é‡ä¼ æœºåˆ¶"></a> è¶…æ—¶é‡ä¼ æœºåˆ¶</h3>
<p>è¶…æ—¶é‡ä¼ æœºåˆ¶æ˜¯æŒ‡ï¼šå‘é€æ•°æ®åŒ…åœ¨ä¸€å®šçš„æ—¶é—´å‘¨æœŸå†…æ²¡æœ‰æ”¶åˆ°ç›¸åº”çš„ ACKï¼Œç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œè¶…æ—¶ä¹‹åå°±è®¤ä¸ºè¿™ä¸ªæ•°æ®åŒ…ä¸¢å¤±ï¼Œå°±ä¼šé‡æ–°å‘é€ã€‚è¿™ä¸ªç­‰å¾…æ—¶é—´è¢«ç§°ä¸º RTO(Retransmission TimeOut)ï¼Œå³é‡ä¼ è¶…æ—¶æ—¶é—´ã€‚</p>
<p>æ²¡æœ‰ç¡®è®¤çš„æ•°æ®åŒ…ä¸ä¼šä»çª—å£ä¸­ç§»èµ°ï¼Œå®šæ—¶å™¨åœ¨é‡ä¼ æ—¶é—´åˆ°æœŸå†…ï¼Œæ¯ä¸ªç‰‡æ®µçš„ä½ç½®ä¸å˜ã€‚</p>
<p>è¿™ç§æœºåˆ¶çš„é‡ç‚¹æ˜¯ RTO çš„è®¾ç½®ï¼š</p>
<ul>
<li>RTO è®¾é•¿äº†ï¼Œé‡å‘å°±æ…¢ï¼Œä¸¢äº†è€åŠå¤©æ‰é‡å‘ï¼Œæ²¡æœ‰æ•ˆç‡ï¼Œæ€§èƒ½å·®ï¼›</li>
<li>RTO è®¾çŸ­äº†ï¼Œä¼šå¯¼è‡´å¯èƒ½å¹¶æ²¡æœ‰ä¸¢å°±é‡å‘ã€‚äºæ˜¯é‡å‘çš„å°±å¿«ï¼Œä¼šå¢åŠ ç½‘ç»œæ‹¥å¡ï¼Œå¯¼è‡´æ›´å¤šçš„è¶…æ—¶ï¼Œæ›´å¤šçš„è¶…æ—¶å¯¼è‡´æ›´å¤šçš„é‡å‘</li>
</ul>
<h3 id="å¿«é€Ÿé‡ä¼ æœºåˆ¶"><a class="markdownIt-Anchor" href="#å¿«é€Ÿé‡ä¼ æœºåˆ¶"></a> å¿«é€Ÿé‡ä¼ æœºåˆ¶</h3>
<p>å¿«é€Ÿé‡ä¼ æœºåˆ¶ï¼Œå®ç°äº†å¦å¤–çš„ä¸€ç§ä¸¢åŒ…è¯„å®šæ ‡å‡†ï¼Œå³å¦‚æœè¿ç»­æ”¶åˆ° 3 æ¬¡é‡å¤ ACKï¼Œå‘é€æ–¹å°±è®¤ä¸ºè¿™ä¸ª seq çš„åŒ…ä¸¢å¤±äº†ï¼Œç«‹åˆ»è¿›è¡Œé‡ä¼ ã€‚</p>
<p>å½“æ¥æ”¶æ–¹æ”¶åˆ°ä¹±åºç‰‡æ®µæ—¶ï¼Œéœ€è¦é‡å¤å‘é€ ACKã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://coolshell.cn/articles/11564.html" target="_blank" rel="noopener">TCP çš„é‚£äº›äº‹å„¿ï¼ˆä¸Šï¼‰</a></li>
<li><a href="https://coolshell.cn/articles/11609.html" target="_blank" rel="noopener">TCP çš„é‚£äº›äº‹å„¿ï¼ˆä¸‹ï¼‰</a></li>
<li><a href="https://juejin.im/post/5a7835a46fb9a063606eb801" target="_blank" rel="noopener">å›¾è§£ TCP ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡åˆ†æ‰‹</a></li>
<li><a href="https://blog.csdn.net/qzcsu/article/details/72861891" target="_blank" rel="noopener">TCP çš„ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹ï¼ˆè¯¦è§£+åŠ¨å›¾ï¼‰</a></li>
<li><a href="https://blog.csdn.net/sinat_36629696/article/details/80740678" target="_blank" rel="noopener">TCP è¯¦è§£</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/5/">5</a><a class="extend next" rel="next" href="/blog/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Zhang Peng"
    src="/blog/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Zhang Peng</p>
  <div class="site-description" itemprop="description">Dunwu's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail &amp;rarr; mailto:forbreak@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/blog/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-paper-plane"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Peng</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">321k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">4:52</span>
</div>

        












        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script>
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/pisces.js"></script>


<script src="/blog/js/next-boot.js"></script>

<script src="/blog/js/bookmark.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>














  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://blog-ajay4qmfci.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
